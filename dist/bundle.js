var Pe=Object.defineProperty;var Ge=(Y,u,n)=>u in Y?Pe(Y,u,{enumerable:!0,configurable:!0,writable:!0,value:n}):Y[u]=n;var ne=(Y,u,n)=>Ge(Y,typeof u!="symbol"?u+"":u,n);(function(){"use strict";(function(u){var n={};typeof exports>"u"?typeof define=="function"&&typeof define.amd=="object"&&define.amd?(n.exports={},define(function(){return n.exports})):n.exports=typeof window<"u"?window:u:n.exports=exports,function(l){if(!h)var h=1e-6;if(!d)var d=typeof Float32Array<"u"?Float32Array:Array;if(!_)var _=Math.random;var m={};m.setMatrixArrayType=function(e){d=e},typeof l<"u"&&(l.glMatrix=m);var E=Math.PI/180;m.toRadian=function(e){return e*E};var L={};L.create=function(){var e=new d(2);return e[0]=0,e[1]=0,e},L.clone=function(e){var t=new d(2);return t[0]=e[0],t[1]=e[1],t},L.fromValues=function(e,t){var r=new d(2);return r[0]=e,r[1]=t,r},L.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},L.set=function(e,t,r){return e[0]=t,e[1]=r,e},L.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e},L.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e},L.sub=L.subtract,L.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e},L.mul=L.multiply,L.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e},L.div=L.divide,L.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e},L.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e},L.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e},L.scaleAndAdd=function(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e},L.distance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(r*r+s*s)},L.dist=L.distance,L.squaredDistance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1];return r*r+s*s},L.sqrDist=L.squaredDistance,L.length=function(e){var t=e[0],r=e[1];return Math.sqrt(t*t+r*r)},L.len=L.length,L.squaredLength=function(e){var t=e[0],r=e[1];return t*t+r*r},L.sqrLen=L.squaredLength,L.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},L.normalize=function(e,t){var r=t[0],s=t[1],a=r*r+s*s;return a>0&&(a=1/Math.sqrt(a),e[0]=t[0]*a,e[1]=t[1]*a),e},L.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},L.cross=function(e,t,r){var s=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=s,e},L.lerp=function(e,t,r,s){var a=t[0],o=t[1];return e[0]=a+s*(r[0]-a),e[1]=o+s*(r[1]-o),e},L.random=function(e,t){t=t||1;var r=_()*2*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e},L.transformMat2=function(e,t,r){var s=t[0],a=t[1];return e[0]=r[0]*s+r[2]*a,e[1]=r[1]*s+r[3]*a,e},L.transformMat2d=function(e,t,r){var s=t[0],a=t[1];return e[0]=r[0]*s+r[2]*a+r[4],e[1]=r[1]*s+r[3]*a+r[5],e},L.transformMat3=function(e,t,r){var s=t[0],a=t[1];return e[0]=r[0]*s+r[3]*a+r[6],e[1]=r[1]*s+r[4]*a+r[7],e},L.transformMat4=function(e,t,r){var s=t[0],a=t[1];return e[0]=r[0]*s+r[4]*a+r[12],e[1]=r[1]*s+r[5]*a+r[13],e},L.forEach=function(){var e=L.create();return function(t,r,s,a,o,c){var f,p;for(r||(r=2),s||(s=0),a?p=Math.min(a*r+s,t.length):p=t.length,f=s;f<p;f+=r)e[0]=t[f],e[1]=t[f+1],o(e,e,c),t[f]=e[0],t[f+1]=e[1];return t}}(),L.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},typeof l<"u"&&(l.vec2=L);var b={};b.create=function(){var e=new d(3);return e[0]=0,e[1]=0,e[2]=0,e},b.clone=function(e){var t=new d(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},b.fromValues=function(e,t,r){var s=new d(3);return s[0]=e,s[1]=t,s[2]=r,s},b.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},b.set=function(e,t,r,s){return e[0]=t,e[1]=r,e[2]=s,e},b.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e},b.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e},b.sub=b.subtract,b.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e},b.mul=b.multiply,b.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e},b.div=b.divide,b.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e},b.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e},b.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e},b.scaleAndAdd=function(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e},b.distance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1],a=t[2]-e[2];return Math.sqrt(r*r+s*s+a*a)},b.dist=b.distance,b.squaredDistance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1],a=t[2]-e[2];return r*r+s*s+a*a},b.sqrDist=b.squaredDistance,b.length=function(e){var t=e[0],r=e[1],s=e[2];return Math.sqrt(t*t+r*r+s*s)},b.len=b.length,b.squaredLength=function(e){var t=e[0],r=e[1],s=e[2];return t*t+r*r+s*s},b.sqrLen=b.squaredLength,b.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},b.normalize=function(e,t){var r=t[0],s=t[1],a=t[2],o=r*r+s*s+a*a;return o>0&&(o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o),e},b.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},b.cross=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=r[0],f=r[1],p=r[2];return e[0]=a*p-o*f,e[1]=o*c-s*p,e[2]=s*f-a*c,e},b.lerp=function(e,t,r,s){var a=t[0],o=t[1],c=t[2];return e[0]=a+s*(r[0]-a),e[1]=o+s*(r[1]-o),e[2]=c+s*(r[2]-c),e},b.random=function(e,t){t=t||1;var r=_()*2*Math.PI,s=_()*2-1,a=Math.sqrt(1-s*s)*t;return e[0]=Math.cos(r)*a,e[1]=Math.sin(r)*a,e[2]=s*t,e},b.transformMat4=function(e,t,r){var s=t[0],a=t[1],o=t[2];return e[0]=r[0]*s+r[4]*a+r[8]*o+r[12],e[1]=r[1]*s+r[5]*a+r[9]*o+r[13],e[2]=r[2]*s+r[6]*a+r[10]*o+r[14],e},b.transformMat3=function(e,t,r){var s=t[0],a=t[1],o=t[2];return e[0]=s*r[0]+a*r[3]+o*r[6],e[1]=s*r[1]+a*r[4]+o*r[7],e[2]=s*r[2]+a*r[5]+o*r[8],e},b.transformQuat=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=r[0],f=r[1],p=r[2],T=r[3],g=T*s+f*o-p*a,N=T*a+p*s-c*o,A=T*o+c*a-f*s,M=-c*s-f*a-p*o;return e[0]=g*T+M*-c+N*-p-A*-f,e[1]=N*T+M*-f+A*-c-g*-p,e[2]=A*T+M*-p+g*-f-N*-c,e},b.rotateX=function(e,t,r,s){var a=[],o=[];return a[0]=t[0]-r[0],a[1]=t[1]-r[1],a[2]=t[2]-r[2],o[0]=a[0],o[1]=a[1]*Math.cos(s)-a[2]*Math.sin(s),o[2]=a[1]*Math.sin(s)+a[2]*Math.cos(s),e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e},b.rotateY=function(e,t,r,s){var a=[],o=[];return a[0]=t[0]-r[0],a[1]=t[1]-r[1],a[2]=t[2]-r[2],o[0]=a[2]*Math.sin(s)+a[0]*Math.cos(s),o[1]=a[1],o[2]=a[2]*Math.cos(s)-a[0]*Math.sin(s),e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e},b.rotateZ=function(e,t,r,s){var a=[],o=[];return a[0]=t[0]-r[0],a[1]=t[1]-r[1],a[2]=t[2]-r[2],o[0]=a[0]*Math.cos(s)-a[1]*Math.sin(s),o[1]=a[0]*Math.sin(s)+a[1]*Math.cos(s),o[2]=a[2],e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e},b.forEach=function(){var e=b.create();return function(t,r,s,a,o,c){var f,p;for(r||(r=3),s||(s=0),a?p=Math.min(a*r+s,t.length):p=t.length,f=s;f<p;f+=r)e[0]=t[f],e[1]=t[f+1],e[2]=t[f+2],o(e,e,c),t[f]=e[0],t[f+1]=e[1],t[f+2]=e[2];return t}}(),b.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},typeof l<"u"&&(l.vec3=b);var S={};S.create=function(){var e=new d(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},S.clone=function(e){var t=new d(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},S.fromValues=function(e,t,r,s){var a=new d(4);return a[0]=e,a[1]=t,a[2]=r,a[3]=s,a},S.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},S.set=function(e,t,r,s,a){return e[0]=t,e[1]=r,e[2]=s,e[3]=a,e},S.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},S.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e},S.sub=S.subtract,S.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e},S.mul=S.multiply,S.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e[3]=t[3]/r[3],e},S.div=S.divide,S.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e},S.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e},S.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},S.scaleAndAdd=function(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e[3]=t[3]+r[3]*s,e},S.distance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1],a=t[2]-e[2],o=t[3]-e[3];return Math.sqrt(r*r+s*s+a*a+o*o)},S.dist=S.distance,S.squaredDistance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1],a=t[2]-e[2],o=t[3]-e[3];return r*r+s*s+a*a+o*o},S.sqrDist=S.squaredDistance,S.length=function(e){var t=e[0],r=e[1],s=e[2],a=e[3];return Math.sqrt(t*t+r*r+s*s+a*a)},S.len=S.length,S.squaredLength=function(e){var t=e[0],r=e[1],s=e[2],a=e[3];return t*t+r*r+s*s+a*a},S.sqrLen=S.squaredLength,S.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},S.normalize=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],c=r*r+s*s+a*a+o*o;return c>0&&(c=1/Math.sqrt(c),e[0]=t[0]*c,e[1]=t[1]*c,e[2]=t[2]*c,e[3]=t[3]*c),e},S.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},S.lerp=function(e,t,r,s){var a=t[0],o=t[1],c=t[2],f=t[3];return e[0]=a+s*(r[0]-a),e[1]=o+s*(r[1]-o),e[2]=c+s*(r[2]-c),e[3]=f+s*(r[3]-f),e},S.random=function(e,t){return t=t||1,e[0]=_(),e[1]=_(),e[2]=_(),e[3]=_(),S.normalize(e,e),S.scale(e,e,t),e},S.transformMat4=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3];return e[0]=r[0]*s+r[4]*a+r[8]*o+r[12]*c,e[1]=r[1]*s+r[5]*a+r[9]*o+r[13]*c,e[2]=r[2]*s+r[6]*a+r[10]*o+r[14]*c,e[3]=r[3]*s+r[7]*a+r[11]*o+r[15]*c,e},S.transformQuat=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=r[0],f=r[1],p=r[2],T=r[3],g=T*s+f*o-p*a,N=T*a+p*s-c*o,A=T*o+c*a-f*s,M=-c*s-f*a-p*o;return e[0]=g*T+M*-c+N*-p-A*-f,e[1]=N*T+M*-f+A*-c-g*-p,e[2]=A*T+M*-p+g*-f-N*-c,e},S.forEach=function(){var e=S.create();return function(t,r,s,a,o,c){var f,p;for(r||(r=4),s||(s=0),a?p=Math.min(a*r+s,t.length):p=t.length,f=s;f<p;f+=r)e[0]=t[f],e[1]=t[f+1],e[2]=t[f+2],e[3]=t[f+3],o(e,e,c),t[f]=e[0],t[f+1]=e[1],t[f+2]=e[2],t[f+3]=e[3];return t}}(),S.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},typeof l<"u"&&(l.vec4=S);var R={};R.create=function(){var e=new d(4);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},R.clone=function(e){var t=new d(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},R.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},R.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},R.transpose=function(e,t){if(e===t){var r=t[1];e[1]=t[2],e[2]=r}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},R.invert=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],c=r*o-a*s;return c?(c=1/c,e[0]=o*c,e[1]=-s*c,e[2]=-a*c,e[3]=r*c,e):null},R.adjoint=function(e,t){var r=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=r,e},R.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},R.multiply=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=r[0],p=r[1],T=r[2],g=r[3];return e[0]=s*f+o*p,e[1]=a*f+c*p,e[2]=s*T+o*g,e[3]=a*T+c*g,e},R.mul=R.multiply,R.rotate=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=Math.sin(r),p=Math.cos(r);return e[0]=s*p+o*f,e[1]=a*p+c*f,e[2]=s*-f+o*p,e[3]=a*-f+c*p,e},R.scale=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=r[0],p=r[1];return e[0]=s*f,e[1]=a*f,e[2]=o*p,e[3]=c*p,e},R.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},R.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2))},R.LDU=function(e,t,r,s){return e[2]=s[2]/s[0],r[0]=s[0],r[1]=s[1],r[3]=s[3]-e[2]*r[1],[e,t,r]},typeof l<"u"&&(l.mat2=R);var C={};C.create=function(){var e=new d(6);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},C.clone=function(e){var t=new d(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},C.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},C.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},C.invert=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],c=t[4],f=t[5],p=r*o-s*a;return p?(p=1/p,e[0]=o*p,e[1]=-s*p,e[2]=-a*p,e[3]=r*p,e[4]=(a*f-o*c)*p,e[5]=(s*c-r*f)*p,e):null},C.determinant=function(e){return e[0]*e[3]-e[1]*e[2]},C.multiply=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=t[4],p=t[5],T=r[0],g=r[1],N=r[2],A=r[3],M=r[4],B=r[5];return e[0]=s*T+o*g,e[1]=a*T+c*g,e[2]=s*N+o*A,e[3]=a*N+c*A,e[4]=s*M+o*B+f,e[5]=a*M+c*B+p,e},C.mul=C.multiply,C.rotate=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=t[4],p=t[5],T=Math.sin(r),g=Math.cos(r);return e[0]=s*g+o*T,e[1]=a*g+c*T,e[2]=s*-T+o*g,e[3]=a*-T+c*g,e[4]=f,e[5]=p,e},C.scale=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=t[4],p=t[5],T=r[0],g=r[1];return e[0]=s*T,e[1]=a*T,e[2]=o*g,e[3]=c*g,e[4]=f,e[5]=p,e},C.translate=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=t[4],p=t[5],T=r[0],g=r[1];return e[0]=s,e[1]=a,e[2]=o,e[3]=c,e[4]=s*T+o*g+f,e[5]=a*T+c*g+p,e},C.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},C.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+1)},typeof l<"u"&&(l.mat2d=C);var G={};G.create=function(){var e=new d(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},G.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},G.clone=function(e){var t=new d(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},G.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},G.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},G.transpose=function(e,t){if(e===t){var r=t[1],s=t[2],a=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=s,e[7]=a}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},G.invert=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],c=t[4],f=t[5],p=t[6],T=t[7],g=t[8],N=g*c-f*T,A=-g*o+f*p,M=T*o-c*p,B=r*N+s*A+a*M;return B?(B=1/B,e[0]=N*B,e[1]=(-g*s+a*T)*B,e[2]=(f*s-a*c)*B,e[3]=A*B,e[4]=(g*r-a*p)*B,e[5]=(-f*r+a*o)*B,e[6]=M*B,e[7]=(-T*r+s*p)*B,e[8]=(c*r-s*o)*B,e):null},G.adjoint=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],c=t[4],f=t[5],p=t[6],T=t[7],g=t[8];return e[0]=c*g-f*T,e[1]=a*T-s*g,e[2]=s*f-a*c,e[3]=f*p-o*g,e[4]=r*g-a*p,e[5]=a*o-r*f,e[6]=o*T-c*p,e[7]=s*p-r*T,e[8]=r*c-s*o,e},G.determinant=function(e){var t=e[0],r=e[1],s=e[2],a=e[3],o=e[4],c=e[5],f=e[6],p=e[7],T=e[8];return t*(T*o-c*p)+r*(-T*a+c*f)+s*(p*a-o*f)},G.multiply=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=t[4],p=t[5],T=t[6],g=t[7],N=t[8],A=r[0],M=r[1],B=r[2],O=r[3],P=r[4],U=r[5],X=r[6],k=r[7],V=r[8];return e[0]=A*s+M*c+B*T,e[1]=A*a+M*f+B*g,e[2]=A*o+M*p+B*N,e[3]=O*s+P*c+U*T,e[4]=O*a+P*f+U*g,e[5]=O*o+P*p+U*N,e[6]=X*s+k*c+V*T,e[7]=X*a+k*f+V*g,e[8]=X*o+k*p+V*N,e},G.mul=G.multiply,G.translate=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=t[4],p=t[5],T=t[6],g=t[7],N=t[8],A=r[0],M=r[1];return e[0]=s,e[1]=a,e[2]=o,e[3]=c,e[4]=f,e[5]=p,e[6]=A*s+M*c+T,e[7]=A*a+M*f+g,e[8]=A*o+M*p+N,e},G.rotate=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=t[4],p=t[5],T=t[6],g=t[7],N=t[8],A=Math.sin(r),M=Math.cos(r);return e[0]=M*s+A*c,e[1]=M*a+A*f,e[2]=M*o+A*p,e[3]=M*c-A*s,e[4]=M*f-A*a,e[5]=M*p-A*o,e[6]=T,e[7]=g,e[8]=N,e},G.scale=function(e,t,r){var s=r[0],a=r[1];return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=a*t[3],e[4]=a*t[4],e[5]=a*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},G.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},G.fromQuat=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],c=r+r,f=s+s,p=a+a,T=r*c,g=s*c,N=s*f,A=a*c,M=a*f,B=a*p,O=o*c,P=o*f,U=o*p;return e[0]=1-N-B,e[3]=g-U,e[6]=A+P,e[1]=g+U,e[4]=1-T-B,e[7]=M-O,e[2]=A-P,e[5]=M+O,e[8]=1-T-N,e},G.normalFromMat4=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],c=t[4],f=t[5],p=t[6],T=t[7],g=t[8],N=t[9],A=t[10],M=t[11],B=t[12],O=t[13],P=t[14],U=t[15],X=r*f-s*c,k=r*p-a*c,V=r*T-o*c,J=s*p-a*f,te=s*T-o*f,F=a*T-o*p,Q=g*O-N*B,ee=g*P-A*B,K=g*U-M*B,z=N*P-A*O,q=N*U-M*O,ie=A*U-M*P,j=X*ie-k*q+V*z+J*K-te*ee+F*Q;return j?(j=1/j,e[0]=(f*ie-p*q+T*z)*j,e[1]=(p*K-c*ie-T*ee)*j,e[2]=(c*q-f*K+T*Q)*j,e[3]=(a*q-s*ie-o*z)*j,e[4]=(r*ie-a*K+o*ee)*j,e[5]=(s*K-r*q-o*Q)*j,e[6]=(O*F-P*te+U*J)*j,e[7]=(P*V-B*F-U*k)*j,e[8]=(B*te-O*V+U*X)*j,e):null},G.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},G.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2))},typeof l<"u"&&(l.mat3=G);var D={};D.create=function(){var e=new d(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},D.clone=function(e){var t=new d(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},D.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},D.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},D.transpose=function(e,t){if(e===t){var r=t[1],s=t[2],a=t[3],o=t[6],c=t[7],f=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=s,e[9]=o,e[11]=t[14],e[12]=a,e[13]=c,e[14]=f}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},D.invert=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],c=t[4],f=t[5],p=t[6],T=t[7],g=t[8],N=t[9],A=t[10],M=t[11],B=t[12],O=t[13],P=t[14],U=t[15],X=r*f-s*c,k=r*p-a*c,V=r*T-o*c,J=s*p-a*f,te=s*T-o*f,F=a*T-o*p,Q=g*O-N*B,ee=g*P-A*B,K=g*U-M*B,z=N*P-A*O,q=N*U-M*O,ie=A*U-M*P,j=X*ie-k*q+V*z+J*K-te*ee+F*Q;return j?(j=1/j,e[0]=(f*ie-p*q+T*z)*j,e[1]=(a*q-s*ie-o*z)*j,e[2]=(O*F-P*te+U*J)*j,e[3]=(A*te-N*F-M*J)*j,e[4]=(p*K-c*ie-T*ee)*j,e[5]=(r*ie-a*K+o*ee)*j,e[6]=(P*V-B*F-U*k)*j,e[7]=(g*F-A*V+M*k)*j,e[8]=(c*q-f*K+T*Q)*j,e[9]=(s*K-r*q-o*Q)*j,e[10]=(B*te-O*V+U*X)*j,e[11]=(N*V-g*te-M*X)*j,e[12]=(f*ee-c*z-p*Q)*j,e[13]=(r*z-s*ee+a*Q)*j,e[14]=(O*k-B*J-P*X)*j,e[15]=(g*J-N*k+A*X)*j,e):null},D.adjoint=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],c=t[4],f=t[5],p=t[6],T=t[7],g=t[8],N=t[9],A=t[10],M=t[11],B=t[12],O=t[13],P=t[14],U=t[15];return e[0]=f*(A*U-M*P)-N*(p*U-T*P)+O*(p*M-T*A),e[1]=-(s*(A*U-M*P)-N*(a*U-o*P)+O*(a*M-o*A)),e[2]=s*(p*U-T*P)-f*(a*U-o*P)+O*(a*T-o*p),e[3]=-(s*(p*M-T*A)-f*(a*M-o*A)+N*(a*T-o*p)),e[4]=-(c*(A*U-M*P)-g*(p*U-T*P)+B*(p*M-T*A)),e[5]=r*(A*U-M*P)-g*(a*U-o*P)+B*(a*M-o*A),e[6]=-(r*(p*U-T*P)-c*(a*U-o*P)+B*(a*T-o*p)),e[7]=r*(p*M-T*A)-c*(a*M-o*A)+g*(a*T-o*p),e[8]=c*(N*U-M*O)-g*(f*U-T*O)+B*(f*M-T*N),e[9]=-(r*(N*U-M*O)-g*(s*U-o*O)+B*(s*M-o*N)),e[10]=r*(f*U-T*O)-c*(s*U-o*O)+B*(s*T-o*f),e[11]=-(r*(f*M-T*N)-c*(s*M-o*N)+g*(s*T-o*f)),e[12]=-(c*(N*P-A*O)-g*(f*P-p*O)+B*(f*A-p*N)),e[13]=r*(N*P-A*O)-g*(s*P-a*O)+B*(s*A-a*N),e[14]=-(r*(f*P-p*O)-c*(s*P-a*O)+B*(s*p-a*f)),e[15]=r*(f*A-p*N)-c*(s*A-a*N)+g*(s*p-a*f),e},D.determinant=function(e){var t=e[0],r=e[1],s=e[2],a=e[3],o=e[4],c=e[5],f=e[6],p=e[7],T=e[8],g=e[9],N=e[10],A=e[11],M=e[12],B=e[13],O=e[14],P=e[15],U=t*c-r*o,X=t*f-s*o,k=t*p-a*o,V=r*f-s*c,J=r*p-a*c,te=s*p-a*f,F=T*B-g*M,Q=T*O-N*M,ee=T*P-A*M,K=g*O-N*B,z=g*P-A*B,q=N*P-A*O;return U*q-X*z+k*K+V*ee-J*Q+te*F},D.multiply=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=t[4],p=t[5],T=t[6],g=t[7],N=t[8],A=t[9],M=t[10],B=t[11],O=t[12],P=t[13],U=t[14],X=t[15],k=r[0],V=r[1],J=r[2],te=r[3];return e[0]=k*s+V*f+J*N+te*O,e[1]=k*a+V*p+J*A+te*P,e[2]=k*o+V*T+J*M+te*U,e[3]=k*c+V*g+J*B+te*X,k=r[4],V=r[5],J=r[6],te=r[7],e[4]=k*s+V*f+J*N+te*O,e[5]=k*a+V*p+J*A+te*P,e[6]=k*o+V*T+J*M+te*U,e[7]=k*c+V*g+J*B+te*X,k=r[8],V=r[9],J=r[10],te=r[11],e[8]=k*s+V*f+J*N+te*O,e[9]=k*a+V*p+J*A+te*P,e[10]=k*o+V*T+J*M+te*U,e[11]=k*c+V*g+J*B+te*X,k=r[12],V=r[13],J=r[14],te=r[15],e[12]=k*s+V*f+J*N+te*O,e[13]=k*a+V*p+J*A+te*P,e[14]=k*o+V*T+J*M+te*U,e[15]=k*c+V*g+J*B+te*X,e},D.mul=D.multiply,D.translate=function(e,t,r){var s=r[0],a=r[1],o=r[2],c,f,p,T,g,N,A,M,B,O,P,U;return t===e?(e[12]=t[0]*s+t[4]*a+t[8]*o+t[12],e[13]=t[1]*s+t[5]*a+t[9]*o+t[13],e[14]=t[2]*s+t[6]*a+t[10]*o+t[14],e[15]=t[3]*s+t[7]*a+t[11]*o+t[15]):(c=t[0],f=t[1],p=t[2],T=t[3],g=t[4],N=t[5],A=t[6],M=t[7],B=t[8],O=t[9],P=t[10],U=t[11],e[0]=c,e[1]=f,e[2]=p,e[3]=T,e[4]=g,e[5]=N,e[6]=A,e[7]=M,e[8]=B,e[9]=O,e[10]=P,e[11]=U,e[12]=c*s+g*a+B*o+t[12],e[13]=f*s+N*a+O*o+t[13],e[14]=p*s+A*a+P*o+t[14],e[15]=T*s+M*a+U*o+t[15]),e},D.scale=function(e,t,r){var s=r[0],a=r[1],o=r[2];return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*a,e[5]=t[5]*a,e[6]=t[6]*a,e[7]=t[7]*a,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},D.rotate=function(e,t,r,s){var a=s[0],o=s[1],c=s[2],f=Math.sqrt(a*a+o*o+c*c),p,T,g,N,A,M,B,O,P,U,X,k,V,J,te,F,Q,ee,K,z,q,ie,j,se;return Math.abs(f)<h?null:(f=1/f,a*=f,o*=f,c*=f,p=Math.sin(r),T=Math.cos(r),g=1-T,N=t[0],A=t[1],M=t[2],B=t[3],O=t[4],P=t[5],U=t[6],X=t[7],k=t[8],V=t[9],J=t[10],te=t[11],F=a*a*g+T,Q=o*a*g+c*p,ee=c*a*g-o*p,K=a*o*g-c*p,z=o*o*g+T,q=c*o*g+a*p,ie=a*c*g+o*p,j=o*c*g-a*p,se=c*c*g+T,e[0]=N*F+O*Q+k*ee,e[1]=A*F+P*Q+V*ee,e[2]=M*F+U*Q+J*ee,e[3]=B*F+X*Q+te*ee,e[4]=N*K+O*z+k*q,e[5]=A*K+P*z+V*q,e[6]=M*K+U*z+J*q,e[7]=B*K+X*z+te*q,e[8]=N*ie+O*j+k*se,e[9]=A*ie+P*j+V*se,e[10]=M*ie+U*j+J*se,e[11]=B*ie+X*j+te*se,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},D.rotateX=function(e,t,r){var s=Math.sin(r),a=Math.cos(r),o=t[4],c=t[5],f=t[6],p=t[7],T=t[8],g=t[9],N=t[10],A=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*a+T*s,e[5]=c*a+g*s,e[6]=f*a+N*s,e[7]=p*a+A*s,e[8]=T*a-o*s,e[9]=g*a-c*s,e[10]=N*a-f*s,e[11]=A*a-p*s,e},D.rotateY=function(e,t,r){var s=Math.sin(r),a=Math.cos(r),o=t[0],c=t[1],f=t[2],p=t[3],T=t[8],g=t[9],N=t[10],A=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*a-T*s,e[1]=c*a-g*s,e[2]=f*a-N*s,e[3]=p*a-A*s,e[8]=o*s+T*a,e[9]=c*s+g*a,e[10]=f*s+N*a,e[11]=p*s+A*a,e},D.rotateZ=function(e,t,r){var s=Math.sin(r),a=Math.cos(r),o=t[0],c=t[1],f=t[2],p=t[3],T=t[4],g=t[5],N=t[6],A=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*a+T*s,e[1]=c*a+g*s,e[2]=f*a+N*s,e[3]=p*a+A*s,e[4]=T*a-o*s,e[5]=g*a-c*s,e[6]=N*a-f*s,e[7]=A*a-p*s,e},D.fromRotationTranslation=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=s+s,p=a+a,T=o+o,g=s*f,N=s*p,A=s*T,M=a*p,B=a*T,O=o*T,P=c*f,U=c*p,X=c*T;return e[0]=1-(M+O),e[1]=N+X,e[2]=A-U,e[3]=0,e[4]=N-X,e[5]=1-(g+O),e[6]=B+P,e[7]=0,e[8]=A+U,e[9]=B-P,e[10]=1-(g+M),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e},D.fromQuat=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],c=r+r,f=s+s,p=a+a,T=r*c,g=s*c,N=s*f,A=a*c,M=a*f,B=a*p,O=o*c,P=o*f,U=o*p;return e[0]=1-N-B,e[1]=g+U,e[2]=A-P,e[3]=0,e[4]=g-U,e[5]=1-T-B,e[6]=M+O,e[7]=0,e[8]=A+P,e[9]=M-O,e[10]=1-T-N,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},D.frustum=function(e,t,r,s,a,o,c){var f=1/(r-t),p=1/(a-s),T=1/(o-c);return e[0]=o*2*f,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o*2*p,e[6]=0,e[7]=0,e[8]=(r+t)*f,e[9]=(a+s)*p,e[10]=(c+o)*T,e[11]=-1,e[12]=0,e[13]=0,e[14]=c*o*2*T,e[15]=0,e},D.perspective=function(e,t,r,s,a){var o=1/Math.tan(t/2),c=1/(s-a);return e[0]=o/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(a+s)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*a*s*c,e[15]=0,e},D.ortho=function(e,t,r,s,a,o,c){var f=1/(t-r),p=1/(s-a),T=1/(o-c);return e[0]=-2*f,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*p,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*T,e[11]=0,e[12]=(t+r)*f,e[13]=(a+s)*p,e[14]=(c+o)*T,e[15]=1,e},D.lookAt=function(e,t,r,s){var a,o,c,f,p,T,g,N,A,M,B=t[0],O=t[1],P=t[2],U=s[0],X=s[1],k=s[2],V=r[0],J=r[1],te=r[2];return Math.abs(B-V)<h&&Math.abs(O-J)<h&&Math.abs(P-te)<h?D.identity(e):(g=B-V,N=O-J,A=P-te,M=1/Math.sqrt(g*g+N*N+A*A),g*=M,N*=M,A*=M,a=X*A-k*N,o=k*g-U*A,c=U*N-X*g,M=Math.sqrt(a*a+o*o+c*c),M?(M=1/M,a*=M,o*=M,c*=M):(a=0,o=0,c=0),f=N*c-A*o,p=A*a-g*c,T=g*o-N*a,M=Math.sqrt(f*f+p*p+T*T),M?(M=1/M,f*=M,p*=M,T*=M):(f=0,p=0,T=0),e[0]=a,e[1]=f,e[2]=g,e[3]=0,e[4]=o,e[5]=p,e[6]=N,e[7]=0,e[8]=c,e[9]=T,e[10]=A,e[11]=0,e[12]=-(a*B+o*O+c*P),e[13]=-(f*B+p*O+T*P),e[14]=-(g*B+N*O+A*P),e[15]=1,e)},D.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},D.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2)+Math.pow(e[9],2)+Math.pow(e[10],2)+Math.pow(e[11],2)+Math.pow(e[12],2)+Math.pow(e[13],2)+Math.pow(e[14],2)+Math.pow(e[15],2))},typeof l<"u"&&(l.mat4=D);var H={};H.create=function(){var e=new d(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},H.rotationTo=function(){var e=b.create(),t=b.fromValues(1,0,0),r=b.fromValues(0,1,0);return function(s,a,o){var c=b.dot(a,o);return c<-.999999?(b.cross(e,t,a),b.length(e)<1e-6&&b.cross(e,r,a),b.normalize(e,e),H.setAxisAngle(s,e,Math.PI),s):c>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(b.cross(e,a,o),s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1+c,H.normalize(s,s))}}(),H.setAxes=function(){var e=G.create();return function(t,r,s,a){return e[0]=s[0],e[3]=s[1],e[6]=s[2],e[1]=a[0],e[4]=a[1],e[7]=a[2],e[2]=-r[0],e[5]=-r[1],e[8]=-r[2],H.normalize(t,H.fromMat3(t,e))}}(),H.clone=S.clone,H.fromValues=S.fromValues,H.copy=S.copy,H.set=S.set,H.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},H.setAxisAngle=function(e,t,r){r*=.5;var s=Math.sin(r);return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=Math.cos(r),e},H.add=S.add,H.multiply=function(e,t,r){var s=t[0],a=t[1],o=t[2],c=t[3],f=r[0],p=r[1],T=r[2],g=r[3];return e[0]=s*g+c*f+a*T-o*p,e[1]=a*g+c*p+o*f-s*T,e[2]=o*g+c*T+s*p-a*f,e[3]=c*g-s*f-a*p-o*T,e},H.mul=H.multiply,H.scale=S.scale,H.rotateX=function(e,t,r){r*=.5;var s=t[0],a=t[1],o=t[2],c=t[3],f=Math.sin(r),p=Math.cos(r);return e[0]=s*p+c*f,e[1]=a*p+o*f,e[2]=o*p-a*f,e[3]=c*p-s*f,e},H.rotateY=function(e,t,r){r*=.5;var s=t[0],a=t[1],o=t[2],c=t[3],f=Math.sin(r),p=Math.cos(r);return e[0]=s*p-o*f,e[1]=a*p+c*f,e[2]=o*p+s*f,e[3]=c*p-a*f,e},H.rotateZ=function(e,t,r){r*=.5;var s=t[0],a=t[1],o=t[2],c=t[3],f=Math.sin(r),p=Math.cos(r);return e[0]=s*p+a*f,e[1]=a*p-s*f,e[2]=o*p+c*f,e[3]=c*p-o*f,e},H.calculateW=function(e,t){var r=t[0],s=t[1],a=t[2];return e[0]=r,e[1]=s,e[2]=a,e[3]=-Math.sqrt(Math.abs(1-r*r-s*s-a*a)),e},H.dot=S.dot,H.lerp=S.lerp,H.slerp=function(e,t,r,s){var a=t[0],o=t[1],c=t[2],f=t[3],p=r[0],T=r[1],g=r[2],N=r[3],A,M,B,O,P;return M=a*p+o*T+c*g+f*N,M<0&&(M=-M,p=-p,T=-T,g=-g,N=-N),1-M>1e-6?(A=Math.acos(M),B=Math.sin(A),O=Math.sin((1-s)*A)/B,P=Math.sin(s*A)/B):(O=1-s,P=s),e[0]=O*a+P*p,e[1]=O*o+P*T,e[2]=O*c+P*g,e[3]=O*f+P*N,e},H.invert=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],c=r*r+s*s+a*a+o*o,f=c?1/c:0;return e[0]=-r*f,e[1]=-s*f,e[2]=-a*f,e[3]=o*f,e},H.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},H.length=S.length,H.len=H.length,H.squaredLength=S.squaredLength,H.sqrLen=H.squaredLength,H.normalize=S.normalize,H.fromMat3=function(e,t){var r=t[0]+t[4]+t[8],s;if(r>0)s=Math.sqrt(r+1),e[3]=.5*s,s=.5/s,e[0]=(t[7]-t[5])*s,e[1]=(t[2]-t[6])*s,e[2]=(t[3]-t[1])*s;else{var a=0;t[4]>t[0]&&(a=1),t[8]>t[a*3+a]&&(a=2);var o=(a+1)%3,c=(a+2)%3;s=Math.sqrt(t[a*3+a]-t[o*3+o]-t[c*3+c]+1),e[a]=.5*s,s=.5/s,e[3]=(t[c*3+o]-t[o*3+c])*s,e[o]=(t[o*3+a]+t[a*3+o])*s,e[c]=(t[c*3+a]+t[a*3+c])*s}return e},H.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},typeof l<"u"&&(l.quat=H)}(n.exports)})(void 0),function(u){var n=u.GL=u.LiteGL={};if(typeof l>"u"){if(!(typeof self<"u")){if(typeof window>"u"){console.log("importing glMatrix"),u.glMatrix=require("./gl-matrix-min.js");var l=u.glMatrix;for(var h in l)u[h]=l[h]}else if(typeof l>"u")throw"litegl.js requires gl-matrix to work. It must be included before litegl."}}else if(!u.vec2)throw"litegl.js does not support gl-matrix 3.0, download 2.8 https://github.com/toji/gl-matrix/releases/tag/v2.8.1";u.requestAnimationFrame=u.requestAnimationFrame||u.mozRequestAnimationFrame||u.webkitRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},n.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0},n.reverse=null,n.LEFT_MOUSE_BUTTON=0,n.MIDDLE_MOUSE_BUTTON=1,n.RIGHT_MOUSE_BUTTON=2,n.LEFT_MOUSE_BUTTON_MASK=1,n.RIGHT_MOUSE_BUTTON_MASK=2,n.MIDDLE_MOUSE_BUTTON_MASK=4,n.last_context_id=0,n.COLOR_BUFFER_BIT=16384,n.DEPTH_BUFFER_BIT=256,n.STENCIL_BUFFER_BIT=1024,n.TEXTURE_2D=3553,n.TEXTURE_CUBE_MAP=34067,n.TEXTURE_3D=32879,n.TEXTURE_MAG_FILTER=10240,n.TEXTURE_MIN_FILTER=10241,n.TEXTURE_WRAP_S=10242,n.TEXTURE_WRAP_T=10243,n.BYTE=5120,n.UNSIGNED_BYTE=5121,n.SHORT=5122,n.UNSIGNED_SHORT=5123,n.INT=5124,n.UNSIGNED_INT=5125,n.FLOAT=5126,n.HALF_FLOAT_OES=36193,n.HALF_FLOAT=5131,n.DEPTH_COMPONENT16=33189,n.DEPTH_COMPONENT24=33190,n.DEPTH_COMPONENT32F=36012,n.FLOAT_VEC2=35664,n.FLOAT_VEC3=35665,n.FLOAT_VEC4=35666,n.INT_VEC2=35667,n.INT_VEC3=35668,n.INT_VEC4=35669,n.BOOL=35670,n.BOOL_VEC2=35671,n.BOOL_VEC3=35672,n.BOOL_VEC4=35673,n.FLOAT_MAT2=35674,n.FLOAT_MAT3=35675,n.FLOAT_MAT4=35676,n.TYPE_LENGTH={},n.TYPE_LENGTH[n.FLOAT]=n.TYPE_LENGTH[n.INT]=n.TYPE_LENGTH[n.BYTE]=n.TYPE_LENGTH[n.BOOL]=1,n.TYPE_LENGTH[n.FLOAT_VEC2]=n.TYPE_LENGTH[n.INT_VEC2]=n.TYPE_LENGTH[n.BOOL_VEC2]=2,n.TYPE_LENGTH[n.FLOAT_VEC3]=n.TYPE_LENGTH[n.INT_VEC3]=n.TYPE_LENGTH[n.BOOL_VEC3]=3,n.TYPE_LENGTH[n.FLOAT_VEC4]=n.TYPE_LENGTH[n.INT_VEC4]=n.TYPE_LENGTH[n.BOOL_VEC4]=4,n.TYPE_LENGTH[n.FLOAT_MAT3]=9,n.TYPE_LENGTH[n.FLOAT_MAT4]=16,n.SAMPLER_2D=35678,n.SAMPLER_3D=35679,n.SAMPLER_CUBE=35680,n.INT_SAMPLER_2D=36298,n.INT_SAMPLER_3D=36299,n.INT_SAMPLER_CUBE=36300,n.UNSIGNED_INT_SAMPLER_2D=36306,n.UNSIGNED_INT_SAMPLER_3D=36307,n.UNSIGNED_INT_SAMPLER_CUBE=36308,n.DEPTH_COMPONENT=6402,n.ALPHA=6406,n.RGB=6407,n.RGBA=6408,n.LUMINANCE=6409,n.LUMINANCE_ALPHA=6410,n.DEPTH_STENCIL=34041,n.UNSIGNED_INT_24_8_WEBGL=34042,n.R8=33321,n.R16F=33325,n.R32F=33326,n.R8UI=33330,n.RG8=33323,n.RG16F=33327,n.RG32F=33328,n.RGB8=32849,n.SRGB8=35905,n.RGB565=36194,n.R11F_G11F_B10F=35898,n.RGB9_E5=35901,n.RGB16F=34843,n.RGB32F=34837,n.RGB8UI=36221,n.RGBA8=32856,n.RGB5_A1=32855,n.RGBA16F=34842,n.RGBA32F=34836,n.RGBA8UI=36220,n.RGBA16I=36232,n.RGBA16UI=36214,n.RGBA32I=36226,n.RGBA32UI=36208,n.NEAREST=9728,n.LINEAR=9729,n.NEAREST_MIPMAP_NEAREST=9984,n.LINEAR_MIPMAP_NEAREST=9985,n.NEAREST_MIPMAP_LINEAR=9986,n.LINEAR_MIPMAP_LINEAR=9987,n.REPEAT=10497,n.CLAMP_TO_EDGE=33071,n.MIRRORED_REPEAT=33648,n.ZERO=0,n.ONE=1,n.SRC_COLOR=768,n.ONE_MINUS_SRC_COLOR=769,n.SRC_ALPHA=770,n.ONE_MINUS_SRC_ALPHA=771,n.DST_ALPHA=772,n.ONE_MINUS_DST_ALPHA=773,n.DST_COLOR=774,n.ONE_MINUS_DST_COLOR=775,n.SRC_ALPHA_SATURATE=776,n.CONSTANT_COLOR=32769,n.ONE_MINUS_CONSTANT_COLOR=32770,n.CONSTANT_ALPHA=32771,n.ONE_MINUS_CONSTANT_ALPHA=32772,n.VERTEX_SHADER=35633,n.FRAGMENT_SHADER=35632,n.FRONT=1028,n.BACK=1029,n.FRONT_AND_BACK=1032,n.NEVER=512,n.LESS=513,n.EQUAL=514,n.LEQUAL=515,n.GREATER=516,n.NOTEQUAL=517,n.GEQUAL=518,n.ALWAYS=519,n.KEEP=7680,n.REPLACE=7681,n.INCR=7682,n.DECR=7683,n.INCR_WRAP=34055,n.DECR_WRAP=34056,n.INVERT=5386,n.STREAM_DRAW=35040,n.STATIC_DRAW=35044,n.DYNAMIC_DRAW=35048,n.ARRAY_BUFFER=34962,n.ELEMENT_ARRAY_BUFFER=34963,n.POINTS=0,n.LINES=1,n.LINE_LOOP=2,n.LINE_STRIP=3,n.TRIANGLES=4,n.TRIANGLE_STRIP=5,n.TRIANGLE_FAN=6,n.CW=2304,n.CCW=2305,n.CULL_FACE=2884,n.DEPTH_TEST=2929,n.BLEND=3042,n.temp_vec3=vec3.create(),n.temp2_vec3=vec3.create(),n.temp_vec4=vec4.create(),n.temp_quat=quat.create(),n.temp_mat3=mat3.create(),n.temp_mat4=mat4.create(),u.DEG2RAD=.0174532925,u.RAD2DEG=57.295779578552306,u.EPSILON=1e-6,u.isPowerOfTwo=n.isPowerOfTwo=function(t){return Math.log(t)/Math.log(2)%1==0},u.nearestPowerOfTwo=n.nearestPowerOfTwo=function(t){return Math.pow(2,Math.round(Math.log(t)/Math.log(2)))},u.nextPowerOfTwo=n.nextPowerOfTwo=function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)))};var d=[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array];function _(){return Array.prototype.slice.call(this)}d.forEach(function(e){e.prototype.toJSON||Object.defineProperty(e.prototype,"toJSON",{value:_,enumerable:!1,configurable:!0,writable:!0})}),typeof performance<"u"?u.getTime=performance.now.bind(performance):u.getTime=Date.now.bind(Date),n.getTime=u.getTime,u.isFunction=function(t){return!!(t&&t.constructor&&t.call&&t.apply)},u.isArray=function(t){return t&&t.constructor===Array},u.isNumber=function(t){return t!=null&&t.constructor===Number},u.getClassName=function(t){if(t){if(t.name)return t.name;if(t.toString){var r=t.toString().match(/function\s*(\w+)/);if(r&&r.length==2)return r[1]}}},u.cloneObject=n.cloneObject=function(e,t){if(e.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";t=t||{};for(var r in e){var s=e[r];if(s===null){t[r]=null;continue}switch(s.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:t[r]=new s.constructor(s);break;case Boolean:case Number:case String:t[r]=s;break;case Array:t[r]=s.concat();break;case Object:t[r]=n.cloneObject(s);break}}return t},u.regexMap=function(t,r,s){for(var a;(a=t.exec(r))!=null;)s(a)},u.createCanvas=n.createCanvas=function(t,r){var s=document.createElement("canvas");return s.width=t,s.height=r,s},u.cloneCanvas=n.cloneCanvas=function(t){var r=document.createElement("canvas");r.width=t.width,r.height=t.height;var s=r.getContext("2d");return s.drawImage(t,0,0),r},typeof Image<"u"&&(Image.prototype.getPixels=function(){var e=document.createElement("canvas");e.width=this.width,e.height=this.height;var t=e.getContext("2d");return t.drawImage(this,0,0),t.getImageData(0,0,this.width,this.height).data}),String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(e){var t=this;for(var r in e)t=t.split(r).join(e[r]);return t},enumerable:!1}),String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var e=0,t,r,s;if(this.length==0)return e;for(t=0,s=this.length;t<s;++t)r=this.charCodeAt(t),e=(e<<5)-e+r,e|=0;return e},enumerable:!1}),Array.prototype.hasOwnProperty("clone")||Object.defineProperty(Array.prototype,"clone",{value:Array.prototype.concat,enumerable:!1}),Float32Array.prototype.hasOwnProperty("clone")||Object.defineProperty(Float32Array.prototype,"clone",{value:function(){return new Float32Array(this)},enumerable:!1}),u.wipeObject=function(t){for(var r in t)t.hasOwnProperty(r)&&delete t[r]},u.extendClass=n.extendClass=function(t,r){for(var s in r)t.hasOwnProperty(s)||(t[s]=r[s]);if(r.prototype)for(var a=Object.getOwnPropertyNames(r.prototype),s=0;s<a.length;++s){var o=a[s];t.prototype.hasOwnProperty(o)||(r.prototype.__lookupGetter__(o)?t.prototype.__defineGetter__(o,r.prototype.__lookupGetter__(o)):t.prototype[o]=r.prototype[o],r.prototype.__lookupSetter__(o)&&t.prototype.__defineSetter__(o,r.prototype.__lookupSetter__(o)))}t.hasOwnProperty("superclass")||Object.defineProperty(t,"superclass",{get:function(){return r},enumerable:!1})},u.HttpRequest=n.request=function(t,r,s,a,o){var c=!0;if(o=o||{},o.async!==void 0&&(c=o.async),r){var f=null,p=[];for(var T in r)p.push(T+"="+r[T]);f=p.join("&"),t=t+"?"+f}var g=new XMLHttpRequest;if(g.open("GET",t,c),g.responseType=o.responseType||"text",g.onload=function(N){if(this.response,this.getResponseHeader("Content-Type"),this.status!=200){D.trigger(g,"fail",this.status),a&&a(this.status);return}D.trigger(g,"done",this.response),s&&s(this.response)},g.onerror=function(N){D.trigger(g,"fail",N)},o){for(var T in o)g[T]=o[T];o.binary&&(g.responseType="arraybuffer")}return g.send(),g},u.XMLHttpRequest&&(XMLHttpRequest.prototype.hasOwnProperty("done")||Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(e){return D.bind(this,"done",function(t,r){e(r)}),this}}),XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(e){return D.bind(this,"fail",function(t,r){e(r)}),this}})),u.getFileExtension=function(t){var r=t.indexOf("?");r!=-1&&(t=t.substr(0,r));var s=t.lastIndexOf(".");return s==-1?"":t.substr(s+1).toLowerCase()},u.loadFileAtlas=n.loadFileAtlas=function(t,r,s){var a=null;return HttpRequest(t,null,function(o){var c=n.processFileAtlas(o);r&&r(c),a&&a(c)},alert,s),{done:function(o){a=o}}},u.processFileAtlas=n.processFileAtlas=function(e,t){for(var r=e.split(`
`),s={},a=[],o="",c=0,f=r.length;c<f;c++){var p=t?r[c]:r[c].trim();if(p.length){if(p[0]!="\\"){a.push(p);continue}a.length&&(s[o]=a.join(`
`)),a.length=0,o=p.substr(1)}}return a.length&&(s[o]=a.join(`
`)),s},u.typedArrayToArray=function(e){var t=[];t.length=e.length;for(var r=0;r<e.length;r++)t[r]=e[r];return t},u.RGBToHex=function(e,t,r){return e=Math.min(255,e*255)|0,t=Math.min(255,t*255)|0,r=Math.min(255,r*255)|0,"#"+((1<<24)+(e<<16)+(t<<8)+r).toString(16).slice(1)},u.HUEToRGB=function(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+(t-e)*6*r:r<1/2?t:r<2/3?e+(t-e)*(2/3-r)*6:e},u.HSLToRGB=function(e,t,r,s){var a,o,c;if(s=s||vec3.create(),t==0)a=o=c=r;else{var f=r<.5?r*(1+t):r+t-r*t,p=2*r-f;a=HUEToRGB(p,f,e+1/3),o=HUEToRGB(p,f,e),c=HUEToRGB(p,f,e-1/3)}return s[0]=a,s[1]=o,s[2]=c,s},u.hexColorToRGBA=function(){var e={white:[1,1,1],black:[0,0,0],gray:[.501960813999176,.501960813999176,.501960813999176],red:[1,0,0],orange:[1,.6470588445663452,0],pink:[1,.7529411911964417,.7960784435272217],green:[0,.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[.9333333373069763,.5098039507865906,.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[.6470588445663452,.16470588743686676,.16470588743686676],silver:[.7529411911964417,.7529411911964417,.7529411911964417],gold:[1,.843137264251709,0],transparent:[0,0,0,0]};return function(t,r,s){if(s=s===void 0?1:s,r=r||new Float32Array(4),r[3]=s,typeof t!="string")return r;var a=e[t];if(a!==void 0)return r.set(a),r.length==3?r[3]=s:r[3]*=s,r;var c=t.indexOf("rgba(");if(c!=-1){var o=t.substr(5,t.length-2);return o=o.split(","),r[0]=parseInt(o[0])/255,r[1]=parseInt(o[1])/255,r[2]=parseInt(o[2])/255,r[3]=parseFloat(o[3])*s,r}var c=t.indexOf("hsla(");if(c!=-1){var o=t.substr(5,t.length-2);return o=o.split(","),HSLToRGB(parseInt(o[0])/360,parseInt(o[1])/100,parseInt(o[2])/100,r),r[3]=parseFloat(o[3])*s,r}r[3]=s;var c=t.indexOf("rgb(");if(c!=-1){var o=t.substr(4,t.length-2);return o=o.split(","),r[0]=parseInt(o[0])/255,r[1]=parseInt(o[1])/255,r[2]=parseInt(o[2])/255,r}var c=t.indexOf("hsl(");if(c!=-1){var o=t.substr(4,t.length-2);return o=o.split(","),HSLToRGB(parseInt(o[0])/360,parseInt(o[1])/100,parseInt(o[2])/100,r),r}var f=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(f,function(T,g,N,A){return g+g+N+N+A+A});var p=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return p&&(r[0]=parseInt(p[1],16)/255,r[1]=parseInt(p[2],16)/255,r[2]=parseInt(p[3],16)/255),r}}(),u.toHalfFloat=function(){var e=new Float32Array(1),t=new Int32Array(e.buffer);return function(s){e[0]=s;var a=t[0],o=a>>16&32768,c=(a&2147483647)+4096;return c>=1199570944?(a&2147483647)>=1199570944?c<2139095040?o|31744:o|31744|(a&8388607)>>13:o|31743:c>=947912704?o|c-939524096>>13:c<855638016?o:(c=(a&2147483647)>>23,o|(a&8388607|8388608)+(8388608>>>c-102)>>126-c)}}();var m=function(){var e=542327876,t=131072,r=512,s=4;function a(z){return z.charCodeAt(0)+(z.charCodeAt(1)<<8)+(z.charCodeAt(2)<<16)+(z.charCodeAt(3)<<24)}function o(z){return String.fromCharCode(z&255,z>>8&255,z>>16&255,z>>24&255)}var c=a("DXT1"),f=a("DXT3"),p=a("DXT5"),T=31,g=0,N=1,A=2,M=3,B=4,O=7,P=20,U=21,X=27;function k(z,q,ie,j){for(var se=new Uint16Array(4),le=new Uint16Array(ie*j),ue=0,he=0,ve=0,I=0,W=0,Z=0,$=0,re=0,ae=0,oe=ie/4,_e=j/4,ce=0;ce<_e;ce++)for(var fe=0;fe<oe;fe++)ve=q+4*(ce*oe+fe),se[0]=z[ve],se[1]=z[ve+1],I=se[0]&31,W=se[0]&2016,Z=se[0]&63488,$=se[1]&31,re=se[1]&2016,ae=se[1]&63488,se[2]=5*I+3*$>>3|5*W+3*re>>3&2016|5*Z+3*ae>>3&63488,se[3]=5*$+3*I>>3|5*re+3*W>>3&2016|5*ae+3*Z>>3&63488,ue=z[ve+2],he=ce*4*ie+fe*4,le[he]=se[ue&3],le[he+1]=se[ue>>2&3],le[he+2]=se[ue>>4&3],le[he+3]=se[ue>>6&3],he+=ie,le[he]=se[ue>>8&3],le[he+1]=se[ue>>10&3],le[he+2]=se[ue>>12&3],le[he+3]=se[ue>>14],ue=z[ve+3],he+=ie,le[he]=se[ue&3],le[he+1]=se[ue>>2&3],le[he+2]=se[ue>>4&3],le[he+3]=se[ue>>6&3],he+=ie,le[he]=se[ue>>8&3],le[he+1]=se[ue>>10&3],le[he+2]=se[ue>>12&3],le[he+3]=se[ue>>14];return le}function V(z){for(var q=0,ie=z.length,j=0;q<ie;q+=4)j=z[q],z[q]=z[q+2],z[q+2]=j}function J(z,q,ie,j){var se=new Int32Array(ie,0,T),le,ue,he,ve,I,W,Z,$,re,ae,oe,_e,ce;if(se[g]!=e)return console.error("Invalid magic number in DDS header"),0;if(!se[P]&s)return console.error("Unsupported format, must contain a FourCC code"),0;switch(le=se[U],le){case c:ue=8,he=q?q.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case f:ue=16,he=q?q.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case p:ue=16,he=q?q.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:ue=4,le=null,he=z.RGBA}if(oe=1,se[A]&t&&j!==!1&&(oe=Math.max(1,se[O])),ve=se[B],I=se[M],Z=se[N]+4,$=!!(se[X+1]&r),$)for(ce=0;ce<6;++ce){ve=se[B],I=se[M];for(var _e=0;_e<oe;++_e)le?(W=Math.max(4,ve)/4*Math.max(4,I)/4*ue,ae=new Uint8Array(ie,Z,W),z.compressedTexImage2D(z.TEXTURE_CUBE_MAP_POSITIVE_X+ce,_e,he,ve,I,0,ae)):(z.pixelStorei(z.UNPACK_FLIP_Y_WEBGL,!1),W=ve*I*ue,ae=new Uint8Array(ie,Z,W),V(ae),z.texImage2D(z.TEXTURE_CUBE_MAP_POSITIVE_X+ce,_e,he,ve,I,0,z.RGBA,z.UNSIGNED_BYTE,ae)),Z+=W,ve*=.5,I*=.5}else if(q){z.pixelStorei(z.UNPACK_FLIP_Y_WEBGL,!0);for(var _e=0;_e<oe;++_e)le?(W=Math.max(4,ve)/4*Math.max(4,I)/4*ue,ae=new Uint8Array(ie,Z,W),z.compressedTexImage2D(z.TEXTURE_2D,_e,he,ve,I,0,ae)):(W=ve*I*ue,ae=new Uint8Array(ie,Z,W),V(ae),z.texImage2D(z.TEXTURE_2D,_e,he,ve,I,0,he,z.UNSIGNED_BYTE,ae)),Z+=W,ve*=.5,I*=.5}else if(le==c)W=Math.max(4,ve)/4*Math.max(4,I)/4*ue,ae=new Uint16Array(ie),re=k(ae,Z/2,ve,I),z.texImage2D(z.TEXTURE_2D,0,z.RGB,ve,I,0,z.RGB,z.UNSIGNED_SHORT_5_6_5,re),j&&z.generateMipmap(z.TEXTURE_2D);else return console.error("No manual decoder for",o(le),"and no native support"),0;return oe}function te(z,q){var ie=new Int32Array(z,0,T),j,se,le,ue,he,ve,I,W,Z,$,re,ae;if(ie[g]!=e)return console.error("Invalid magic number in DDS header"),0;if(!ie[P]&s)return console.error("Unsupported format, must contain a FourCC code"),0;switch(j=ie[U],j){case c:se=8,le="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case f:se=16,le="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case p:se=16,le="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:se=4,le="RGBA"}$=1,ie[A]&t&&loadMipmaps!==!1&&($=Math.max(1,ie[O])),ue=ie[B],he=ie[M],I=ie[N]+4,W=!!(ie[X+1]&r);var oe=[];if(W)for(var ae=0;ae<6;++ae){ue=ie[B],he=ie[M];for(var re=0;re<$;++re)j?(ve=Math.max(4,ue)/4*Math.max(4,he)/4*se,Z=new Uint8Array(z,I,ve),oe.push({tex:"TEXTURE_CUBE_MAP",face:ae,mipmap:re,internalFormat:le,width:ue,height:he,offset:0,dataOffset:I,dataLength:ve})):(ve=ue*he*se,Z=new Uint8Array(z,I,ve),V(Z),oe.push({tex:"TEXTURE_CUBE_MAP",face:ae,mipmap:re,internalFormat:le,width:ue,height:he,offset:0,type:"UNSIGNED_BYTE",dataOffset:I,dataLength:ve})),I+=ve,ue*=.5,he*=.5}else for(var re=0;re<$;++re)ve=Math.max(4,ue)/4*Math.max(4,he)/4*se,Z=new Uint8Array(z,I,ve),oe.push({tex:"TEXTURE_2D",mipmap:re,internalFormat:le,width:ue,height:he,offset:0,type:"UNSIGNED_BYTE",dataOffset:I,dataLength:ve}),I+=ve,ue*=.5,he*=.5;return oe}function F(z,q,ie,j,se,le){var ue=new XMLHttpRequest;return ue.open("GET",ie,!0),ue.responseType="arraybuffer",ue.onload=function(){if(this.status==200){var he=new Int32Array(this.response,0,T),ve=!!(he[X+1]&r),I=ve?z.TEXTURE_CUBE_MAP:z.TEXTURE_2D;z.bindTexture(I,j);var W=J(z,q,this.response,se);z.texParameteri(I,z.TEXTURE_MAG_FILTER,z.LINEAR),z.texParameteri(I,z.TEXTURE_MIN_FILTER,W>1?z.LINEAR_MIPMAP_LINEAR:z.LINEAR),z.bindTexture(I,null),j.texture_type=I,j.width=he[B],j.height=he[M]}le&&le(j)},ue.send(null),j}function Q(z,q,ie,j,se){var le=new Int32Array(ie,0,T),ue=!!(le[X+1]&r),he=ue?z.TEXTURE_CUBE_MAP:z.TEXTURE_2D;j.handler,z.bindTexture(he,j.handler);var ve=J(z,q,ie,se);return z.texParameteri(he,z.TEXTURE_MAG_FILTER,z.LINEAR),z.texParameteri(he,z.TEXTURE_MIN_FILTER,ve>1?z.LINEAR_MIPMAP_LINEAR:z.LINEAR),ue&&(z.texParameteri(he,z.TEXTURE_WRAP_S,z.CLAMP_TO_EDGE),z.texParameteri(he,z.TEXTURE_WRAP_T,z.CLAMP_TO_EDGE)),z.bindTexture(he,null),j.handler&&(j.texture_type=he,j.width=le[B],j.height=le[M]),j}function ee(z){var q=new Int32Array(z,0,T),ie=!!(q[X+1]&r),j=ie?"TEXTURE_CUBE_MAP":"TEXTURE_2D",se=te(z),le={type:j,buffers:se,data:z,width:q[B],height:q[M]};return le}function K(z,le,ie,j){var se=z.createTexture(),le=z.getExtension("WEBGL_compressed_texture_s3tc");return F(z,le,ie,se,!0,j),se}return{dxtToRgb565:k,uploadDDSLevels:J,loadDDSTextureEx:F,loadDDSTexture:K,loadDDSTextureFromMemoryEx:Q,getDDSTextureFromMemoryEx:ee}}();if(typeof u<"u"&&(u.DDS=m),typeof l>"u"&&typeof exports<"u"&&typeof process!==void 0&&exports.vec3)for(var h in exports)u[h]=exports[h];Math.clamp=function(e,t,r){return t>e?t:r<e?r:e},Math.lerp=function(e,t,r){return e*(1-r)+t*r},Math.lerp01=function(e,t,r){return Math.clamp(e*(1-r)+t*r,0,1)},Math.iLerp=function(e,t,r){return(r-e)/(t-e)},Math.remap=function(e,t,r,s,a){return Math.lerp(s,a,Math.iLerp(t,r,e))},vec3.create,vec3.create,vec3.ZERO=vec3.fromValues(0,0,0),vec3.FRONT=vec3.fromValues(0,0,-1),vec3.UP=vec3.fromValues(0,1,0),vec3.RIGHT=vec3.fromValues(1,0,0),vec2.rotate=function(e,t,r){var s=t[0],a=t[1],o=Math.cos(r),c=Math.sin(r);return e[0]=s*o-a*c,e[1]=s*c+a*o,e},vec3.zero=function(e){return e[0]=e[1]=0,e},vec2.perpdot=function(e,t){return e[1]*t[0]+-e[0]*t[1]},vec2.computeSignedAngle=function(e,t){return Math.atan2(vec2.perpdot(e,t),vec2.dot(e,t))},vec2.random=function(e,t){return t=t||1,e[0]=Math.random()*t,e[1]=Math.random()*t,e},vec3.zero=function(e){return e[0]=e[1]=e[2]=0,e},vec3.minValue=function(e){return e[0]<e[1]&&e[0]<e[2]?e[0]:e[1]<e[2]?e[1]:e[2]},vec3.maxValue=function(e){return e[0]>e[1]&&e[0]>e[2]?e[0]:e[1]>e[2]?e[1]:e[2]},vec3.minValue=function(e){return e[0]<e[1]&&e[0]<e[2]?e[0]:e[1]<e[2]?e[1]:e[2]},vec3.addValue=function(e,t,r){e[0]=t[0]+r,e[1]=t[1]+r,e[2]=t[2]+r},vec3.subValue=function(e,t,r){e[0]=t[0]-r,e[1]=t[1]-r,e[2]=t[2]-r},vec3.toArray=function(e){return[e[0],e[1],e[2]]},vec3.rotateX=function(e,t,r){var s=t[1],a=t[2],o=Math.cos(r),c=Math.sin(r);return e[0]=t[0],e[1]=s*o-a*c,e[2]=s*c+a*o,e},vec3.rotateY=function(e,t,r){var s=t[0],a=t[2],o=Math.cos(r),c=Math.sin(r);return e[0]=s*o-a*c,e[1]=t[1],e[2]=s*c+a*o,e},vec3.rotateZ=function(e,t,r){var s=t[0],a=t[1],o=Math.cos(r),c=Math.sin(r);return e[0]=s*o-a*c,e[1]=s*c+a*o,e[2]=t[2],e},vec3.angle=function(e,t){return Math.acos(vec3.dot(e,t))},vec3.signedAngle=function(e,t,r){var s=vec3.angle(e,t),a=e[1]*t[2]-e[2]*t[1],o=e[2]*t[0]-e[0]*t[2],c=e[0]*t[1]-e[1]*t[0],f=Math.sign(r[0]*a+r[1]*o+r[2]*c);return s*f},vec3.random=function(e,t){return t=t||1,e[0]=Math.random()*t,e[1]=Math.random()*t,e[2]=Math.random()*t,e},vec3.cartesianToPolar=function(e,t){e=e||vec3.create();var r=t[0],s=t[1],a=t[2];return e[0]=Math.sqrt(r*r+s*s+a*a),e[1]=Math.asin(s/e[0]),e[2]=Math.atan2(r,a),e},vec3.polarToCartesian=function(e,t){var r=t[0],s=t[1],a=t[2];return e[0]=r*Math.cos(s)*Math.sin(a),e[1]=r*Math.sin(s),e[2]=r*Math.cos(s)*Math.cos(a),e},vec3.reflect=function(e,t,r){var s=t[0],a=t[1],o=t[2];return vec3.scale(e,r,-2*vec3.dot(t,r)),e[0]+=s,e[1]+=a,e[2]+=o,e},vec4.random=function(e,t){return t=t||1,e[0]=Math.random()*t,e[1]=Math.random()*t,e[2]=Math.random()*t,e[3]=Math.random()*t,e},vec4.toArray=function(e){return[e[0],e[1],e[2],e[3]]},mat3.IDENTITY=mat3.create(),mat4.IDENTITY=mat4.create(),mat4.toArray=function(e){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]},mat4.setUpAndOrthonormalize=function(e,t,r){t!=e&&mat4.copy(e,t);var s=e.subarray(0,3);vec3.normalize(e.subarray(4,7),r);var a=e.subarray(8,11);vec3.cross(s,r,a),vec3.normalize(s,s),vec3.cross(a,s,r),vec3.normalize(a,a)},mat4.multiplyVec3=function(e,t,r){var s=r[0],a=r[1],o=r[2];return e[0]=t[0]*s+t[4]*a+t[8]*o+t[12],e[1]=t[1]*s+t[5]*a+t[9]*o+t[13],e[2]=t[2]*s+t[6]*a+t[10]*o+t[14],e},mat4.projectVec3=function(e,t,r){var s=r[0],a=r[1],o=r[2],c=t[0]*s+t[4]*a+t[8]*o+t[12],f=t[1]*s+t[5]*a+t[9]*o+t[13],p=t[2]*s+t[6]*a+t[10]*o+t[14],T=t[3]*s+t[7]*a+t[11]*o+t[15];return e[0]=(c/T+1)/2,e[1]=(f/T+1)/2,e[2]=(p/T+1)/2,e},vec3.project=function(e,t,r,s){s=s||gl.viewport_data;var a=r,o=t[0],c=t[1],f=t[2],p=a[0]*o+a[4]*c+a[8]*f+a[12],T=a[1]*o+a[5]*c+a[9]*f+a[13],g=a[2]*o+a[6]*c+a[10]*f+a[14],N=a[3]*o+a[7]*c+a[11]*f+a[15],A=(p/N+1)/2,M=1-(T/N+1)/2,B=(g/N+1)/2;return e[0]=A*s[2]+s[0],e[1]=M*s[3]+s[1],e[2]=B,e};var E=mat4.create(),L=vec4.create();vec3.unproject=function(e,t,r,s){var a=E,o=L;return o[0]=(t[0]-s[0])*2/s[2]-1,o[1]=(t[1]-s[1])*2/s[3]-1,o[2]=2*t[2]-1,o[3]=1,!mat4.invert(a,r)||(vec4.transformMat4(o,o,a),o[3]===0)?null:(e[0]=o[0]/o[3],e[1]=o[1]/o[3],e[2]=o[2]/o[3],e)},mat4.rotateVec3=function(e,t,r){var s=r[0],a=r[1],o=r[2];return e[0]=t[0]*s+t[4]*a+t[8]*o,e[1]=t[1]*s+t[5]*a+t[9]*o,e[2]=t[2]*s+t[6]*a+t[10]*o,e},mat4.fromTranslationFrontTop=function(e,t,r,s){return vec3.cross(e.subarray(0,3),r,s),e.set(s,4),e.set(r,8),e.set(t,12),e},mat4.translationMatrix=function(e){var t=mat4.create();return t[12]=e[0],t[13]=e[1],t[14]=e[2],t},mat4.setTranslation=function(e,t){return e[12]=t[0],e[13]=t[1],e[14]=t[2],e},mat4.getTranslation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},mat4.toRotationMat4=function(e,t){return mat4.copy(e,t),e[12]=e[13]=e[14]=0,e},mat4.swapRows=function(e,t,r,s){if(e!=t)return mat4.copy(e,t),e[4*r]=t[4*s],e[4*r+1]=t[4*s+1],e[4*r+2]=t[4*s+2],e[4*r+3]=t[4*s+3],e[4*s]=t[4*r],e[4*s+1]=t[4*r+1],e[4*s+2]=t[4*r+2],e[4*s+3]=t[4*r+3],e;var a=new Float32Array(matrix.subarray(r*4,r*5));return matrix.set(matrix.subarray(s*4,s*5),r*4),matrix.set(a,s*4),e},mat4.scaleAndAdd=function(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e[3]=t[3]+r[3]*s,e[4]=t[4]+r[4]*s,e[5]=t[5]+r[5]*s,e[6]=t[6]+r[6]*s,e[7]=t[7]+r[7]*s,e[8]=t[8]+r[8]*s,e[9]=t[9]+r[9]*s,e[10]=t[10]+r[10]*s,e[11]=t[11]+r[11]*s,e[12]=t[12]+r[12]*s,e[13]=t[13]+r[13]*s,e[14]=t[14]+r[14]*s,e[15]=t[15]+r[15]*s,e},quat.fromAxisAngle=function(e,t){var r=quat.create();t=t*.5;var s=Math.sin(t);return r[0]=s*e[0],r[1]=s*e[1],r[2]=s*e[2],r[3]=Math.cos(t),r},quat.lookRotation=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s,a,o){vec3.normalize(e,a),vec3.cross(t,o,e),vec3.normalize(t,t),vec3.cross(r,e,t);var c=t[0],f=t[1],p=t[2],T=r[0],g=r[1],N=r[2],A=e[0],M=e[1],B=e[2],O=c+g+B;if(O>0){var P=Math.sqrt(O+1);return s[3]=P*.5,P=.5/P,s[0]=(N-M)*P,s[1]=(A-p)*P,s[2]=(f-T)*P,s}if(c>=g&&c>=B){var U=Math.sqrt(1+c-g-B),X=.5/U;return s[0]=.5*U,s[1]=(f+T)*X,s[2]=(p+A)*X,s[3]=(N-M)*X,s}if(g>B){var k=Math.sqrt(1+g-c-B),V=.5/k;return s[0]=(T+f)*V,s[1]=.5*k,s[2]=(M+N)*V,s[3]=(A-p)*V,s}var J=Math.sqrt(1+B-c-g),te=.5/J;return s[0]=(A+p)*te,s[1]=(M+N)*te,s[2]=.5*J,s[3]=(f-T)*te,s}}(),quat.toEuler=function(e,t){var r=Math.atan2(2*t[1]*t[3]-2*t[0]*t[2],1-2*t[1]*t[1]-2*t[2]*t[2]),s=Math.asin(2*t[0]*t[1]+2*t[2]*t[3]),a=Math.atan2(2*t[0]*t[3]-2*t[1]*t[2],1-2*t[0]*t[0]-2*t[2]*t[2]);return e||(e=vec3.create()),vec3.set(e,r,s,a),e},quat.fromEuler=function(e,t){var r=t[0],s=t[1],a=t[2],o=Math.cos(r),c=Math.cos(s),f=Math.cos(a),p=Math.sin(r),T=Math.sin(s),g=Math.sin(a),N=Math.sqrt(1+o*c+o*f-p*T*g+c*f)*.5;N==0&&(N=1e-6);var A=(c*g+o*g+p*T*f)/(4*N),M=(p*c+p*f+o*T*g)/(4*N),B=(-p*g+o*T*f+T)/(4*N);return quat.set(e,A,M,B,N),quat.normalize(e,e),e},quat.fromMat4=function(e,t){var r=t[0]+t[5]+t[10];if(r>0){var s=Math.sqrt(r+1);e[3]=s*.5;var a=.5/s;e[0]=(t[9]-t[6])*a,e[1]=(t[8]-t[2])*a,e[2]=(t[4]-t[1])*a}else{var o=0;t[5]>t[0]&&(o=1),t[10]>t[o*4+o]&&(o=2);var c=(o+1)%3,f=(c+1)%3,s=Math.sqrt(t[o*4+o]-t[c*4+c]-t[f*4+f]+1);e[o]=.5*s;var a=.5/s;e[3]=(t[f*4+c]-t[c*4+f])*a,e[c]=(t[c*4+o]+t[o*4+c])*a,e[f]=(t[f*4+o]+t[o*4+f])*a}quat.normalize(e,e)},vec3.getMat3Column=function(e,t,r){return e[0]=t[r*3],e[1]=t[r*3+1],e[2]=t[r*3+2],e},mat3.setColumn=function(e,t,r){return e[r*3]=t[0],e[r*3+1]=t[1],e[r*3+2]=t[2],e},quat.fromMat3AndQuat=function(){var e=mat3.create(),t=quat.create(),r=vec3.create(),s=vec3.create(),a=vec3.create(),o=vec3.create(),c=vec3.create(),f=vec3.create(),p=vec3.create(),T=vec3.create(),g=vec3.create(),N=vec3.create();return mat3.create(),function(A,M,B){B=B||25;for(var O=0;O<B;++O){var P=mat3.fromQuat(e,A);vec3.getMat3Column(r,P,0),vec3.getMat3Column(s,P,1),vec3.getMat3Column(a,P,2),vec3.getMat3Column(o,M,0),vec3.getMat3Column(c,M,1),vec3.getMat3Column(f,M,2),vec3.cross(p,r,o),vec3.cross(T,s,c),vec3.cross(g,a,f),vec3.add(N,p,T),vec3.add(N,N,g);var U=1/Math.abs(vec3.dot(r,o)+vec3.dot(s,c)+vec3.dot(a,f))+1e-9;vec3.scale(N,N,U);var X=vec3.length(N);if(X<1e-9)break;vec3.scale(N,N,1/X),quat.setAxisAngle(t,N,X),quat.mul(A,t,A),quat.normalize(A,A)}return A}}(),quat.rotateToFrom=function(){var e=vec3.create();return function(t,r,s){t=t||quat.create();var a=vec3.cross(e,r,s),o=vec3.dot(r,s);return o<-1+.01?(t[0]=0,t[1]=1,t[2]=0,t[3]=0,t):(t[0]=a[0]*.5,t[1]=a[1]*.5,t[2]=a[2]*.5,t[3]=(1+o)*.5,quat.normalize(t,t),t)}}(),quat.lookAt=function(){var e=vec3.create();return function(t,r,s){var a=vec3.dot(vec3.FRONT,r);if(Math.abs(a- -1)<1e-6)return t.set(vec3.UP),t[3]=Math.PI,t;if(Math.abs(a-1)<1e-6)return quat.identity(t);var o=Math.acos(a);return vec3.cross(e,vec3.FRONT,r),vec3.normalize(e,e),quat.setAxisAngle(t,e,o),t}}(),n.Indexer=function(){this.unique=[],this.indices=[],this.map={}},n.Indexer.prototype={add:function(e){var t=JSON.stringify(e);return t in this.map||(this.map[t]=this.unique.length,this.unique.push(e)),this.map[t]}},n.Buffer=function(t,r,s,a,o){n.debug&&console.log("GL.Buffer created"),o!==null&&(o=o||u.gl),this.gl=o,this.buffer=null,this.target=t,this.attribute=null,this.normalize=!1,this.data=r,this.spacing=s||3,this.data&&this.gl&&this.upload(a)},n.Buffer.prototype.bind=function(e,t){t=t||this.gl,t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,this.spacing,this.buffer.gl_type,this.normalize||!1,0,0)},n.Buffer.prototype.unbind=function(e,t){t=t||this.gl,t.disableVertexAttribArray(e)},n.Buffer.prototype.forEach=function(e){for(var t=this.data,r=0,s=this.spacing,a=t.length;r<a;r+=s)e(t.subarray(r,r+s),r);return this},n.Buffer.prototype.applyTransform=function(e){for(var t=this.data,r=0,s=this.spacing,a=t.length;r<a;r+=s){var o=t.subarray(r,r+s);vec3.transformMat4(o,o,e)}return this},n.Buffer.prototype.upload=function(e){var t=this.spacing||3,r=this.gl;if(r){if(!this.data)throw"No data supplied";var s=this.data;if(!s.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||r.createBuffer(),!!this.buffer){switch(this.buffer.length=s.length,this.buffer.spacing=t,s.constructor){case Int8Array:this.buffer.gl_type=r.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=r.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=r.SHORT;break;case Uint16Array:this.buffer.gl_type=r.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=r.INT;break;case Uint32Array:this.buffer.gl_type=r.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=r.FLOAT;break;default:throw"unsupported buffer type"}this.target==r.ARRAY_BUFFER&&(this.buffer.gl_type==r.INT||this.buffer.gl_type==r.UNSIGNED_INT)&&(console.warn("WebGL does not support UINT32 or INT32 as vertex buffer types, converting to FLOAT"),this.buffer.gl_type=r.FLOAT,s=new Float32Array(s)),r.bindBuffer(this.target,this.buffer),r.bufferData(this.target,s,e||this.stream_type||r.STATIC_DRAW)}}},n.Buffer.prototype.compile=n.Buffer.prototype.upload,n.Buffer.prototype.setData=function(e,t){if(!e.buffer)throw"Data must be typed array";if(t=t||0,this.data){if(this.data.length<e.length)throw"buffer is not big enough, you cannot set data to a smaller buffer"}else{this.data=e,this.upload();return}if(this.data!=e){if(this.data.length==e.length){this.data.set(e),this.upload();return}var r=new Uint8Array(e.buffer,e.buffer.byteOffset,e.buffer.byteLength),s=new Uint8Array(this.data.buffer);s.set(r,t),this.uploadRange(t,r.length)}},n.Buffer.prototype.uploadRange=function(e,t){if(!this.data)throw"No data stored in this buffer";var r=this.data;if(!r.buffer)throw"Buffers must be typed arrays";var s=new Uint8Array(this.data.buffer,e,t),a=this.gl;a.bindBuffer(this.target,this.buffer),a.bufferSubData(this.target,e,s)},n.Buffer.prototype.clone=function(e){var t=new n.Buffer;if(e)for(var r in this)t[r]=this[r];else this.target&&(t.target=this.target),this.gl&&(t.gl=this.gl),this.spacing&&(t.spacing=this.spacing),this.data&&(t.data=new u[this.data.constructor](this.data),t.upload());return t},n.Buffer.prototype.toJSON=function(){return this.data?{data_type:getClassName(this.data),data:this.data.toJSON(),target:this.target,attribute:this.attribute,spacing:this.spacing}:(console.error("cannot serialize a mesh without data"),null)},n.Buffer.prototype.fromJSON=function(e){var t=u[e.data_type]||Float32Array;this.data=new t(e.data),this.target=e.target,this.spacing=e.spacing||3,this.attribute=e.attribute,this.upload(n.STATIC_DRAW)},n.Buffer.prototype.delete=function(){var e=this.gl;e.deleteBuffer(this.buffer),this.buffer=null},u.Mesh=n.Mesh=function(t,r,s,a){if(n.debug&&console.log("GL.Mesh created"),a!==null&&(a=a||u.gl,this.gl=a),this._context_id=a.context_id,this.vertexBuffers={},this.indexBuffers={},this.info={groups:[]},this._bounding=BBox.create(),(t||r)&&this.addBuffers(t,r,s?s.stream_type:null),s)for(var o in s)this[o]=s[o]},Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal",normalize:!0},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color",normalize:!0},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights",normalize:!0},extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}},Mesh.default_datatype=Float32Array,Object.defineProperty(Mesh.prototype,"bounding",{set:function(e){if(e){if(e.length<13)throw"Bounding must use the BBox bounding format of 13 floats: center, halfsize, min, max, radius";this._bounding.set(e)}},get:function(){return this._bounding}}),Mesh.prototype.addBuffer=function(e,t){if(t.target==gl.ARRAY_BUFFER?this.vertexBuffers[e]=t:this.indexBuffers[e]=t,!t.attribute){var r=n.Mesh.common_buffers[e];r&&(t.attribute=r.attribute)}},Mesh.prototype.addBuffers=function(e,t,r){var s=0;this.vertexBuffers.vertices&&(s=this.vertexBuffers.vertices.data.length/3);for(var a in e){var o=e[a];if(o){if(o.constructor==n.Buffer||o.data)o=o.data;else if(typeof o[0]!="number"){for(var c=[],f=0,p=1e4;f<o.length;f+=p)c=Array.prototype.concat.apply(c,o.slice(f,f+p));o=c}var T=n.Mesh.common_buffers[a];if(o.constructor===Array){var g=n.Mesh.default_datatype;T&&T.type&&(g=T.type),o=new g(o)}a=="vertices"&&(s=o.length/3);var N=o.length/s;T&&T.spacing&&(N=T.spacing);var A="a_"+a;T&&T.attribute&&(A=T.attribute),this.vertexBuffers[a]?this.updateVertexBuffer(a,A,N,o,r):this.createVertexBuffer(a,A,N,o,r)}}if(t)for(var a in t){var o=t[a];if(o){if((o.constructor==n.Buffer||o.data)&&(o=o.data),typeof o[0]!="number"){c=[];for(var a=0,p=1e4;a<o.length;a+=p)c=Array.prototype.concat.apply(c,o.slice(a,a+p));o=c}if(o.constructor===Array){var g=Uint16Array;s>256*256&&(g=Uint32Array),o=new g(o)}this.createIndexBuffer(a,o)}}},Mesh.prototype.createVertexBuffer=function(e,t,r,s,a){var o=n.Mesh.common_buffers[e];if(!t&&o&&(t=o.attribute),!t)throw"Buffer added to mesh without attribute name";if(!r&&o&&(o&&o.spacing?r=o.spacing:r=3),!s){var c=this.getNumVertices();if(!c)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";s=new n.Mesh.default_datatype(c*r)}if(!s.buffer)throw"Buffer data MUST be typed array";var f=this.vertexBuffers[e]=new n.Buffer(gl.ARRAY_BUFFER,s,r,a,this.gl);return f.name=e,f.attribute=t,(s.constructor==Uint8Array||s.constructor==Int8Array||s.constructor==Uint16Array||s.constructor==Int16Array||s.constructor==Uint32Array||s.constructor==Int32Array)&&o&&o.normalize&&(f.normalize=!0),f},Mesh.prototype.updateVertexBuffer=function(e,t,r,s,a){var o=this.vertexBuffers[e];if(!o){console.log("buffer not found: ",e);return}s.length&&(o.attribute=t,o.spacing=r,o.data=s,o.upload(a))},Mesh.prototype.removeVertexBuffer=function(e,t){var r=this.vertexBuffers[e];r&&(t&&r.delete(),delete this.vertexBuffers[e])},Mesh.prototype.getVertexBuffer=function(e){return this.vertexBuffers[e]},Mesh.prototype.createIndexBuffer=function(e,t,r){if(t.constructor===Array){var s=Uint16Array,a=this.vertexBuffers.vertices;if(a){var o=a.data.length/3;o>256*256&&(s=Uint32Array),t=new s(t)}}var c=this.indexBuffers[e]=new n.Buffer(gl.ELEMENT_ARRAY_BUFFER,t,0,r,this.gl);return c},Mesh.prototype.getBuffer=function(e){return this.vertexBuffers[e]},Mesh.prototype.getIndexBuffer=function(e){return this.indexBuffers[e]},Mesh.prototype.removeIndexBuffer=function(e,t){var r=this.indexBuffers[e];r&&(t&&r.delete(),delete this.indexBuffers[e])},Mesh.prototype.upload=function(e){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t];r.upload(e)}for(var s in this.indexBuffers){var r=this.indexBuffers[s];r.upload()}},Mesh.prototype.compile=Mesh.prototype.upload,Mesh.prototype.deleteBuffers=function(){for(var e in this.vertexBuffers){var t=this.vertexBuffers[e];t.delete()}this.vertexBuffers={};for(var e in this.indexBuffers){var t=this.indexBuffers[e];t.delete()}this.indexBuffers={}},Mesh.prototype.delete=Mesh.prototype.deleteBuffers,Mesh.prototype.bindBuffers=function(e){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t],s=r.attribute||t,a=e.attributes[s];a==null||!r.buffer||(gl.bindBuffer(gl.ARRAY_BUFFER,r.buffer),gl.enableVertexAttribArray(a),gl.vertexAttribPointer(a,r.buffer.spacing,r.buffer.gl_type,r.normalize||!1,0,0))}},Mesh.prototype.unbindBuffers=function(e){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t],s=r.attribute||t,a=e.attributes[s];a==null||!r.buffer||gl.disableVertexAttribArray(e.attributes[s])}},Mesh.prototype.clone=function(t){var t=t||u.gl,r={},s={};for(var a in this.vertexBuffers){var o=this.vertexBuffers[a];r[a]=new o.data.constructor(o.data)}for(var a in this.indexBuffers){var o=this.indexBuffers[a];s[a]=new o.data.constructor(o.data)}return new n.Mesh(r,s,void 0,t)},Mesh.prototype.cloneShared=function(t){var t=t||u.gl;return new n.Mesh(this.vertexBuffers,this.indexBuffers,void 0,t)},Mesh.prototype.toObject=function(){var e={},t={};for(var r in this.vertexBuffers){var s=this.vertexBuffers[r];e[r]={spacing:s.spacing,data:new s.data.constructor(s.data)}}for(var r in this.indexBuffers){var s=this.indexBuffers[r];t[r]={data:new s.data.constructor(s.data)}}return{vertexBuffers:e,indexBuffers:t,info:this.info?cloneObject(this.info):null,bounding:this._bounding.toJSON()}},Mesh.prototype.toJSON=function(){var e={vertexBuffers:{},indexBuffers:{},info:this.info?cloneObject(this.info):null,bounding:this._bounding.toJSON()};for(var t in this.vertexBuffers)e.vertexBuffers[t]=this.vertexBuffers[t].toJSON();for(var t in this.indexBuffers)e.indexBuffers[t]=this.indexBuffers[t].toJSON();return e},Mesh.prototype.fromJSON=function(e){this.vertexBuffers={},this.indexBuffers={};for(var t in e.vertexBuffers)if(e.vertexBuffers[t]){var r=new n.Buffer;r.fromJSON(e.vertexBuffers[t]),!r.attribute&&n.Mesh.common_buffers[t]&&(r.attribute=n.Mesh.common_buffers[t].attribute),this.vertexBuffers[t]=r}for(var t in e.indexBuffers)if(e.indexBuffers[t]){var r=new n.Buffer;r.fromJSON(e.indexBuffers[t]),this.indexBuffers[t]=r}e.info&&(this.info=cloneObject(e.info)),e.bounding&&(this.bounding=e.bounding)},Mesh.prototype.generateMetadata=function(){var e={},t=this.vertexBuffers.vertices.data,r=this.indexBuffers.triangles.data;e.vertices=t.length/3,r?e.faces=r.length/3:e.faces=t.length/9,e.indexed=!!this.metadata.faces,this.metadata=e},Mesh.prototype.computeWireframe=function(){var e=this.indexBuffers.triangles,t=this.vertexBuffers.vertices.data,r=t.length/3;if(e){for(var c=e.data,f=new n.Indexer,o=0;o<c.length;o+=3)for(var p=c.subarray(o,o+3),T=0;T<p.length;T++){var g=p[T],N=p[(T+1)%p.length];f.add([Math.min(g,N),Math.max(g,N)])}for(var A=f.unique,a=r>256*256?new Uint32Array(A.length*2):new Uint16Array(A.length*2),o=0,M=A.length;o<M;++o)a.set(A[o],o*2)}else for(var s=r/3,a=r>256*256?new Uint32Array(s*6):new Uint16Array(s*6),o=0;o<r;o+=3)a[o*2]=o,a[o*2+1]=o+1,a[o*2+2]=o+1,a[o*2+3]=o+2,a[o*2+4]=o+2,a[o*2+5]=o;return this.createIndexBuffer("wireframe",a),this},Mesh.prototype.flipNormals=function(e){var t=this.vertexBuffers.normals;if(t){for(var a=t.data,o=a.length,r=0;r<o;++r)a[r]*=-1;t.upload(e),this.indexBuffers.triangles||this.computeIndices();for(var s=this.indexBuffers.triangles,a=s.data,o=a.length,r=0;r<o;r+=3){var c=a[r];a[r]=a[r+1],a[r+1]=c}s.upload(e)}},Mesh.prototype.computeIndices=function(){var e=[],t=[],r=[],s=[],a=this.vertexBuffers.vertices,o=this.vertexBuffers.normals,c=this.vertexBuffers.coords,f=a.data,p=null;o&&(p=o.data);var T=null;c&&(T=c.data);for(var g={},N=f.length/3,A=0;A<N;++A){var M=f.subarray(A*3,(A+1)*3),B=M[0]*1e3|0,O=0,P=g[B];if(P)for(var U=P.length;O<U;O++){var X=e[P[O]];if(vec3.sqrDist(M,X)<.01){s.push(O);break}}if(!(P&&O!=U)){var k=O;e.push(M),g[B]?g[B].push(k):g[B]=[k],p&&t.push(p.subarray(A*3,(A+1)*3)),T&&r.push(T.subarray(A*2,(A+1)*2)),s.push(k)}}this.vertexBuffers={},this.createVertexBuffer("vertices",n.Mesh.common_buffers.vertices.attribute,3,b(e)),p&&this.createVertexBuffer("normals",n.Mesh.common_buffers.normals.attribute,3,b(t)),T&&this.createVertexBuffer("coords",n.Mesh.common_buffers.coords.attribute,2,b(r)),this.createIndexBuffer("triangles",s)},Mesh.prototype.explodeIndices=function(e){e=e||"triangles";var t=this.getIndexBuffer(e);if(t){var r=t.data,s={};for(var a in this.vertexBuffers){var o=n.Mesh.common_buffers[a];s[a]=new(o.type||Float32Array)(o.spacing*r.length)}for(var a=0,c=r.length;a<c;++a){var f=r[a];for(var p in this.vertexBuffers){var T=this.vertexBuffers[p],o=n.Mesh.common_buffers[p],g=T.spacing||o.spacing,N=s[p];N.set(T.data.subarray(f*g,f*g+g),a*g)}}for(var a in s){var A=this.vertexBuffers[a];this.createVertexBuffer(a,A.attribute,A.spacing,s[a])}delete this.indexBuffers[e]}},Mesh.prototype.computeNormals=function(e){var t=this.vertexBuffers.vertices;if(!t)return console.error("Cannot compute normals of a mesh without vertices");var r=this.vertexBuffers.vertices.data;r.length/3;var s=new Float32Array(r.length),a=null;this.indexBuffers.triangles&&(a=this.indexBuffers.triangles.data);for(var o=n.temp_vec3,c=n.temp2_vec3,f,p,T,g,N,A,M,B,O,P=a?a.length:r.length,U=0;U<P;U+=3)a?(f=a[U],p=a[U+1],T=a[U+2],g=r.subarray(f*3,f*3+3),N=r.subarray(p*3,p*3+3),A=r.subarray(T*3,T*3+3),M=s.subarray(f*3,f*3+3),B=s.subarray(p*3,p*3+3),O=s.subarray(T*3,T*3+3)):(g=r.subarray(U*3,U*3+3),N=r.subarray(U*3+3,U*3+6),A=r.subarray(U*3+6,U*3+9),M=s.subarray(U*3,U*3+3),B=s.subarray(U*3+3,U*3+6),O=s.subarray(U*3+6,U*3+9)),vec3.sub(o,N,g),vec3.sub(c,A,g),vec3.cross(o,o,c),vec3.normalize(o,o),vec3.add(M,M,o),vec3.add(B,B,o),vec3.add(O,O,o);if(a)for(var U=0,P=s.length;U<P;U+=3){var X=s.subarray(U,U+3);vec3.normalize(X,X)}var k=this.vertexBuffers.normals;if(k)k.data=s,k.upload(e);else return this.createVertexBuffer("normals",n.Mesh.common_buffers.normals.attribute,3,s);return k},Mesh.prototype.computeTangents=function(){var e=this.vertexBuffers.vertices;if(!e)return console.error("Cannot compute tangents of a mesh without vertices");var t=this.vertexBuffers.normals;if(!t)return console.error("Cannot compute tangents of a mesh without normals");var r=this.vertexBuffers.coords;if(!r)return console.error("Cannot compute tangents of a mesh without uvs");var s=this.indexBuffers.triangles;if(!s)return console.error("Cannot compute tangents of a mesh without indices");var a=e.data,o=t.data,c=r.data,f=s.data;if(!(!a||!o||!c)){var p=a.length/3,T=new Float32Array(p*4),g=new Float32Array(p*3*2),N=g.subarray(p*3),A,M,B=vec3.create(),O=vec3.create(),P=vec3.create(),U=vec3.create();for(A=0,M=f.length;A<M;A+=3){var X=f[A],k=f[A+1],V=f[A+2],J=a.subarray(X*3,X*3+3),te=a.subarray(k*3,k*3+3),F=a.subarray(V*3,V*3+3),Q=c.subarray(X*2,X*2+2),ee=c.subarray(k*2,k*2+2),K=c.subarray(V*2,V*2+2),z=te[0]-J[0],q=F[0]-J[0],ie=te[1]-J[1],j=F[1]-J[1],se=te[2]-J[2],le=F[2]-J[2],ue=ee[0]-Q[0],he=K[0]-Q[0],ve=ee[1]-Q[1],I=K[1]-Q[1],W,Z=ue*I-he*ve;Math.abs(Z)<1e-9?W=0:W=1/Z,vec3.copy(B,[(I*z-ve*q)*W,(I*ie-ve*j)*W,(I*se-ve*le)*W]),vec3.copy(O,[(ue*q-he*z)*W,(ue*j-he*ie)*W,(ue*le-he*se)*W]),vec3.add(g.subarray(X*3,X*3+3),g.subarray(X*3,X*3+3),B),vec3.add(g.subarray(k*3,k*3+3),g.subarray(k*3,k*3+3),B),vec3.add(g.subarray(V*3,V*3+3),g.subarray(V*3,V*3+3),B),vec3.add(N.subarray(X*3,X*3+3),N.subarray(X*3,X*3+3),O),vec3.add(N.subarray(k*3,k*3+3),N.subarray(k*3,k*3+3),O),vec3.add(N.subarray(V*3,V*3+3),N.subarray(V*3,V*3+3),O)}for(A=0,M=a.length;A<M;A+=3){var $=o.subarray(A,A+3),re=g.subarray(A,A+3);vec3.subtract(P,re,vec3.scale(P,$,vec3.dot($,re))),vec3.normalize(P,P);var ae=vec3.dot(vec3.cross(U,$,re),N.subarray(A,A+3))<0?-1:1;T.set([P[0],P[1],P[2],ae],A/3*4)}this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,T)}},Mesh.prototype.computeTextureCoordinates=function(e){var t=this.vertexBuffers.vertices;if(!t)return console.error("Cannot compute uvs of a mesh without vertices");this.explodeIndices("triangles");var r=t.data,s=r.length/3,a=this.vertexBuffers.coords,o=new Float32Array(s*2),c=this.indexBuffers.triangles,f=null;c&&(f=c.data);var p=vec3.create(),T=vec3.create(),g=vec3.create(),N=this.getBoundingBox(),A=BBox.getCenter(N),M=vec3.create();M.set(BBox.getHalfsize(N)),vec3.scale(M,M,2);for(var B=f?f.length:r.length/3,O=0;O<B;O+=3){if(f)var P=f[O],U=f[O+1],X=f[O+2],k=r.subarray(P*3,P*3+3),V=r.subarray(U*3,U*3+3),J=r.subarray(X*3,X*3+3),te=o.subarray(P*2,P*2+2),F=o.subarray(U*2,U*2+2),Q=o.subarray(X*2,X*2+2);else var k=r.subarray(O*3,O*3+3),V=r.subarray((O+1)*3,(O+1)*3+3),J=r.subarray((O+2)*3,(O+2)*3+3),te=o.subarray(O*2,O*2+2),F=o.subarray((O+1)*2,(O+1)*2+2),Q=o.subarray((O+2)*2,(O+2)*2+2);vec3.sub(T,k,V),vec3.sub(g,k,J),vec3.cross(p,T,g),p[0]=Math.abs(p[0]),p[1]=Math.abs(p[1]),p[2]=Math.abs(p[2]),p[0]>p[1]&&p[0]>p[2]?(te[0]=(k[2]-A[2])/M[2],te[1]=(k[1]-A[1])/M[1],F[0]=(V[2]-A[2])/M[2],F[1]=(V[1]-A[1])/M[1],Q[0]=(J[2]-A[2])/M[2],Q[1]=(J[1]-A[1])/M[1]):p[1]>p[2]?(te[0]=(k[0]-A[0])/M[0],te[1]=(k[2]-A[2])/M[2],F[0]=(V[0]-A[0])/M[0],F[1]=(V[2]-A[2])/M[2],Q[0]=(J[0]-A[0])/M[0],Q[1]=(J[2]-A[2])/M[2]):(te[0]=(k[0]-A[0])/M[0],te[1]=(k[1]-A[1])/M[1],F[0]=(V[0]-A[0])/M[0],F[1]=(V[1]-A[1])/M[1],Q[0]=(J[0]-A[0])/M[0],Q[1]=(J[1]-A[1])/M[1])}a?(a.data=o,a.upload(e)):this.createVertexBuffer("coords",Mesh.common_buffers.coords.attribute,2,o)},Mesh.prototype.getNumVertices=function(){var e=this.vertexBuffers.vertices;return e?e.data.length/e.spacing:0},Mesh.prototype.getNumTriangles=function(){var e=this.getIndexBuffer("triangles");return e?e.data.length/3:this.getNumVertices()/3},Mesh.computeBoundingBox=function(e,t,r){if(e){var s=0;if(r){for(var a=0;a<r.length;++a)if(r[a]){s=a;break}if(s==r.length){console.warn("mask contains only zeros, no vertices marked");return}}for(var o=vec3.clone(e.subarray(s*3,s*3+3)),c=vec3.clone(e.subarray(s*3,s*3+3)),f,a=s*3;a<e.length;a+=3)r&&!r[a/3]||(f=e.subarray(a,a+3),vec3.min(o,f,o),vec3.max(c,f,c));(isNaN(o[0])||isNaN(o[1])||isNaN(o[2])||isNaN(c[0])||isNaN(c[1])||isNaN(c[2]))&&(o[0]=o[1]=o[2]=0,c[0]=c[1]=c[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices"));var p=vec3.add(vec3.create(),o,c);vec3.scale(p,p,.5);var T=vec3.subtract(vec3.create(),c,p);return BBox.setCenterHalfsize(t||BBox.create(),p,T)}},Mesh.prototype.getBoundingBox=function(){return this._bounding?this._bounding:(this.updateBoundingBox(),this._bounding)},Mesh.prototype.updateBoundingBox=function(){var e=this.vertexBuffers.vertices;e&&(n.Mesh.computeBoundingBox(e.data,this._bounding),this.info&&this.info.groups&&this.info.groups.length&&this.computeGroupsBoundingBoxes())},Mesh.prototype.computeGroupsBoundingBoxes=function(){var e=null,t=this.getIndexBuffer("triangles");t&&(e=t.data);var r=this.getVertexBuffer("vertices");if(!r)return!1;var s=r.data;if(!s.length)return!1;var a=this.info.groups;if(a){for(var o=0;o<a.length;++o){var c=a[o];c.bounding=c.bounding||BBox.create();var f=null;if(e){for(var p=new Uint8Array(s.length/3),T=c.start,g=0,N=c.length;g<N;g+=3)p[e[T+g]]=1,p[e[T+g+1]]=1,p[e[T+g+2]]=1;n.Mesh.computeBoundingBox(s,c.bounding,p)}else f=s.subarray(c.start*3,(c.start+c.length)*3),n.Mesh.computeBoundingBox(f,c.bounding)}return!0}},Mesh.prototype.setBoundingBox=function(e,t){BBox.setCenterHalfsize(this._bounding,e,t)},Mesh.prototype.freeData=function(){for(var e in this.vertexBuffers)this.vertexBuffers[e].data=null,delete this[this.vertexBuffers[e].name];for(var t in this.indexBuffers)this.indexBuffers[t].data=null,delete this[this.indexBuffers[t].name]},Mesh.prototype.configure=function(e,t){var r={},s={};t=t||{};for(var a in e)if(e[a]){if(a=="vertexBuffers"||a=="vertex_buffers"){for(o in e[a])r[o]=e[a][o];continue}if(a=="indexBuffers"||a=="index_buffers"){for(o in e[a])s[o]=e[a][o];continue}a=="indices"||a=="lines"||a=="wireframe"||a=="triangles"?s[a]=e[a]:n.Mesh.common_buffers[a]?r[a]=e[a]:t[a]=e[a]}this.addBuffers(r,s,t.stream_type);for(var o in t)this[o]=t[o];t.bounding||this.updateBoundingBox()},Mesh.prototype.totalMemory=function(){var e=0;for(var t in this.vertexBuffers)e+=this.vertexBuffers[t].data.buffer.byteLength;for(var t in this.indexBuffers)e+=this.indexBuffers[t].data.buffer.byteLength;return e},Mesh.prototype.slice=function(e,t){var r={},s=this.indexBuffers.triangles;if(!s)return console.warn("splice in not indexed not supported yet"),null;var a=s.data,o=[],c=new Int32Array(a.length);c.fill(-1);var f=e+t;f>=a.length&&(f=a.length);for(var p=0,T=e;T<f;++T){var g=a[T];if(c[g]!=-1){o.push(c[g]);continue}var N=p++;c[g]=N,o.push(N);for(var A in this.vertexBuffers){var M=this.vertexBuffers[A],B=M.data,O=M.spacing;r[A]||(r[A]=[]);for(var P=r[A],U=0;U<O;++U)P.push(B[U+g*O])}}var X=new n.Mesh(r,{triangles:o},null,gl);return X.updateBoundingBox(),X},Mesh.prototype.simplify=function(){var e=this.getBoundingBox(),t=BBox.getMin(e),r=BBox.getHalfsize(e),s=vec3.scale(vec3.create(),r,2),a=new n.Mesh,o=vec3.create();for(var c in this.vertexBuffers){var f=this.vertexBuffers[c],p=f.data,T=new Float32Array(p.length);if(c=="vertices")for(var g=0,N=p.length;g<N;g+=3){var A=p.subarray(g,g+3);vec3.sub(o,A,t),vec3.div(o,o,s),o[0]=Math.round(o[0]*256)/256,o[1]=Math.round(o[1]*256)/256,o[2]=Math.round(o[2]*256)/256,vec3.mul(o,o,s),vec3.add(o,o,t),T.set(o,g)}a.addBuffer()}},Mesh.load=function(e,t,r,s){t=t||{},t.no_gl&&(s=null);var a=r||new n.Mesh(null,null,null,s);return a.configure(e,t),a},Mesh.mergeMeshes=function(e,t){t=t||{};for(var r={},s={},a={},o=[],c=0,f=[],p=[],T={},g=0;g<e.length;++g){var N=e[g],A=N.mesh,M=c;o.push(M);var B=A.vertexBuffers.vertices.data.length/3;c+=B;for(var O in A.vertexBuffers)r[O]?r[O]+=A.vertexBuffers[O].data.length:r[O]=A.vertexBuffers[O].data.length;for(var O in A.indexBuffers)s[O]?s[O]+=A.indexBuffers[O].data.length:s[O]=A.indexBuffers[O].data.length;var P={name:"mesh_"+g,start:M,length:B,material:""};if(A.bones){for(var U={},O=0;O<A.bones.length;++O){var X=A.bones[O];T[X[0]]||(T[X[0]]=p.length,p.push(X)),U[O]=T[X[0]]}for(var k=A.vertexBuffers.bone_indices.data,O=0;O<k.length;O+=1)k[O]=U[k[O]]}else if(p.length)throw"cannot merge meshes, one contains bones, the other doesnt";f.push(P)}for(var O in r){var V=t[O];if(V===null){delete r[O];continue}if(!V){var J=A.vertexBuffers[O];J&&(J.data&&(J=J.data),J.constructor!==Array&&(V=J.constructor)),V||(V=Float32Array)}r[O]=new V(r[O]),a[O]=0}for(var O in s){var V=c<65536?Uint16Array:Uint32Array;s[O]=new V(s[O]),a[O]=0}for(var g=0;g<e.length;++g){var N=e[g],A=N.mesh,M=0,B=0;for(var O in A.vertexBuffers)if(r[O]){if(O=="vertices"&&(B=A.vertexBuffers[O].data.length/3),r[O].set(A.vertexBuffers[O].data,a[O]),N[O+"_matrix"]){var te=N[O+"_matrix"];te.length==16?F(r[O],a[O],A.vertexBuffers[O].data.length,te):te.length==9&&Q(r[O],a[O],A.vertexBuffers[O].data.length,te)}a[O]+=A.vertexBuffers[O].data.length}for(var O in A.indexBuffers)s[O].set(A.indexBuffers[O].data,a[O]),ee(s[O],a[O],A.indexBuffers[O].data.length,o[g]),a[O]+=A.indexBuffers[O].data.length}function F(z,q,ie,j){for(var se=q+ie,le=q;le<se;le+=3){var ue=z.subarray(le,le+3);vec3.transformMat4(ue,ue,j)}}function Q(z,q,ie,j){for(var se=q+ie,le=q;le<se;le+=2){var ue=z.subarray(le,le+2);vec2.transformMat3(ue,ue,j)}}function ee(z,q,ie,j){if(j)for(var se=q+ie,le=q;le<se;++le)z[le]+=j}var K={info:{groups:f}};if(p.length&&(K.bones=p),typeof gl<"u"||t.only_data){var A=new n.Mesh(r,s,K);return A.updateBoundingBox(),A}return{vertexBuffers:r,indexBuffers:s,info:{groups:f}}},Mesh.parsers={},Mesh.encoders={},Mesh.binary_file_formats={},Mesh.compressors={},Mesh.decompressors={},Mesh.fromURL=function(e,t,r,s){s=s||{},r=r||u.gl;var a=e.lastIndexOf("."),o=e.substr(a+1).toLowerCase();s.extension&&(o=s.extension);var c=n.Mesh.parsers[o.toLowerCase()];if(!c)return console.error("No parser available in litegl to parse mesh of type",o),null;var f=new n.Mesh(void 0,void 0,void 0,r);return f.ready=!1,s.binary=Mesh.binary_file_formats[o],HttpRequest(e,null,function(p){f.parse(p,o,s),delete f.ready,t&&t.call(f,f,e,s)},function(p){t&&t(null)},s),f},Mesh.prototype.parse=function(e,t,r){r=r||{},r.mesh=this,t=t.toLowerCase();var s=n.Mesh.parsers[t];if(s)return s.call(null,e,r);throw"GL.Mesh.parse: no parser found for format "+t},Mesh.prototype.encode=function(e,t){e=e.toLowerCase();var r=n.Mesh.encoders[e];if(r)return r.call(null,this,t);throw"GL.Mesh.encode: no encoder found for format "+e},Mesh.getScreenQuad=function(e){e=e||u.gl;var t=e.meshes[":screen_quad"];if(t)return t;var r=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]),s=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]);return t=new n.Mesh({vertices:r,coords:s},void 0,void 0,e),e.meshes[":screen_quad"]=t};function b(e,t){if(e.constructor===t)return e;if(e.constructor!==Array)return t=t||Float32Array,new t(e);t=t||Float32Array;for(var r=e[0].length,s=e.length*r,a=new t(s),o=0;o<e.length;++o)for(var c=0;c<r;++c)a[o*r+c]=e[o][c];return a}n.linearizeArray=b,n.Mesh.EXTENSION="wbin",n.Mesh.enable_wbin_compression=!0;function S(e,t,r,s,a){e=e||1024,n.debug&&console.log("GL.Mesh created"),a!==null&&(a=a||u.gl,this.gl=a),this._context_id=a.context_id,this.vertexBuffers={},this.indexBuffers={},this.info={groups:[]},this._bounding=BBox.create(),this.resize(e)}S.DEFAULT_NORMAL=vec3.fromValues(0,1,0),S.DEFAULT_COORD=vec2.fromValues(.5,.5),S.DEFAULT_COLOR=vec4.fromValues(1,1,1,1),S.prototype.resize=function(e){var t={};this._vertex_data=new Float32Array(e*3),t.vertices=this._vertex_data,normals&&(t.normals=this._normal_data=new Float32Array(e*3)),coords&&(t.coords=this._coord_data=new Float32Array(e*2)),colors&&(t.colors=this._color_data=new Float32Array(e*4)),this.addBuffers(t),this.current_pos=0,this.max_size=e,this._must_update=!0},S.prototype.clear=function(){this.current_pos=0},S.prototype.addPoint=function(e,t,r,s){if(a>=this.max_size)return console.warn("DynamicMesh: not enough space, reserve more"),!1;var a=this.current_pos++;return this._vertex_data.set(e,a*3),this._normal_data&&this._normal_data.set(t||S.DEFAULT_NORMAL,a*3),this._coord_data&&this._coord_data.set(r||S.DEFAULT_COORD,a*2),this._color_data&&this._color_data.set(s||S.DEFAULT_COLOR,a*4),this._must_update=!0,!0},S.prototype.update=function(e){return!this._must_update&&!e?this.current_pos:(this._must_update=!1,this.getBuffer("vertices").upload(gl.STREAM_DRAW),this._normal_data&&this.getBuffer("normal").upload(gl.STREAM_DRAW),this._coord_data&&this.getBuffer("coord").upload(gl.STREAM_DRAW),this._color_data&&this.getBuffer("color").upload(gl.STREAM_DRAW),this.current_pos)},extendClass(S,Mesh),Mesh.plane=function(e,t){e=e||{},e.triangles=[];var r=e.detailX||e.detail||1,s=e.detailY||e.detail||1,a=e.width||e.size||1,o=e.height||e.size||1,c=e.xz;a*=.5,o*=.5;var f=[],p=[],T=[],g=[],N=vec3.fromValues(0,0,1);c&&N.set([0,1,0]);for(var A=0;A<=s;A++)for(var M=A/s,B=0;B<=r;B++){var O=B/r;if(c?p.push((2*O-1)*a,0,-(2*M-1)*o):p.push((2*O-1)*a,(2*M-1)*o,0),T.push(O,M),g.push(N[0],N[1],N[2]),B<r&&A<s){var P=B+A*(r+1);c?(f.push(P+1,P+r+1,P),f.push(P+1,P+r+2,P+r+1)):(f.push(P,P+1,P+r+1),f.push(P+r+1,P+1,P+r+2))}}var U=BBox.fromCenterHalfsize([0,0,0],c?[a,0,o]:[a,o,0]),X={vertices:p,normals:g,coords:T,triangles:f};return n.Mesh.load(X,{bounding:U},t)},Mesh.plane2D=function(e,t){var r=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),s=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(e&&e.size)for(var a=e.size*.5,o=0;o<r.length;++o)r[o]*=a;return new n.Mesh({vertices2D:r,coords:s},null,t)},Mesh.point=function(e){return new n.Mesh({vertices:[0,0,0]})},Mesh.cube=function(e,t){e=e||{};var r=(e.size||1)*.5,s={};s.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var a=0,o=s.vertices.length;a<o;++a)s.vertices[a]*=r;return s.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]),s.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]),e.wireframe&&(s.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11])),e.bounding=BBox.fromCenterHalfsize([0,0,0],[r,r,r]),n.Mesh.load(s,e,t)},Mesh.box=function(e,t){e=e||{};var r=e.sizex||1,s=e.sizey||1,a=e.sizez||1;r*=.5,s*=.5,a*=.5;var o={};o.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var c=0,f=o.vertices.length;c<f;c+=3)o.vertices[c]*=r,o.vertices[c+1]*=s,o.vertices[c+2]*=a;return o.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]),o.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]),e.wireframe&&(o.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11])),e.bounding=BBox.fromCenterHalfsize([0,0,0],[r,s,a]),n.Mesh.load(o,e,t)},Mesh.circle=function(e,t){e=e||{};var r=e.size||e.radius||1,s=Math.ceil(e.slices||24),a=e.xz||!1,o=e.empty||!1;s<3&&(s=3);var c=2*Math.PI/s,f=vec3.create(),p=vec3.create(),T=vec3.fromValues(0,0,1),g=vec2.fromValues(.5,.5),N=vec2.create();a&&T.set([0,1,0]);var A=a?2:1,M=new Float32Array(3*(s+1)),B=new Float32Array(3*(s+1)),O=new Float32Array(2*(s+1)),P=null;M.set(f,0),B.set(T,0),O.set(g,0);for(var U=0,X=0,k=0;k<s;++k)U=Math.sin(c*k),X=Math.cos(c*k),p[0]=U*r,p[A]=X*r,N[0]=U*.5+.5,N[1]=X*.5+.5,M.set(p,k*3+3),B.set(T,k*3+3),O.set(N,k*2+2);if(o)M=M.subarray(3),B=M.subarray(3),O=M.subarray(2),P=null;else{var P=new Uint16Array(3*s),V=2,J=1;a&&(V=1,J=2);for(var k=0;k<s-1;++k)P[k*3]=0,P[k*3+1]=k+V,P[k*3+2]=k+J;P[k*3]=0,a?(P[k*3+1]=k+1,P[k*3+2]=1):(P[k*3+1]=1,P[k*3+2]=k+1)}e.bounding=BBox.fromCenterHalfsize([0,0,0],a?[r,0,r]:[r,r,0]);var te={vertices:M,normals:B,coords:O,triangles:P};if(e.wireframe){for(var F=new Uint16Array(s*2),k=0;k<s;k++)F[k*2]=k,F[k*2+1]=k+1;F[0]=s,te.wireframe=F}return n.Mesh.load(te,e,t)},Mesh.ring=function(e,t){e=e||{};var r=e.size||e.radius||1,s=e.thickness||r*.1,a=Math.ceil(e.slices||24),o=e.xz||!1,c=e.empty||!1;a<3&&(a=3);var f=2*Math.PI/a;vec3.create();var p=vec3.create(),T=vec3.create(),g=vec3.fromValues(0,0,1);vec2.fromValues(.5,.5);var N=vec2.create();o&&g.set([0,1,0]);for(var A=o?2:1,M=new Float32Array(3*(a*2+2)),B=new Float32Array(3*(a*2+2)),O=new Float32Array(2*(a*2+2)),P=null,U=0,X=0,k=0;k<=a;++k)U=Math.sin(f*k),X=Math.cos(f*k),p[0]=U*(r-s),p[A]=X*(r-s),N[0]=k/a,N[1]=0,M.set(p,k*6),B.set(g,k*6),O.set(N,k*4),T[0]=U*(r+s),T[A]=X*(r+s),N[1]=1,M.set(T,k*6+3),B.set(g,k*6+3),O.set(N,k*4+2);if(c)M=M.subarray(3),B=M.subarray(3),O=M.subarray(2),P=null;else{var P=new Uint16Array(6*a),V=2,J=1;o&&(V=1,J=2);for(var k=0;k<a;++k)P[k*6]=k*2,P[k*6+1]=k*2+V,P[k*6+2]=k*2+J,P[k*6+3]=k*2+J,P[k*6+4]=k*2+V,P[k*6+5]=k*2+3}e.bounding=BBox.fromCenterHalfsize([0,0,0],o?[r+s,0,r+s]:[r+s,r+s,0]);var te={vertices:M,normals:B,coords:O,triangles:P};if(e.wireframe){for(var F=new Uint16Array(a*4),k=0;k<a;k++)F[k*4]=k*2,F[k*4+1]=k*2+2,F[k*4+2]=k*2+1,F[k*4+3]=k*2+3;te.wireframe=F}return n.Mesh.load(te,e,t)},Mesh.cylinder=function(e,t){e=e||{};for(var r=e.radius||e.size||1,s=e.height||e.size||2,a=e.subdivisions||64,o=new Float32Array(a*6*3*2),c=new Float32Array(a*6*3*2),f=new Float32Array(a*6*2*2),p=2*Math.PI/a,T=null,g=0;g<a;++g){var N=g*p;T=[Math.sin(N),0,Math.cos(N)],o.set([T[0]*r,s*.5,T[2]*r],g*6*3),c.set(T,g*6*3),f.set([g/a,1],g*6*2),T=[Math.sin(N),0,Math.cos(N)],o.set([T[0]*r,s*-.5,T[2]*r],g*6*3+3),c.set(T,g*6*3+3),f.set([g/a,0],g*6*2+2),T=[Math.sin(N+p),0,Math.cos(N+p)],o.set([T[0]*r,s*-.5,T[2]*r],g*6*3+6),c.set(T,g*6*3+6),f.set([(g+1)/a,0],g*6*2+4),T=[Math.sin(N+p),0,Math.cos(N+p)],o.set([T[0]*r,s*.5,T[2]*r],g*6*3+9),c.set(T,g*6*3+9),f.set([(g+1)/a,1],g*6*2+6),T=[Math.sin(N),0,Math.cos(N)],o.set([T[0]*r,s*.5,T[2]*r],g*6*3+12),c.set(T,g*6*3+12),f.set([g/a,1],g*6*2+8),T=[Math.sin(N+p),0,Math.cos(N+p)],o.set([T[0]*r,s*-.5,T[2]*r],g*6*3+15),c.set(T,g*6*3+15),f.set([(g+1)/a,0],g*6*2+10)}var A=g*6*3,M=g*6*2,B=A;if(e.caps===!1)o=o.subarray(0,A),c=c.subarray(0,A),f=f.subarray(0,M);else for(var O=vec3.fromValues(0,s*.5,0),P=vec3.fromValues(0,s*-.5,0),U=vec3.fromValues(0,1,0),X=vec3.fromValues(0,-1,0),g=0;g<a;++g){var N=g*p,k=vec3.fromValues(Math.sin(N),0,Math.cos(N)),V=vec3.fromValues(Math.sin(N+p),0,Math.cos(N+p));o.set([k[0]*r,s*.5,k[2]*r],A+g*6*3),c.set(U,A+g*6*3),f.set([-k[0]*.5+.5,k[2]*.5+.5],M+g*6*2),o.set([V[0]*r,s*.5,V[2]*r],A+g*6*3+3),c.set(U,A+g*6*3+3),f.set([-V[0]*.5+.5,V[2]*.5+.5],M+g*6*2+2),o.set(O,A+g*6*3+6),c.set(U,A+g*6*3+6),f.set([.5,.5],M+g*6*2+4),o.set([V[0]*r,s*-.5,V[2]*r],A+g*6*3+9),c.set(X,A+g*6*3+9),f.set([V[0]*.5+.5,V[2]*.5+.5],M+g*6*2+6),o.set([k[0]*r,s*-.5,k[2]*r],A+g*6*3+12),c.set(X,A+g*6*3+12),f.set([k[0]*.5+.5,k[2]*.5+.5],M+g*6*2+8),o.set(P,A+g*6*3+15),c.set(X,A+g*6*3+15),f.set([.5,.5],M+g*6*2+10)}var J={vertices:o,normals:c,coords:f};return e.bounding=BBox.fromCenterHalfsize([0,0,0],[r,s*.5,r]),e.info={groups:[]},e.caps!==!1&&(e.info.groups.push({name:"side",start:0,length:B/3}),e.info.groups.push({name:"caps",start:B/3,length:(o.length-B)/3})),Mesh.load(J,e,t)},Mesh.cone=function(e,t){e=e||{};for(var r=e.radius||e.size||1,s=e.height||e.size||2,a=e.subdivisions||64,o=new Float32Array(a*3*3*2),c=new Float32Array(a*3*3*2),f=new Float32Array(a*2*3*2),p=2*Math.PI/a,T=null,g=r/s,N=0;N<a;++N){var A=N*p;T=[Math.sin(A+p*.5),g,Math.cos(A+p*.5)],vec3.normalize(T,T),o.set([0,s,0],N*6*3),c.set(T,N*6*3),f.set([N/a,1],N*6*2),T=[Math.sin(A),g,Math.cos(A)],o.set([T[0]*r,0,T[2]*r],N*6*3+3),vec3.normalize(T,T),c.set(T,N*6*3+3),f.set([N/a,0],N*6*2+2),T=[Math.sin(A+p),g,Math.cos(A+p)],o.set([T[0]*r,0,T[2]*r],N*6*3+6),vec3.normalize(T,T),c.set(T,N*6*3+6),f.set([(N+1)/a,0],N*6*2+4)}for(var M=0,B=0,O=vec3.fromValues(0,0,0),P=vec3.fromValues(0,-1,0),N=0;N<a;++N){var A=N*p,U=vec3.fromValues(Math.sin(A),0,Math.cos(A)),X=vec3.fromValues(Math.sin(A+p),0,Math.cos(A+p));o.set([X[0]*r,0,X[2]*r],M+N*6*3+9),c.set(P,M+N*6*3+9),f.set([X[0]*.5+.5,X[2]*.5+.5],B+N*6*2+6),o.set([U[0]*r,0,U[2]*r],M+N*6*3+12),c.set(P,M+N*6*3+12),f.set([U[0]*.5+.5,U[2]*.5+.5],B+N*6*2+8),o.set(O,M+N*6*3+15),c.set(P,M+N*6*3+15),f.set([.5,.5],B+N*6*2+10)}var k={vertices:o,normals:c,coords:f};return e.bounding=BBox.fromCenterHalfsize([0,s*.5,0],[r,s*.5,r]),Mesh.load(k,e,t)},Mesh.torus=function(e,t){e=e||{};var r=e.outerradius||e.radius||1,s=Math.ceil(e.outerslices||e.slices||24),a=e.innerradius||r*.1,o=Math.ceil(e.innerslices||s),c=e.angle||Math.PI*2,f=Math.PI*2/o,p=c/s,T=1;vec3.create();var g=vec3.create(),N=vec3.fromValues(0,0,1);vec2.fromValues(.5,.5);for(var A=vec2.create(),M=c==Math.PI*2,B=new Float32Array(3*o),O=new Float32Array(3*o),V=0,J=0,P=0;P<o;++P)V=Math.sin(f*P),J=Math.cos(f*P),g[0]=V*a,g[T]=J*a,A[0]=V*.5+.5,A[1]=J*.5+.5,B.set(g,P*3),vec3.normalize(N,g),O.set(N,P*3);var U=new Float32Array(3*s*o),X=new Float32Array(3*s*o),k=new Float32Array(2*s*o),ee=null,V=0,J=0,te=mat4.create(),F=vec3.fromValues(-r,0,0),Q=vec3.fromValues(0,1,0);vec3.create();for(var ee=[],K=o,P=0;P<s;++P){mat4.identity(te),mat4.rotate(te,te,P*p,Q),mat4.translate(te,te,F);var z=P*o,K=o;P>=s-1&&(K=(s-1)*-o,M||(K=0));for(var q=0;q<o;++q){var ie=B.subarray(q*3,q*3+3),j=O.subarray(q*3,q*3+3);mat4.multiplyVec3(g,te,ie),mat4.rotateVec3(N,te,j),U.set(g,q*3+P*3*o),X.set(N,q*3+P*3*o),k.set([P/s,q/o],q*2+P*2*o);var se=z+q,le=z+(q+1)%o;ee.push(le,se,se+K,le,se+K,le+K)}}var ue=a+r;e.bounding=BBox.fromCenterHalfsize([0,0,0],[ue,ue,a]);var he={vertices:U,normals:X,coords:k,triangles:ee};return n.Mesh.load(he,e,t)},Mesh.sphere=function(e,t){e=e||{};for(var r=e.radius||e.size||1,s=e.lat||e.subdivisions||16,a=e.long||e.subdivisions||16,o=new Float32Array((s+1)*(a+1)*3),c=new Float32Array((s+1)*(a+1)*3),f=new Float32Array((s+1)*(a+1)*2),p=new Uint16Array(s*a*6),T=e.hemi?Math.PI*.5:Math.PI,g=0,N=0,A=0;A<=s;A++)for(var M=A*T/s,B=Math.sin(M),O=Math.cos(M),P=0;P<=a;P++){var U=P*2*Math.PI/a,X=Math.sin(U),k=Math.cos(U),V=k*B,J=O,te=X*B,F=1-P/a,Q=1-A/s;o.set([r*V,r*J,r*te],g),c.set([V,J,te],g),f.set([F,Q],N),g+=3,N+=2}g=0;for(var A=0;A<s;A++)for(var P=0;P<a;P++){var ee=A*(a+1)+P,K=ee+a+1;p.set([K,ee,ee+1],g),p.set([K+1,K,ee+1],g+3),g+=6}var z={vertices:o,normals:c,coords:f,triangles:p};if(e.wireframe){for(var q=new Uint16Array(a*s*4),ie=0,g=0;g<s;g++){for(var j=0;j<a;j++)q[ie]=g*(a+1)+j,q[ie+1]=g*(a+1)+j+1,ie+=2;q[ie-a*2]=g*(a+1)+j}for(var g=0;g<a;g++)for(var j=0;j<s;j++)q[ie]=j*(a+1)+g,q[ie+1]=(j+1)*(a+1)+g,ie+=2;z.wireframe=q}return e.hemi?e.bounding=BBox.fromCenterHalfsize([0,r*.5,0],[r,r*.5,r],r):e.bounding=BBox.fromCenterHalfsize([0,0,0],[r,r,r],r),n.Mesh.load(z,e,t)},Mesh.grid=function(e,t){e=e||{};var r=e.lines||11;r<0&&(r=1);for(var s=e.size||10,a=new Float32Array(r*2*2*3),o=s*.5,c=0,f=-o,p=s/(r-1),T=0;T<r;T++)a[c]=f,a[c+2]=-o,a[c+3]=f,a[c+5]=o,a[c+6]=o,a[c+8]=f,a[c+9]=-o,a[c+11]=f,f+=p,c+=12;return new n.Mesh({vertices:a},e,t)},Mesh.icosahedron=function(e,t){e=e||{};var r=e.radius||e.size||1,s=e.subdivisions===void 0?0:e.subdivisions;s>6&&(s=6);for(var a=(1+Math.sqrt(5))/2,o=[-1,a,0,1,a,0,-1,-a,0,1,-a,0,0,-1,a,0,1,a,0,-1,-a,0,1,-a,a,0,-1,a,0,1,-a,0,-1,-a,0,1],c=[],f=[],p=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],T=o.length,g=0;g<T;g+=3){var N=Math.sqrt(o[g]*o[g]+o[g+1]*o[g+1]+o[g+2]*o[g+2]),A=o[g]/N,M=o[g+1]/N,B=o[g+2]/N;c.push(A,M,B),f.push(Math.atan2(A,B),Math.acos(M)),o[g]*=r/N,o[g+1]*=r/N,o[g+2]*=r/N}var O={};function P(te,F){var Q=p[te]<p[F]?p[te]+":"+p[F]:p[F]+":"+p[te],ee=O[Q];if(ee)return ee;var K=o.length/3;o.push((o[p[te]*3]+o[p[F]*3])*.5,(o[p[te]*3+1]+o[p[F]*3+1])*.5,(o[p[te]*3+2]+o[p[F]*3+2])*.5);var z=Math.sqrt(o[K*3]*o[K*3]+o[K*3+1]*o[K*3+1]+o[K*3+2]*o[K*3+2]),q=o[K*3]/z,ie=o[K*3+1]/z,j=o[K*3+2]/z;return c.push(q,ie,j),f.push(Math.atan2(q,j)/Math.PI*.5,Math.acos(ie)/Math.PI),o[K*3]*=r/z,o[K*3+1]*=r/z,o[K*3+2]*=r/z,O[Q]=K,K}for(var U=0;U<s;++U){for(var X=[],T=p.length,g=0;g<T;g+=3){var k=P(g,g+1),V=P(g+1,g+2),J=P(g+2,g);X.push(p[g],k,J),X.push(p[g+1],V,k),X.push(p[g+2],J,V),X.push(k,V,J)}p=X}return e.bounding=BBox.fromCenterHalfsize([0,0,0],[r,r,r],r),new n.Mesh.load({vertices:o,coords:f,normals:c,triangles:p},e,t)},Mesh.shape=function(e,t,r){if(t=t||{},typeof earcut>"u")throw"To use GL.Mesh.shape you must download and include earcut.js (do not link it directly!): https://raw.githubusercontent.com/mapbox/earcut/master/src/earcut.js";if(!e||!e.length||e.length%2==1)throw"GL.Mesh.shape line missing, must be an array of 2D vertices";var s=t.extrude||0;e[0].constructor===Array&&(e=earcut.flatten(e));var a=earcut(e).reverse();console.log(a);for(var o=[],c=[],f=[],p=[e[0],e[1]],T=[e[0],e[1]],g=0;g<e.length;g+=2)p[0]=Math.min(p[0],e[g]),p[1]=Math.max(p[1],e[g]),T[0]=Math.min(T[0],e[g+1]),T[1]=Math.max(T[1],e[g+1]);var N=p[1]-p[0],A=T[1]-T[0],M=[],B=null;if(s){B=[];for(var O=vec3.create(),P=e.length,g=0;g<e.length;g+=2){var U=e[g],X=e[g+1],k=e[(g+2)%P],V=e[(g+3)%P],J=o.length/3;o.push(U,s*.5,X),o.push(U,s*-.5,X),o.push(k,s*.5,V),o.push(k,s*-.5,V),vec3.normalize(O,vec3.cross(O,[0,1,0],[k-U,0,V-X])),c.push(O[0],O[1],O[2],O[0],O[1],O[2],O[0],O[1],O[2],O[0],O[1],O[2]);var te=(U-p[0])/N,F=(X-T[0])/A,Q=(k-p[0])/N,ee=(V-T[0])/A;f.push(te,F,te,F,Q,ee,Q,ee),B.push(J,J+2,J+1,J+2,J+3,J+1)}M.push({name:"side",start:0,length:B.length});for(var K=o.length/3,z=B.length,g=0;g<e.length;g+=2){var U=e[g],X=e[g+1],te=(U-p[0])/N,F=(X-T[0])/A;o.push(U,s*.5,X),o.push(U,s*-.5,X),c.push(0,1,0,0,-1,0),f.push(te,F,te,F)}for(var g=0;g<a.length;g+=3)B.push(K+a[g]*2,K+a[g+1]*2,K+a[g+2]*2),B.push(K+a[g]*2+1,K+a[g+2]*2+1,K+a[g+1]*2+1);M.push({name:"caps",start:z,length:B.length}),t.bounding=BBox.fromCenterHalfsize([(p[0]+p[1])*.5,0,(T[0]+T[1])*.5],[N*.5,s*.5,A*.5],vec2.len([N*.5,s*.5,A*.5]))}else{for(var g=0;g<e.length;g+=2)o.push(e[g],0,e[g+1]),c.push(0,1,0),f.push((e[g]-p[0])/N,(e[g+1]-T[0])/A);B=a,M.push({name:"side",start:0,length:B.length}),t.bounding=BBox.fromCenterHalfsize([(p[0]+p[1])*.5,0,(T[0]+T[1])*.5],[N*.5,0,A*.5],vec2.len([N*.5,0,A*.5]))}if(t.xy){for(var g=0;g<o.length;g+=3)q(o,g),q(c,g);s?t.bounding=BBox.fromCenterHalfsize([(p[0]+p[1])*.5,(T[0]+T[1])*.5,0],[N*.5,A*.5,s*.5],vec2.len([N*.5,A*.5,s*.5])):t.bounding=BBox.fromCenterHalfsize([(p[0]+p[1])*.5,(T[0]+T[1])*.5,0],[N*.5,A*.5,0],vec2.len([N*.5,A*.5,0]))}return t.info={groups:M},new n.Mesh.load({vertices:o,coords:f,normals:c,triangles:B},t,r);function q(ie,j){var se=ie[j+1];ie[j+1]=ie[j+2],ie[j+2]=-se}},u.Texture=n.Texture=function e(t,r,s,a){if(s=s||{},a=a||u.gl,this.gl=a,this._context_id=a.context_id,t=parseInt(t),r=parseInt(r),n.debug&&console.log("GL.Texture created: ",t,r),this.handler=a.createTexture(),this.width=t,this.height=r,s.depth&&(this.depth=s.depth),this.texture_type=s.texture_type||a.TEXTURE_2D,this.format=s.format||e.DEFAULT_FORMAT,this.internalFormat=s.internalFormat,this.type=s.type||e.DEFAULT_TYPE,this.magFilter=s.magFilter||s.filter||e.DEFAULT_MAG_FILTER,this.minFilter=s.minFilter||s.filter||e.DEFAULT_MIN_FILTER,this.wrapS=s.wrap||s.wrapS||e.DEFAULT_WRAP_S,this.wrapT=s.wrap||s.wrapT||e.DEFAULT_WRAP_T,this.data=null,e.MAX_TEXTURE_IMAGE_UNITS||(e.MAX_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS)),this.has_mipmaps=!1,this.format==a.DEPTH_COMPONENT&&a.webgl_version==1&&!a.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==a.FLOAT&&!a.extensions.OES_texture_float&&a.webgl_version==1)throw"Float Texture not supported";if(this.type==a.HALF_FLOAT_OES){if(!a.extensions.OES_texture_half_float&&a.webgl_version==1)throw"Half Float Texture extension not supported.";a.webgl_version>1&&(console.warn("using HALF_FLOAT_OES in WebGL2 is deprecated, suing HALF_FLOAT instead"),this.type=this.format==a.RGB?a.RGB16F:a.RGBA16F)}if((!isPowerOfTwo(this.width)||!isPowerOfTwo(this.height))&&(this.minFilter!=a.NEAREST&&this.minFilter!=a.LINEAR||this.wrapS!=a.CLAMP_TO_EDGE||this.wrapT!=a.CLAMP_TO_EDGE))if(s.ignore_pot)this.minFilter=this.magFilter=a.LINEAR,this.wrapS=this.wrapT=a.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(!t||!r)return;this.internalFormat||this.computeInternalFormat(),a.activeTexture(a.TEXTURE0+e.MAX_TEXTURE_IMAGE_UNITS-1),a.bindTexture(this.texture_type,this.handler),a.texParameteri(this.texture_type,a.TEXTURE_MAG_FILTER,this.magFilter),a.texParameteri(this.texture_type,a.TEXTURE_MIN_FILTER,this.minFilter),a.texParameteri(this.texture_type,a.TEXTURE_WRAP_S,this.wrapS),a.texParameteri(this.texture_type,a.TEXTURE_WRAP_T,this.wrapT),s.anisotropic&&a.extensions.EXT_texture_filter_anisotropic&&a.texParameterf(n.TEXTURE_2D,a.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,s.anisotropic);var o=this.type,c=s.pixel_data;if(c&&!c.buffer){if(this.texture_type==n.TEXTURE_CUBE_MAP)if(c[0].constructor===Number)c=p(c),c=[c,c,c,c,c,c];else for(var f=0;f<c.length;++f)c[f]=p(c[f]);else c=p(c);this.data=c}function p(N){return N.constructor!==Array?N:o==n.FLOAT?new Float32Array(N):o==n.HALF_FLOAT_OES?new Uint16Array(N):new Uint8Array(N)}if(e.setUploadOptions(s),this.texture_type==n.TEXTURE_2D)a.texImage2D(n.TEXTURE_2D,0,this.internalFormat,t,r,0,this.format,this.type,c||null),n.isPowerOfTwo(t)&&n.isPowerOfTwo(r)&&s.minFilter&&s.minFilter!=a.NEAREST&&s.minFilter!=a.LINEAR&&(a.generateMipmap(this.texture_type),this.has_mipmaps=!0);else if(this.texture_type==n.TEXTURE_CUBE_MAP)for(var T=t*t*(this.format==n.RGBA?4:3),f=0;f<6;++f){var g=c;g&&(g.constructor===Array?g=g[f]:g.subarray(T*f,T*(f+1))),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,this.internalFormat,this.width,this.height,0,this.format,this.type,g||null)}else if(this.texture_type==n.TEXTURE_3D){if(this.gl.webgl_version==1)throw"TEXTURE_3D not supported in WebGL 1. Enable WebGL 2 in the context by passing webgl2:true to the context";if(!s.depth)throw"3d texture depth must be set in the options.depth";a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.texImage3D(n.TEXTURE_3D,0,this.internalFormat,t,r,s.depth,0,this.format,this.type,c||null)}a.bindTexture(this.texture_type,null),a.activeTexture(a.TEXTURE0)},Texture.DEFAULT_TYPE=n.UNSIGNED_BYTE,Texture.DEFAULT_FORMAT=n.RGBA,Texture.DEFAULT_MAG_FILTER=n.LINEAR,Texture.DEFAULT_MIN_FILTER=n.LINEAR,Texture.DEFAULT_WRAP_S=n.CLAMP_TO_EDGE,Texture.DEFAULT_WRAP_T=n.CLAMP_TO_EDGE,Texture.EXTENSION="png",Texture.framebuffer=null,Texture.renderbuffer=null,Texture.loading_color=new Uint8Array([0,0,0,0]),Texture.use_renderbuffer_pool=!0,Texture.CROSS_ORIGIN_CREDENTIALS="Anonymous",Texture.prototype.computeInternalFormat=function(){if(this.internalFormat=this.format,this.format==n.DEPTH_COMPONENT){if(this.minFilter=n.NEAREST,gl.webgl_version==2)if(this.type==n.UNSIGNED_SHORT)this.internalFormat=n.DEPTH_COMPONENT16;else if(this.type==n.UNSIGNED_INT)this.internalFormat=n.DEPTH_COMPONENT24;else if(this.type==n.FLOAT)this.internalFormat=n.DEPTH_COMPONENT32F;else throw"unsupported type for a depth texture";else if(gl.webgl_version==1){if(this.type==n.FLOAT)throw"WebGL 1.0 does not support float depth textures";this.internalFormat=n.DEPTH_COMPONENT}}else this.format==gl.RGBA&&(gl.webgl_version==2?this.type==n.FLOAT?this.internalFormat=n.RGBA32F:this.type==n.HALF_FLOAT?this.internalFormat=n.RGBA16F:this.type==n.HALF_FLOAT_OES&&(console.warn("webgl 2 does not use HALF_FLOAT_OES, converting to HALF_FLOAT"),this.type=n.HALF_FLOAT,this.internalFormat=n.RGBA16F):gl.webgl_version==1&&this.type==n.HALF_FLOAT&&(console.warn("webgl 1 does not use HALF_FLOAT, converting to HALF_FLOAT_OES"),this.type=n.HALF_FLOAT_OES))},Texture.prototype.delete=function(){gl.deleteTexture(this.handler),this.handler=null},Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}},Texture.prototype.hasSameProperties=function(e){return e?e.width==this.width&&e.height==this.height&&e.type==this.type&&e.format==this.format&&e.texture_type==this.texture_type:!1},Texture.prototype.hasSameSize=function(e){return e?e.width==this.width&&e.height==this.height:!1},Texture.prototype.toJSON=function(){return""},Texture.isDepthSupported=function(){return gl.extensions.WEBGL_depth_texture!=null},Texture.prototype.bind=function(e){e==null&&(e=0);var t=this.gl;return t.activeTexture(t.TEXTURE0+e),t.bindTexture(this.texture_type,this.handler),e},Texture.prototype.unbind=function(e){e===void 0&&(e=0);var t=this.gl;t.activeTexture(t.TEXTURE0+e),t.bindTexture(this.texture_type,null)},Texture.prototype.setParameter=function(e,t){switch(this.bind(0),this.gl.texParameteri(this.texture_type,e,t),e){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=t;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=t;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=t;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=t;break}},Texture.setUploadOptions=function(e,t){t=t||u.gl,Texture.disable_deprecated||(e?(t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!e.premultiply_alpha),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!e.no_flip)):(t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0))),t.pixelStorei(t.UNPACK_ALIGNMENT,1)},Texture.flipYData=function(e,t,r,s){for(var a=new e.constructor(t*s),o=0,c=t*(r-1)*s,f=Math.floor(r*.5),p=0;p<f;++p){var T=e.subarray(o,o+t*s),g=e.subarray(c,c+t*s);if(a.set(T),T.set(g),g.set(a),o+=t*s,c-=t*s,o>c)break}},Texture.prototype.uploadImage=function(e,t){this.bind();var r=this.gl;if(!e)throw"uploadImage parameter must be Image";Texture.setUploadOptions(t,r);try{if(t&&t.subimage)r.webgl_version==1?r.texSubImage2D(r.TEXTURE_2D,0,0,0,this.format,this.type,e):r.texSubImage2D(r.TEXTURE_2D,0,0,0,e.videoWidth||e.width,e.videoHeight||e.height,this.format,this.type,e);else{var s=e.videoWidth||e.width,a=e.videoHeight||e.height;(s!=this.width||a!=this.height)&&this.width!=1&&this.height!=1&&console.warn("image uploaded has a different size than texture, resizing it."),r.texImage2D(r.TEXTURE_2D,0,this.format,this.format,this.type,e),this.width=s,this.height=a}this.data=e}catch(o){throw console.error(o),location.protocol=="file:"?'image not loaded for security reasons (serve this page over "http://" instead)':"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}this.minFilter&&this.minFilter!=r.NEAREST&&this.minFilter!=r.LINEAR&&(r.generateMipmap(this.texture_type),this.has_mipmaps=!0),r.bindTexture(this.texture_type,null)},Texture.prototype.uploadData=function(e,t,r){if(t=t||{},!e)throw"no data passed";var s=this.gl;this.bind(),Texture.setUploadOptions(t,s);var a=t.mipmap_level||0,o=this.width,c=this.height;o=o>>a,c=c>>a;var f=this.internalFormat||this.format;if(this.type==n.HALF_FLOAT_OES&&e.constructor===Float32Array&&console.warn("cannot uploadData to a HALF_FLOAT texture from a Float32Array, must be Uint16Array. To upload it we recomment to create a FLOAT texture, upload data there and copy to your HALF_FLOAT."),this.texture_type==n.TEXTURE_2D)s.webgl_version==1?e.buffer&&e.buffer.constructor==ArrayBuffer?s.texImage2D(this.texture_type,a,f,o,c,0,this.format,this.type,e):s.texImage2D(this.texture_type,a,f,this.format,this.type,e):s.webgl_version==2&&(e.buffer&&e.buffer.constructor==ArrayBuffer?s.texImage2D(this.texture_type,a,f,o,c,0,this.format,this.type,e):s.texImage2D(this.texture_type,a,f,o,c,0,this.format,this.type,e));else if(this.texture_type==n.TEXTURE_3D)s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),s.texImage3D(this.texture_type,a,f,o,c,this.depth>>a,0,this.format,this.type,e);else if(this.texture_type==n.TEXTURE_CUBE_MAP)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+(t.cubemap_face||0),a,f,o,c,0,this.format,this.type,e);else throw"cannot uploadData for this texture type";this.data=e,!r&&this.minFilter&&this.minFilter!=s.NEAREST&&this.minFilter!=s.LINEAR&&(s.generateMipmap(this.texture_type),this.has_mipmaps=!0),s.bindTexture(this.texture_type,null)},Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,0,0)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}],Texture.prototype.drawTo=function(e,t){var r=this.gl,s=r.getViewport(),a=n.getTime(),o=r.getParameter(r.FRAMEBUFFER_BINDING),c=r._framebuffer=r._framebuffer||r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,c);var f=null;if(Texture.use_renderbuffer_pool){r._renderbuffers_pool||(r._renderbuffers_pool={});var p=this.width+":"+this.height;r._renderbuffers_pool[p]?(f=r._renderbuffers_pool[p],f.time=a,r.bindRenderbuffer(r.RENDERBUFFER,f)):(r._renderbuffers_pool[p]=f=r.createRenderbuffer(),f.time=a,f.width=this.width,f.height=this.height,r.bindRenderbuffer(r.RENDERBUFFER,f),setTimeout(T.bind(f),1e3*60))}else f=r._renderbuffer=r._renderbuffer||r.createRenderbuffer(),f.width=this.width,f.height=this.height,r.bindRenderbuffer(r.RENDERBUFFER,f);this.format===r.DEPTH_COMPONENT?r.renderbufferStorage(r.RENDERBUFFER,r.RGBA4,this.width,this.height):r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,this.width,this.height);function T(){n.getTime()-this.time>=1e3*60?(r.deleteRenderbuffer(r._renderbuffers_pool[p]),delete r._renderbuffers_pool[p]):setTimeout(T.bind(this),1e3*60)}if(r.viewport(0,0,this.width,this.height),r._current_texture_drawto=this,r._current_fbo_color=c,r._current_fbo_depth=f,this.texture_type==r.TEXTURE_2D)this.format!==r.DEPTH_COMPONENT?(r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.handler,0),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,f)):(r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,f),r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_2D,this.handler,0)),e(this,t);else if(this.texture_type==r.TEXTURE_CUBE_MAP){this.format!==r.DEPTH_COMPONENT?r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,f):r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,f);for(var g=0;g<6;g++)this.format!==r.DEPTH_COMPONENT?r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+g,this.handler,0):r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_CUBE_MAP_POSITIVE_X+g,this.handler,0),e(this,g,t)}return this.data=null,r._current_texture_drawto=null,r._current_fbo_color=null,r._current_fbo_depth=null,r.bindFramebuffer(r.FRAMEBUFFER,o),r.bindRenderbuffer(r.RENDERBUFFER,null),r.viewport(s[0],s[1],s[2],s[3]),this},Texture.prototype.copyTo=function(e,t,r){var s=this.gl;if(!e)throw"target_texture required";var a=s.getParameter(s.FRAMEBUFFER_BINDING),o=s.getViewport();t||(t=this.texture_type==s.TEXTURE_2D?n.Shader.getScreenShader():n.Shader.getCubemapCopyShader()),s.disable(s.BLEND),s.disable(s.DEPTH_TEST),t&&r&&t.uniforms(r);var c=s.__copy_fbo;if(c||(c=s.__copy_fbo=s.createFramebuffer()),s.bindFramebuffer(s.FRAMEBUFFER,c),s.viewport(0,0,e.width,e.height),this.texture_type==s.TEXTURE_2D)if(this.format!==s.DEPTH_COMPONENT&&this.format!==s.DEPTH_STENCIL)s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,e.handler,0),this.toViewport(t);else{var f=s._color_renderbuffer=s._color_renderbuffer||s.createRenderbuffer(),p=f.width=e.width,T=f.height=e.height;s.bindRenderbuffer(s.RENDERBUFFER,f),s.renderbufferStorage(s.RENDERBUFFER,s.RGBA4,p,T),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,f);var g=e.format==s.DEPTH_STENCIL?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;s.framebufferTexture2D(s.FRAMEBUFFER,g,s.TEXTURE_2D,e.handler,0);var N=s.checkFramebufferStatus(s.FRAMEBUFFER);if(N!==s.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+N;s.enable(s.DEPTH_TEST),s.depthFunc(s.ALWAYS),s.colorMask(!1,!1,!1,!1),t=n.Shader.getCopyDepthShader(),this.toViewport(t),s.colorMask(!0,!0,!0,!0),s.disable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,null),s.framebufferTexture2D(s.FRAMEBUFFER,g,s.TEXTURE_2D,null,0)}else if(this.texture_type==s.TEXTURE_CUBE_MAP){t.uniforms({u_texture:0});for(var A=n.temp_mat3,M=0;M<6;M++){s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+M,e.handler,0);var B=n.Texture.cubemap_camera_parameters[M];mat3.identity(A),A.set(B.right,0),A.set(B.up,3),A.set(B.dir,6),this.toViewport(t,{u_rotation:A})}}return s.setViewport(o),s.bindFramebuffer(s.FRAMEBUFFER,a),e.minFilter&&e.minFilter!=s.NEAREST&&e.minFilter!=s.LINEAR&&(e.bind(),s.generateMipmap(e.texture_type),e.has_mipmaps=!0),e.data=null,s.bindTexture(e.texture_type,null),this},Texture.prototype.blit=function(){var e=new Float32Array(4);return function(t,r,s){var a=this.gl;if(this.texture_type!=a.TEXTURE_2D||this.format===a.DEPTH_COMPONENT||this.format===a.DEPTH_STENCIL)throw"blit only support TEXTURE_2D of RGB or RGBA. use copyTo instead";var o=a.getParameter(a.FRAMEBUFFER_BINDING);e.set(a.viewport_data),r=r||n.Shader.getScreenShader(),r&&s&&r.uniforms(s);var c=a.__copy_fbo;return c||(c=a.__copy_fbo=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,c),a.viewport(0,0,t.width,t.height),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,t.handler,0),this.bind(0),r.draw(n.Mesh.getScreenQuad(),a.TRIANGLES),a.setViewport(e),a.bindFramebuffer(a.FRAMEBUFFER,o),t.data=null,a.bindTexture(t.texture_type,null),this}}(),Texture.prototype.toViewport=function(e,t){e=e||Shader.getScreenShader();var r=Mesh.getScreenQuad();this.bind(0),t&&e.uniforms(t),e.draw(r,gl.TRIANGLES)},Texture.prototype.fill=function(e,t){if(e.constructor===n.Shader){var r=e;this.drawTo(function(){r.toViewport()})}else{var s=e,a=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(s[0],s[1],s[2],s[3]),this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)}),gl.clearColor(a[0],a[1],a[2],a[3])}!t&&this.minFilter&&this.minFilter!=gl.NEAREST&&this.minFilter!=gl.LINEAR&&(this.bind(),gl.generateMipmap(this.texture_type),this.has_mipmaps=!0)},Texture.prototype.renderQuad=function(){var e=mat3.create(),t=vec2.create(),r=vec2.create(),s=vec4.fromValues(1,1,1,1);return function(a,o,c,f,p,T){t[0]=a,t[1]=o,r[0]=c,r[1]=f,p=p||Shader.getQuadShader(this.gl);var g=Mesh.getScreenQuad(this.gl);this.bind(0),p.uniforms({u_texture:0,u_position:t,u_color:s,u_size:r,u_viewport:gl.viewport_data.subarray(2,4),u_transform:e}),T&&p.uniforms(T),p.draw(g,gl.TRIANGLES)}}(),Texture.prototype.applyBlur=function(e,t,r,s,a){var o=this.gl;e===void 0&&(e=1),t===void 0&&(t=1),o.disable(o.DEPTH_TEST),o.disable(o.BLEND),s=s||this;var c=!a;if(a===s)throw"cannot use applyBlur in a texture using as temporary itself";if(s&&this.texture_type!==s.texture_type)throw"cannot use applyBlur with textures of different texture_type";var f=o.getParameter(o.FRAMEBUFFER_BINDING),p=o.getViewport(),T=o.__copy_fbo;if(T||(T=o.__copy_fbo=o.createFramebuffer()),o.bindFramebuffer(o.FRAMEBUFFER,T),o.viewport(0,0,this.width,this.height),this.texture_type===o.TEXTURE_2D){var g=n.Shader.getBlurShader();a||(a=n.Texture.getTemporary(this.width,this.height,this)),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,a.handler,0),this.toViewport(g,{u_texture:0,u_intensity:r,u_offset:[0,t/this.height]}),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,s.handler,0),o.viewport(0,0,s.width,s.height),a.toViewport(g,{u_intensity:r,u_offset:[e/a.width,0]}),c&&n.Texture.releaseTemporary(a)}else if(this.texture_type===o.TEXTURE_CUBE_MAP){var g=n.Shader.getCubemapBlurShader();g.uniforms({u_texture:0,u_intensity:r,u_offset:[e/this.width,t/this.height]}),this.bind(0);var N=Mesh.getScreenQuad();N.bindBuffers(g),g.bind();var A=null;!a&&s==this?A=a=n.Texture.getTemporary(s.width,s.height,s):A=s;for(var M=n.temp_mat3,B=0;B<6;++B){o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_CUBE_MAP_POSITIVE_X+B,A.handler,0);var O=n.Texture.cubemap_camera_parameters[B];mat3.identity(M),M.set(O.right,0),M.set(O.up,3),M.set(O.dir,6),g._setUniform("u_rotation",M),o.drawArrays(o.TRIANGLES,0,6)}N.unbindBuffers(g),a&&a.copyTo(s),a&&c&&n.Texture.releaseTemporary(a)}o.setViewport(p),o.bindFramebuffer(o.FRAMEBUFFER,f),s.data=null,s.minFilter&&s.minFilter!=o.NEAREST&&s.minFilter!=o.LINEAR&&(s.bind(),o.generateMipmap(s.texture_type),s.has_mipmaps=!0),o.bindTexture(s.texture_type,null)},Texture.fromURL=function(e,t,r,s){s=s||u.gl,t=t||{},t=Object.create(t);var a=t.texture||new n.Texture(1,1,t,s);e.length<64&&(a.url=e),a.bind();var o=t.temp_color||Texture.loading_color;s.pixelStorei(s.UNPACK_ALIGNMENT,4);var c=t.type==s.FLOAT?new Float32Array(o):new Uint8Array(o);s.texImage2D(s.TEXTURE_2D,0,a.format,a.width,a.height,0,a.format,a.type,c),s.bindTexture(a.texture_type,null),a.ready=!1;var f=null;if(t.extension&&(f=t.extension),!f&&e.length<512){var p=e,T=e.indexOf("?");T!=-1&&(p=e.substr(0,T)),T=p.lastIndexOf("."),T!=-1&&(f=p.substr(T+1).toLowerCase())}if(f=="dds"){var f=s.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||s.getExtension("WEBGL_compressed_texture_s3tc"),g=new n.Texture(0,0,t,s);m.loadDDSTextureEx(s,f,e,g.handler,!0,function(M){a.texture_type=M.texture_type,a.handler=M,delete a.ready,r&&r(a,e)})}else if(f=="tga")HttpRequest(e,null,function(A){var M=n.Texture.parseTGA(A);M&&(t.texture=a,M.flipY&&(t.no_flip=!0),M.format=="RGB"&&(a.format=s.RGB),a=n.Texture.fromMemory(M.width,M.height,M.pixels,t),delete a.ready,r&&r(a,e))},null,{binary:!0});else{var N=new Image;N.src=e,N.crossOrigin=Texture.CROSS_ORIGIN_CREDENTIALS,N.onload=function(){t.texture=a,n.Texture.fromImage(this,t),delete a.ready,r&&r(a,e)},N.onerror=function(){r&&r(null)}}return a},Texture.parseTGA=function(e){if(!e||e.constructor!==ArrayBuffer)throw"TGA: data must be ArrayBuffer";e=new Uint8Array(e);for(var t=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),r=e.subarray(0,12),s=0;s<r.length;s++)if(t[s]!=r[s])return console.error("TGA header is not valid"),null;var a=e.subarray(12,18),o={};o.width=a[1]*256+a[0],o.height=a[3]*256+a[2],o.bpp=a[4],o.bytesPerPixel=o.bpp/8,o.imageSize=o.width*o.height*o.bytesPerPixel,o.pixels=e.subarray(18,18+o.imageSize),o.pixels=new Uint8Array(o.pixels),o.flipY=(a[5]&32)==0;for(var s=0;s<o.imageSize;s+=o.bytesPerPixel){var c=o.pixels[s];o.pixels[s]=o.pixels[s+2],o.pixels[s+2]=c}return o.format=o.bpp==32?"RGBA":"RGB",o},Texture.fromImage=function(e,t){t=t||{};var r=t.texture||new n.Texture(e.width,e.height,t);return r.uploadImage(e,t),r.bind(),gl.texParameteri(r.texture_type,gl.TEXTURE_MAG_FILTER,r.magFilter||n.LINEAR),gl.texParameteri(r.texture_type,gl.TEXTURE_MIN_FILTER,r.minFilter||n.LINEAR_MIPMAP_LINEAR),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_S,r.wrapS||n.REPEAT),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_T,r.wrapT||n.REPEAT),n.isPowerOfTwo(r.width)&&n.isPowerOfTwo(r.height)||gl.webgl_version>1?t.minFilter&&t.minFilter!=gl.NEAREST&&t.minFilter!=gl.LINEAR&&(r.bind(),gl.generateMipmap(r.texture_type),r.has_mipmaps=!0):(gl.texParameteri(r.texture_type,gl.TEXTURE_MIN_FILTER,n.LINEAR),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),r.has_mipmaps=!1),gl.bindTexture(r.texture_type,null),r.data=e,t.keep_image&&(r.img=e),r},Texture.fromVideo=function(e,t){t=t||{};var r=t.texture||new n.Texture(e.videoWidth,e.videoHeight,t);return r.bind(),r.uploadImage(e,t),t.minFilter&&t.minFilter!=gl.NEAREST&&t.minFilter!=gl.LINEAR&&(r.bind(),gl.generateMipmap(r.texture_type),r.has_mipmaps=!0,r.data=e),gl.bindTexture(r.texture_type,null),r},Texture.fromTexture=function(e,t){t=t||{};var r=new n.Texture(e.width,e.height,t);return e.copyTo(r),r},Texture.prototype.clone=function(e){var t=this.getProperties();if(e)for(var r in e)t[r]=e[r];return Texture.fromTexture(this,t)},Texture.fromMemory=function(e,t,r,s){s=s||{};var a=s.texture||new n.Texture(e,t,s);return Texture.setUploadOptions(s),a.bind(),r.constructor===Array&&(s.type==gl.FLOAT?r=new Float32Array(r):s.type==n.HALF_FLOAT||s.type==n.HALF_FLOAT_OES?r=new Uint16Array(r):r=new Uint8Array(r)),gl.texImage2D(gl.TEXTURE_2D,0,a.format,e,t,0,a.format,a.type,r),a.width=e,a.height=t,a.data=r,s.minFilter&&s.minFilter!=gl.NEAREST&&s.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),a.has_mipmaps=!0),gl.bindTexture(a.texture_type,null),a},Texture.fromDDSInMemory=function(e,t){t=t||{};var r=t.texture||new n.Texture(0,0,t);n.Texture.setUploadOptions(t),r.bind();var s=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");return m.loadDDSTextureFromMemoryEx(gl,s,e,r,!0),gl.bindTexture(r.texture_type,null),r},Texture.fromShader=function(e,t,r,s){s=s||{};var a=new n.Texture(e,t,s);return a.drawTo(function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE);var o=Mesh.getScreenQuad();r.draw(o)}),a},Texture.cubemapFromImages=function(e,t){if(t=t||{},e.length!=6)throw"missing images to create cubemap";var r=e[0].width,s=e[0].height;t.texture_type=gl.TEXTURE_CUBE_MAP;var a=null;t.texture?(a=t.texture,a.width=r,a.height=s):a=new n.Texture(r,s,t),Texture.setUploadOptions(t),a.bind();try{for(var o=0;o<6;o++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,a.format,a.format,a.type,e[o]);a.data=e}catch{throw location.protocol=="file:"?'image not loaded for security reasons (serve this page over "http://" instead)':"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}return t.minFilter&&t.minFilter!=gl.NEAREST&&t.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),a.has_mipmaps=!0),a.unbind(),a},Texture.cubemapFromImage=function(e,t){if(t=t||{},e.width!=e.height/6&&e.height%6!=0&&!t.faces&&!t.is_polar)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",e.width,e.height),null;var r=e.width,s=e.height;if(t.is_polar){var N=t.size||n.nearestPowerOfTwo(e.height),a=n.Texture.fromImage(e,{ignore_pot:!0,wrap:gl.REPEAT,filter:gl.LINEAR}),o=new n.Texture(N,N,{texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGBA});if(t.texture){var c=t.texture;for(var f in o)c[f]=o[f];o=c}var p=mat3.create(),T={u_texture:0,u_rotation:p};gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND);var g=n.Shader.getPolarToCubemapShader();return o.drawTo(function(U,X){var k=n.Texture.cubemap_camera_parameters[X];mat3.identity(p),p.set(k.right,0),p.set(k.up,3),p.set(k.dir,6),a.toViewport(g,T)}),t.keep_image&&(o.img=e),o}else t.is_cross!==void 0?(t.faces=Texture.generateCubemapCrossFacesInfo(e.width,t.is_cross),r=s=e.width/4):t.faces?(r=t.width||t.faces[0].width,s=t.height||t.faces[0].height):s/=6;if(r!=s)return console.log("Texture not valid, width and height for every face must be square"),null;var N=r;t.no_flip=!0;for(var A=[],f=0;f<6;f++){var M=createCanvas(N,N),B=M.getContext("2d");t.faces?B.drawImage(e,t.faces[f].x,t.faces[f].y,t.faces[f].width||N,t.faces[f].height||N,0,0,N,N):B.drawImage(e,0,s*f,r,s,0,0,N,N),A.push(M)}var O=Texture.cubemapFromImages(A,t);return t.keep_image&&(O.img=e),O},Texture.generateCubemapCrossFacesInfo=function(e,t){t===void 0&&(t=1);var r=e/4;return[{x:2*r,y:r,width:r,height:r},{x:0,y:r,width:r,height:r},{x:t*r,y:0,width:r,height:r},{x:t*r,y:2*r,width:r,height:r},{x:r,y:r,width:r,height:r},{x:3*r,y:r,width:r,height:r}]},Texture.cubemapFromURL=function(e,t,r){t=t||{},t=Object.create(t),t.texture_type=gl.TEXTURE_CUBE_MAP;var s=t.texture||new n.Texture(1,1,t);s.bind(),Texture.setUploadOptions(t);for(var a=t.temp_color||[0,0,0,255],o=t.type==gl.FLOAT?new Float32Array(a):new Uint8Array(a),c=0;c<6;c++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,s.format,1,1,0,s.format,s.type,o);gl.bindTexture(s.texture_type,null),s.ready=!1;var f=new Image;return f.src=e,f.onload=function(){t.texture=s,s=n.Texture.cubemapFromImage(this,t),s&&delete s.ready,r&&r(s)},s},Texture.prototype.getPixels=function(e,t){t=t||0;var r=this.gl,s=r.getViewport(),a=r.getParameter(r.FRAMEBUFFER_BINDING);if(this.format==r.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";r.disable(r.DEPTH_TEST);var o=r.__copy_fbo;o||(o=r.__copy_fbo=r.createFramebuffer()),r.bindFramebuffer(r.FRAMEBUFFER,o);var c=null,f=this.width>>t,p=this.height>>t;r.viewport(0,0,f,p),this.texture_type==r.TEXTURE_2D?r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.handler,t):this.texture_type==r.TEXTURE_CUBE_MAP&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+(e||0),this.handler,t);var T=this.format==r.RGB?3:4;T=4;var g=this.type;return g==r.UNSIGNED_BYTE?c=new Uint8Array(f*p*T):g==n.HALF_FLOAT||g==n.HALF_FLOAT_OES?c=new Uint16Array(f*p*T):c=new Float32Array(f*p*T),r.readPixels(0,0,f,p,T==3?r.RGB:r.RGBA,g,c),r.bindFramebuffer(r.FRAMEBUFFER,a),r.viewport(s[0],s[1],s[2],s[3]),c},Texture.prototype.setPixels=function(e,t,r,s){var a={no_flip:t};s&&(a.cubemap_face=s),this.uploadData(e,a,r)},Texture.prototype.getCubemapPixels=function(){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap";return[this.getPixels(0),this.getPixels(1),this.getPixels(2),this.getPixels(3),this.getPixels(4),this.getPixels(5)]},Texture.prototype.setCubemapPixels=function(e,t){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap, it should be created with { texture_type: gl.TEXTURE_CUBE_MAP }";for(var r=0;r<6;++r)this.setPixels(e[r],t,r!=5,r)},Texture.prototype.toCanvas=function(e,t,r){r=r||8192;var s=this.gl,a=Math.min(this.width,r),o=Math.min(this.height,r);this.texture_type==s.TEXTURE_CUBE_MAP&&(a=a*4,o=o*3),e=e||createCanvas(a,o),e.width!=a&&(e.width=a),e.height!=o&&(e.height=o);var c=null;if(this.texture_type==s.TEXTURE_2D){if(this.width!=a||this.height!=o||this.type!=s.UNSIGNED_BYTE){var f=new n.Texture(a,o,{format:s.RGBA,filter:s.NEAREST});this.copyTo(f),c=f.getPixels()}else c=this.getPixels();var p=e.getContext("2d"),T=p.getImageData(0,0,a,o);if(T.data.set(c),p.putImageData(T,0,0),t){var f=createCanvas(a,o),g=f.getContext("2d");g.translate(0,f.height),g.scale(1,-1),g.drawImage(e,0,0,f.width,f.height),p.clearRect(0,0,p.canvas.width,p.canvas.height),p.drawImage(f,0,0)}}else if(this.texture_type==s.TEXTURE_CUBE_MAP){var N=createCanvas(this.width,this.height),g=N.getContext("2d"),A=n.Texture.generateCubemapCrossFacesInfo(e.width,1),p=e.getContext("2d");p.fillStyle="black",p.fillRect(0,0,e.width,e.height);var M=this;this.type!=s.UNSIGNED_BYTE&&(M=new n.Texture(this.width,this.height,{format:s.RGBA,texture_type:s.TEXTURE_CUBE_MAP,filter:s.NEAREST,type:s.UNSIGNED_BYTE}),this.copyTo(M));for(var B=0;B<6;B++){var T=g.getImageData(0,0,N.width,N.height);c=M.getPixels(B),T.data.set(c),g.putImageData(T,0,0),p.drawImage(N,A[B].x,A[B].y,N.width,N.height)}}return e},Texture.binary_extension="png",Texture.prototype.toBinary=function(e,t){for(var r=this.toCanvas(null,e),s=r.toDataURL(t),a=s.indexOf(","),o=s.substr(a+1),c=atob(o),f=c.length,p=new Uint8Array(f),T=0;T<f;++T)p[T]=c.charCodeAt(T);return p},Texture.prototype.toBlob=function(e,t){var r=this.toBinary(e),s=new Blob([r],{type:t||"image/png"});return s},Texture.prototype.toBlobAsync=function(e,t,r){var s=this.toCanvas(null,e);if(s.toBlob){s.toBlob(r,t);return}var a=this.toBlob(e,t);r&&r(a)},Texture.prototype.toBase64=function(e){var t=this.width,r=this.height,s=this.getPixels(),a=createCanvas(t,r),o=a.getContext("2d"),c=o.getImageData(0,0,t,r);if(c.data.set(s),o.putImageData(c,0,0),e){var f=createCanvas(t,r),p=f.getContext("2d");p.translate(0,r),p.scale(1,-1),p.drawImage(a,0,0),a=f}var T=a.toDataURL("image/png");return T},Texture.prototype.generateMetadata=function(){var e={};e.width=this.width,e.height=this.height,this.metadata=e},Texture.compareFormats=function(e,t){return!e||!t?!1:e==t?!0:!(e.width!=t.width||e.height!=t.height||e.type!=t.type||e.format!=t.format||e.texture_type!=t.texture_type)},Texture.blend=function(e,t,r,s){if(!e||!t)return!1;if(e==t)return s?e.copyTo(s):e.toViewport(),!0;gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE);var a=n.Shader.getBlendShader(),o=n.Mesh.getScreenQuad();return t.bind(1),a.uniforms({u_texture:0,u_texture2:1,u_factor:r}),s?(s.drawTo(function(){if(e==s||t==s)throw"Blend output cannot be the same as the input";e.bind(0),a.draw(o,gl.TRIANGLES)}),!0):(e.bind(0),a.draw(o,gl.TRIANGLES),!0)},Texture.cubemapToTexture2D=function(e,t,r,s,a){if(!e||e.texture_type!=gl.TEXTURE_CUBE_MAP)throw"No cubemap in convert";t=t||e.width;var o=s?e.type:gl.UNSIGNED_BYTE;a=a||0,r||(r=new n.Texture(t*2,t,{minFilter:gl.NEAREST,type:o}));var c=gl.shaders.cubemap_to_texture2D;return c||(c=gl.shaders.cubemap_to_texture2D=new n.Shader(n.Shader.SCREEN_VERTEX_SHADER,`		precision mediump float;
		#define PI 3.14159265358979323846264
		uniform samplerCube texture;		varying vec2 v_coord;		uniform float u_yaw;
		void main() {			float alpha = ((1.0 - v_coord.x) * 2.0) * PI + u_yaw;			float beta = (v_coord.y * 2.0 - 1.0) * PI * 0.5;			vec3 N = vec3( -cos(alpha) * cos(beta), sin(beta), sin(alpha) * cos(beta) );			gl_FragColor = textureCube(texture,N);		}`)),c.setUniform("u_yaw",a),r.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),e.toViewport(c)}),r},Texture.getWhiteTexture=function(e){e=e||u.gl;var t=e.textures[":white"];if(t)return t;var r=new Uint8Array([255,255,255,255]);return e.textures[":white"]=new n.Texture(1,1,{pixel_data:r})},Texture.getBlackTexture=function(e){e=e||u.gl;var t=e.textures[":black"];if(t)return t;var r=new Uint8Array([0,0,0,255]);return e.textures[":black"]=new n.Texture(1,1,{pixel_data:r})},Texture.getTemporary=function(e,t,r,s){s=s||u.gl,s._texture_pool||(s._texture_pool=[]);var a=n.TEXTURE_2D,o=Texture.DEFAULT_TYPE,c=Texture.DEFAULT_FORMAT;r&&(r.texture_type&&(a=r.texture_type),r.type&&(o=r.type),r.format&&(c=r.format));for(var f=a+":"+o+":"+e+"x"+t+":"+c,p=s._texture_pool,T=0;T<p.length;++T){var g=p[T];if(g._key==f)return p.splice(T,1),g._pool=0,g}var g=new n.Texture(e,t,{type:o,texture_type:a,format:c,filter:s.LINEAR});return g._key=f,g._pool=0,g},Texture.releaseTemporary=function(e,t){t=t||u.gl,t._texture_pool||(t._texture_pool=[]),e._pool>0&&console.warn("this texture is already in the textures pool");var r=t._texture_pool;if(r||(r=t._texture_pool=[]),e._pool=getTime(),r.push(e),r.length>20){r.sort(function(a,o){return o._pool-a._pool});var e=r.pop();e._pool=0,e.delete()}},Texture.nextPOT=function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.log(2)))};function R(e,t,r,s){if(s=s||u.gl,this.gl=s,this._context_id=s.context_id,e&&e.constructor!==Array)throw"FBO textures must be an Array";this.handler=null,this.width=-1,this.height=-1,this.color_textures=[],this.depth_texture=null,this.stencil=!!r,this._stencil_enabled=!1,this._num_binded_textures=0,this.order=null,(e&&e.length||t)&&this.setTextures(e,t),this._old_fbo_handler=null,this._old_viewport=new Float32Array(4)}n.FBO=R,R.prototype.setTextures=function(e,t,r){if(t&&t.constructor===n.Texture){if(t.format!==n.DEPTH_COMPONENT&&t.format!==n.DEPTH_STENCIL&&t.format!==n.DEPTH_COMPONENT16&&t.format!==n.DEPTH_COMPONENT24&&t.format!==n.DEPTH_COMPONENT32F)throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT, gl.DEPTH_STENCIL or gl.DEPTH_COMPONENT16/24/32F (only in webgl2)";if(t.type!=n.UNSIGNED_SHORT&&t.type!=n.UNSIGNED_INT&&t.type!=n.UNSIGNED_INT_24_8_WEBGL&&t.type!=n.FLOAT)throw"FBO Depth texture must be of type: gl.UNSIGNED_SHORT, gl.UNSIGNED_INT, gl.UNSIGNED_INT_24_8_WEBGL"}var s=this.depth_texture==t;if(s&&e){if(e.constructor!==Array)throw"FBO: color_textures parameter must be an array containing all the textures to be binded in the color";if(e.length==this.color_textures.length){for(var a=0;a<e.length;++a)if(e[a]!=this.color_textures[a]){s=!1;break}}else s=!1}if(this._stencil_enabled!==this.stencil&&(s=!1),!s){if(this.color_textures.length=e?e.length:0,e)for(var a=0;a<e.length;++a)this.color_textures[a]=e[a];this.depth_texture=t,this.update(r)}},R.prototype.update=function(e){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING),this.handler||(this.handler=gl.createFramebuffer());var t=-1,r=-1,s=null,a=null,o=this.color_textures,c=this.depth_texture;if(o&&o.length)for(var f=0;f<o.length;f++){var p=o[f];if(p.constructor!==n.Texture)throw"FBO can only bind instances of GL.Texture";if(t==-1)t=p.width;else if(t!=p.width)throw"Cannot bind textures with different dimensions";if(r==-1)r=p.height;else if(r!=p.height)throw"Cannot bind textures with different dimensions";if(s==null)s=p.type,a=p.format;else if(s!=p.type)throw"Cannot bind textures to a FBO with different pixel formats";if(p.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO"}else t=c.width,r=c.height;this.width=t,this.height=r,gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);var T=gl.extensions.WEBGL_draw_buffers;if(gl.webgl_version==1&&!T&&o&&o.length>1)throw"Rendering to several textures not supported by your browser";var g=gl.webgl_version==1?gl.FRAMEBUFFER:gl.DRAW_FRAMEBUFFER;if(gl.framebufferRenderbuffer(g,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,null),gl.framebufferRenderbuffer(g,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,null),c&&c.constructor===n.Texture){if(gl.webgl_version==1&&!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";this.stencil&&c.format!==gl.DEPTH_STENCIL&&console.warn("Stencil cannot be enabled if there is a depth texture with a DEPTH_STENCIL format"),c.format==gl.DEPTH_STENCIL?gl.framebufferTexture2D(g,gl.DEPTH_STENCIL_ATTACHMENT,gl.TEXTURE_2D,c.handler,0):gl.framebufferTexture2D(g,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,c.handler,0)}else{var N=null;c&&c.constructor===WebGLRenderbuffer&&c.width==t&&c.height==r?N=this._depth_renderbuffer=c:(N=this._depth_renderbuffer=this._depth_renderbuffer||gl.createRenderbuffer(),N.width=t,N.height=r),gl.bindRenderbuffer(gl.RENDERBUFFER,N),this.stencil?(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,t,r),gl.framebufferRenderbuffer(g,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,N)):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,t,r),gl.framebufferRenderbuffer(g,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,N))}if(o&&o.length){this.order=[];for(var f=0;f<o.length;f++){var p=o[f];gl.framebufferTexture2D(g,gl.COLOR_ATTACHMENT0+f,gl.TEXTURE_2D,p.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+f)}}else{var A=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer();A.width=t,A.height=r,gl.bindRenderbuffer(gl.RENDERBUFFER,A),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,t,r),gl.framebufferRenderbuffer(g,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,A)}for(var M=o?o.length:0,f=M;f<this._num_binded_textures;++f)gl.framebufferTexture2D(g,gl.COLOR_ATTACHMENT0+f,gl.TEXTURE_2D,null,0);this._num_binded_textures=M,this._stencil_enabled=this.stencil,o&&o.length>1&&(T?T.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order));var B=gl.checkFramebufferStatus(g);if(B!==gl.FRAMEBUFFER_COMPLETE)throw a==n.RGB&&(s==n.FLOAT||s==n.HALF_FLOAT_OES)&&console.error("Tip: Firefox does not support RGB channel float/half_float textures, you must use RGBA"),"FBO not complete: "+B;gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),e||gl.bindFramebuffer(g,this._old_fbo_handler)},R.prototype.bind=function(e){if(this.multi_sample){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING),this._old_viewport.set(gl.viewport_data),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,this.colorRenderbuffer),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer),gl.viewport(0,0,this.width,this.height),R.current=this;return}if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data),e?this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING):this._old_fbo_handler=null,this._old_fbo_handler!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);for(var t=0;t<this.color_textures.length;++t)this.color_textures[t]._in_current_fbo=!0;this.depth_texture&&(this.depth_texture._in_current_fbo=!0),gl.viewport(0,0,this.width,this.height),R.current=this},R.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler),this._old_fbo_handler=null,gl.setViewport(this._old_viewport);for(var e=0;e<this.color_textures.length;++e)this.color_textures[e]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1),R.current=null},R.prototype.switchTo=function(e){e._old_fbo_handler=this._old_fbo_handler,e._old_viewport.set(this._old_viewport),gl.bindFramebuffer(gl.FRAMEBUFFER,e.handler),this._old_fbo_handler=null,gl.viewport(0,0,this.width,this.height);for(var t=0;t<this.color_textures.length;++t)this.color_textures[t]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);for(var t=0;t<e.color_textures.length;++t)e.color_textures[t]._in_current_fbo=!0;e.depth_texture&&(e.depth_texture._in_current_fbo=!0),R.current=e},R.prototype.delete=function(){gl.deleteFramebuffer(this.handler),this.handler=null},R.supported={},R.testSupport=function(e,t){var r=e+":"+t;if(R.supported[r]!=null)return R.supported[r];var s=new n.Texture(1,1,{format:t,type:e});try{var a=new n.FBO([s])}catch{return console.warn("This browser WEBGL implementation doesn't support this FBO format: "+n.reverse[e]+" "+n.reverse[t]),R.supported[r]=!1}return R.supported[r]=!0,!0},R.prototype.toSingle=function(e){if(e=e||0,!(this.color_textures.length<2)){var t=gl.extensions.WEBGL_draw_buffers;t?t.drawBuffersWEBGL([this.order[e]]):gl.drawBuffers([this.order[e]])}},R.prototype.toMulti=function(){if(!(this.color_textures.length<2)){var e=gl.extensions.WEBGL_draw_buffers;e?e.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}},R.prototype.clearSecondary=function(e){if(!(!this.order||this.order.length<2)){for(var t=gl.extensions.WEBGL_draw_buffers,r=[gl.NONE],s=1;s<this.order.length;++s)r.push(this.order[s]);t?t.drawBuffersWEBGL(r):gl.drawBuffers(r),gl.clearColor(e[0],e[1],e[2],e[3]),gl.clear(gl.COLOR_BUFFER_BIT),t?t.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}},R.prototype.makeMultiSample=function(e,t,r,s){if(this.gl.webgl_version==1)throw"cannot use makeMultiSample in webgl 1.0";this.width=e,this.height=t,r=r||4,s=s||{};var a=s.format||gl.RGBA8,o=gl.DEPTH_COMPONENT16;this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING),this.handler=gl.createFramebuffer(),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),this.colorRenderbuffer=gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,this.colorRenderbuffer),gl.renderbufferStorageMultisample(gl.RENDERBUFFER,r,a,this.width,this.height),this.depthRenderbuffer=gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthRenderbuffer),gl.renderbufferStorageMultisample(gl.RENDERBUFFER,r,o,this.width,this.height),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,this.colorRenderbuffer),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer),gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler),this._old_fbo_handler=null,this.multi_sample=!0},R.prototype.blitMultisample=function(e){if(!e||e.constructor!==n.FBO)throw"parameter must be GL.FBO";gl.bindFramebuffer(gl.READ_FRAMEBUFFER,this.handler),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,e.handler),gl.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,gl.COLOR_BUFFER_BIT,gl.LINEAR),gl.bindFramebuffer(gl.READ_FRAMEBUFFER,null),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler),this._old_fbo_handler=null,gl.setViewport(this._old_viewport)},u.Shader=n.Shader=function e(t,r,s){if(n.debug&&console.log("GL.Shader created"),!t||!r)throw"GL.Shader source code parameter missing";this._context_id=u.gl.context_id;var a=this.gl=u.gl,o=e.expandMacros(s),c=t.constructor===String?e.injectCode(o,t,a):t,f=r.constructor===String?e.injectCode(o,r,a):r;this.program=a.createProgram();var p=t.constructor===String?n.Shader.compileSource(a.VERTEX_SHADER,c):t,T=r.constructor===String?n.Shader.compileSource(a.FRAGMENT_SHADER,f):r;a.attachShader(this.program,p,a),a.attachShader(this.program,T,a),a.linkProgram(this.program),this.vs_shader=p,this.fs_shader=T,this.attributes={},this.uniformInfo={},this.samplers={},e.use_async?this._first_use=!0:this.checkLink()},Shader.use_async=!0,Shader.expandMacros=function(e){var t="";if(e)for(var r in e)t+="#define "+r+" "+(e[r]?e[r]:"")+`
`;return t},Shader.injectCode=function(e,t,r){var s=t.indexOf(`
`),a=r?"#define WEBGL"+r.webgl_version+`
`:"",o=t.substr(0,s).trim();return o.indexOf("#version")==-1?a+e+t:o+`
`+a+e+t.substr(s)},Shader.compileSource=function(e,t,r,s){return r=r||u.gl,s=s||r.createShader(e),r.shaderSource(s,t),r.compileShader(s),s},Shader.parseError=function(e,t,r){if(!e)return null;var s=e.split(" "),a=s[5].split(":");return{type:s[0],line_number:parseInt(a[1]),line_pos:parseInt(a[0]),line_code:(s[0]=="Fragment"?r:t).split(`
`)[parseInt(a[1])],err:e}},Shader.prototype.delete=function(){this.program&&this.gl.deleteProgram(this.program),this.vs_shader&&this.gl.deleteShader(this.vs_shader),this.fs_shader&&this.gl.deleteShader(this.fs_shader),this.gl=null,this.attributes={},this.uniformInfo={},this.samplers={}},Shader.prototype.updateShader=function(e,t,r){var s=this.gl||u.gl,a=Shader.expandMacros(r);this.program?(s.detachShader(this.program,this.vs_shader),s.detachShader(this.program,this.fs_shader)):this.program=s.createProgram();var a=Shader.expandMacros(r),o=e.constructor===String?Shader.injectCode(a,e,s):e,c=t.constructor===String?Shader.injectCode(a,t,s):t,f=e.constructor===String?n.Shader.compileSource(s.VERTEX_SHADER,o):e,p=t.constructor===String?n.Shader.compileSource(s.FRAGMENT_SHADER,c):t;s.attachShader(this.program,f,s),s.attachShader(this.program,p,s),s.linkProgram(this.program),this.vs_shader=f,this.fs_shader=p,this.attributes={},this.uniformInfo={},this.samplers={},Shader.use_async?this._first_use=!0:this.checkLink()},Shader.prototype.extractShaderInfo=function(){for(var e=this.gl,t=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS),r=0;r<t;++r){var s=e.getActiveUniform(this.program,r);if(!s)break;var a=s.name,o=a.indexOf("[");if(o!=-1){var c=a.indexOf("].");c==-1&&(a=a.substr(0,o))}(s.type==n.SAMPLER_2D||s.type==n.SAMPLER_CUBE||s.type==n.SAMPLER_3D||s.type==n.INT_SAMPLER_2D||s.type==n.INT_SAMPLER_CUBE||s.type==n.INT_SAMPLER_3D||s.type==n.UNSIGNED_INT_SAMPLER_2D||s.type==n.UNSIGNED_INT_SAMPLER_CUBE||s.type==n.UNSIGNED_INT_SAMPLER_3D)&&(this.samplers[a]=s.type);var f=Shader.getUniformFunc(s),p=!1;(s.type==e.FLOAT_MAT2||s.type==e.FLOAT_MAT3||s.type==e.FLOAT_MAT4)&&(p=!0);var T=n.TYPE_LENGTH[s.type]||1;this.uniformInfo[a]={type:s.type,func:f,size:s.size,type_length:T,is_matrix:p,loc:e.getUniformLocation(this.program,a),data:new Float32Array(T*s.size)}}for(var r=0,t=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES);r<t;++r){var s=e.getActiveAttrib(this.program,r);if(!s)break;var f=Shader.getUniformFunc(s),T=n.TYPE_LENGTH[s.type]||1;this.uniformInfo[s.name]={type:s.type,func:f,type_length:T,size:s.size,loc:null},this.attributes[s.name]=e.getAttribLocation(this.program,s.name)}},Shader.prototype.hasUniform=function(e){return this.uniformInfo[e]},Shader.prototype.hasAttribute=function(e){return this.attributes[e]},Shader.getUniformFunc=function(e){var t=null;switch(e.type){case n.FLOAT:e.size==1?t=gl.uniform1f:t=gl.uniform1fv;break;case n.FLOAT_MAT2:t=gl.uniformMatrix2fv;break;case n.FLOAT_MAT3:t=gl.uniformMatrix3fv;break;case n.FLOAT_MAT4:t=gl.uniformMatrix4fv;break;case n.FLOAT_VEC2:t=gl.uniform2fv;break;case n.FLOAT_VEC3:t=gl.uniform3fv;break;case n.FLOAT_VEC4:t=gl.uniform4fv;break;case n.UNSIGNED_INT:case n.INT:e.size==1?t=gl.uniform1i:t=gl.uniform1iv;break;case n.INT_VEC2:t=gl.uniform2iv;break;case n.INT_VEC3:t=gl.uniform3iv;break;case n.INT_VEC4:t=gl.uniform4iv;break;case n.SAMPLER_2D:case n.SAMPLER_3D:case n.SAMPLER_CUBE:case n.INT_SAMPLER_2D:case n.INT_SAMPLER_3D:case n.INT_SAMPLER_CUBE:case n.UNSIGNED_INT_SAMPLER_2D:case n.UNSIGNED_INT_SAMPLER_3D:case n.UNSIGNED_INT_SAMPLER_CUBE:t=gl.uniform1i;break;default:t=gl.uniform1f;break}return t},Shader.fromURL=function(e,t,r){var s=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute mat4 u_mvp;
			void main() { 
				gl_Position = u_mvp * vec4(a_vertex,1.0); 
			}
		`,a=`
			precision highp float;
			void main() {
				gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
			`,o=new n.Shader(s,a);o.ready=!1;var c=null,f=null;HttpRequest(e,null,function(T){c=T,f&&p()}),HttpRequest(t,null,function(T){f=T,c&&p()});function p(){var T=new n.Shader(c,f);for(var g in T)o[g]=T[g];o.ready=!0}return o},Shader.prototype.checkLink=function(){if(this._first_use=!1,!gl.getShaderParameter(this.vs_shader,gl.COMPILE_STATUS))throw"Vertex shader compile error: "+gl.getShaderInfoLog(this.vs_shader);if(!gl.getShaderParameter(this.fs_shader,gl.COMPILE_STATUS))throw"Fragment shader compile error: "+gl.getShaderInfoLog(this.fs_shader);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS))throw"link error: "+gl.getProgramInfoLog(this.program);this.extractShaderInfo()},Shader.prototype.bind=function(){var e=this.gl;Shader.use_async&&this._first_use&&(this.checkLink(),this._first_use=!1),e.useProgram(this.program),e._current_shader=this},Shader.prototype.getLocation=function(e){var t=this.uniformInfo[e];return t?this.uniformInfo[e].loc:null},Shader._temp_uniform=new Float32Array(16),Shader.prototype.uniforms=function(e){var t=this.gl;this._first_use&&this.checkLink(),t.useProgram(this.program),t._current_shader=this;for(var r in e){var s=this.uniformInfo[r];s&&this._setUniform(r,e[r])}return this},Shader.prototype.uniformsArray=function(e){var t=this.gl;this._first_use&&this.checkLink(),t.useProgram(this.program),t._current_shader=this;for(var r=0,s=e.length;r<s;++r){var a=e[r];for(var o in a)this._setUniform(o,a[o])}return this},Shader.prototype.setUniform=function(){return function(e,t){this.gl._current_shader!=this&&this.bind();var r=this.uniformInfo[e];r&&r.loc!==null&&t!=null&&(t.constructor===Array&&(r.data.set(t),t=r.data),r.is_matrix?r.func.call(this.gl,r.loc,!1,t):r.func.call(this.gl,r.loc,t))}}(),Shader.prototype._setUniform=function(){return function(e,t){this._first_use&&this.checkLink();var r=this.uniformInfo[e];r&&r.loc!==null&&t!=null&&(t.constructor===Array&&(r.data.set(t),t=r.data),r.is_matrix?r.func.call(this.gl,r.loc,!1,t):r.func.call(this.gl,r.loc,t))}}(),Shader.prototype.draw=function(e,t,r){r=r===void 0?t==gl.LINES?"lines":"triangles":r,this.drawBuffers(e.vertexBuffers,r?e.indexBuffers[r]:null,arguments.length<2?gl.TRIANGLES:t)},Shader.prototype.drawRange=function(e,t,r,s,a){a=a===void 0?t==gl.LINES?"lines":"triangles":a,this.drawBuffers(e.vertexBuffers,a?e.indexBuffers[a]:null,t,r,s)};var C=new Uint8Array(16),G=new Uint8Array(16);Shader.prototype.drawBuffers=function(e,t,r,s,a){if(a!=0){var o=this.gl;this._first_use&&this.checkLink(),o.useProgram(this.program);var c=0,f=C;f.set(G);for(var p in e){var T=e[p],g=T.attribute||p,N=this.attributes[g];N==null||!T.buffer||(f[N]=1,o.bindBuffer(o.ARRAY_BUFFER,T.buffer),o.enableVertexAttribArray(N),o.vertexAttribPointer(N,T.buffer.spacing,T.buffer.gl_type,T.normalize,0,0),c=T.buffer.length/T.buffer.spacing)}var A=0;s>0&&(A=s),t&&(c=t.buffer.length-A),a>0&&a<c&&(c=a);var M=t&&t.data?t.data.constructor.BYTES_PER_ELEMENT:1;A*=M;for(var g in this.attributes){var N=this.attributes[g];f[N]||o.disableVertexAttribArray(this.attributes[g])}return c&&(!t||t.buffer)&&(t?(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t.buffer),o.drawElements(r,c,t.buffer.gl_type,A),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null)):o.drawArrays(r,A,c),o.draw_calls++),this}},Shader._instancing_arrays=[],Shader.prototype.drawInstanced=function(e,t,r,s,a,o,c){if(o!==0){var f=this.gl;if(f.webgl_version==1&&!f.extensions.ANGLE_instanced_arrays)throw"instancing not supported";this._first_use&&this.checkLink(),f.useProgram(this.program);var p=0,T=C;T.set(G);var g=e.vertexBuffers;for(var N in g){var A=g[N],M=A.attribute||N,B=this.attributes[M];B==null||!A.buffer||(T[B]=1,f.bindBuffer(f.ARRAY_BUFFER,A.buffer),f.enableVertexAttribArray(B),f.vertexAttribPointer(B,A.buffer.spacing,A.buffer.gl_type,A.normalize,0,0),p=A.buffer.length/A.buffer.spacing)}var O=null;r&&(r.constructor===String?O=e.getIndexBuffer(r):r.constructor===n.Buffer&&(O=r));var P=0;a>0&&(P=a),O&&(p=O.buffer.length-P),o>0&&o<p&&(p=o);var U=O&&O.data?O.data.constructor.BYTES_PER_ELEMENT:1;P*=U;for(var M in this.attributes){var B=this.attributes[M];T[B]||f.disableVertexAttribArray(this.attributes[M])}var X=f.extensions.ANGLE_instanced_arrays,k=0,V=0;for(var J in s){var te=s[J];k=te.length;var F=this.attributes[J];if(F==null)return;var Q=0,ee=0;te.constructor===Array?(Q=te[0].constructor===Number?1:te[0].length,ee=Q*te.length):(Q=this.uniformInfo[J].type_length,ee=te.length,k=ee/Q);var K=Shader._instancing_arrays[V];if((!K||K.data.length<ee)&&(K=Shader._instancing_arrays[V]={data:new Float32Array(ee),buffer:f.createBuffer()}),K.uniform=J,K.element_size=Q,te.constructor===Array)for(var z=0;z<te.length;++z)K.data.set(te[z],z*Q);else K.data.set(te);if(f.bindBuffer(f.ARRAY_BUFFER,K.buffer),f.bufferData(f.ARRAY_BUFFER,K.data,f.STREAM_DRAW),Q==16)for(var q=0;q<4;++q)f.enableVertexAttribArray(F+q),f.vertexAttribPointer(F+q,4,f.FLOAT,!1,16*4,q*4*4),X?X.vertexAttribDivisorANGLE(F+q,1):f.vertexAttribDivisor(F+q,1);else f.enableVertexAttribArray(F),f.vertexAttribPointer(F,Q,f.FLOAT,!1,Q*4,0),X?X.vertexAttribDivisorANGLE(F,1):f.vertexAttribDivisor(F,1);V+=1}c&&(k=c),X?O?(f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,O.buffer),X.drawElementsInstancedANGLE(t,p,O.buffer.gl_type,P,k),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null)):X.drawArraysInstancedANGLE(t,P,p,k):O?(f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,O.buffer),f.drawElementsInstanced(t,p,O.buffer.gl_type,P,k),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null)):f.drawArraysInstanced(t,P,p,k);for(var ie=0;ie<V;++ie){var j=Shader._instancing_arrays[ie],F=this.attributes[j.uniform],Q=j.element_size;if(Q==16)for(var q=0;q<4;++q)f.disableVertexAttribArray(F+q),X?X.vertexAttribDivisorANGLE(F+q,0):f.vertexAttribDivisor(F+q,0);else f.enableVertexAttribArray(F),X?X.vertexAttribDivisorANGLE(F,0):f.vertexAttribDivisor(F,0)}return this}},Shader.expandImports=function(e,t){t=t||Shader.files;var r={};if(!t)throw"Shader.files not initialized, assign files there";var s=function(a){var o=a.split('"'),c=o[1];if(r[c])return"//already imported: "+c+`
`;var f=t[c];return r[c]=!0,f?f+`
`:"//import code not found: "+c+`
`};return e.replace(/#import\s+\"([a-zA-Z0-9_\.]+)\"\s*\n/g,s)},Shader.dumpErrorToConsole=function(e,t,r){console.error(e),e.msg;var s=null;e.indexOf("Fragment")!=-1?s=r:s=t;var a=s.split(`
`);for(var o in a)a[o]=o+"| "+a[o];console.groupCollapsed("Shader code"),console.log(a.join(`
`)),console.groupEnd()},Shader.convertTo100=function(e,t){},Shader.convertTo300=function(e,t){},Shader.validateValue=function(e,t){if(e==null)return!1;switch(t.type){case n.INT:case n.FLOAT:case n.SAMPLER_2D:case n.SAMPLER_3D:case n.SAMPLER_CUBE:case n.INT_SAMPLER_2D:case n.INT_SAMPLER_3D:case n.INT_SAMPLER_CUBE:case n.UNSIGNED_INT_SAMPLER_2D:case n.UNSIGNED_INT_SAMPLER_3D:case n.UNSIGNED_INT_SAMPLER_CUBE:return isNumber(e);case n.INT_VEC2:case n.FLOAT_VEC2:return e.length===2;case n.INT_VEC3:case n.FLOAT_VEC3:return e.length===3;case n.INT_VEC4:case n.FLOAT_VEC4:case n.FLOAT_MAT2:return e.length===4;case n.FLOAT_MAT3:return e.length===8;case n.FLOAT_MAT4:return e.length===16}return!0},Shader.DEFAULT_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec3 a_normal;
			attribute vec2 a_coord;
			varying vec3 v_position;
			varying vec3 v_normal;
			varying vec2 v_coord;
			uniform mat4 u_model;
			uniform mat4 u_mvp;
			void main() {
				v_position = (u_model * vec4(a_vertex,1.0)).xyz;
				v_normal = (u_model * vec4(a_normal,0.0)).xyz;
				v_coord = a_coord;
				gl_Position = u_mvp * vec4(a_vertex,1.0);
			}
			`,Shader.SCREEN_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			void main() { 
				v_coord = a_coord; 
				gl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); 
			}
			`,Shader.SCREEN_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = texture2D(u_texture, v_coord);
			}
			`,Shader.SCREEN_FRAGMENT_FX=`
			precision highp float;
			uniform sampler2D u_texture;
			varying vec2 v_coord;
			#ifdef FX_UNIFORMS
				FX_UNIFORMS
			#endif
			void main() {
				vec2 uv = v_coord;
				vec4 color = texture2D(u_texture, uv);
				#ifdef FX_CODE
					FX_CODE ;
				#endif
				gl_FragColor = color;
			}
			`,Shader.SCREEN_COLORED_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = u_color * texture2D(u_texture, v_coord);
			}
			`,Shader.BLEND_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform sampler2D u_texture2;
			uniform float u_factor;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);
			}
			`,Shader.QUAD_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			uniform vec2 u_position;
			uniform vec2 u_size;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			void main() { 
				vec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);
				v_coord = a_coord; 
				pos = u_transform * pos;
				pos.z = 0.0;
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
			}
			`,Shader.QUAD_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = u_color * texture2D(u_texture, v_coord);
			}
			`,Shader.QUAD2_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			uniform vec4 u_texture_area;
			varying vec2 v_coord;
			void main() {
			    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );
				gl_FragColor = u_color * texture2D(u_texture, uv);
			}
			`,Shader.PRIMITIVE2D_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			void main() { 
				vec3 pos = a_vertex;
				pos = u_transform * pos;
				pos.z = 0.0;
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
			}
			`,Shader.FLAT_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			uniform mat4 u_mvp;
			void main() { 
				gl_Position = u_mvp * vec4(a_vertex,1.0); 
			}
			`,Shader.FLAT_FRAGMENT_SHADER=`
			precision highp float;
			uniform vec4 u_color;
			void main() {
				gl_FragColor = u_color;
			}
			`,Shader.SCREEN_FLAT_FRAGMENT_SHADER=Shader.FLAT_FRAGMENT_SHADER,Shader.createFX=function(e,t,r){e=n.Shader.removeComments(e,!0),t=n.Shader.removeComments(t,!0);var s={FX_CODE:e,FX_UNIFORMS:t||""};return r?(r.updateShader(n.Shader.SCREEN_VERTEX_SHADER,n.Shader.SCREEN_FRAGMENT_FX,s),r):new n.Shader(n.Shader.SCREEN_VERTEX_SHADER,n.Shader.SCREEN_FRAGMENT_FX,s)},Shader.replaceCodeUsingContext=function(e,t){return e.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(r){return r=r.replace(/[\{\}]/g,""),t[r]||""})},Shader.removeComments=function(s,t){if(!s)return"";for(var r=/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(\/\/.*)/g,s=s.replace(r,""),a=s.split(`
`),o=[],c=0;c<a.length;++c){var f=a[c],p=f.indexOf("//");p!=-1&&(f=a[c].substr(0,p)),f=f.trim(),f.length&&o.push(f)}return o.join(t?"":`
`)},Shader.prototype.toViewport=function(e){var t=n.Mesh.getScreenQuad();e&&this.uniforms(e),this.draw(t)},Shader.getScreenShader=function(e){e=e||u.gl;var t=e.shaders[":screen"];return t||(t=e.shaders[":screen"]=new n.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER),t.uniforms({u_texture:0}))},Shader.getFlatScreenShader=function(e){e=e||u.gl;var t=e.shaders[":flat_screen"];return t||(t=e.shaders[":flat_screen"]=new n.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER),t.uniforms({u_color:[1,1,1,1]}))},Shader.getColoredScreenShader=function(e){e=e||u.gl;var t=e.shaders[":colored_screen"];return t||(t=e.shaders[":colored_screen"]=new n.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER),t.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)}))},Shader.getQuadShader=function(e){e=e||u.gl;var t=e.shaders[":quad"];return t||(e.shaders[":quad"]=new n.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER))},Shader.getPartialQuadShader=function(e){e=e||u.gl;var t=e.shaders[":quad2"];return t||(e.shaders[":quad2"]=new n.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER))},Shader.getBlendShader=function(e){e=e||u.gl;var t=e.shaders[":blend"];return t||(e.shaders[":blend"]=new n.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.BLEND_FRAGMENT_SHADER))},Shader.getBlurShader=function(e){e=e||u.gl;var t=e.shaders[":blur"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_offset;
			uniform float u_intensity;
			void main() {
			   vec4 sum = vec4(0.0);
			   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;
			   sum += texture2D(u_texture, v_coord) * 0.16/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;
			   gl_FragColor = u_intensity * sum;
			}
			`);return e.shaders[":blur"]=t},Shader.getCopyDepthShader=function(e){e=e||u.gl;var t=e.shaders[":copy_depth"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			#extension GL_EXT_frag_depth : enable
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			void main() {
			   gl_FragDepthEXT = texture2D( u_texture, v_coord ).x;
			   gl_FragColor = vec4(1.0);
			}
			`);return e.shaders[":copy_depth"]=t},Shader.getCubemapShowShader=function(e){e=e||u.gl;var t=e.shaders[":show_cubemap"];if(t)return t;var t=new n.Shader(Shader.DEFAULT_VERTEX_SHADER,`
			precision highp float;
			varying vec3 v_normal;
			uniform samplerCube u_texture;
			void main() {
			   gl_FragColor = textureCube( u_texture, v_normal );
			}
			`);return t.uniforms({u_texture:0}),e.shaders[":show_cubemap"]=t},Shader.getPolarToCubemapShader=function(e){e=e||u.gl;var t=e.shaders[":polar_to_cubemap"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform mat3 u_rotation;
			void main() {
				vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );
				vec3 dir = normalize( vec3( uv - vec2(0.5), 0.5 ));
				dir = u_rotation * dir;
				float u = atan(dir.x,dir.z) / 6.28318531;
				float v = (asin(dir.y) / 1.57079633) * 0.5 + 0.5;
				u = mod(u,1.0);
				v = mod(v,1.0);
			   gl_FragColor = texture2D( u_texture, vec2(u,v) );
			}
			`);return e.shaders[":polar_to_cubemap"]=t},Shader.getCubemapCopyShader=function(e){e=e||u.gl;var t=e.shaders[":copy_cubemap"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform samplerCube u_texture;
			uniform mat3 u_rotation;
			void main() {
				vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );
				vec3 dir = vec3( uv - vec2(0.5), 0.5 );
				dir = u_rotation * dir;
			   gl_FragColor = textureCube( u_texture, dir );
			}
			`);return e.shaders[":copy_cubemap"]=t},Shader.getCubemapBlurShader=function(e){e=e||u.gl;var t=e.shaders[":blur_cubemap"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			#ifndef NUM_SAMPLES
				#define NUM_SAMPLES 4
			#endif
			
			precision highp float;
			varying vec2 v_coord;
			uniform samplerCube u_texture;
			uniform mat3 u_rotation;
			uniform vec2 u_offset;
			uniform float u_intensity;
			void main() {
				vec4 sum = vec4(0.0);
				vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);
				vec3 dir = vec3(0.0);
				vec4 color = vec4(0.0);
				for( int x = -2; x <= 2; x++ )
				{
					for( int y = -2; y <= 2; y++ )
					{
						dir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;
						dir.z = 0.5;
						dir = u_rotation * dir;
						color = textureCube( u_texture, dir );
						color.xyz = color.xyz * color.xyz;/*linearize*/
						sum += color;
					}
				}
				sum /= 25.0;
			   gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;
			}
			`);return e.shaders[":blur_cubemap"]=t},Shader.FXAA_FUNC=`
	uniform vec2 u_viewportSize;
	uniform vec2 u_iViewportSize;
	#define FXAA_REDUCE_MIN   (1.0/ 128.0)
	#define FXAA_REDUCE_MUL   (1.0 / 8.0)
	#define FXAA_SPAN_MAX     8.0
	
	/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */
	/* fragCoord MUST BE IN PIXELS */
	vec4 applyFXAA(sampler2D tex, vec2 fragCoord)
	{
		vec4 color = vec4(0.0);
		/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/
		vec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;
		vec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;
		vec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;
		vec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;
		vec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;
		vec3 luma = vec3(0.299, 0.587, 0.114);
		float lumaNW = dot(rgbNW, luma);
		float lumaNE = dot(rgbNE, luma);
		float lumaSW = dot(rgbSW, luma);
		float lumaSE = dot(rgbSE, luma);
		float lumaM  = dot(rgbM,  luma);
		float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
		float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));
		
		vec2 dir;
		dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
		dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));
		
		float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
		
		float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
		dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;
		
		vec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + 
			texture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);
		vec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + 
			texture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);
		
		//return vec4(rgbA,1.0);
		float lumaB = dot(rgbB, luma);
		if ((lumaB < lumaMin) || (lumaB > lumaMax))
			color = vec4(rgbA, 1.0);
		else
			color = vec4(rgbB, 1.0);
		return color;
	}
`,Shader.getFXAAShader=function(e){e=e||u.gl;var t=e.shaders[":fxaa"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			`+Shader.FXAA_FUNC+`
			
			void main() {
			   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;
			}
			`),r=vec2.fromValues(e.viewport_data[2],e.viewport_data[3]),s=vec2.fromValues(1/e.viewport_data[2],1/e.viewport_data[3]);return t.setup=function(){r[0]=e.viewport_data[2],r[1]=e.viewport_data[3],s[0]=1/e.viewport_data[2],s[1]=1/e.viewport_data[3],this.uniforms({u_viewportSize:r,u_iViewportSize:s})},e.shaders[":fxaa"]=t},Shader.getFlatShader=function(e){e=e||u.gl;var t=e.shaders[":flat"];if(t)return t;var t=new n.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);return t.uniforms({u_color:[1,1,1,1]}),e.shaders[":flat"]=t},n.create=function(e){e=e||{};var t=null;if(e.canvas)if(typeof e.canvas=="string"){if(t=document.getElementById(e.canvas),!t)throw"Canvas element not found: "+e.canvas}else t=e.canvas;else{var r=null;if(e.container&&(r=e.container.constructor===String?document.querySelector(e.container):e.container),r&&!e.width){var s=r.getBoundingClientRect();e.width=s.width,e.height=s.height}t=createCanvas(e.width||800,e.height||600),r&&r.appendChild(t)}"alpha"in e||(e.alpha=!1);var a=null,o=null;if(e.version==2?o=["webgl2","experimental-webgl2"]:e.version==1||e.version===void 0?o=["webgl","experimental-webgl"]:e.version===0&&(o=["webgl2","experimental-webgl2","webgl","experimental-webgl"]),!o)throw"Incorrect WebGL version, must be 1 or 2";for(var c={alpha:e.alpha===void 0?!0:e.alpha,depth:e.depth===void 0?!0:e.depth,stencil:e.stencil===void 0?!0:e.stencil,antialias:e.antialias===void 0?!0:e.antialias,premultipliedAlpha:e.premultipliedAlpha===void 0?!0:e.premultipliedAlpha,preserveDrawingBuffer:e.preserveDrawingBuffer===void 0?!0:e.preserveDrawingBuffer},f=0;f<o.length;++f){try{a=t.getContext(o[f],c)}catch{}if(a)break}if(!a)throw t.getContext("webgl")?"WebGL supported but not with those parameters":"WebGL not supported";a.webgl_version=a.constructor.name==="WebGL2RenderingContext"?2:1,u.gl=a,t.is_webgl=!0,t.gl=a,a.context_id=this.last_context_id++,a.extensions={};for(var p=a.getSupportedExtensions(),f=0;f<p.length;++f)a.extensions[p[f]]=a.getExtension(p[f]);if(a.webgl_version==1?a.HIGH_PRECISION_FORMAT=a.extensions.OES_texture_half_float?n.HALF_FLOAT_OES:a.extensions.OES_texture_float?n.FLOAT:n.UNSIGNED_BYTE:a.HIGH_PRECISION_FORMAT=n.HALF_FLOAT_OES,a.max_texture_units=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS),a._viewport_func?console.warn("Creating LiteGL context over the same canvas twice"):(a._viewport_func=a.viewport,a.viewport_data=new Float32Array([0,0,a.canvas.width,a.canvas.height]),a.viewport=function(F,Q,ee,K){var z=this.viewport_data;z[0]=F|0,z[1]=Q|0,z[2]=ee|0,z[3]=K|0,this._viewport_func(F,Q,ee,K)},a.getViewport=function(F){return F?(F[0]=a.viewport_data[0],F[1]=a.viewport_data[1],F[2]=a.viewport_data[2],F[3]=a.viewport_data[3],F):new Float32Array(a.viewport_data)},a.setViewport=function(F,Q){a.viewport_data.set(F),Q&&(a.viewport_data[1]=this.drawingBufferHeight-F[1]-F[3]),this._viewport_func(F[0],a.viewport_data[1],F[2],F[3])}),!n.reverse){n.reverse={};for(var f in a)a[f]&&a[f].constructor===Number&&(n.reverse[a[f]]=f)}if(window.glMatrix==null)throw"glMatrix not found, LiteGL requires glMatrix to be included";var T=0;a.shaders={},a.textures={},a.meshes={},a.draw_calls=0,a.makeCurrent=function(){u.gl=this},a.execute=function(F){var Q=u.gl;u.gl=this,F(),u.gl=Q},a.animate=function(F){if(F===!1){u.cancelAnimationFrame(this._requestFrame_id),this._requestFrame_id=null;return}var Q=u.requestAnimationFrame,ee=getTime(),K=this,z=0;function q(){if(!a.destroyed){K._requestFrame_id=Q(q);var ie=getTime(),j=(ie-ee)*.001;if(K.mouse&&(K.mouse.last_buttons=z),z=K.mouse.buttons,K.onupdate&&K.onupdate(j),D.trigger(K,"update",j),K.ondraw){var se=u.gl;u.gl=K,K.ondraw(),D.trigger(K,"draw"),u.gl=se}ee=ie}}this._requestFrame_id=Q(q)},a.destroy=function(){k&&(document.removeEventListener("keydown",k),document.removeEventListener("keyup",k)),A&&(this.canvas.removeEventListener("mousedown",A),this.canvas.removeEventListener("mousemove",A),this.canvas.removeEventListener("mouseup",A),this.canvas.addEventListener("drag",A),this.canvas.addEventListener("dragstart",A),this.canvas.addEventListener("wheel",A));for(var F in this.shaders)this.shaders[F].delete(),this.shaders[F]=null;this.shaders={};for(var F in this.meshes)this.meshes[F].deleteBuffers(),this.meshes[F]=null;this.meshes={};for(var F in this.textures)this.textures[F].delete(),this.textures[F]=null;this.textures={},this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.destroyed=!0,u.gl==this&&(u.gl=null)};var g=a.mouse={buttons:0,last_buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,clientx:0,clienty:0,isInsideRect:function(F,Q,ee,K,z){var q=this.y;return z&&(q=a.canvas.height-q),this.x>F&&this.x<F+ee&&q>Q&&q<Q+K},isButtonPressed:function(F){if(F==n.LEFT_MOUSE_BUTTON)return this.buttons&n.LEFT_MOUSE_BUTTON_MASK;if(F==n.MIDDLE_MOUSE_BUTTON)return this.buttons&n.MIDDLE_MOUSE_BUTTON_MASK;if(F==n.RIGHT_MOUSE_BUTTON)return this.buttons&n.RIGHT_MOUSE_BUTTON_MASK},wasButtonPressed:function(F){var Q=0;return F==n.LEFT_MOUSE_BUTTON?Q=n.LEFT_MOUSE_BUTTON_MASK:F==n.MIDDLE_MOUSE_BUTTON?Q=n.MIDDLE_MOUSE_BUTTON_MASK:F==n.RIGHT_MOUSE_BUTTON&&(Q=n.RIGHT_MOUSE_BUTTON_MASK),this.buttons&Q&&!(this.last_buttons&Q)}};a.captureMouse=function(F,Q){t.addEventListener("mousedown",N),t.addEventListener("mousemove",N),t.addEventListener("drag",N),t.addEventListener("dragstart",N),F&&(t.addEventListener("mousewheel",N,!1),t.addEventListener("wheel",N,!1)),t.addEventListener("contextmenu",function(ee){return ee.preventDefault(),!1}),Q&&this.captureTouch(!0)};function N(F){if(!a.ignore_events){var Q=a.mouse.buttons;n.augmentEvent(F,t),F.eventType=F.eventType||F.type;var ee=getTime();if(g.dragging=F.dragging,g.position[0]=F.canvasx,g.position[1]=F.canvasy,g.x=F.canvasx,g.y=F.canvasy,g.mousex=F.mousex,g.mousey=F.mousey,g.canvasx=F.canvasx,g.canvasy=F.canvasy,g.clientx=F.mousex,g.clienty=F.mousey,g.buttons=F.buttons,g.left_button=!!(g.buttons&n.LEFT_MOUSE_BUTTON_MASK),g.middle_button=!!(g.buttons&n.MIDDLE_MOUSE_BUTTON_MASK),g.right_button=!!(g.buttons&n.RIGHT_MOUSE_BUTTON_MASK),F.eventType=="mousedown"){if(Q==0){t.removeEventListener("mousemove",N);var K=t.ownerDocument;K.addEventListener("mousemove",N),K.addEventListener("mouseup",N)}T=ee,a.onmousedown&&a.onmousedown(F),D.trigger(a,"mousedown")}else if(F.eventType=="mousemove")a.onmousemove&&a.onmousemove(F),D.trigger(a,"mousemove",F);else if(F.eventType=="mouseup"){if(a.mouse.buttons==0){t.addEventListener("mousemove",N);var K=t.ownerDocument;K.removeEventListener("mousemove",N),K.removeEventListener("mouseup",N)}F.click_time=ee-T,a.onmouseup&&a.onmouseup(F),D.trigger(a,"mouseup",F)}else F.eventType=="mousewheel"||F.eventType=="wheel"||F.eventType=="DOMMouseScroll"?(F.eventType="mousewheel",F.type=="wheel"?F.wheel=-F.deltaY:F.wheel=F.wheelDeltaY!=null?F.wheelDeltaY:F.detail*-60,F.delta=F.wheelDelta!==void 0?F.wheelDelta/40:F.deltaY?-F.deltaY/3:0,a.onmousewheel&&a.onmousewheel(F),D.trigger(a,"mousewheel",F)):F.eventType=="dragstart"&&(a.ondragstart&&a.ondragstart(F),D.trigger(a,"dragstart",F));if(a.onmouse&&a.onmouse(F),!F.skip_preventDefault)return F.eventType!="mousemove"&&F.stopPropagation(),F.preventDefault(),!1}}var A=N,M=!1;if(typeof Hammer<"u"){var B=new Hammer.Manager(t),O=new Hammer.Pinch({threshold:.3});B&&O&&(B.add(O),B.on("pinch",P))}function P(F){var Q=F.srcEvent,ee="wheel",K=document.createEvent("MouseEvent");K.initMouseEvent(ee,!0,!0,window,1,Q.screenX,Q.screenY,Q.clientX,Q.clientY,!1,!1,!1,!1,0,null),K.originalEvent=K,K.is_touch=!0;var z=!1;F.additionalEvent==="pinchin"?(K.deltaY=1,z=!0):F.additionalEvent==="pinchout"&&(K.deltaY=-1,z=!0),z&&(K.pinchScaling=F.distance*.0312,Q.target.dispatchEvent(K)),Q.preventDefault()}a.captureTouch=function(F){M=F,t.addEventListener("touchstart",U,!0),t.addEventListener("touchmove",U,!0),t.addEventListener("touchend",U,!0),t.addEventListener("touchcancel",U,!0),t.addEventListener("gesturestart",X),t.addEventListener("gesturechange",X),t.addEventListener("gestureend",X)};function U(F){var Q=F.changedTouches,ee=Q[0],K="";if(!(a.ontouch&&a.ontouch(F)===!0)&&D.trigger(a,F.type,F)!==!0&&M&&!(F.touches.length&&F.changedTouches[0].identifier!==F.touches[0].identifier)&&!(Q>1)){switch(F.type){case"touchstart":K="mousedown";break;case"touchmove":K="mousemove";break;case"touchend":K="mouseup";break;default:return}var z=document.createEvent("MouseEvent");z.initMouseEvent(K,!0,!0,window,1,ee.screenX,ee.screenY,ee.clientX,ee.clientY,!1,!1,!1,!1,0,null),z.originalEvent=z,z.is_touch=!0,ee.target.dispatchEvent(z),F.preventDefault()}}function X(F){F.eventType=F.type,!(a.ongesture&&a.ongesture(F)===!1)&&D.trigger(a,F.type,F)!==!1&&F.preventDefault()}a.keys={};var k=null;a.captureKeys=function(F,Q){if(k)return;a.keys={},Q&&a.canvas,document.addEventListener("keydown",ee),document.addEventListener("keyup",ee);function ee(K){V(K,F)}k=ee};function V(F,Q){F.eventType=F.type;var ee=F.target.nodeName.toLowerCase();if(!(ee==="input"||ee==="textarea"||ee==="select"||F.target.contentEditable==="true")){F.character=String.fromCharCode(F.keyCode).toLowerCase();var K=!1,z=n.mapKeyCode(F.keyCode);z||(z=F.character);var q=F.altKey||F.ctrlKey||F.metaKey;q||(z&&(a.keys[z]=F.type=="keydown"),K=a.keys[F.keyCode],a.keys[F.keyCode]=F.type=="keydown"),(K!=a.keys[F.keyCode]||q)&&(F.type=="keydown"&&a.onkeydown?a.onkeydown(F):F.type=="keyup"&&a.onkeyup&&a.onkeyup(F),D.trigger(a,F.type,F)),a.onkey&&a.onkey(F),Q&&(F.isChar||n.blockable_keys[F.keyIdentifier||F.key])&&F.preventDefault()}}a.gamepads=null,a.captureGamepads=function(){var F=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;F&&(this.gamepads=F.call(navigator))},a.getGamepads=function(F){var Q=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(Q){var ee=Q.call(navigator);this.gamepads||(this.gamepads=[]);for(var K=0;K<4;K++){var z=ee[K];if(z&&!F&&J(z),z&&!z.prev_buttons){z.prev_buttons=new Uint8Array(32);var q=new CustomEvent("gamepadconnected");q.eventType=q.type,q.gamepad=z,this.ongamepadconnected&&this.ongamepadconnected(q),D.trigger(a,"gamepadconnected",q)}if(z)for(var ie=0;ie<z.buttons.length;++ie){var j=z.buttons[ie];if(j.was_pressed=!1,j.pressed&&!z.prev_buttons[ie]){j.was_pressed=!0;var q=new CustomEvent("gamepadButtonDown");q.eventType=q.type,q.button=j,q.which=ie,q.gamepad=z,a.onbuttondown&&a.onbuttondown(q),D.trigger(a,"buttondown",q)}else if(!j.pressed&&z.prev_buttons[ie]){var q=new CustomEvent("gamepadButtonUp");q.eventType=q.type,q.button=j,q.which=ie,q.gamepad=z,a.onbuttondown&&a.onbuttondown(q),D.trigger(a,"buttonup",q)}z.prev_buttons[ie]=j.pressed?1:0}}return this.gamepads=ee,ee}};function J(F){var Q=F.xbox||{axes:[],buttons:{},hat:""};Q.axes.lx=F.axes[0],Q.axes.ly=F.axes[1],Q.axes.rx=F.axes[2],Q.axes.ry=F.axes[3],Q.axes.triggers=F.axes[4];for(var ee=0;ee<F.buttons.length;ee++)switch(ee){case 0:Q.buttons.a=F.buttons[ee].pressed;break;case 1:Q.buttons.b=F.buttons[ee].pressed;break;case 2:Q.buttons.x=F.buttons[ee].pressed;break;case 3:Q.buttons.y=F.buttons[ee].pressed;break;case 4:Q.buttons.lb=F.buttons[ee].pressed;break;case 5:Q.buttons.rb=F.buttons[ee].pressed;break;case 6:Q.buttons.lt=F.buttons[ee].pressed;break;case 7:Q.buttons.rt=F.buttons[ee].pressed;break;case 8:Q.buttons.back=F.buttons[ee].pressed;break;case 9:Q.buttons.start=F.buttons[ee].pressed;break;case 10:Q.buttons.ls=F.buttons[ee].pressed;break;case 11:Q.buttons.rs=F.buttons[ee].pressed;break;case 12:F.buttons[ee].pressed&&(Q.hat+="up");break;case 13:F.buttons[ee].pressed&&(Q.hat+="down");break;case 14:F.buttons[ee].pressed&&(Q.hat+="left");break;case 15:F.buttons[ee].pressed&&(Q.hat+="right");break;case 16:Q.buttons.home=F.buttons[ee].pressed;break}F.xbox=Q}a.fullscreen=function(){var F=this.canvas;F.requestFullScreen?F.requestFullScreen():F.webkitRequestFullScreen?F.webkitRequestFullScreen():F.mozRequestFullScreen?F.mozRequestFullScreen():console.error("Fullscreen not supported")},a.snapshot=function(F,Q,ee,K,z){var q=createCanvas(ee,K),le=q.getContext("2d"),ie=le.getImageData(0,0,q.width,q.height),j=new Uint8Array(ee*K*4);if(a.readPixels(F,Q,q.width,q.height,a.RGBA,a.UNSIGNED_BYTE,j),ie.data.set(j),le.putImageData(ie,0,0),z)return q;var se=createCanvas(ee,K),le=se.getContext("2d");return le.translate(0,K),le.scale(1,-1),le.drawImage(q,0,0),se};var te={};return a.loadTexture=function(F,Q,ee){if(this.textures[F])return this.textures[F];if(te[F])return null;var K=new Image;return K.url=F,K.onload=function(){var z=n.Texture.fromImage(this,Q);z.img=this,a.textures[this.url]=z,delete te[this.url],ee&&ee(z)},K.src=F,te[F]=!0,null},a.drawTexture=function(){var F=mat3.create(),Q=vec2.create(),ee=vec2.create(),K=vec4.create(),z=vec4.fromValues(1,1,1,1),q=vec2.create(),ie={u_texture:0,u_position:Q,u_color:z,u_size:ee,u_texture_area:K,u_viewport:q,u_transform:F};return function(j,se,le,ue,he,ve,I,W,Z,$,re){Q[0]=se,Q[1]=le,ue===void 0&&(ue=j.width),he===void 0&&(he=j.height),ee[0]=ue,ee[1]=he,ve===void 0&&(ve=0),I===void 0&&(I=0),W===void 0&&(W=j.width),Z===void 0&&(Z=j.height),K[0]=ve/j.width,K[1]=I/j.height,K[2]=(ve+W)/j.width,K[3]=(I+Z)/j.height,q[0]=this.viewport_data[2],q[1]=this.viewport_data[3],$=$||Shader.getPartialQuadShader(this);var ae=Mesh.getScreenQuad(this);j.bind(0),$.uniforms(ie),re&&$.uniforms(re),$.draw(ae,a.TRIANGLES)}}(),a.canvas.addEventListener("webglcontextlost",function(F){F.preventDefault(),a.context_lost=!0,a.onlosecontext&&a.onlosecontext(F)},!1),a.reset=function(){a.viewport(0,0,this.canvas.width,this.canvas.height),a.disable(a.BLEND),a.disable(a.CULL_FACE),a.disable(a.DEPTH_TEST),a.frontFace(a.CCW),a._current_texture_drawto=null,a._current_fbo_color=null,a._current_fbo_depth=null},a.dump=function(){console.log("userAgent: ",navigator.userAgent),console.log("Supported extensions:");var F=a.getSupportedExtensions();console.log(F.join(","));var Q=["VENDOR","VERSION","MAX_VERTEX_ATTRIBS","MAX_VARYING_VECTORS","MAX_VERTEX_UNIFORM_VECTORS","MAX_VERTEX_TEXTURE_IMAGE_UNITS","MAX_FRAGMENT_UNIFORM_VECTORS","MAX_TEXTURE_SIZE","MAX_TEXTURE_IMAGE_UNITS"];console.log("WebGL info:");for(var ee in Q)console.log(" * "+Q[ee]+": "+a.getParameter(a[Q[ee]]));console.log("*************************************************")},a.reset(),a},n.mapKeyCode=function(e){var t={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",33:"PAGEUP",34:"PAGEDOWN",35:"END",36:"HOME",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};return t[e]||(e>=65&&e<=90?String.fromCharCode(e):null)},n.dragging=!1,n.last_pos=[0,0],n.augmentEvent=function(e,t){var r=null;t=t||e.target||gl.canvas,r=t.getBoundingClientRect(),e.mousex=e.clientX-r.left,e.mousey=e.clientY-r.top,e.canvasx=e.mousex,e.canvasy=r.height-e.mousey,e.deltax=0,e.deltay=0,e.is_touch&&(gl.mouse.buttons=e.which),document.pointerLockElement===t&&(e.canvasx=e.mousex=r.width*.5,e.canvasy=e.mousey=r.height*.5),e.type=="mousedown"?this.dragging=!0:e.type=="mousemove"||e.type=="mouseup"&&e.buttons==0&&(this.dragging=!1),e.movementX!==void 0&&!e.is_touch&&!n.isMobile()?(e.deltax=e.movementX,e.deltay=e.movementY):(e.deltax=e.mousex-this.last_pos[0],e.deltay=e.mousey-this.last_pos[1]),this.last_pos[0]=e.mousex,this.last_pos[1]=e.mousey,e.dragging=this.dragging,e.leftButton=!!(gl.mouse.buttons&n.LEFT_MOUSE_BUTTON_MASK),e.middleButton=!!(gl.mouse.buttons&n.MIDDLE_MOUSE_BUTTON_MASK),e.rightButton=!!(gl.mouse.buttons&n.RIGHT_MOUSE_BUTTON_MASK),e.buttons_mask=0,e.leftButton&&(e.buttons_mask=1),e.middleButton&&(e.buttons_mask|=2),e.rightButton&&(e.buttons_mask|=4),e.isButtonPressed=function(s){return this.buttons_mask&1<<s}},n.isMobile=function(){return this.mobile!==void 0?this.mobile:u.navigator?navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/SamsungBrowser/i)||navigator.userAgent.match(/Mobile\ VR/i)||navigator.userAgent.match(/Android/i)?this.mobile=!0:this.mobile=!1:this.mobile=!1};var D=u.LEvent=n.LEvent={bind:function(e,t,r,s){if(!e)throw"cannot bind event to null";if(!r)throw"cannot bind to null callback";if(e.constructor===String)throw"cannot bind event to a string";var a=e.__levents;a||(Object.defineProperty(e,"__levents",{value:{},enumerable:!1}),a=e.__levents),a.hasOwnProperty(t)?a[t].push([r,s]):a[t]=[[r,s]],e.onLEventBinded&&e.onLEventBinded(t,r,s)},unbind:function(e,t,r,s){if(!e)throw"cannot unbind event to null";if(!r)throw"cannot unbind from null callback";if(e.constructor===String)throw"cannot bind event to a string";var a=e.__levents;if(a&&a.hasOwnProperty(t)){for(var o=0,c=a[t].length;o<c;++o){var f=a[t][o];if(f[0]===r&&f[1]===s){a[t].splice(o,1);break}}a[t].length==0&&delete a[t],e.onLEventUnbinded&&e.onLEventUnbinded(t,r,s)}},unbindAll:function(e,t,r){if(!e)throw"cannot unbind events in null";var s=e.__levents;if(s){if(e.onLEventUnbindAll&&e.onLEventUnbindAll(t,r),!t){delete e.__levents;return}for(var a in s)for(var o=s[a],c=o.length-1;c>=0;--c)o[c][1]!=t||r&&r!==o[c][0]||o.splice(c,1)}},unbindAllEvent:function(e,t){if(!e)throw"cannot unbind events in null";var r=e.__levents;r&&(delete r[t],e.onLEventUnbindAll&&e.onLEventUnbindAll(t,target_instance,callback))},isBind:function(e,t,r,s){if(!e)throw"LEvent cannot have null as instance";var a=e.__levents;if(a){if(!a.hasOwnProperty(t))return!1;for(var o=0,c=a[t].length;o<c;++o){var f=a[t][o];if(f[0]===r&&f[1]===s)return!0}return!1}},hasBind:function(e,t){if(!e)throw"LEvent cannot have null as instance";var r=e.__levents;return!(!r||!r.hasOwnProperty(t)||!r[t].length)},hasBindTo:function(e,t){if(!e)throw"LEvent cannot have null as instance";var r=e.__levents;if(!r)return!1;for(var s in r)for(var a=r[s],o=0;o<a.length;++o)if(a[o][1]===t)return!0;return!1},trigger:function(e,t,r,s,a){if(!e)throw"cannot trigger event from null";if(e.constructor===String)throw"cannot bind event to a string";var o=e.__levents;if(!o||!o.hasOwnProperty(t))return!1;var c=o[t];if(s)for(var f=c.length-1;f>=0;--f){var p=c[f];if(a){if(p&&p[0].apply(p[1],r)===!0)return!0}else if(p&&p[0].call(p[1],t,r)===!0)return!0}else for(var f=0,T=c.length;f<T;++f){var p=c[f];if(a){if(p&&p[0].apply(p[1],r)===!0)return!0}else if(p&&p[0].call(p[1],t,r)===!0)return!0}return!1},triggerArray:function(e,t,r,s,a){for(var o=!1,c=0,f=e.length;c<f;++c){var p=e[c];if(!p)throw"cannot trigger event from null";if(p.constructor===String)throw"cannot bind event to a string";var T=p.__levents;if(!(!T||!T.hasOwnProperty(t)))if(s)for(var g=T[t].length-1;g>=0;--g){var N=T[t][g];if(a){if(N[0].apply(N[1],r)===!0){o=!0;break}}else if(N[0].call(N[1],t,r)===!0){o=!0;break}}else for(var g=0,A=T[t].length;g<A;++g){var N=T[t][g];if(a){if(N[0].apply(N[1],r)===!0){o=!0;break}}else if(N[0].call(N[1],t,r)===!0){o=!0;break}}}return o},extendObject:function(e){e.bind=function(t,r,s){return D.bind(this,t,r,s)},e.trigger=function(t,r){return D.trigger(this,t,r)},e.unbind=function(t,r,s){return D.unbind(this,t,r,instance)},e.unbindAll=function(t,r){return D.unbindAll(this,t,r)}},extendClass:function(e){this.extendObject(e.prototype)}};u.CLIP_INSIDE=n.CLIP_INSIDE=0,u.CLIP_OUTSIDE=n.CLIP_OUTSIDE=1,u.CLIP_OVERLAP=n.CLIP_OVERLAP=2,u.geo={last_t:-1,createPlane:function(e,t){return new Float32Array([t[0],t[1],t[2],-vec3.dot(e,t)])},planeFromTriangle:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s,a,o,c){return vec3.sub(e,o,a),vec3.sub(t,c,a),vec3.cross(r,e,t),vec3.normalize(r,r),s[0]=r[0],s[1]=r[1],s[2]=r[2],s[3]=-vec3.dot(a,r),s}}(),computeTriangleNormal:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s,a,o,c){return vec3.sub(e,o,a),vec3.sub(t,c,a),vec3.cross(r,e,t),vec3.normalize(r,r),s[0]=r[0],s[1]=r[1],s[2]=r[2],s}}(),distancePointToPlane:function(e,t){return(vec3.dot(e,t)+t[3])/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},distance2PointToPlane:function(e,t){return(vec3.dot(e,t)+t[3])/(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},projectPointOnLine:function(){var e=vec3.create(),t=vec3.create();return function(r,s,a,o){o=o||vec3.create(),vec3.sub(e,r,s),vec3.sub(t,a,s);var c=vec3.dot(e,t)/vec3.dot(t,t);return o[0]=s[0]+c*t[0],o[1]=s[1]+c*t[1],o[2]=s[2]+c*t[2],o}}(),project2DPointOnLine:function(e,t,r,s){s=s||vec2.create();var a=vec2.fromValues(e[0]-t[0],e[1]-t[1]),o=vec2.fromValues(r[0]-t[0],r[1]-t[1]),c=vec2.dot(a,o)/vec2.dot(o,o);return s[0]=t[0]+c*o[0],s[1]=t[1]+c*o[1],s},closestPointToSegment:function(){var e=vec3.create(),t=vec3.create();return function(r,s,a,o){o=o||vec3.create(),vec3.sub(e,r,s),vec3.sub(t,a,s);var c=vec3.dot(e,t)/vec3.dot(t,t);return c=Math.min(1,Math.max(0,c)),o[0]=s[0]+c*t[0],o[1]=s[1]+c*t[1],o[2]=s[2]+c*t[2],o}}(),projectPointOnPlane:function(){var e=vec3.create();return function(t,r,s,a){a=a||vec3.create(),vec3.sub(e,t,r);var o=vec3.dot(e,s);return vec3.scale(e,s,o),vec3.sub(a,t,e)}}(),isPointInsideTriangle:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create(),o=vec3.create();return function(c,f,p,T){return vec3.sub(e,f,c),vec3.sub(t,p,c),vec3.sub(r,T,c),vec3.cross(s,t,r),vec3.cross(a,r,e),vec3.cross(o,e,t),!(vec3.dot(s,a)<0||vec3.dot(s,o)<0)}}(),reflectPointInPlane:function(e,t,r){var s=-1*(t[0]*r[0]+t[1]*r[1]+t[2]*r[2]),a=-(s+r[0]*e[0]+r[1]*e[1]+r[2]*e[2])/(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);return vec3.fromValues(e[0]+a*r[0]*2,e[1]+a*r[1]*2,e[2]+a*r[2]*2)},testRayPlane:function(e,t,r,s,a){var o=vec3.dot(r,s),c=o-vec3.dot(s,e),f=vec3.dot(s,t);if(Math.abs(f)<EPSILON)return!1;var p=this.last_t=c/f;return p<0?!1:(a&&vec3.add(a,e,vec3.scale(a,t,p)),!0)},testSegmentPlane:function(){var e=vec3.create();return function(t,r,s,a,o){var c=vec3.dot(s,a),f=c-vec3.dot(a,t),p=vec3.sub(e,r,t),T=vec3.dot(a,p);if(Math.abs(T)<EPSILON)return!1;var g=this.last_t=f/T;return g<0||g>1?!1:(o&&vec3.add(o,t,vec3.scale(o,p,g)),!0)}}(),testRaySphere:function(){var e=vec3.create();return function(t,r,s,a,o,c){var f=vec3.subtract(e,t,s),p=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],T=2*f[0]*r[0]+2*f[1]*r[1]+2*f[2]*r[2],g=f[0]*f[0]+f[1]*f[1]+f[2]*f[2]-a*a,N=T*T-4*p*g;if(N<0)return!1;if(o){var A=Math.sqrt(N),M=1/(2*p),B=(-T+A)*M,O=(-T-A)*M,P=B<O?B:O;if(c!==void 0&&P>c)return!1;this.last_t=P,vec3.add(o,t,vec3.scale(o,r,P))}return!0}}(),hitTestTriangle:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create();return function(o,c,f,p,T,g){vec3.subtract(e,p,f),vec3.subtract(t,T,f),vec3.cross(r,e,t),vec3.normalize(r,r);var N=vec3.dot(r,vec3.subtract(s,f,o))/vec3.dot(r,c);if(N>0){vec3.add(a,o,vec3.scale(s,c,N));var A=vec3.subtract(s,s,f),M=vec3.dot(t,t),B=vec3.dot(t,e),O=vec3.dot(t,A),P=vec3.dot(e,e),U=vec3.dot(e,A),X=M*P-B*B,k=(P*O-B*U)/X,V=(M*U-B*O)/X;if(k>=0&&V>=0&&k+V<=1)return this.last_t=N,g&&vec3.add(g,o,vec3.scale(s,c,N)),!0}return!1}}(),testRayCylinder:function(e,t,r,s,a,o){var c=vec3.clone(e),f=vec3.add(vec3.create(),e,vec3.scale(vec3.create(),t,1e5)),p=0,T=vec3.subtract(vec3.create(),s,r),g=vec3.subtract(vec3.create(),c,r),N=vec3.subtract(vec3.create(),f,c),A=vec3.dot(g,T),M=vec3.dot(N,T),B=vec3.dot(T,T);if(A<0&&A+M<0||A>B&&A+M>B)return!1;var O=vec3.dot(N,N),P=vec3.dot(g,N),U=B*O-M*M,X=vec3.dot(g,g)-a*a,k=B*X-A*A;if(Math.abs(U)<EPSILON)return k>0?!1:(A<0?p=-P/O:A>B?p=(M-P)/O:p=0,o&&vec3.add(o,c,vec3.scale(o,N,p)),!0);var V=B*P-M*A,J=V*V-U*k;return J<0||(p=(-V-Math.sqrt(J))/U,p<0||p>1)?!1:A+p*M<0?M<=0?!1:(p=-A/M,o&&vec3.add(o,c,vec3.scale(o,N,p)),X+2*p*(P+p*O)<=0):A+p*M>B?M>=0?!1:(p=(B-A)/M,o&&vec3.add(o,c,vec3.scale(o,N,p)),X+B-2*A+p*(2*(P-M)+p*O)<=0):(this.last_t=p,o&&vec3.add(o,c,vec3.scale(o,N,p)),!0)},testRayBox:function(){var e=new Float32Array(3),t=new Float32Array(3),r=new Float32Array(3);return function(s,a,o,c,f,p){p=p||Number.MAX_VALUE;var T=!0,g=0,N;for(e.fill(0),r.fill(0),t.fill(0),g=0;g<3;++g)s[g]<o[g]?(e[g]=1,t[g]=o[g],T=!1):s[g]>c[g]?(e[g]=0,t[g]=c[g],T=!1):e[g]=2;if(T)return this.last_t=0,f&&vec3.copy(f,s),!0;for(g=0;g<3;++g)e[g]!=2&&a[g]!=0?r[g]=(t[g]-s[g])/a[g]:r[g]=-1;for(N=0,g=1;g<3;g++)r[N]<r[g]&&(N=g);if(r[N]<0||r[N]>p)return!1;for(this.last_t=r[N],g=0;g<3;++g)if(N!=g){var A=s[g]+r[N]*a[g];if(A<o[g]||A>c[g])return!1;f&&(f[g]=A)}else f&&(f[g]=t[g]);return!0}}(),testRayBBox:function(){var e=mat4.create(),t=vec3.create(),r=vec3.create();return function(s,a,o,c,f,p,T){if(!s||!a||!o)throw"parameters missing";c&&(mat4.invert(e,c),vec3.add(t,s,a),s=vec3.transformMat4(r,s,e),vec3.transformMat4(t,t,e),vec3.sub(t,t,s),a=vec3.normalize(t,t));var g=this.testRayBox(s,a,o.subarray(6,9),o.subarray(9,12),f,p);return!T&&c&&f&&vec3.transformMat4(f,f,c),g}}(),testPointBBox:function(e,t){return!(e[0]<t[6]||e[0]>t[9]||e[1]<t[7]||e[0]>t[10]||e[2]<t[8]||e[0]>t[11])},testBBoxBBox:function(e,t){var r=Math.abs(t[0]-e[0]);if(r>e[3]+t[3])return!1;var s=Math.abs(t[1]-e[1]);if(s>e[4]+t[4])return!1;var a=Math.abs(t[2]-e[2]);if(a>e[5]+t[5])return!1;var o=BBox.getMin(t);if(geo.testPointBBox(o,e)){var c=BBox.getMax(t);if(geo.testPointBBox(c,e))return!0}return!0},testSphereBBox:function(e,t,r){for(var s,a=0,o=BBox.getMin(r),c=BBox.getMax(r),f=0;f<3;++f)e[f]<o[f]?(s=e[f]-o[f],a+=s*s):e[f]>c[f]&&(s=e[f]-c[f],a+=s*s);var p=t*t;return a<=p},closestPointBetweenLines:function(e,t,r,s,a,o){var c=vec3.subtract(vec3.create(),t,e),f=vec3.subtract(vec3.create(),s,r),p=vec3.subtract(vec3.create(),e,r),T=vec3.dot(c,c),g=vec3.dot(c,f),N=vec3.dot(f,f),A=vec3.dot(c,p),M=vec3.dot(f,p),B=T*N-g*g,O,P;B<EPSILON?(O=0,P=g>N?A/g:M/N):(O=(g*M-N*A)/B,P=(T*M-g*A)/B),a&&vec3.add(a,e,vec3.scale(vec3.create(),c,O)),o&&vec3.add(o,r,vec3.scale(vec3.create(),f,P));var U=vec3.add(vec3.create(),p,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),c,O),vec3.scale(vec3.create(),f,P)));return vec3.length(U)},extractPlanes:function(e,r){var r=r||new Float32Array(24);return r.set([e[3]-e[0],e[7]-e[4],e[11]-e[8],e[15]-e[12]],0),s(0),r.set([e[3]+e[0],e[7]+e[4],e[11]+e[8],e[15]+e[12]],4),s(4),r.set([e[3]+e[1],e[7]+e[5],e[11]+e[9],e[15]+e[13]],8),s(8),r.set([e[3]-e[1],e[7]-e[5],e[11]-e[9],e[15]-e[13]],12),s(12),r.set([e[3]-e[2],e[7]-e[6],e[11]-e[10],e[15]-e[14]],16),s(16),r.set([e[3]+e[2],e[7]+e[6],e[11]+e[10],e[15]+e[14]],20),s(20),r;function s(a){var o=r.subarray(a,a+3),c=vec3.length(o);c!==0&&(c=1/c,r[a]*=c,r[a+1]*=c,r[a+2]*=c,r[a+3]*=c)}},frustumTestBox:function(e,t){var r=0,s=0;return r=planeBoxOverlap(e.subarray(0,4),t),r==CLIP_OUTSIDE||(s+=r,r=planeBoxOverlap(e.subarray(4,8),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(e.subarray(8,12),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(e.subarray(12,16),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(e.subarray(16,20),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(e.subarray(20,24),t),r==CLIP_OUTSIDE)?CLIP_OUTSIDE:(s+=r,s==0?CLIP_INSIDE:CLIP_OVERLAP)},frustumTestSphere:function(e,t,r){var s,a=!1;return s=distanceToPlane(e.subarray(0,4),t),s<-r||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(e.subarray(4,8),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(e.subarray(8,12),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(e.subarray(12,16),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(e.subarray(16,20),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(e.subarray(20,24),t),s<-r)?CLIP_OUTSIDE:(s>=-r&&s<=r&&(a=!0),a?CLIP_OVERLAP:CLIP_INSIDE)},testPoint2DInPolygon:function(e,t){for(var r=!1,s=-1,a=e.length,o=a-1;++s<a;o=s)(e[s][1]<=t[1]&&t[1]<e[o][1]||e[o][1]<=t[1]&&t[1]<e[s][1])&&t[0]<(e[o][0]-e[s][0])*(t[1]-e[s][1])/(e[o][1]-e[s][1])+e[s][0]&&(r=!r);return r}},u.BBox=n.BBox={center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:[vec3.fromValues(1,1,1),vec3.fromValues(1,1,-1),vec3.fromValues(1,-1,1),vec3.fromValues(1,-1,-1),vec3.fromValues(-1,1,1),vec3.fromValues(-1,1,-1),vec3.fromValues(-1,-1,1),vec3.fromValues(-1,-1,-1)],create:function(){return new Float32Array(13)},clone:function(e){return new Float32Array(e)},copy:function(e,t){return e.set(t),e},fromPoint:function(e){var t=this.create();return t.set(e,0),t.set(e,6),t.set(e,9),t},fromMinMax:function(e,t){var r=this.create();return this.setMinMax(r,e,t),r},fromCenterHalfsize:function(e,t){var r=this.create();return this.setCenterHalfsize(r,e,t),r},fromPoints:function(e){var t=this.create();return this.setFromPoints(t,e),t},setFromPoints:function(e,t){var r=e.subarray(6,9),s=e.subarray(9,12);r[0]=t[0],r[1]=t[1],r[2]=t[2],s.set(r);for(var a=3,o=t.length;a<o;a+=3){var c=t[a],f=t[a+1],p=t[a+2];c<r[0]?r[0]=c:c>s[0]&&(s[0]=c),f<r[1]?r[1]=f:f>s[1]&&(s[1]=f),p<r[2]?r[2]=p:p>s[2]&&(s[2]=p)}return e[0]=(r[0]+s[0])*.5,e[1]=(r[1]+s[1])*.5,e[2]=(r[2]+s[2])*.5,e[3]=s[0]-e[0],e[4]=s[1]-e[1],e[5]=s[2]-e[2],e[12]=Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]),e},setMinMax:function(e,t,r){e[6]=t[0],e[7]=t[1],e[8]=t[2],e[9]=r[0],e[10]=r[1],e[11]=r[2];var s=e.subarray(3,6);return vec3.sub(s,r,t),vec3.scale(s,s,.5),e[0]=r[0]-s[0],e[1]=r[1]-s[1],e[2]=r[2]-s[2],e[12]=vec3.length(e.subarray(3,6)),e},setCenterHalfsize:function(e,t,r,s){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=r[0],e[4]=r[1],e[5]=r[2],e[6]=e[0]-e[3],e[7]=e[1]-e[4],e[8]=e[2]-e[5],e[9]=e[0]+e[3],e[10]=e[1]+e[4],e[11]=e[2]+e[5],s?e[12]=s:e[12]=vec3.length(r),e},transformMat4:function(){for(var e=0,t=0,r=0,s=new Float32Array(8*3),a=[],o=0;o<24;o+=3)a.push(s.subarray(o,o+3));return function(c,f,p){var T=f[0],g=f[1],N=f[2];e=f[3],t=f[4],r=f[5];for(var A=this.corners,M=0;M<8;++M){var B=A[M],O=a[M];O[0]=e*B[0]+T,O[1]=t*B[1]+g,O[2]=r*B[2]+N,mat4.multiplyVec3(O,p,O)}return this.setFromPoints(c,s)}}(),getCorners:function(e,t){var r=e,s=e.subarray(3,6),a=null;t?(t.set(this.corners),a=t):a=new Float32Array(this.corners);for(var o=0;o<8;++o){var c=a.subarray(o*3,o*3+3);vec3.multiply(c,s,c),vec3.add(c,c,r)}return a},merge:function(e,t,r){var s=e.subarray(6,9),a=e.subarray(9,12);return vec3.min(s,t.subarray(6,9),r.subarray(6,9)),vec3.max(a,t.subarray(9,12),r.subarray(9,12)),BBox.setMinMax(e,s,a)},extendToPoint:function(e,t){t[0]<e[6]?e[6]=t[0]:t[0]>e[9]&&(e[9]=t[0]),t[1]<e[7]?e[7]=t[1]:t[1]>e[10]&&(e[10]=t[1]),t[2]<e[8]?e[8]=t[2]:t[2]>e[11]&&(e[11]=t[2]);var r=e.subarray(6,9),s=e.subarray(9,12),a=vec3.add(e.subarray(0,3),r,s);return vec3.scale(a,a,.5),vec3.subtract(e.subarray(3,6),s,a),e[12]=vec3.length(e.subarray(3,6)),e},clampPoint:function(e,t,r){e[0]=Math.clamp(r[0],t[0]-t[3],t[0]+t[3]),e[1]=Math.clamp(r[1],t[1]-t[4],t[1]+t[4]),e[2]=Math.clamp(r[2],t[2]-t[5],t[2]+t[5])},isPointInside:function(e,t){return!(e[0]-e[3]>t[0]||e[1]-e[4]>t[1]||e[2]-e[5]>t[2]||e[0]+e[3]<t[0]||e[1]+e[4]<t[1]||e[2]+e[5]<t[2])},getCenter:function(e){return e.subarray(0,3)},getHalfsize:function(e){return e.subarray(3,6)},getMin:function(e){return e.subarray(6,9)},getMax:function(e){return e.subarray(9,12)},getRadius:function(e){return e[12]}},u.distanceToPlane=n.distanceToPlane=function(t,r){return vec3.dot(t,r)+t[3]},u.planeBoxOverlap=n.planeBoxOverlap=function(t,r){var s=t,a=t[3],o=r,c=r,f=Math.abs(c[3]*s[0])+Math.abs(c[4]*s[1])+Math.abs(c[5]*s[2]),p=vec3.dot(s,o)+a;return p<=-f?CLIP_OUTSIDE:p<=f?CLIP_OVERLAP:CLIP_INSIDE},u.Octree=n.Octree=function(t,r,s){this.root=null,this.total_depth=0,this.total_nodes=0,t&&(this.buildFromMesh(t,r,s),this.total_nodes=this.trim())},Octree.MAX_NODE_TRIANGLES_RATIO=.1,Octree.MAX_OCTREE_DEPTH=8,Octree.OCTREE_MARGIN_RATIO=.01,Octree.OCTREE_MIN_MARGIN=.1,Octree.NEAREST=0,Octree.FIRST=1,Octree.ALL=2,Octree.prototype.buildFromMesh=function(e,t,r){this.total_depth=0,this.total_nodes=0,t=t||0;var s=e.getBuffer("vertices").data,a=e.getIndexBuffer("triangles");a&&(a=a.data),r||(r=a?a.length:s.length/3);var o=null;a?o=this.computeAABBFromIndices(s,a,t,r):o=this.computeAABB(s),this.root=o,this.total_nodes=1,this.total_triangles=a?a.length/3:s.length/9,this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var c=vec3.create();vec3.scale(c,o.size,Octree.OCTREE_MARGIN_RATIO),c[0]<Octree.OCTREE_MIN_MARGIN&&(c[0]=Octree.OCTREE_MIN_MARGIN),c[1]<Octree.OCTREE_MIN_MARGIN&&(c[1]=Octree.OCTREE_MIN_MARGIN),c[2]<Octree.OCTREE_MIN_MARGIN&&(c[2]=Octree.OCTREE_MIN_MARGIN),vec3.sub(o.min,o.min,c),vec3.add(o.max,o.max,c),o.faces=[],o.inside=0;var f=t+r;if(a)for(var p=t;p<f;p+=3){var T=new Float32Array([s[a[p]*3],s[a[p]*3+1],s[a[p]*3+2],s[a[p+1]*3],s[a[p+1]*3+1],s[a[p+1]*3+2],s[a[p+2]*3],s[a[p+2]*3+1],s[a[p+2]*3+2],p/3]);Octree.isValidFace(T)&&this.addToNode(T,o,0)}else for(var p=t*3;p<r*3;p+=9){var T=new Float32Array(10);T.set(s.subarray(p,p+9)),T[9]=p/9,Octree.isValidFace(T)&&this.addToNode(T,o,0)}return o},Octree.isValidFace=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s){var a=s.subarray(0,3),o=s.subarray(3,6),c=s.subarray(6,9);return vec3.sub(e,o,a),vec3.sub(t,c,a),vec3.cross(r,e,t),vec3.length(r)>0}}(),Octree.prototype.addToNode=function(e,t,r){if(t.inside+=1,t.c){for(var s=this.computeAABB(e),a=!1,o=0;o<t.c.length;++o){var c=t.c[o];if(Octree.isInsideAABB(s,c)){this.addToNode(e,c,r+1),a=!0;break}}a||(t.faces==null&&(t.faces=[]),t.faces.push(e))}else if(t.faces==null&&(t.faces=[]),t.faces.push(e),t.faces.length>this.max_node_triangles&&r<Octree.MAX_OCTREE_DEPTH){this.splitNode(t),this.total_depth<r+1&&(this.total_depth=r+1);var f=t.faces.concat();t.faces=null;for(var o=0;o<f.length;++o){for(var e=f[o],s=this.computeAABB(e),a=!1,p=0;p<t.c.length;++p){var c=t.c[p];if(Octree.isInsideAABB(s,c)){this.addToNode(e,c,r+1),a=!0;break}}a||(t.faces==null&&(t.faces=[]),t.faces.push(e))}}},Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]],Octree.prototype.splitNode=function(e){e.c=[];for(var t=[(e.max[0]-e.min[0])*.5,(e.max[1]-e.min[1])*.5,(e.max[2]-e.min[2])*.5],r=0;r<this.octree_pos_ref.length;++r){var s=this.octree_pos_ref[r],a={};this.total_nodes+=1,a.min=[e.min[0]+t[0]*s[0],e.min[1]+t[1]*s[1],e.min[2]+t[2]*s[2]],a.max=[a.min[0]+t[0],a.min[1]+t[1],a.min[2]+t[2]],a.faces=null,a.inside=0,e.c.push(a)}},Octree.prototype.computeAABB=function(e){for(var t=new Float32Array([e[0],e[1],e[2]]),r=new Float32Array(t),s=3;s<e.length-1;s+=3)for(var a=0;a<3;a++)t[a]>e[s+a]&&(t[a]=e[s+a]),r[a]<e[s+a]&&(r[a]=e[s+a]);return{min:t,max:r,size:vec3.sub(vec3.create(),r,t)}},Octree.prototype.computeAABBFromIndices=function(e,t,r,s){r=r||0,s=s||t.length;for(var a=t[r],o=new Float32Array([e[a*3],e[a*3+1],e[a*3+2]]),c=new Float32Array([e[a*3],e[a*3+1],e[a*3+2]]),f=r+1;f<r+s;++f)for(var a=t[f]*3,p=0;p<3;p++)o[p]>e[a+p]&&(o[p]=e[a+p]),c[p]<e[a+p]&&(c[p]=e[a+p]);return{min:o,max:c,size:vec3.sub(vec3.create(),c,o)}},Octree.prototype.trim=function(e){if(e=e||this.root,!e.c)return 1;for(var t=1,r=[],s=e.c,a=0;a<s.length;++a)s[a].inside&&(r.push(s[a]),t+=this.trim(s[a]));return e.c=r,t},Octree.prototype.testRay=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create();return function(a,o,c,f,p,T){if(T=T||Octree.NEAREST,!this.root)throw"Error: octree not build";e.set(a),t.set(o),r.set(this.root.min),s.set(this.root.max);var g=Octree.hitTestBox(e,t,r,s);if(!g)return null;var g=Octree.testRayInNode(this.root,e,t,p,T);if(g==null)return null;if(T==Octree.ALL)return g;var N=vec3.scale(vec3.create(),o,g.t);return vec3.add(N,N,a),g.pos=N,g}}(),Octree.testRayInNode=function(e,t,r,s,a){var o=null,c=null;if(e.faces)for(var f=0,p=e.faces.length;f<p;++f){var T=e.faces[f];if(o=Octree.hitTestTriangle(t,r,T.subarray(0,3),T.subarray(3,6),T.subarray(6,9),s),o!=null){if(a==Octree.FIRST)return o;a==Octree.ALL?(c||(c=[]),c.push(o)):(o.face=T,c?c.mergeWith(o):c=o)}}var g=vec3.create(),N=vec3.create(),A;if(e.c){for(var f=0;f<e.c.length;++f)if(A=e.c[f],g.set(A.min),N.set(A.max),o=Octree.hitTestBox(t,r,g,N),o!=null&&!(a!=Octree.ALL&&c&&o.t>c.t)&&(o=Octree.testRayInNode(A,t,r,s,a),o!=null)){if(a==Octree.FIRST)return o;a==Octree.ALL?(c||(c=[]),c.push(o)):c?c.mergeWith(o):c=o}}return c},Octree.prototype.testSphere=function(e,t){if(e=vec3.clone(e),!this.root)throw"Error: octree not build";var r=t*t;return Octree.testSphereBox(e,r,vec3.clone(this.root.min),vec3.clone(this.root.max))?Octree.testSphereInNode(this.root,e,r):!1},Octree.testSphereInNode=function(e,t,r){if(e.faces)for(var s=0,a=e.faces.length;s<a;++s){var o=e.faces[s];if(Octree.testSphereTriangle(t,r,o.subarray(0,3),o.subarray(3,6),o.subarray(6,9)))return!0}var c=vec3.create(),f=vec3.create(),p;if(e.c){for(var s=0;s<e.c.length;++s)if(p=e.c[s],c.set(p.min),f.set(p.max),!!Octree.testSphereBox(t,r,c,f)&&Octree.testSphereInNode(p,t,r))return!0}return!1},Octree.prototype.findNearestPoint=function(e,t,r,s){if(r=r||1/0,e===t)throw"findNearestPoint input point and output cannot be the same";return Octree.nearestInNode(this.root,e,t,r,s)},Octree.nearestInNode=function(e,t,r,s,a){var o=vec3.create(),c;if(a&&(c=vec3.create()),e.faces)for(var f=0,p=e.faces.length;f<p;++f){var T=e.faces[f];Octree.closestPointOnTriangle(t,T.subarray(0,3),T.subarray(3,6),T.subarray(6,9),o);var g=vec3.dist(o,t);g<s&&(s=g,vec3.copy(r,o),a&&geo.computeTriangleNormal(a,T.subarray(0,3),T.subarray(3,6),T.subarray(6,9)))}if(!e.c)return s;for(var f=0;f<e.c.length;++f){var N=e.c[f],A=Octree.distanceToBox(t,N.min,N.max);if(!(A>s)){var g=Octree.nearestInNode(N,t,o,s,c);g<s&&(s=g,vec3.copy(r,o),a&&vec3.copy(a,c))}}return s},Octree.closestPointOnTriangle=function(){var e=new Float32Array(4),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create();return function(o,c,f,p,T){if(geo.planeFromTriangle(e,c,f,p),vec3.length(e)>1e-6&&(geo.projectPointOnPlane(o,c,e,t),geo.isPointInsideTriangle(t,c,f,p)))return vec3.copy(T,t),T;geo.closestPointToSegment(t,c,f,r),geo.closestPointToSegment(t,f,p,s),geo.closestPointToSegment(t,p,c,a);var g=vec3.sqrDist(t,r),N=vec3.sqrDist(t,s),A=vec3.sqrDist(t,a),M=Math.min(g,N,A);return M===g?vec3.copy(T,r):M===N?vec3.copy(T,s):vec3.copy(T,a),T}}(),Octree.isInsideAABB=function(e,t){return!(e.min[0]<t.min[0]||e.min[1]<t.min[1]||e.min[2]<t.min[2]||e.max[0]>t.max[0]||e.max[1]>t.max[1]||e.max[2]>t.max[2])},Octree.distanceToBox=function(e,t,r){var s=(r[0]+t[0])*.5,a=(r[1]+t[1])*.5,o=(r[2]+t[2])*.5,c=r[0]-s,f=r[1]-a,p=r[2]-o,T=Math.abs(e[0]-s)-c,g=Math.abs(e[1]-a)-f,N=Math.abs(e[2]-o)-p,A=Math.min(Math.max(T,g,N),0);return T=Math.max(T,0),g=Math.max(g,0),N=Math.max(N,0),Math.sqrt(T*T+g*g+N*N)+A},Octree.hitTestBox=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create(),o=vec3.create(),c=1e-6,f=vec3.fromValues(c,c,c);return function(p,T,g,N){if(vec3.subtract(e,g,p),vec3.subtract(t,N,p),vec3.maxValue(e)<0&&vec3.minValue(t)>0)return new HitTest(0,p,T);r[0]=1/T[0],r[1]=1/T[1],r[2]=1/T[2],vec3.multiply(e,e,r),vec3.multiply(t,t,r),vec3.min(s,e,t),vec3.max(a,e,t);var A=vec3.maxValue(s),M=vec3.minValue(a);if(A>0&&A<M){var B=vec3.add(vec3.create(),vec3.scale(o,T,A),p);return vec3.add(g,g,f),vec3.subtract(g,g,f),new HitTest(A,B,vec3.fromValues((B[0]>N[0])-(B[0]<g[0]),(B[1]>N[1])-(B[1]<g[1]),(B[2]>N[2])-(B[2]<g[2])))}return null}}(),Octree.hitTestTriangle=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create();return function(a,o,c,f,p,T){vec3.subtract(e,f,c),vec3.subtract(t,p,c);var g=vec3.cross(vec3.create(),e,t);if(vec3.normalize(g,g),!T&&vec3.dot(g,o)>0)return null;var N=vec3.dot(g,vec3.subtract(s,c,a))/vec3.dot(g,o);if(N>0){var A=vec3.scale(vec3.create(),o,N);vec3.add(A,A,a),vec3.subtract(r,A,c);var M=vec3.dot(t,t),B=vec3.dot(t,e),O=vec3.dot(t,r),P=vec3.dot(e,e),U=vec3.dot(e,r),X=M*P-B*B,k=(P*O-B*U)/X,V=(M*U-B*O)/X;if(k>=0&&V>=0&&k+V<=1)return new HitTest(N,A,g)}return null}}(),Octree.testSphereTriangle=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create(),o=vec3.create(),c=vec3.create(),f=vec3.create();return function(p,T,g,N,A){vec3.sub(e,g,p),vec3.sub(t,N,p),vec3.sub(r,A,p),vec3.sub(s,t,e),vec3.sub(a,r,e),vec3.cross(f,s,a);var M=vec3.dot(e,f),B=vec3.dot(f,f),O=M*M>T*B,P=vec3.dot(e,e),U=vec3.dot(e,t),X=vec3.dot(e,r),k=vec3.dot(t,t),V=vec3.dot(t,r),J=vec3.dot(r,r),te=P>T&U>P&X>P,F=k>T&U>k&V>k,Q=J>T&X>J&V>J,ee=U-P,K=V-k,z=X-J;vec3.sub(o,r,t),vec3.sub(c,e,r);var q=vec3.dot(s,s),ie=vec3.dot(o,o),j=vec3.dot(c,c),se=vec3.scale(vec3.create(),e,q);vec3.sub(se,se,vec3.scale(vec3.create(),s,ee));var le=vec3.scale(vec3.create(),t,ie);vec3.sub(le,le,vec3.scale(vec3.create(),o,K));var ue=vec3.scale(vec3.create(),r,j);vec3.sub(ue,ue,vec3.scale(vec3.create(),c,z));var he=vec3.scale(vec3.create(),r,q);he=vec3.sub(he,he,se);var ve=vec3.scale(vec3.create(),e,ie);ve=vec3.sub(ve,ve,le);var I=vec3.scale(vec3.create(),t,j);I=vec3.sub(I,I,ue);var W=vec3.dot(se,se)>T*q*q&vec3.dot(se,he)>0,Z=vec3.dot(le,le)>T*ie*ie&vec3.dot(le,ve)>0,$=vec3.dot(ue,ue)>T*j*j&vec3.dot(ue,I)>0,re=O|te|F|Q|W|Z|$;return!re}}(),Octree.testSphereBox=function(e,t,r,s){for(var a,o=0,c=0;c<3;++c)e[c]<r[c]?(a=e[c]-r[c],o+=a*a):e[c]>s[c]&&(a=e[c]-s[c],o+=a*a);return o<=t},u.HitTest=n.HitTest=function(t,r,s){this.t=arguments.length?t:Number.MAX_VALUE,this.hit=r,this.normal=s,this.face=null},HitTest.prototype={mergeWith:function(e){e.t>0&&e.t<this.t&&(this.t=e.t,this.hit=e.hit,this.normal=e.normal,this.face=e.face)}},u.Ray=n.Ray=function(t,r){this.origin=vec3.create(),this.direction=vec3.create(),this.collision_point=vec3.create(),this.t=-1,t&&this.origin.set(t),r&&this.direction.set(r)},Ray.prototype.testPlane=function(e,t){var r=geo.testRayPlane(this.origin,this.direction,e,t,this.collision_point);return this.t=geo.last_t,r},Ray.prototype.testSphere=function(e,t,r){var s=geo.testRaySphere(this.origin,this.direction,e,t,this.collision_point,r);return this.t=geo.last_t,s},Ray.prototype.testBBox=function(e,t,r,s){var a=geo.testRayBBox(this.origin,this.direction,e,r,this.collision_point,t,s);return this.t=geo.last_t,a},u.Raytracer=n.Raytracer=function(t,r){this.viewport=vec4.create(),this.ray00=vec3.create(),this.ray10=vec3.create(),this.ray01=vec3.create(),this.ray11=vec3.create(),this.eye=vec3.create(),this.setup(t,r)},Raytracer.prototype.setup=function(e,t){t=t||gl.viewport_data,this.viewport.set(t);var r=t[0],s=r+t[2],a=t[1],o=a+t[3];vec3.set(this.ray00,r,a,1),vec3.set(this.ray10,s,a,1),vec3.set(this.ray01,r,o,1),vec3.set(this.ray11,s,o,1),vec3.unproject(this.ray00,this.ray00,e,t),vec3.unproject(this.ray10,this.ray10,e,t),vec3.unproject(this.ray01,this.ray01,e,t),vec3.unproject(this.ray11,this.ray11,e,t);var c=this.eye;vec3.unproject(c,c,e,t),vec3.subtract(this.ray00,this.ray00,c),vec3.subtract(this.ray10,this.ray10,c),vec3.subtract(this.ray01,this.ray01,c),vec3.subtract(this.ray11,this.ray11,c)},Raytracer.prototype.getRayForPixel=function(){var e=vec3.create(),t=vec3.create();return function(r,s,a){return a=a||vec3.create(),r=(r-this.viewport[0])/this.viewport[2],s=1-(s-this.viewport[1])/this.viewport[3],vec3.lerp(e,this.ray00,this.ray10,r),vec3.lerp(t,this.ray01,this.ray11,r),vec3.lerp(a,e,t,s),vec3.normalize(a,a)}}();var H=mat4.create();Raytracer.hitTestBox=function(e,t,r,s,a){var o=new Float32Array(30);if(a){var c=mat4.invert(H,a);e=mat4.multiplyVec3(o.subarray(3,6),c,e),t=mat4.rotateVec3(o.subarray(6,9),c,t)}var f=vec3.subtract(o.subarray(9,12),r,e);vec3.divide(f,f,t);var p=vec3.subtract(o.subarray(12,15),s,e);vec3.divide(p,p,t);var T=vec3.min(o.subarray(15,18),f,p),g=vec3.max(o.subarray(18,21),f,p),N=vec3.maxValue(T),A=vec3.minValue(g);if(N>0&&N<=A){var M=1e-6,B=vec3.scale(o.subarray(21,24),t,N);return vec3.add(B,e,B),vec3.addValue(o.subarray(24,27),r,M),vec3.subValue(o.subarray(27,30),s,M),new HitTest(N,B,vec3.fromValues((B[0]>s[0])-(B[0]<r[0]),(B[1]>s[1])-(B[1]<r[1]),(B[2]>s[2])-(B[2]<r[2])))}return null},Raytracer.hitTestSphere=function(e,t,r,s){var a=vec3.subtract(vec3.create(),e,r),o=vec3.dot(t,t),c=2*vec3.dot(t,a),f=vec3.dot(a,a)-s*s,p=c*c-4*o*f;if(p>0){var T=(-c-Math.sqrt(p))/(2*o),g=vec3.add(vec3.create(),e,vec3.scale(vec3.create(),t,T));return new HitTest(T,g,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),g,r),1/s))}return null},Raytracer.hitTestTriangle=function(e,t,r,s,a){var o=vec3.subtract(vec3.create(),s,r),c=vec3.subtract(vec3.create(),a,r),f=vec3.cross(vec3.create(),o,c);vec3.normalize(f,f);var p=vec3.dot(f,vec3.subtract(vec3.create(),r,e))/vec3.dot(f,t);if(p>0){var T=vec3.add(vec3.create(),e,vec3.scale(vec3.create(),t,p)),g=vec3.subtract(vec3.create(),T,r),N=vec3.dot(c,c),A=vec3.dot(c,o),M=vec3.dot(c,g),B=vec3.dot(o,o),O=vec3.dot(o,g),P=N*B-A*A,U=(B*M-A*O)/P,X=(N*O-A*M)/P;if(U>=0&&X>=0&&U+X<=1)return new HitTest(p,T,f)}return null},Mesh.parseOBJ=function(e,t){t=t||{};var r=t.matextension||"",s=[],a=[],o=[],c=[],f=[],p=[],T=[],g={},N=null,A=fe(),M=new Map,B=0,O=1;t.scale&&(O=t.scale);for(var P=1,U=2,X=3,k=4,V=5,J=6,te=7,F=8,Q={v:P,vt:U,vn:X,f:k,g:V,o:J,usemtl:te,mtllib:F},ee,K,z,q=e.split(`
`),ie=q.length,j=0;j<ie;++j){var se=q[j];if(se=se.replace(/[ \t]+/g," ").replace(/\s\s*$/,""),se[se.length-1]=="\\"){j+=1;var le=q[j].replace(/[ \t]+/g," ").replace(/\s\s*$/,"");se=(se.substr(0,se.length-1)+le).replace(/[ \t]+/g," ").replace(/\s\s*$/,"")}if(se[0]!="#"&&se!=""){var ue=se.split(" "),he=Q[ue[0]];switch(he<=X&&(ee=parseFloat(ue[1]),K=parseFloat(ue[2]),he!=U&&(z=parseFloat(ue[3]))),he){case P:ee*=O,K*=O,z*=O,s.push(ee,K,z);break;case U:o.push(ee,K);break;case X:a.push(ee,K,z);break;case k:if(ue.length<4)continue;for(var ve=[],I=1;I<ue.length;++I)ve.push(ce(ue[I]));A.indices.push(ve[0],ve[1],ve[2]);for(var I=2;I<ve.length-1;++I)A.indices.push(ve[0],ve[I],ve[I+1]);break;case V:case J:var W=ue[1];N=W,A.name?(g={},A=fe(W)):A.name=W;break;case te:ge(ue[1]);break;case F:ue[1];break}}}for(var Z=[],$=0,re=[],I=0;I<T.length;++I){var A=T[I];A.indices&&(A.start=$,A.length=A.indices.length,Z=Z.concat(A.indices),delete A.indices,$+=A.length,re.push(A))}T=re;var ae={};if(!s.length)return console.error("mesh without vertices"),null;if(t.flip_normals&&f.length)for(var a=f,I=0;I<a.length;++I)a[I]*=-1;ae.vertices=new Float32Array(c),f.length&&(ae.normals=new Float32Array(f)),p.length&&(ae.coords=new Float32Array(p)),Z&&Z.length>0&&(ae.triangles=new($>256*256?Uint32Array:Uint16Array)(Z)),ae.bounding=n.Mesh.computeBoundingBox(ae.vertices);var oe={};if(T.length>1&&(oe.groups=T),ae.info=oe,!ae.bounding)return console.log("empty mesh"),null;if(t.only_data)return ae;var _e=null;return _e=Mesh.load(ae,null,t.mesh),_e;function ce(pe){var de,me,Ee,Te,Ae=!1;if(pe.indexOf("-")==-1){var be=M.get(pe);if(be!==void 0)return be}else Ae=!0;if(Te||(Te=pe.split("/")),Te.length==1)de=parseInt(Te[0]),me=de,Ee=de;else if(Te.length==2)de=parseInt(Te[0]),me=parseInt(Te[1]),Ee=de;else if(Te.length==3)de=parseInt(Te[0]),me=parseInt(Te[1]),Ee=parseInt(Te[2]);else return console.log("Problem parsing: unknown number of values per face"),-1;if(de<0&&(de=s.length/3+de+1),Ee<0&&(Ee=a.length/2+Ee+1),me<0&&(me=o.length/2+me+1),Ae){pe=de+"/"+me+"/"+Ee;var be=M.get(pe);if(be!==void 0)return be}de-=1,me-=1,Ee-=1,c.push(s[de*3+0],s[de*3+1],s[de*3+2]),o.length&&p.push(o[me*2+0],o[me*2+1]),a.length&&f.push(a[Ee*3+0],a[Ee*3+1],a[Ee*3+2]);var be=B;return M.set(pe,be),++B,be}function fe(pe){var de={name:pe||"",material:"",start:-1,length:-1,indices:[]};return T.push(de),de}function ge(pe){if(!A.material)return A.material=pe+r,g[pe]=A,A;var de=g[pe];return de||(de=fe(N+"_"+pe),de.material=pe+r,g[pe]=de),A=de,de}},Mesh.parsers.obj=Mesh.parseOBJ,Mesh.encoders.obj=function(e,t){var r=e.getBuffer("vertices");if(!r)return null;var s=[];s.push(`# Generated with liteGL.js by Javi Agenjo
`);for(var a=r.data,o=0;o<a.length;o+=3)s.push("v "+a[o].toFixed(4)+" "+a[o+1].toFixed(4)+" "+a[o+2].toFixed(4));var c=e.getBuffer("normals");if(c){s.push("");for(var f=c.data,o=0;o<f.length;o+=3)s.push("vn "+f[o].toFixed(4)+" "+f[o+1].toFixed(4)+" "+f[o+2].toFixed(4))}var p=e.getBuffer("coords");if(p){s.push("");for(var T=p.data,o=0;o<T.length;o+=2)s.push("vt "+T[o].toFixed(4)+" "+T[o+1].toFixed(4)+"  0.0000")}var g=e.info.groups,N=e.getIndexBuffer("triangles");if(N){var A=N.data;(!g||!g.length)&&(g=[{start:0,length:A.length,name:"mesh"}]);for(var M=0;M<g.length;++M){var B=g[M];s.push("g "+B.name);var O=B.material||"mat_"+M;O.indexOf(".json")!=-1&&(O=O.substr(0,O.indexOf(".json"))),s.push("usemtl "+O);for(var P=B.start,U=P+B.length,o=P;o<U;o+=3)s.push("f "+(A[o]+1)+"/"+(A[o]+1)+"/"+(A[o]+1)+" "+(A[o+1]+1)+"/"+(A[o+1]+1)+"/"+(A[o+1]+1)+" "+(A[o+2]+1)+"/"+(A[o+2]+1)+"/"+(A[o+2]+1))}}else{(!g||!g.length)&&(g=[{start:0,length:a.length/3,name:"mesh"}]);for(var M=0;M<g.length;++M){var B=g[M];s.push("g "+B.name),s.push("usemtl "+(B.material||"mat_"+M));for(var P=B.start,U=P+B.length,o=P;o<U;o+=3)s.push("f "+(o+1)+"/"+(o+1)+"/"+(o+1)+" "+(o+2)+"/"+(o+2)+"/"+(o+2)+" "+(o+3)+"/"+(o+3)+"/"+(o+3))}}return s.join(`
`)},Mesh.parsers.mesh=function(e,t){for(var r={},s=e.split(`
`),a=0;a<s.length;++a){var o=s[a],c=o[0],f=o.substr(1).split(","),p=f[0];if(c=="-"){var T=1,g=Float32Array;(p=="weights"||p=="bone_indices")&&(g=Uint8Array),p=="weights"&&(T=255);for(var N=new g(Number(f[1])),A=0;A<N.length;++A)N[A]=Number(f[A+2])*T;r[p]=N}else if(c=="*"){var g=Uint16Array;Number(f[1])>256*256&&(g=Uint32Array);for(var N=new g(Number(f[1])),A=0;A<N.length;++A)N[A]=Number(f[A+2]);r[p]=N}else if(c=="@"){if(p=="bones"){for(var M=[],B=Number(f[1]),A=0;A<B;++A){var O=f.slice(3+A*17,3+(A+1)*17-1).map(Number);M.push([f[2+A*17],O])}r.bones=M}else if(p=="bind_matrix")r.bind_matrix=f.slice(1,17).map(Number);else if(p=="groups"){r.info={groups:[]};for(var P=Number(f[1]),A=0;A<P;++A){var U={name:f[2+A*4],material:f[2+A*4+1],start:Number(f[2+A*4+2]),length:Number(f[2+A*4+3])};r.info.groups.push(U)}}}else console.warn("type unknown: "+f[0])}if(t.only_data)return r;var X=null;return X=Mesh.load(r,null,t.mesh),X.updateBoundingBox(),X},Mesh.encoders.mesh=function(e,t){var r=[];for(var s in e.vertexBuffers){var a=e.vertexBuffers[s],o=typedArrayToArray(a.data);if(a.normalize&&a.data.constructor==Uint8Array)for(var c=0;c<o.length;++c)o[c]/=255;var f=["-"+s,a.data.length,a.data,o];r.push(f.join(","))}for(var s in e.indexBuffers){var a=e.indexBuffers[s],o=typedArrayToArray(a.data),f=["*"+s,a.data.length,a.data,o];r.push(f.join(","))}if(e.bounding&&r.push(["@bounding",typedArrayToArray(e.bounding.subarray(0,6))].join(",")),e.info&&e.info.groups){for(var p=[],c=0;c<e.info.groups.length;++c){var T=e.info.groups[c];p.push(T.name,T.material,T.start,T.length)}r.push(["@groups",e.info.groups.length].concat(p).join(","))}return e.bones&&r.push(["@bones",e.bones.length,e.bones.flat()].join(",")),e.bind_matrix&&r.push(["@bind_matrix",typedArrayToArray(e.bind_matrix)].join(",")),r.join(`
`)},u.WBin&&(u.WBin.classes.Mesh=Mesh),Mesh.binary_file_formats.wbin=!0,Mesh.parsers.wbin=Mesh.fromBinary=function(e,t){t=t||{};var r=null;if(e.constructor==ArrayBuffer){if(!u.WBin)throw"To use binary meshes you need to install WBin.js from https://github.com/jagenjo/litescene.js/blob/master/src/utils/wbin.js ";r=WBin.load(e,!0)}else r=e;r.info||console.warn("This WBin doesn't seem to contain a mesh. Classname: ",r["@classname"]),r.format&&n.Mesh.decompress(r);var s={};if(r.vertex_buffers)for(var a in r.vertex_buffers)s[r.vertex_buffers[a]]=r[r.vertex_buffers[a]];else r.vertices&&(s.vertices=r.vertices),r.normals&&(s.normals=r.normals),r.coords&&(s.coords=r.coords),r.weights&&(s.weights=r.weights),r.bone_indices&&(s.bone_indices=r.bone_indices);var o={};if(r.index_buffers)for(var a in r.index_buffers)o[r.index_buffers[a]]=r[r.index_buffers[a]];else r.triangles&&(o.triangles=r.triangles),r.wireframe&&(o.wireframe=r.wireframe);var c={vertex_buffers:s,index_buffers:o,bounding:r.bounding,info:r.info};if(r.bones){c.bones=r.bones;for(var a=0;a<c.bones.length;++a)c.bones[a][1]=mat4.clone(c.bones[a][1]);r.bind_matrix&&(c.bind_matrix=mat4.clone(r.bind_matrix))}if(r.morph_targets&&(c.morph_targets=r.morph_targets),t.only_data)return c;var f=t.mesh||new n.Mesh;return f.configure(c),f},Mesh.encoders.wbin=function(e,t){return e.updateBoundingBox(),e.toBinary(t)},Mesh.prototype.toBinary=function(e){if(!u.WBin)throw"to use Mesh.toBinary you need to have WBin included. Check the repository for wbin.js";this.info||(this.info={});var t={object_class:"Mesh",info:this.info,groups:this.groups};if(this.bones){for(var r=[],s=0;s<this.bones.length;++s)r.push([this.bones[s][0],mat4.toArray(this.bones[s][1])]);t.bones=r,this.bind_matrix&&(t.bind_matrix=this.bind_matrix)}this.bounding||this.updateBoundingBox(),t.bounding=this.bounding;var a=[],o=[];for(var s in this.vertexBuffers){var c=this.vertexBuffers[s];t[c.name]=c.data,a.push(c.name),c.name=="vertices"&&(t.info.num_vertices=c.data.length/3)}for(var s in this.indexBuffers){var c=this.indexBuffers[s];t[s]=c.data,o.push(s)}t.vertex_buffers=a,t.index_buffers=o,n.Mesh.enable_wbin_compression&&n.Mesh.compress(t);var f=WBin.create(t,"Mesh");return f},Mesh.compress=function(e,t){t=t||"bounding_compressed",e.format={type:t};var r=Mesh.compressors[t];if(!r)throw"compression format not supported:"+t;return r(e)},Mesh.decompress=function(e){if(e.format){var t=Mesh.decompressors[e.format.type];if(!t)throw"decompression format not supported:"+e.format.type;return t(e)}},Mesh.compressors.bounding_compressed=function(e){if(!e.vertex_buffers)throw"buffers not found";for(var t=BBox.getMin(e.bounding),r=BBox.getMax(e.bounding),s=vec3.sub(vec3.create(),r,t),a=e.vertices,o=new Uint16Array(a.length),c=0;c<a.length;c+=3)o[c]=(a[c]-t[0])/s[0]*65535,o[c+1]=(a[c+1]-t[1])/s[1]*65535,o[c+2]=(a[c+2]-t[2])/s[2]*65535;if(e.vertices=o,e.normals){for(var f=e.normals,p=new Uint8Array(f.length),T=p.constructor==Uint8Array?255:65535,c=0;c<f.length;c+=3)p[c]=(f[c]*.5+.5)*T,p[c+1]=(f[c+1]*.5+.5)*T,p[c+2]=(f[c+2]*.5+.5)*T;e.normals=p}if(e.coords){for(var g=e.coords,N=[1e4,1e4,-1e4,-1e4],c=0;c<g.length;c+=2){var A=g[c];N[0]>A?N[0]=A:N[2]<A&&(N[2]=A);var M=g[c+1];N[1]>M?N[1]=M:N[3]<M&&(N[3]=M)}e.format.uvs_bounding=N;for(var B=new Uint16Array(g.length),s=[N[2]-N[0],N[3]-N[1]],c=0;c<g.length;c+=2)B[c]=(g[c]-N[0])/s[0]*65535,B[c+1]=(g[c+1]-N[1])/s[1]*65535;e.coords=B}if(e.weights){for(var O=e.weights,P=new Uint16Array(O.length),U=P.constructor==Uint8Array?255:65535,c=0;c<O.length;c+=4)P[c]=O[c]*U,P[c+1]=O[c+1]*U,P[c+2]=O[c+2]*U,P[c+3]=O[c+3]*U;e.weights=P}},Mesh.decompressors.bounding_compressed=function(e){var t=e.bounding;if(!t)throw"error in mesh decompressing data: bounding not found, cannot use the bounding decompression.";for(var r=BBox.getMin(t),s=BBox.getMax(t),a=vec3.sub(vec3.create(),s,r),o=e.format,c=1/255,f=1/65535,p=e.vertices,T=new Float32Array(p.length),g=0,N=p.length;g<N;g+=3)T[g]=p[g]*f*a[0]+r[0],T[g+1]=p[g+1]*f*a[1]+r[1],T[g+2]=p[g+2]*f*a[2]+r[2];if(e.vertices=T,e.normals&&e.normals.constructor!=Float32Array){for(var A=e.normals,M=new Float32Array(A.length),B=A.constructor==Uint8Array?c:f,g=0,N=A.length;g<N;g+=3){M[g]=A[g]*B*2-1,M[g+1]=A[g+1]*B*2-1,M[g+2]=A[g+2]*B*2-1;var O=M.subarray(g,g+3);vec3.normalize(O,O)}e.normals=M}if(e.coords&&o.uvs_bounding&&e.coords.constructor!=Float32Array){for(var P=e.coords,U=o.uvs_bounding,a=[U[2]-U[0],U[3]-U[1]],X=new Float32Array(P.length),g=0,N=P.length;g<N;g+=2)X[g]=P[g]*f*a[0]+U[0],X[g+1]=P[g+1]*f*a[1]+U[1];e.coords=X}if(e.weights&&e.weights.constructor!=Float32Array){for(var k=e.weights,V=new Float32Array(k.length),J=k.constructor==Uint8Array?c:f,g=0,N=k.length;g<N;g+=4)V[g]=k[g]*J,V[g+1]=k[g+1]*J,V[g+2]=k[g+2]*J,V[g+3]=k[g+3]*J;e.weights=V}}}(typeof window<"u"?window:typeof self<"u"?self:global);const GL$1=window.GL;if(typeof GL$1>"u")throw"litegl.js must be included to use enableWebGLCanvas";function enableWebGLCanvas(u,n){var l;if(n=n||{},u.is_webgl)l=u.gl;else{n.canvas=u,n.alpha=!0,n.stencil=!0;try{l=GL$1.create(n)}catch{return console.log("This canvas cannot be used as WebGL, maybe WebGL is not supported or this canvas has already a 2D context associated"),l=u.getContext("2d",n),l}}const h=l.getError();if(h!==l.NO_ERROR&&console.error("WebGL error:",h),u.canvas2DtoWebGL_enabled)return l;var d=50,_=1e4,m=1e3;u.canvas2DtoWebGL_enabled=!0;var E=null,L=u.ctx=l;L.WebGLCanvas={},vec4.fromValues(1,1,1,1);var b=0,S=new Float32Array(_*3),R=new GL$1.Mesh,C=R.createVertexBuffer("vertices",null,null,S,l.STREAM_DRAW),G=GL$1.Mesh.getScreenQuad(),D=GL$1.Mesh.circle({size:1}),H=mat4.create(),e=n.anisotropic!==void 0?n.anisotropic:2,t={u_texture:0},r={};n.allow3D&&(r.EXTRA_PROJECTION="");var s=l.WebGLCanvas.textures_atlas={};l.WebGLCanvas.clearAtlas=function(){s=l.WebGLCanvas.textures_atlas={}};var a=null,o=null,c=null,f=null,p=null,T=null,g=null,N=null,A=null,M=null;l.WebGLCanvas.set3DMatrix=function(I){I?H.set(I):mat4.identity(H),r.EXTRA_PROJECTION==null&&(r.EXTRA_PROJECTION="",B(),t.u_projection=H),t.u_projection_enabled=!!I},B();function B(){a=`
				precision highp float;
				attribute vec3 a_vertex;
				uniform vec2 u_viewport;
				uniform mat3 u_transform;
				#ifdef EXTRA_PROJECTION
					uniform bool u_projection_enabled;
					uniform mat4 u_projection;
				#endif
				varying float v_visible;
				void main() { 
					vec3 pos = a_vertex;
					v_visible = pos.z;
					pos = u_transform * vec3(pos.xy,1.0);
					pos.z = 0.0;
					#ifdef EXTRA_PROJECTION
						if(u_projection_enabled)
						{
							gl_Position = u_projection * vec4(pos.xy,0.0,1.0);
							return;
						}
					#endif
					//normalize
					pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
					pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
					gl_Position = vec4(pos, 1.0); 
				}
				`,o=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			uniform vec2 u_position;
			uniform vec2 u_size;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			#ifdef EXTRA_PROJECTION
				uniform bool u_projection_enabled;
				uniform mat4 u_projection;
			#endif
			void main() { 
				vec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);
				v_coord = a_coord; 
				pos = u_transform * pos;
				pos.z = 0.0;
				#ifdef EXTRA_PROJECTION
					if(u_projection_enabled)
					{
						gl_Position = u_projection * vec4(pos.xy,0.0,1.0);
						return;
					}
				#endif
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
			}
		`,c=new GL$1.Shader(o,`
				precision highp float;
				uniform vec4 u_color;
				void main() {
					gl_FragColor = u_color;
				}
			`,r),f=new GL$1.Shader(o,`
				precision highp float;
				varying vec2 v_coord;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				void main() {
					gl_FragColor = u_color * texture2D( u_texture, v_coord );
				}
			`,r),p=new GL$1.Shader(o,`
				precision highp float;
				varying vec2 v_coord;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				void main() {
					vec4 color = u_color * texture2D( u_texture, v_coord );
					if(color.a <= 0.0)
						discard;
					gl_FragColor = color;
				}
			`,r),T=new GL$1.Shader(a,`
				precision highp float;
				varying float v_visible;
				uniform vec4 u_color;
				void main() {
					if (v_visible == 0.0)
						discard;
					gl_FragColor = u_color;
				}
			`,r),g=new GL$1.Shader(GL$1.Shader.QUAD_VERTEX_SHADER,`
				precision highp float;
				uniform sampler2D u_texture;
				uniform vec4 u_color;
				uniform vec4 u_texture_transform;
				varying vec2 v_coord;
				void main() {
					vec2 uv = v_coord * u_texture_transform.zw + vec2(u_texture_transform.x,0.0);
					uv.y = uv.y - u_texture_transform.y + (1.0 - u_texture_transform.w);
					uv = clamp(uv,vec2(0.0),vec2(1.0));
					gl_FragColor = u_color * texture2D(u_texture, uv);
				}
			`,r),N=new GL$1.Shader(a,`
				precision highp float;
				varying float v_visible;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				uniform vec4 u_texture_transform;
				uniform vec2 u_viewport;
				uniform mat3 u_itransform;
				void main() {
					vec2 pos = (u_itransform * vec3( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t,1.0)).xy;
					pos *= vec2( (u_viewport.x * u_texture_transform.z), (u_viewport.y * u_texture_transform.w) );
					vec2 uv = fract(pos / u_viewport) + u_texture_transform.xy;
					uv.y = 1.0 - uv.y;
					gl_FragColor = u_color * texture2D( u_texture, uv);
				}
			`,r),A=new GL$1.Shader(a,`
				precision highp float;
				varying float v_visible;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				uniform vec4 u_gradient;
				uniform vec2 u_viewport;
				uniform mat3 u_itransform;
				void main() {
					vec2 pos = (u_itransform * vec3( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t,1.0)).xy;
					//vec2 pos = vec2( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t);
					vec2 AP = pos - u_gradient.xy;
					vec2 AB = u_gradient.zw - u_gradient.xy;
					float dotAPAB = dot(AP,AB);
					float dotABAB = dot(AB,AB);
					float x = dotAPAB / dotABAB;
					vec2 uv = vec2( x, 0.0 );
					gl_FragColor = u_color * texture2D( u_texture, uv );
				}
			`,r);var I=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			#ifdef EXTRA_PROJECTION
				uniform bool u_projection_enabled;
				uniform mat4 u_projection;
			#endif
			uniform float u_pointSize;
			void main() { 
				vec3 pos = a_vertex;
				pos = u_transform * pos;
				pos.z = 0.0;
				#ifdef EXTRA_PROJECTION
					if(u_projection_enabled)
					{
						gl_Position = u_projection * vec4(pos.xy,0.0,1.0);
						return;
					}
				#endif
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
				gl_PointSize = ceil(u_pointSize);
				v_coord = a_coord;
			}
			`,W=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform float u_iCharSize;
			uniform vec4 u_color;
			uniform float u_pointSize;
			uniform vec2 u_viewport;
			uniform vec2 u_angle_sincos;
			varying vec2 v_coord;
			void main() {
				vec2 uv = vec2(1.0 - gl_PointCoord.s, gl_PointCoord.t);
				uv = vec2( ((uv.y - 0.5) * u_angle_sincos.y - (uv.x - 0.5) * u_angle_sincos.x) + 0.5, ((uv.x - 0.5) * u_angle_sincos.y + (uv.y - 0.5) * u_angle_sincos.x) + 0.5);
				uv = v_coord - uv * u_iCharSize + vec2(u_iCharSize*0.5);
				uv.y = 1.0 - uv.y;
				gl_FragColor = vec4(u_color.xyz, u_color.a * texture2D(u_texture, uv, -1.0  ).a);
      }
			`;M=new GL$1.Shader(I,W,r)}L.createImageShader=function(I){return new GL$1.Shader(GL$1.Shader.QUAD_VERTEX_SHADER,`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			uniform vec4 u_texture_transform;
			uniform vec2 u_viewport;
			varying vec2 v_coord;
			void main() {
				vec2 uv = v_coord * u_texture_transform.zw + vec2(u_texture_transform.x,0.0);
				uv.y = uv.y - u_texture_transform.y + (1.0 - u_texture_transform.w);
				uv = clamp(uv,vec2(0.0),vec2(1.0));
				vec4 color = u_color * texture2D(u_texture, uv);
				`+I+`;
				gl_FragColor = color;
			}
		`,r)},L.WebGLCanvas.vertex_shader=a,L._matrix=mat3.create();var O=mat3.create(),P=vec2.create(),U=vec4.create(),X=vec4.create(),k=vec2.create();L._stack=[],L._stack_size=0;var V=0,J=L.viewport_data.subarray(2,4);L.translate=function(I,W){P[0]=I,P[1]=W,mat3.translate(this._matrix,this._matrix,P)},L.rotate=function(I){mat3.rotate(this._matrix,this._matrix,I),V+=I},L.scale=function(I,W){P[0]=I,P[1]=W,mat3.scale(this._matrix,this._matrix,P)},L.resetTransform=function(){l._stack_size=0,this._matrix.set([1,0,0,0,1,0,0,0,1]),V=0},L.save=function(){if(!(this._stack_size>=32)){var I=null;this._stack_size==this._stack.length?I=this._stack[this._stack_size]={matrix:mat3.create(),fillColor:vec4.create(),strokeColor:vec4.create(),shadowColor:vec4.create(),globalAlpha:1,font:"",fontFamily:"",fontSize:14,fontMode:"",textAlign:"",clip_level:0}:I=this._stack[this._stack_size],this._stack_size++,I.matrix.set(this._matrix),I.fillColor.set(this._fillcolor),I.strokeColor.set(this._strokecolor),I.shadowColor.set(this._shadowcolor),I.globalAlpha=this._globalAlpha,I.font=this._font,I.fontFamily=this._font_family,I.fontSize=this._font_size,I.fontMode=this._font_mode,I.textAlign=this.textAlign,I.clip_level=this.clip_level}},L.restore=function(){if(this._stack_size==0){mat3.identity(this._matrix),V=0;return}this._stack_size--;var I=this._stack[this._stack_size];this._matrix.set(I.matrix),this._fillcolor.set(I.fillColor),this._strokecolor.set(I.strokeColor),this._shadowcolor.set(I.shadowColor),this._globalAlpha=I.globalAlpha,this._font=I.font,this._font_family=I.fontFamily,this._font_size=parseInt(I.fontSize),this._font_mode=I.fontMode,this.textAlign=I.textAlign;var W=this.clip_level;this.clip_level=I.clip_level,V=Math.atan2(this._matrix[3],this._matrix[4]),W==this.clip_level||(this.clip_level==0?(l.enable(l.STENCIL_TEST),l.clearStencil(0),l.clear(l.STENCIL_BUFFER_BIT),l.disable(l.STENCIL_TEST)):(l.stencilFunc(l.LEQUAL,this.clip_level,255),l.stencilOp(l.KEEP,l.KEEP,l.KEEP)))},L.clip=function(){this.clip_level==0,this.clip_level++,l.colorMask(!1,!1,!1,!1),l.depthMask(!1),l.enable(l.STENCIL_TEST),l.stencilFunc(l.EQUAL,this.clip_level-1,255),l.stencilOp(l.KEEP,l.KEEP,l.INCR),this.fill(),l.colorMask(!0,!0,!0,!0),l.depthMask(!0),l.stencilFunc(l.EQUAL,this.clip_level,255),l.stencilOp(l.KEEP,l.KEEP,l.KEEP)},L.clipImage=function(I,W,Z,$,re){this.clip_level++,l.colorMask(!1,!1,!1,!1),l.depthMask(!1),l.enable(l.STENCIL_TEST),l.stencilFunc(l.EQUAL,this.clip_level-1,255),l.stencilOp(l.KEEP,l.KEEP,l.INCR),this.drawImage(I,W,Z,$,re,p),l.colorMask(!0,!0,!0,!0),l.depthMask(!0),l.stencilFunc(l.EQUAL,this.clip_level,255),l.stencilOp(l.KEEP,l.KEEP,l.KEEP)},L.transform=function(I,W,Z,$,re,ae){var oe=O;oe[0]=I,oe[1]=W,oe[2]=0,oe[3]=Z,oe[4]=$,oe[5]=0,oe[6]=re,oe[7]=ae,oe[8]=1,mat3.multiply(this._matrix,this._matrix,oe),V=Math.atan2(this._matrix[0],this._matrix[1])},L.setTransform=function(I,W,Z,$,re,ae){var oe=this._matrix;oe[0]=I,oe[1]=W,oe[2]=0,oe[3]=Z,oe[4]=$,oe[5]=0,oe[6]=re,oe[7]=ae,oe[8]=1,V=Math.atan2(this._matrix[0],this._matrix[1])};function te(I){var W=null;if(I.constructor===GL$1.Texture)return I._context_id==l.context_id?I:null;if(I.gl||(I.gl={}),I.src){var Z=l.REPEAT;return W=I.gl[l.context_id],W?(I.mustUpdate&&(W.uploadData(I),I.mustUpdate=!1),W):I.gl[l.context_id]=GL$1.Texture.fromImage(I,{magFilter:l.LINEAR,minFilter:l.LINEAR_MIPMAP_LINEAR,wrap:Z,ignore_pot:!0,premultipliedAlpha:!0,anisotropic:e})}else return W=I.gl[l.context_id],W?(I.mustUpdate&&(W.uploadData(I),I.mustUpdate=!1),W):I.gl[l.context_id]=GL$1.Texture.fromImage(I,{minFilter:l.LINEAR,magFilter:l.LINEAR,anisotropic:e})}L.drawImage=function(I,W,Z,$,re,ae){if(I){var oe=I.videoWidth||I.width,_e=I.videoHeight||I.height;if(!(oe==0||_e==0)){var ce=te(I);ce&&(arguments.length==9?(X.set([W/oe,Z/_e,$/oe,re/_e]),W=arguments[5],Z=arguments[6],$=arguments[7],re=arguments[8],ae=g):X.set([0,0,1,1]),P[0]=W,P[1]=Z,k[0]=$===void 0?ce.width:$,k[1]=re===void 0?ce.height:re,ce.bind(0),ce!==I&&l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,this.imageSmoothingEnabled?l.LINEAR:l.NEAREST),this.tintImages||(U[0]=U[1]=U[2]=1,U[3]=this._globalAlpha),t.u_color=this.tintImages?this._fillcolor:U,t.u_position=P,t.u_size=k,t.u_transform=this._matrix,t.u_texture_transform=X,t.u_viewport=J,ae=ae||f,ae.uniforms(t).draw(G),H[14]-=.001)}}},L.createPattern=function(I){return te(I)};function F(I,W,Z,$){this.id=L._last_gradient_id++%L._max_gradients,this.points=new Float32Array([I,W,Z,$]),this.stops=[],this._must_update=!0}L._last_gradient_id=0,L._max_gradients=16,L._gradients_pool=[],F.prototype.addColorStop=function(I,W){var Z=hexColorToRGBA(W),$=new Uint8Array(4);$[0]=Math.clamp(Z[0],0,1)*255,$[1]=Math.clamp(Z[1],0,1)*255,$[2]=Math.clamp(Z[2],0,1)*255,$[3]=Math.clamp(Z[3],0,1)*255,this.stops.push([I,$]),this.stops.sort(function(re,ae){return re[0]>ae[0]?1:ae[0]>re[0]?-1:0}),this._must_update=!0},F.prototype.toTexture=function(){if(this._texture||(this.id!=-1&&(this._texture=L._gradients_pool[this.id]),this._texture||(this._texture=new GL$1.Texture(128,1,{format:l.RGBA,magFilter:l.LINEAR,wrap:l.CLAMP_TO_EDGE,minFilter:l.NEAREST}),this.id!=-1&&(L._gradients_pool[this.id]=this._texture))),!this._must_update)return this._texture;if(this._must_update=!1,this.stops.length<1)return this._texture;if(this.stops.length<2)return this._texture.fill(this.stops[0][1]),this._texture;for(var I=0,W=this.stops[I],Z=this.stops[I+1],$=new Uint8Array(128*4),re=0;re<128;re+=1){var ae=$.subarray(re*4,re*4+4),oe=re/128;if(W[0]>oe)if(I==0)ae.set(W[1]);else{if(I+=1,W=this.stops[I],Z=this.stops[I+1],!Z)break;re-=1}else if(W[0]<=oe&&oe<Z[0]){var _e=(oe-W[0])/(Z[0]-W[0]);vec4.lerp(ae,W[1],Z[1],_e)}else if(Z[0]<=oe){if(I+=1,W=this.stops[I],Z=this.stops[I+1],!Z)break;re-=1}}if(re<128)for(var ce=re;ce<128;ce+=1)$.set(W[1],ce*4);return this._texture.uploadData($),this._texture},L.createLinearGradient=function(I,W,Z,$){return new F(I,W,Z,$)},L.beginPath=function(){b=0},L.closePath=function(){b<3||(S[b]=S[0],S[b+1]=S[1],S[b+2]=1,b+=3)},L.moveTo=function(I,W){b==0?(S[b]=I,S[b+1]=W,S[b+2]=1,b+=3):(S[b]=S[b-3],S[b+1]=S[b-2],S[b+2]=0,b+=3,S[b]=I,S[b+1]=W,S[b+2]=0,b+=3)},L.lineTo=function(I,W){S[b]=I,S[b+1]=W,S[b+2]=1,b+=3},L.bezierCurveTo=function(I,W,Z,$,re,ae){if(!(b<3))for(var oe=[S[b-3],S[b-2]],_e=[oe,[I,W],[Z,$],[re,ae]],ce=0;ce<=d;ce++){var fe=ce/d,ge,pe,de,me,Ee,Te,Ae,be;de=3*(_e[1][0]-_e[0][0]),pe=3*(_e[2][0]-_e[1][0])-de,ge=_e[3][0]-_e[0][0]-de-pe,Te=3*(_e[1][1]-_e[0][1]),Ee=3*(_e[2][1]-_e[1][1])-Te,me=_e[3][1]-_e[0][1]-Te-Ee,Ae=fe*fe,be=Ae*fe;var Ce=ge*be+pe*Ae+de*fe+_e[0][0],Se=me*be+Ee*Ae+Te*fe+_e[0][1];S[b]=Ce,S[b+1]=Se,S[b+2]=1,b+=3}},L.quadraticCurveTo=function(I,W,Z,$){if(!(b<3))for(var re=S[b-3],ae=S[b-2],oe=0;oe<=d;oe++){var _e=oe/d,ce=1-_e,fe=re*ce+I*_e,ge=ae*ce+W*_e,pe=I*ce+Z*_e,de=W*ce+$*_e;S[b]=fe*ce+pe*_e,S[b+1]=ge*ce+de*_e,S[b+2]=1,b+=3}},L.fill=function(){if(!(b<9)){C.uploadRange(0,b*4),t.u_viewport=J;var I=T;this._shadowcolor[3]>0&&(t.u_color=this._shadowcolor,this.save(),this.translate(this.shadowOffsetX,this.shadowOffsetY),I.uniforms(t).drawRange(R,l.TRIANGLE_FAN,0,b/3),this.restore()),t.u_color=this._fillcolor,t.u_transform=this._matrix;var W=this._fillStyle;if(W.constructor===F){var Z=W,$=Z.toTexture();t.u_color=[1,1,1,this.globalAlpha],t.u_gradient=Z.points,t.u_texture=0,t.u_itransform=mat3.invert(O,this._matrix),$.bind(0),I=A}else if(W.constructor===GL$1.Texture){var $=W;t.u_color=[1,1,1,this._globalAlpha],t.u_texture=0,U.set([0,0,1/$.width,1/$.height]),t.u_texture_transform=U,t.u_itransform=mat3.invert(O,this._matrix),$.bind(0),I=N}I.uniforms(t).drawRange(R,l.TRIANGLE_FAN,0,b/3),H[14]-=.001}},L.strokeThin=function(){b<6||(C.uploadRange(0,b*4),l.setLineWidth(this.lineWidth),t.u_color=this._strokecolor,t.u_transform=this._matrix,t.u_viewport=J,T.uniforms(t).drawRange(R,l.LINE_STRIP,0,b/3))};var Q=new Float32Array(_*3),ee=new GL$1.Mesh,K=ee.createVertexBuffer("vertices",null,null,Q,l.STREAM_DRAW);L.stroke=function(){if(!(b<6)){if(P[0]=this._matrix[0],P[1]=this._matrix[1],this.lineWidth*vec2.length(P)<=1)return this.strokeThin();var I=Q,W=b,Z=this.lineWidth*.5,$=S,re=0,ae=0,oe=0,_e=0,ce=0,fe=0,ge=0,pe=0;if($[0]==$[b-3]&&$[1]==$[b-2]){re=$[b-3]-$[b-6],ae=$[b-2]-$[b-5];var de=Math.sqrt(re*re+ae*ae);de!=0&&(re=re/de,ae=ae/de)}var me,Ee=0;for(me=0;me<W-3;me+=3){oe=re,_e=ae,re=$[me+3]-$[me],ae=$[me+4]-$[me+1];var de=Math.sqrt(re*re+ae*ae);de!=0&&(re=re/de,ae=ae/de),me==0&&(ge=re,pe=ae),ce=re+oe,fe=ae+_e;var de=Math.sqrt(ce*ce+fe*fe);de!=0&&(ce=ce/de,fe=fe/de),I[Ee+0]=$[me]-fe*Z,I[Ee+1]=$[me+1]+ce*Z,I[Ee+2]=1,I[Ee+3]=$[me]+fe*Z,I[Ee+4]=$[me+1]-ce*Z,I[Ee+5]=1,Ee+=6}if($[0]==$[b-3]&&$[1]==$[b-2]){ce=re+ge,fe=ae+pe;var de=Math.sqrt(ce*ce+fe*fe);de!=0&&(ce=ce/de,fe=fe/de),I[Ee+0]=$[me]-fe*Z,I[Ee+1]=$[me+1]+ce*Z,I[Ee+2]=1,I[Ee+3]=$[me]+fe*Z,I[Ee+4]=$[me+1]-ce*Z,I[Ee+5]=1}else{var de=Math.sqrt(re*re+ae*ae);de!=0&&(ce=re/de,fe=ae/de),I[Ee+0]=$[me]-(fe-ce)*Z,I[Ee+1]=$[me+1]+(ce+fe)*Z,I[Ee+2]=1,I[Ee+3]=$[me]+(fe+ce)*Z,I[Ee+4]=$[me+1]-(ce-fe)*Z,I[Ee+5]=1}Ee+=6,K.upload(l.STREAM_DRAW),K.uploadRange(0,Ee*4),t.u_transform=this._matrix,t.u_viewport=J,this._shadowcolor[3]>0&&(t.u_color=this._shadowcolor,this.save(),this.translate(this.shadowOffsetX,this.shadowOffsetY),T.uniforms(t).drawRange(R,l.TRIANGLE_STRIP,0,Ee/3),this.restore()),t.u_color=this._strokecolor,T.uniforms(t).drawRange(ee,l.TRIANGLE_STRIP,0,Ee/3),H[14]-=.001}},L.rect=function(I,W,Z,$){S[b]=I,S[b+1]=W,S[b+2]=1,S[b+3]=I+Z,S[b+4]=W,S[b+5]=1,S[b+6]=I+Z,S[b+7]=W+$,S[b+8]=1,S[b+9]=I,S[b+10]=W+$,S[b+11]=1,S[b+12]=I,S[b+13]=W,S[b+14]=1,b+=15},L.roundRect=function(I,W,Z,$,re,ae){var oe=0,_e=0,ce=0,fe=0;if(re===0){this.rect(I,W,Z,$);return}if(ae===void 0&&(ae=re),re!=null&&re.constructor===Array)if(re.length==1)oe=_e=ce=fe=re[0];else if(re.length==2)oe=fe=re[0],_e=ce=re[1];else if(re.length==4)oe=re[0],_e=re[1],ce=re[2],fe=re[3];else return;else oe=re||0,_e=re||0,ce=ae||0,fe=ae||0;var ge=S,pe=b;if(oe>0)for(var de=0;de<10;++de){var me=de/10*Math.PI*.5;ge[pe]=I+oe*(1-Math.cos(me)),ge[pe+1]=W+oe*(1-Math.sin(me)),ge[pe+2]=1,pe+=3}if(ge[pe+0]=I+oe,ge[pe+1]=W,ge[pe+2]=1,ge[pe+3]=I+Z-_e,ge[pe+4]=W,ge[pe+5]=1,pe+=6,_e>0)for(var de=0;de<10;++de){var me=de/10*Math.PI*.5;ge[pe+0]=I+Z-_e*(1-Math.sin(me)),ge[pe+1]=W+_e*(1-Math.cos(me)),ge[pe+2]=1,pe+=3}if(ge[pe+0]=I+Z,ge[pe+1]=W+_e,ge[pe+2]=1,ge[pe+3]=I+Z,ge[pe+4]=W+$-fe,ge[pe+5]=1,pe+=6,fe>0)for(var de=0;de<10;++de){var me=de/10*Math.PI*.5;ge[pe+0]=I+Z-fe*(1-Math.cos(me)),ge[pe+1]=W+$-fe*(1-Math.sin(me)),ge[pe+2]=1,pe+=3}if(ge[pe+0]=I+Z-fe,ge[pe+1]=W+$,ge[pe+2]=1,ge[pe+3]=I+ce,ge[pe+4]=W+$,ge[pe+5]=1,pe+=6,ce>0)for(var de=0;de<10;++de){var me=de/10*Math.PI*.5;ge[pe+0]=I+ce*(1-Math.sin(me)),ge[pe+1]=W+$-ce*(1-Math.cos(me)),ge[pe+2]=1,pe+=3}ge[pe+0]=I,ge[pe+1]=W+oe,ge[pe+2]=1,b=pe+3},L.arc=function(I,W,Z,$,re){var ae=Math.max(Math.abs(this._matrix[0]),Math.abs(this._matrix[1]),Math.abs(this._matrix[3]),Math.abs(this._matrix[4])),oe=Math.ceil(Z*2*ae+1);if(!(oe<1)){oe=Math.min(oe,1024),$=$===void 0?0:$,re=re===void 0?Math.PI*2:re;for(var _e=(re-$)/oe,ce=0;ce<=oe;ce++){var fe=$+ce*_e;this.lineTo(I+Math.cos(fe)*Z,W+Math.sin(fe)*Z)}}},L.strokeRect=function(I,W,Z,$){this.beginPath(),this.rect(I,W,Z,$),this.stroke()},L.fillRect=function(I,W,Z,$){if(b=0,this._fillStyle.constructor==GL$1.Texture||this._fillStyle.constructor===F){this.beginPath(),this.rect(I,W,Z,$),this.fill();return}t.u_color=this._fillcolor,P[0]=I,P[1]=W,k[0]=Z,k[1]=$,t.u_position=P,t.u_size=k,t.u_transform=this._matrix,t.u_viewport=J,c.uniforms(t).draw(G),H[14]-=.001},L.clearRect=function(I,W,Z,$){(I!=0||W!=0||Z!=u.width||$!=u.height)&&(l.enable(l.SCISSOR_TEST),l.scissor(I,W,Z,$)),l.clear(l.COLOR_BUFFER_BIT);var re=l.viewport_data;l.scissor(re[0],re[1],re[2],re[3]),l.disable(l.SCISSOR_TEST)},L.fillCircle=function(I,W,Z){if(b=0,this._fillStyle.constructor==GL$1.Texture||this._fillStyle.constructor===F){this.beginPath(),this.arc(I,W,Z,0,Math.PI*2),this.fill();return}t.u_color=this._fillcolor,P[0]=I,P[1]=W,k[0]=Z,k[1]=Z,t.u_position=P,t.u_size=k,t.u_transform=this._matrix,t.u_viewport=J,c.uniforms(t).draw(D),H[14]-=.001},L.start2D=function(){E=window.gl,window.gl=this;var I=this;I.disable(I.CULL_FACE),I.disable(I.DEPTH_TEST),I.disable(I.STENCIL_TEST),I.enable(I.BLEND),I.blendFunc(I.SRC_ALPHA,I.ONE_MINUS_SRC_ALPHA),I.blendEquation(I.FUNC_ADD),I.lineWidth=1,b=0,mat4.identity(H),this.clip_level=0},L.finish2D=function(){b=0,l.lineWidth=1,window.gl=E,l.disable(l.STENCIL_TEST)};var z=new Float32Array(m*3),q=new Float32Array(m*2),ie=new GL$1.Mesh,j=ie.createVertexBuffer("vertices",null,null,z,l.STREAM_DRAW),se=ie.createVertexBuffer("coords",null,null,q,l.STREAM_DRAW);L.fillText=L.strokeText=function(I,W,Z){if(I==null)return;I.constructor!==String&&(I=String(I));let $=0;const{textures:re,info:ae}=le.call(this,this._font_family,this._font_mode),oe=z,_e=q,ce=this._font_size*1.1;ce<1&&(ce=1);let fe=0,ge=0;const pe=I.length,de=ae.spacing,me=ae.kernings;let Ee=!0,Te=0,Ae=0,be=-1;function Ce(){if(Te===0||Ae===0||be===-1)return;j.uploadRange(0,Te*4),se.uploadRange(0,Ae*4),t.u_color=this._fillcolor,t.u_pointSize=ce*vec2.length(this._matrix),t.u_iCharSize=ae.char_size/$,t.u_transform=this._matrix,t.u_viewport=J,t.u_angle_sincos||(t.u_angle_sincos=vec2.create());const ye=V;V=0,t.u_angle_sincos[1]=Math.sin(-V),t.u_angle_sincos[0]=-Math.cos(-V),V=ye,M.uniforms(t).drawRange(ie,l.POINTS,0,Te/3),Te=0,Ae=0}for(let ye=0;ye<pe;ye++){const Le=I.charCodeAt(ye),we=ae.pages[Le];if(!we){Le===10?(fe=0,ge+=ce,Ee=!0):fe+=ce*.5;continue}const[Me,Re,Ne,Be]=we;if(Ne!==be)if(Ce.call(this),be=Ne,re[Ne])re[Ne].bind(0),$=re[Ne].width;else{console.error(`Page ${Ne} not found in textures.`);continue}const xe=me[I[ye]];Ee&&(fe-=ce*((xe==null?void 0:xe.nwidth)||0)*.25,Ee=!1),oe[Te+0]=W+fe+ce*.5,oe[Te+1]=Z+ge-ce*.25,oe[Te+2]=1,Te+=3,_e[Ae+0]=Me,_e[Ae+1]=Re,Ae+=2;const Oe=me[I[ye+1]]?me[I[ye+1]].nwidth:de/ae.char_size;fe+=ce*Oe}Ce.call(this);let Se=0;if(this.textAlign==="right"?Se=fe+ce*.5:this.textAlign==="center"&&(Se=(fe+ce*.5)*.5),Se)for(let ye=0;ye<Te;ye+=3)oe[ye]-=Se;return{x:fe,y:ge}},L.measureText=function(I){const{info:W}=le.call(this,this._font_family,this._font_mode),Z=Math.ceil(this._font_size*(W.line_height||1));let $=0;const re=Z*(W.spacing/W.char_size);for(let ae=0;ae<I.length;++ae){const oe=W.kernings[I[ae]];oe?$+=oe.nwidth:$+=re}return $*=Z,{width:$,height:Z}},L.cacheFontAtlas=function(I="monospace",W="normal",Z=!1){const $=`:font_${I}:${W}:${enableWebGLCanvas.useInternationalFont}`;if(!Z&&s[$])return s[$];const re=le.call(this,I,W,Z);return s[$]=re,re},L.loadCachedTextures=async function(){const I=await getAllData();if(I&&(I==null?void 0:I.length)>0)for(let W in I){const Z=I[W];s[Z.name]=Z}};function le(I="monospace",W="normal",Z=!1){const $=`:font_${I}:${W}:${enableWebGLCanvas.useInternationalFont}`;if(!Z&&s[$])return s[$];const re=enableWebGLCanvas.useInternationalFont;let ae=1024,oe=10,_e=200;re&&(_e=55203,oe=20,ae=2048);const ce=this.imageSmoothingEnabled,fe=Math.floor(ae/oe),ge=Math.floor(fe*.95);let pe=.5,de=ge*-.15;const me=[],Ee={font_size:ge,char_size:fe,spacing:fe*.6,space:null,kernings:{},pages:[]},Te=ye=>ye>=32&&ye<=47||ye>=58&&ye<=64||ye>=91&&ye<=96||ye>=123&&ye<=126,Ae=ye=>ye>=65&&ye<=90||ye>=97&&ye<=122||ye>=48&&ye<=57||ye>=32&&ye<=47||ye>=58&&ye<=64||ye>=91&&ye<=96||ye>=123&&ye<=126||ye>=44032&&ye<=55203||ye>=127744&&ye<=128767,be=[];for(let ye=32;ye<=_e;ye++)Ae(ye)&&be.push(ye);const Ce=Math.ceil(be.length/(oe*oe));for(let ye=0;ye<Ce;ye++){const Le=createCanvas(ae,ae),we=Le.getContext("2d");we.fillStyle="white",we.imageSmoothingEnabled=ce,we.clearRect(0,0,Le.width,Le.height),we.font=`${W} ${ge}px ${I}`,we.textAlign="center";let Me=0,Re=0;const Ne=ye*oe*oe,Be=Math.min(be.length,Ne+oe*oe);for(let Oe=Ne;Oe<Be;Oe++){const Fe=be[Oe],Ie=String.fromCharCode(Fe);let De=we.measureText(Ie).width;Te(Fe)&&De<50&&(De*=1.8),Ee.kernings[Ie]={width:De,nwidth:De/ge},Ee.pages[Fe]=[(Me+fe*.5)/Le.width,(Re+fe*.5)/Le.height,ye,Ie],we.save(),we.beginPath(),we.rect(Math.floor(Me)+.5,Math.floor(Re)+.5,fe-2,fe-2),we.clip(),we.fillText(Ie,Math.floor(Me+fe*pe),Math.floor(Re+fe+de),fe),we.restore(),Me+=fe,Me+fe>Le.width&&(Me=0,Re+=fe)}const xe=GL$1.Texture.fromImage(Le,{format:l.RGBA,magFilter:l.LINEAR,minFilter:l.LINEAR_MIPMAP_LINEAR,premultiply_alpha:!1,anisotropic:1});me.push(xe)}Ee.space=Ee.kernings[" "]?Ee.kernings[" "].width/ge:0;const Se={textures:me,info:Ee,name:$};return s[$]=Se,saveComplexData(Se,1),s[$]}L.getImageData=function(I,W,Z,$){var re=new Uint8Array(Z*$*4);return l.readPixels(I,W,Z,$,l.RGBA,l.UNSIGNED_BYTE,re),{data:re,width:Z,height:$,resolution:1}},L.putImageData=function(I,W,Z){var $=new GL$1.Texture(I.width,I.height,{filter:l.NEAREST,pixel_data:I.data});$.renderQuad(W,Z,$.width,$.height)},Object.defineProperty(l,"fillStyle",{get:function(){return this._fillStyle},set:function(I){I&&(this._fillStyle=I,hexColorToRGBA(I,this._fillcolor,this._globalAlpha))}}),Object.defineProperty(l,"strokeStyle",{get:function(){return this._strokeStyle},set:function(I){I&&(this._strokeStyle=I,hexColorToRGBA(I,this._strokecolor,this._globalAlpha))}}),Object.defineProperty(l,"fillColor",{get:function(){return this._fillcolor},set:function(I){I&&(I.length<5?this._fillcolor.set(I):console.error("fillColor value has more than 4 components"))}}),Object.defineProperty(l,"strokeColor",{get:function(){return this._strokecolor},set:function(I){I&&(I.length<5?this._strokecolor.set(I):console.error("strokeColor value has more than 4 components"))}}),Object.defineProperty(l,"shadowColor",{get:function(){return this._shadowcolor},set:function(I){I&&hexColorToRGBA(I,this._shadowcolor,this._globalAlpha)}}),Object.defineProperty(l,"globalAlpha",{get:function(){return this._globalAlpha},set:function(I){this._globalAlpha=I,this._strokecolor[3]=this._fillcolor[3]=I}}),Object.defineProperty(l,"globalCompositeOperation",{get:function(){return this._globalCompositeOperation},set:function(I){switch(this._globalCompositeOperation=I,l.blendEquation(l.FUNC_ADD),I){case"source-over":l.blendFunc(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA);break;case"difference":l.blendFunc(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA),l.blendEquation(l.FUNC_REVERSE_SUBTRACT);break}}}),Object.defineProperty(l,"font",{get:function(){return this._font},set:function(I){this._font=I;var W=I.split(" ");W.length>=3?(this._font_mode=W[0],this._font_size=parseFloat(W[1]),Number.isNaN(this._font_size)&&(this._font_size=14),this._font_size<5&&(this._font_size=5),this._font_family=W[2]):W.length==2?(this._font_mode="normal",this._font_size=parseFloat(W[0]),Number.isNaN(this._font_size)&&(this._font_size=14),this._font_size<5&&(this._font_size=5),this._font_family=W[1]):(this._font_mode="normal",this._font_family=W[0])}}),L._fillcolor=vec4.fromValues(0,0,0,1),L._strokecolor=vec4.fromValues(0,0,0,1),L._shadowcolor=vec4.fromValues(0,0,0,0),L._globalAlpha=1,L._font="14px monospace",L._font_family="monospace",L._font_size="14px",L._font_mode="normal",L.clip_level=0,L.strokeStyle="rgba(0,0,0,1)",L.fillStyle="rgba(0,0,0,1)",L.shadowColor="transparent",L.shadowOffsetX=L.shadowOffsetY=0,L.globalAlpha=1,L.globalCompositeOperation="source-over",L.setLineWidth=L.lineWidth,L.lineWidth=4,L.imageSmoothingEnabled=!0,L.tintImages=!1;var ue=["arcTo","isPointInPath","createImageData"],he=function(){};for(var ve in ue)L[ue[ve]]=he;return L}function openDatabase(){return new Promise((u,n)=>{const l=indexedDB.open("WebglContextDB",2);l.onupgradeneeded=function(h){var _;const d=h.target.result;(_=d.objectStoreNames)!=null&&_.contains("fontTexture")||d.createObjectStore("fontTexture",{keyPath:"name"})},l.onsuccess=function(h){u(h.target.result)},l.onerror=function(h){n(h.target.error)}})}async function makeTexture(u){const n=base64ToBlob(u.data),l=await blobToImage(n),h=GL$1.Texture.fromImage(l);return h.wrapS=u.wrapS||h.gl.CLAMP_TO_EDGE,h.wrapT=u.wrapT||h.gl.CLAMP_TO_EDGE,h.minFilter=u.minFilter||h.gl.LINEAR,h.magFilter=u.magFilter||h.gl.LINEAR,h.format=u.format||h.format,h.internalFormat=u.internalFormat||h.internalFormat,h.type=u.type||h.type,h.texture_type=u.texture_type||h.texture_type,h.width=u.width||h.width,h.height=u.height||h.height,u=h,u}function base64ToBlob(u){const n=atob(u.split(",")[1]),l=u.split(",")[0].split(":")[1].split(";")[0],h=new Array(n.length);for(let _=0;_<n.length;_++)h[_]=n.charCodeAt(_);const d=new Uint8Array(h);return new Blob([d],{type:l})}function blobToImage(u){return new Promise((n,l)=>{const h=new Image;h.onload=()=>n(h),h.onerror=l,h.src=URL.createObjectURL(u)})}function textureToBase64(u){const n=u.gl,l=u.handler,h=u.width,d=u.height,_=n.createFramebuffer();if(n.bindFramebuffer(n.FRAMEBUFFER,_),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,l,0),n.checkFramebufferStatus(n.FRAMEBUFFER)!==n.FRAMEBUFFER_COMPLETE)return console.error("Framebuffer is not complete."),n.bindFramebuffer(n.FRAMEBUFFER,null),n.deleteFramebuffer(_),null;const m=new Uint8Array(h*d*4),E=u.format||n.RGBA,L=u.type||n.UNSIGNED_BYTE;try{n.readPixels(0,0,h,d,E,L,m)}catch(G){return console.error("Error reading pixels from framebuffer:",G),null}const b=document.createElement("canvas");b.width=h,b.height=d;const S=b.getContext("2d"),R=S.createImageData(h,d);for(let G=0;G<d;G++){const D=G*h*4,H=(d-G-1)*h*4;R.data.set(m.subarray(D,D+h*4),H)}S.putImageData(R,0,0);const C=b.toDataURL("image/png");return n.bindFramebuffer(n.FRAMEBUFFER,null),n.deleteFramebuffer(_),C}async function saveComplexData(u,n=1){var l;try{const _=(await openDatabase()).transaction("fontTexture","readwrite").objectStore("fontTexture"),E=(l=u.textures)==null?void 0:l.map(R=>{const{width:C,height:G,format:D,internalFormat:H,type:e,wrapS:t,wrapT:r,minFilter:s,magFilter:a,has_mipmaps:o,texture_type:c}=R,f=textureToBase64(R);return{width:C,height:G,format:D,internalFormat:H,type:e,wrapS:t,wrapT:r,minFilter:s,magFilter:a,has_mipmaps:o,texture_type:c,data:f}}),L=new Date;L.setDate(L.getDate()+n);const b={info:u.info,textures:E,name:u.name,expiresAt:L.toISOString()},S=_.put(b);S.onsuccess=function(){},S.onerror=function(R){console.error("Error saving data:",R)}}catch(h){console.error("Error in saveComplexData:",h)}}async function getAllData(){const u=await openDatabase();return new Promise((n,l)=>{const d=u.transaction("fontTexture","readwrite").objectStore("fontTexture"),_=d.getAll();_.onsuccess=async function(m){const L=m.target.result.filter(b=>{const S=new Date,R=new Date(b.expiresAt);return S<R?!0:(d.delete(b.name),!1)});if((L==null?void 0:L.length)===0){n([]);return}for(const b of L)b.textures=await Promise.all(b.textures.map(async S=>makeTexture(S)));n(L)},_.onerror=function(m){console.error("Error retrieving data:",m.target.error),l(m.target.error)}})}enableWebGLCanvas.useInternationalFont=!0,enableWebGLCanvas.fontOffsetY=0;const Y=class Y{constructor(){}static distance(n,l){return Math.sqrt((l[0]-n[0])*(l[0]-n[0])+(l[1]-n[1])*(l[1]-n[1]))}static isInsideRectangle(n,l,h,d,_,m){return h<n&&h+_>n&&d<l&&d+m>l}static closeAllContextMenus(n){n=n||window;let l=n.document.querySelectorAll(".litecontextmenu");if(!l.length)return;let h=[];for(let d=0;d<l.length;d++)h.push(l[d]);for(let d=0;d<h.length;d++)h[d].close?h[d].close():h[d].parentNode&&h[d].parentNode.removeChild(h[d])}static extendClass(n,l){var h,d,_,m;for(const E in l)Object.prototype.hasOwnProperty.call(n,E)||(n[E]=l[E]);if(l.prototype)for(const E in l.prototype){if(!Object.prototype.hasOwnProperty.call(l.prototype,E)||Object.prototype.hasOwnProperty.call(n.prototype,E))continue;const L=(d=(h=l.prototype).__lookupGetter__)==null?void 0:d.call(h,E),b=(m=(_=l.prototype).__lookupSetter__)==null?void 0:m.call(_,E);L?n.prototype.__defineGetter__(E,L):n.prototype[E]=l.prototype[E],b&&n.prototype.__defineSetter__(E,b)}}static getParameterNames(n){return(n+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)}static pointerListenerAdd(n,l,h,d=!1){if(!n||!n.addEventListener||!l||typeof h!="function")return;let _=Y.pointerevents_method,m=l;if(_==="pointer"&&!window.PointerEvent){console.warn("PointerEvent not supported. Converting to touch event.");const L={down:"start",move:"move",up:"end",cancel:"cancel"};L[m]?(_="touch",m=L[m]):m==="enter"?console.log("debug: Should I send a move event?"):console.warn(`Event ${m} will not be called`)}if(["down","up","move","over","out","enter","leave","cancel","gotpointercapture","lostpointercapture"].includes(m)&&(_!=="mouse"||["down","up","move","over","out","enter"].includes(m))){n.addEventListener(_+m,h,d);return}n.addEventListener(m,h,d)}static pointerListenerRemove(n,l,h,d=!1){if(!n||!n.removeEventListener||!l||typeof h!="function")return;const _=Y.pointerevents_method,m=["down","up","move","over","out","enter"],E=["leave","cancel","gotpointercapture","lostpointercapture"];if(m.includes(l)&&(_==="pointer"||_==="mouse")){n.removeEventListener(_+l,h,d);return}if(E.includes(l)&&_==="pointer"){n.removeEventListener(_+l,h,d);return}n.removeEventListener(l,h,d)}static overlapBounding(n,l){let h=n[0]+n[2],d=n[1]+n[3],_=l[0]+l[2],m=l[1]+l[3];return!(n[0]>_||n[1]>m||h<l[0]||d<l[1])}static registerNodeType(n,l){if(!l.prototype)throw"Cannot register a simple object, it must be a class with a prototype";l.type=n,Y.debug&&console.log("Node registered: "+n);const h=l.name,d=n.lastIndexOf("/");l.category=n.substring(0,d),l.title||(l.title=h);for(let m in LGraphNode.prototype)l.prototype[m]||(l.prototype[m]=LGraphNode.prototype[m]);const _=Y.registered_node_types[n];if(_&&console.log("replacing node type: "+n),!Object.prototype.hasOwnProperty.call(l.prototype,"shape")&&(Object.defineProperty(l.prototype,"shape",{set:function(m){switch(m){case"default":delete this._shape;break;case"box":this._shape=Y.BOX_SHAPE;break;case"round":this._shape=Y.ROUND_SHAPE;break;case"circle":this._shape=Y.CIRCLE_SHAPE;break;case"card":this._shape=Y.CARD_SHAPE;break;default:this._shape=m}},get:function(){return this._shape},enumerable:!0,configurable:!0}),l.supported_extensions))for(let m in l.supported_extensions){const E=l.supported_extensions[m];E&&E.constructor===String&&(this.node_types_by_file_extension[E.toLowerCase()]=l)}Y.registered_node_types[n]=l,l.constructor.name&&(this.Nodes[h]=l),Y.onNodeTypeRegistered&&Y.onNodeTypeRegistered(n,l),_&&Y.onNodeTypeReplaced&&Y.onNodeTypeReplaced(n,l,_),l.prototype.onPropertyChange&&console.warn("LiteGraph node class "+n+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),this.auto_load_slot_types&&new l(l.title||"tmpnode")}static unregisterNodeType(n){const l=n.constructor===String?Y.registered_node_types[n]:n;if(!l)throw"node type not found: "+n;delete Y.registered_node_types[l.type],l.constructor.name&&delete this.Nodes[l.constructor.name]}static registerNodeAndSlotType(n,l,h){h=h||!1;const _=(n.constructor===String&&Y.registered_node_types[n]!=="anonymous"?Y.registered_node_types[n]:n).constructor.type;let m=[];typeof l=="string"?m=l.split(","):l==this.EVENT||l==this.ACTION?m=["_event_"]:m=["*"];for(let E=0;E<m.length;++E){let L=m[E];L===""&&(L="*");const b=h?"registered_slot_out_types":"registered_slot_in_types";this[b][L]===void 0&&(this[b][L]={nodes:[]}),this[b][L].nodes.includes(_)||this[b][L].nodes.push(_),h?this.slot_types_out.includes(L.toLowerCase())||(this.slot_types_out.push(L.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(L.toLowerCase())||(this.slot_types_in.push(L.toLowerCase()),this.slot_types_in.sort())}}static buildNodeClassFromObject(n,l){let h="";if(l.inputs)for(let _=0;_<l.inputs.length;++_){let m=l.inputs[_][0],E=l.inputs[_][1];E&&E.constructor===String&&(E='"'+E+'"'),h+="this.addInput('"+m+"',"+E+`);
`}if(l.outputs)for(let _=0;_<l.outputs.length;++_){let m=l.outputs[_][0],E=l.outputs[_][1];E&&E.constructor===String&&(E='"'+E+'"'),h+="this.addOutput('"+m+"',"+E+`);
`}if(l.properties)for(let _ in l.properties){let m=l.properties[_];m&&m.constructor===String&&(m='"'+m+'"'),h+="this.addProperty('"+_+"',"+m+`);
`}h+="if(this.onCreate)this.onCreate()";let d=Function(h);for(let _ in l)_!="inputs"&&_!="outputs"&&_!="properties"&&(d.prototype[_]=l[_]);return d.title=l.title||n.split("/").pop(),d.desc=l.desc||"Generated from object",Y.registerNodeType(n,d),d}static wrapFunctionAsNode(n,l,h,d,_){let m=Array(l.length),E="";if(h!==null){let b=Y.getParameterNames(l);for(let S=0;S<b.length;++S){let R=0;h&&(h[S]!=null&&h[S].constructor===String?R="'"+h[S]+"'":h[S]!=null&&(R=h[S])),E+="this.addInput('"+b[S]+"',"+R+`);
`}}d!==null&&(E+="this.addOutput('out',"+(d!=null?d.constructor===String?"'"+d+"'":d:0)+`);
`),_&&(E+="this.properties = "+JSON.stringify(_)+`;
`);let L=Function(E);return L.title=n.split("/").pop(),L.desc="Generated from "+l.name,L.prototype.onExecute=function(){for(let R=0;R<m.length;++R)m[R]=this.getInputData(R);let S=l.apply(this,m);this.setOutputData(0,S)},this.registerNodeType(n,L),L}static clearRegisteredTypes(){Y.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}static addNodeMethod(n,l){LGraphNode.prototype[n]=l;for(let h in Y.registered_node_types){let d=Y.registered_node_types[h];d.prototype[n]&&(d.prototype["_"+n]=d.prototype[n]),d.prototype[n]=l}}static createNode(n,l,h){let d=Y.registered_node_types[n];if(!d)return Y.debug&&console.log('GraphNode type "'+n+'" not registered.'),null;d.prototype,l=l||d.title||n;let _=null;if(Y.catch_exceptions)try{_=new d(l)}catch(m){return console.error(m),null}else _=new d(l);if(_.type=n,!_.title&&l&&(_.title=l),_.properties||(_.properties={}),_.properties_info||(_.properties_info=[]),_.flags||(_.flags={}),_.size||(_.size=_.computeSize()),_.pos||(_.pos=Y.DEFAULT_POSITION.concat()),_.mode||(_.mode=Y.ALWAYS),h)for(let m in h)_[m]=h[m];return _.onNodeCreated&&_.onNodeCreated(),_}static getNodeType(n){return Y.registered_node_types[n]}static getNodeTypesInCategory(n,l){let h=[];for(let d in Y.registered_node_types){let _=Y.registered_node_types[d];_.filter==l&&(n==""?_.category==null&&h.push(_):_.category==n&&h.push(_))}return this.auto_sort_node_types&&h.sort(function(d,_){return d.title.localeCompare(_.title)}),h}static getNodeTypesCategories(n){let l={"":1};for(let d in Y.registered_node_types){let _=Y.registered_node_types[d];if(_.category&&!_.skip_list){if(_.filter!=n)continue;l[_.category]=1}}let h=[];for(let d in l)h.push(d);return this.auto_sort_node_types?h.sort():h}static reloadNodes(n){let l=document.getElementsByTagName("script"),h=[];for(let _=0;_<l.length;_++)h.push(l[_]);let d=document.getElementsByTagName("head")[0];n=document.location.href+n;for(let _=0;_<h.length;_++){let m=h[_].src;if(!(!m||m.substr(0,n.length)!=n))try{Y.debug&&console.log("Reloading: "+m);let E=document.createElement("script");E.type="text/javascript",E.src=m,d.appendChild(E),d.removeChild(h[_])}catch(E){if(Y.throw_errors)throw E;Y.debug&&console.log("Error while reloading "+m)}}Y.debug&&console.log("Nodes reloaded")}static cloneObject(n,l){if(n==null)return null;let h=JSON.parse(JSON.stringify(n));if(!l)return h;for(let d in h)l[d]=h[d];return l}static uuidv4(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,n=>(n^Math.random()*16>>n/4).toString(16))}static isValidConnection(n,l){if((n==""||n==="*")&&(n=0),(l==""||l==="*")&&(l=0),!n||!l||n==l||n==Y.EVENT&&l==Y.ACTION)return!0;if(n=String(n),l=String(l),n=n.toLowerCase(),l=l.toLowerCase(),n.indexOf(",")==-1&&l.indexOf(",")==-1)return n==l;let h=n.split(","),d=l.split(",");for(let _=0;_<h.length;++_)for(let m=0;m<d.length;++m)if(this.isValidConnection(h[_],d[m]))return!0;return!1}static registerSearchboxExtra(n,l,h){this.searchbox_extras[l.toLowerCase()]={type:n,desc:l,data:h}}static fetchFile(n,l,h,d){if(!n)return null;if(l=l||"text",n.constructor===String)return n.substr(0,4)=="http"&&Y.proxy&&(n=Y.proxy+n.substr(n.indexOf(":")+3)),fetch(n).then(function(_){if(!_.ok)throw new Error("File not found");if(l=="arraybuffer")return _.arrayBuffer();if(l=="text"||l=="string")return _.text();if(l=="json")return _.json();if(l=="blob")return _.blob()}).then(function(_){h&&h(_)}).catch(function(_){console.error("error fetching file:",n),d&&d(_)});if(n.constructor===File||n.constructor===Blob){let _=new FileReader;if(_.onload=function(m){let E=m.target.result;l=="json"&&(E=JSON.parse(E)),h&&h(E)},l=="arraybuffer")return _.readAsArrayBuffer(n);if(l=="text"||l=="json")return _.readAsText(n);if(l=="blob")return _.readAsBinaryString(n)}return null}};ne(Y,"VERSION",.4),ne(Y,"CANVAS_GRID_SIZE",10),ne(Y,"NODE_TITLE_HEIGHT",30),ne(Y,"NODE_TITLE_TEXT_Y",20),ne(Y,"NODE_SLOT_HEIGHT",20),ne(Y,"NODE_WIDGET_HEIGHT",20),ne(Y,"NODE_WIDTH",140),ne(Y,"NODE_MIN_WIDTH",50),ne(Y,"NODE_COLLAPSED_RADIUS",10),ne(Y,"NODE_COLLAPSED_WIDTH",80),ne(Y,"NODE_TITLE_COLOR","#999"),ne(Y,"NODE_SELECTED_TITLE_COLOR","#FFF"),ne(Y,"NODE_TEXT_SIZE",14),ne(Y,"NODE_TEXT_COLOR","#AAA"),ne(Y,"NODE_SUBTEXT_SIZE",12),ne(Y,"NODE_DEFAULT_COLOR","#333"),ne(Y,"NODE_DEFAULT_BGCOLOR","#353535"),ne(Y,"NODE_DEFAULT_BOXCOLOR","#666"),ne(Y,"NODE_DEFAULT_SHAPE","box"),ne(Y,"NODE_BOX_OUTLINE_COLOR","#FFF"),ne(Y,"DEFAULT_SHADOW_COLOR","rgba(0,0,0,0.5)"),ne(Y,"DEFAULT_GROUP_FONT",24),ne(Y,"WIDGET_BGCOLOR","#222"),ne(Y,"WIDGET_OUTLINE_COLOR","#666"),ne(Y,"WIDGET_TEXT_COLOR","#DDD"),ne(Y,"WIDGET_SECONDARY_TEXT_COLOR","#999"),ne(Y,"LINK_COLOR","#9A9"),ne(Y,"EVENT_LINK_COLOR","#A86"),ne(Y,"CONNECTING_LINK_COLOR","#AFA"),ne(Y,"MAX_NUMBER_OF_NODES",1e3),ne(Y,"DEFAULT_POSITION",[100,100]),ne(Y,"VALID_SHAPES",["default","box","round","card"]),ne(Y,"BOX_SHAPE",1),ne(Y,"ROUND_SHAPE",2),ne(Y,"CIRCLE_SHAPE",3),ne(Y,"CARD_SHAPE",4),ne(Y,"ARROW_SHAPE",5),ne(Y,"GRID_SHAPE",6),ne(Y,"INPUT",1),ne(Y,"OUTPUT",2),ne(Y,"EVENT",-1),ne(Y,"ACTION",-1),ne(Y,"NODE_MODES",["Always","On Event","Never","On Trigger"]),ne(Y,"NODE_MODES_COLORS",["#666","#422","#333","#224","#626"]),ne(Y,"ALWAYS",0),ne(Y,"ON_EVENT",1),ne(Y,"NEVER",2),ne(Y,"ON_TRIGGER",3),ne(Y,"UP",1),ne(Y,"DOWN",2),ne(Y,"LEFT",3),ne(Y,"RIGHT",4),ne(Y,"CENTER",5),ne(Y,"LINK_RENDER_MODES",["Straight","Linear","Spline"]),ne(Y,"STRAIGHT_LINK",0),ne(Y,"LINEAR_LINK",1),ne(Y,"SPLINE_LINK",2),ne(Y,"NORMAL_TITLE",0),ne(Y,"NO_TITLE",1),ne(Y,"TRANSPARENT_TITLE",2),ne(Y,"AUTOHIDE_TITLE",3),ne(Y,"VERTICAL_LAYOUT","vertical"),ne(Y,"proxy",null),ne(Y,"node_images_path",""),ne(Y,"debug",!1),ne(Y,"catch_exceptions",!0),ne(Y,"throw_errors",!0),ne(Y,"allow_scripts",!1),ne(Y,"use_deferred_actions",!0),ne(Y,"registered_node_types",{}),ne(Y,"node_types_by_file_extension",{}),ne(Y,"Nodes",{}),ne(Y,"Globals",{}),ne(Y,"searchbox_extras",{}),ne(Y,"auto_sort_node_types",!1),ne(Y,"node_box_coloured_when_on",!1),ne(Y,"node_box_coloured_by_mode",!1),ne(Y,"dialog_close_on_mouse_leave",!0),ne(Y,"dialog_close_on_mouse_leave_delay",500),ne(Y,"shift_click_do_break_link_from",!1),ne(Y,"click_do_break_link_to",!1),ne(Y,"search_hide_on_mouse_leave",!0),ne(Y,"search_filter_enabled",!1),ne(Y,"search_show_all_on_open",!0),ne(Y,"auto_load_slot_types",!1),ne(Y,"registered_slot_in_types",{}),ne(Y,"registered_slot_out_types",{}),ne(Y,"slot_types_in",[]),ne(Y,"slot_types_out",[]),ne(Y,"slot_types_default_in",[]),ne(Y,"slot_types_default_out",[]),ne(Y,"alt_drag_do_clone_nodes",!1),ne(Y,"do_add_triggers_slots",!1),ne(Y,"allow_multi_output_for_events",!0),ne(Y,"middle_click_slot_add_default_node",!1),ne(Y,"release_link_on_empty_shows_menu",!1),ne(Y,"pointerevents_method","mouse"),ne(Y,"ctrl_shift_v_paste_connect_unselected_outputs",!1),ne(Y,"use_uuids",!1);let LiteGraph=Y;typeof performance<"u"?LiteGraph.getTime=performance.now.bind(performance):typeof Date<"u"&&Date.now?LiteGraph.getTime=Date.now.bind(Date):typeof process<"u"?LiteGraph.getTime=function(){let u=process.hrtime();return u[0]*.001+u[1]*1e-6}:LiteGraph.getTime=function(){return new Date().getTime()};class LLink{constructor(n,l,h,d,_,m){this.id=n,this.type=l,this.origin_id=h,this.origin_slot=d,this.target_id=_,this.target_slot=m,this._data=null,this._pos=new Float32Array(2)}configure(n){n.constructor===Array?(this.id=n[0],this.origin_id=n[1],this.origin_slot=n[2],this.target_id=n[3],this.target_slot=n[4],this.type=n[5]):(this.id=n.id,this.type=n.type,this.origin_id=n.origin_id,this.origin_slot=n.origin_slot,this.target_id=n.target_id,this.target_slot=n.target_slot)}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}class LGraphNode{constructor(n){this._ctor(n)}_ctor(n){this.title=n||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(l){!l||l.length<2||(this._pos[0]=l[0],this._pos[1]=l[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}}configure(n){this.graph&&this.graph._version++;for(const l in n){if(l=="properties"){for(const h in n.properties)this.properties[h]=n.properties[h],this.onPropertyChanged&&this.onPropertyChanged(h,n.properties[h]);continue}n[l]!=null&&(typeof n[l]=="object"?this[l]&&this[l].configure?this[l].configure(n[l]):this[l]=LiteGraph.cloneObject(n[l],this[l]):this[l]=n[l])}if(n.title||(this.title=this.constructor.title),this.inputs)for(let l=0;l<this.inputs.length;++l){const h=this.inputs[l],d=this.graph?this.graph.links[h.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,l,!0,d,h),this.onInputAdded&&this.onInputAdded(h)}if(this.outputs)for(let l=0;l<this.outputs.length;++l){const h=this.outputs[l];if(h.links){for(let d=0;d<h.links.length;++d){const _=this.graph?this.graph.links[h.links[d]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,l,!0,_,h)}this.onOutputAdded&&this.onOutputAdded(h)}}if(this.widgets){for(let l=0;l<this.widgets.length;++l){const h=this.widgets[l];h&&h.options&&h.options.property&&this.properties[h.options.property]!=null&&(h.value=JSON.parse(JSON.stringify(this.properties[h.options.property])))}if(n.widgets_values)for(let l=0;l<n.widgets_values.length;++l)this.widgets[l]&&(this.widgets[l].value=n.widgets_values[l])}this.onConfigure&&this.onConfigure(n)}serialize(){const n={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;if(this.inputs&&(n.inputs=this.inputs),this.outputs){for(let l=0;l<this.outputs.length;l++)delete this.outputs[l]._data;n.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(n.title=this.title),this.properties&&(n.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){n.widgets_values=[];for(let l=0;l<this.widgets.length;++l)this.widgets[l]?n.widgets_values[l]=this.widgets[l].value:n.widgets_values[l]=null}return n.type||(n.type=this.constructor.type),this.color&&(n.color=this.color),this.bgcolor&&(n.bgcolor=this.bgcolor),this.boxcolor&&(n.boxcolor=this.boxcolor),this.shape&&(n.shape=this.shape),this.onSerialize&&this.onSerialize(n)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),n}clone(){const n=LiteGraph.createNode(this.type);if(!n)return null;const l=LiteGraph.cloneObject(this.serialize());if(l.inputs)for(let h=0;h<l.inputs.length;++h)l.inputs[h].link=null;if(l.outputs)for(let h=0;h<l.outputs.length;++h)l.outputs[h].links&&(l.outputs[h].links.length=0);return delete l.id,LiteGraph.use_uuids&&(l.id=LiteGraph.uuidv4()),n.configure(l),n}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title||this.constructor.title}setProperty(n,l){if(this.properties||(this.properties={}),l===this.properties[n])return;const h=this.properties[n];if(this.properties[n]=l,this.onPropertyChanged&&this.onPropertyChanged(n,l,h)===!1&&(this.properties[n]=h),this.widgets)for(let d=0;d<this.widgets.length;++d){const _=this.widgets[d];if(_&&_.options.property==n){_.value=l;break}}}setOutputData(n,l){if(!this.outputs||n==-1||n>=this.outputs.length)return;const h=this.outputs[n];if(h&&(h._data=l,this.outputs[n].links))for(let d=0;d<this.outputs[n].links.length;d++){const _=this.outputs[n].links[d],m=this.graph.links[_];m&&(m.data=l)}}setOutputDataType(n,l){if(!this.outputs||n==-1||n>=this.outputs.length)return;const h=this.outputs[n];if(h&&(h.type=l,this.outputs[n].links))for(let d=0;d<this.outputs[n].links.length;d++){const _=this.outputs[n].links[d];this.graph.links[_].type=l}}getInputData(n,l){if(!this.inputs||n>=this.inputs.length||this.inputs[n].link==null)return;const h=this.inputs[n].link,d=this.graph.links[h];if(!d)return null;if(!l)return d.data;const _=this.graph.getNodeById(d.origin_id);return _&&(_.updateOutputData?_.updateOutputData(d.origin_slot):_.onExecute&&_.onExecute()),d.data}getInputDataType(n){if(!this.inputs||n>=this.inputs.length||this.inputs[n].link==null)return null;const l=this.inputs[n].link,h=this.graph.links[l];if(!h)return null;const d=this.graph.getNodeById(h.origin_id);if(!d)return h.type;const _=d.outputs[h.origin_slot];return _?_.type:null}getInputDataByName(n,l){const h=this.findInputSlot(n);return h==-1?null:this.getInputData(h,l)}isInputConnected(n){return this.inputs?n<this.inputs.length&&this.inputs[n].link!=null:!1}getInputInfo(n){return this.inputs&&n<this.inputs.length?this.inputs[n]:null}getInputLink(n){if(!this.inputs)return null;if(n<this.inputs.length){const l=this.inputs[n];return this.graph.links[l.link]}return null}getInputNode(n){if(!this.inputs||n>=this.inputs.length)return null;const l=this.inputs[n];if(!l||l.link===null)return null;const h=this.graph.links[l.link];return h?this.graph.getNodeById(h.origin_id):null}getInputOrProperty(n){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[n]:null;for(let l=0,h=this.inputs.length;l<h;++l){const d=this.inputs[l];if(n==d.name&&d.link!=null){const _=this.graph.links[d.link];if(_)return _.data}}return this.properties[n]}getOutputData(n){return!this.outputs||n>=this.outputs.length?null:this.outputs[n]._data}getOutputInfo(n){return this.outputs&&n<this.outputs.length?this.outputs[n]:null}isOutputConnected(n){return this.outputs?n<this.outputs.length&&this.outputs[n].links&&this.outputs[n].links.length:!1}isAnyOutputConnected(){if(!this.outputs)return!1;for(let n=0;n<this.outputs.length;++n)if(this.outputs[n].links&&this.outputs[n].links.length)return!0;return!1}getOutputNodes(n){if(!this.outputs||this.outputs.length==0||n>=this.outputs.length)return null;const l=this.outputs[n];if(!l.links||l.links.length==0)return null;const h=[];for(let d=0;d<l.links.length;d++){const _=l.links[d],m=this.graph.links[_];if(m){const E=this.graph.getNodeById(m.target_id);E&&h.push(E)}}return h}addOnTriggerInput(){const n=this.findInputSlot("onTrigger");if(n==-1){//!trigS ||
return this.addInput("onTrigger",LiteGraph.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")}return n}addOnExecutedOutput(){const n=this.findOutputSlot("onExecuted");if(n==-1){//!trigS ||
return this.addOutput("onExecuted",LiteGraph.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")}return n}onAfterExecuteNode(n,l){const h=this.findOutputSlot("onExecuted");h!=-1&&this.triggerSlot(h,n,null,l)}changeMode(n){switch(n){case LiteGraph.ON_EVENT:break;case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.NEVER:break;case LiteGraph.ALWAYS:break;case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=n,!0}executePendingActions(){if(!(!this._waiting_actions||!this._waiting_actions.length)){for(let n=0;n<this._waiting_actions.length;++n){const l=this._waiting_actions[n];this.onAction(l[0],l[1],l[2],l[3],l[4])}this._waiting_actions.length=0}}doExecute(n,l){l=l||{},this.onExecute&&(l.action_call||(l.action_call=this.id+"_exec_"+Math.floor(Math.random()*9999)),this.graph.nodes_executing[this.id]=!0,this.onExecute(n,l),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,l&&l.action_call&&(this.action_call=l.action_call,this.graph.nodes_executedAction[this.id]=l.action_call)),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(n,l)}actionDo(n,l,h,d){h=h||{},this.onAction&&(h.action_call||(h.action_call=this.id+"_"+(n||"action")+"_"+Math.floor(Math.random()*9999)),this.graph.nodes_actioning[this.id]=n||"actioning",this.onAction(n,l,h,d),this.graph.nodes_actioning[this.id]=!1,h&&h.action_call&&(this.action_call=h.action_call,this.graph.nodes_executedAction[this.id]=h.action_call)),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(l,h)}trigger(n,l,h){if(!(!this.outputs||!this.outputs.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(let d=0;d<this.outputs.length;++d){const _=this.outputs[d];!_||_.type!==LiteGraph.EVENT||n&&_.name!=n||this.triggerSlot(d,l,null,h)}}}triggerSlot(n,l,h,d){if(d=d||{},!this.outputs)return;if(n==null){console.error("slot must be a number");return}n.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");const _=this.outputs[n];if(!_)return;const m=_.links;if(!(!m||!m.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(let E=0;E<m.length;++E){const L=m[E];if(h!=null&&h!=L)continue;const b=this.graph.links[m[E]];if(!b)continue;b._last_time=LiteGraph.getTime();const S=this.graph.getNodeById(b.target_id);if(S){if(S.inputs[b.target_slot],S.mode===LiteGraph.ON_TRIGGER)d.action_call||(d.action_call=this.id+"_trigg_"+Math.floor(Math.random()*9999)),S.onExecute&&S.doExecute(l,d);else if(S.onAction){d.action_call||(d.action_call=this.id+"_act_"+Math.floor(Math.random()*9999));const R=S.inputs[b.target_slot];LiteGraph.use_deferred_actions&&S.onExecute?(S._waiting_actions||(S._waiting_actions=[]),S._waiting_actions.push([R.name,l,d,b.target_slot])):S.actionDo(R.name,l,d,b.target_slot)}}}}}clearTriggeredSlot(n,l){if(!this.outputs)return;const h=this.outputs[n];if(!h)return;const d=h.links;if(!(!d||!d.length))for(let _=0;_<d.length;++_){const m=d[_];if(l!=null&&l!=m)continue;const E=this.graph.links[d[_]];E&&(E._last_time=0)}}setSize(n){this.size=n,this.onResize&&this.onResize(this.size)}addProperty(n,l,h,d){const _={name:n,type:h,default_value:l};if(d)for(const m in d)_[m]=d[m];return this.properties_info||(this.properties_info=[]),this.properties_info.push(_),this.properties||(this.properties={}),this.properties[n]=l,_}addOutput(n,l,h){const d={name:n,type:l,links:null};if(h)for(const _ in h)d[_]=h[_];return this.outputs||(this.outputs=[]),this.outputs.push(d),this.onOutputAdded&&this.onOutputAdded(d),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,l,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),d}addOutputs(n){for(let l=0;l<n.length;++l){const h=n[l],d={name:h[0],type:h[1],link:null};if(n[2])for(const _ in h[2])d[_]=h[2][_];this.outputs||(this.outputs=[]),this.outputs.push(d),this.onOutputAdded&&this.onOutputAdded(d),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,h[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}removeOutput(n){this.disconnectOutput(n),this.outputs.splice(n,1);for(let l=n;l<this.outputs.length;++l){if(!this.outputs[l]||!this.outputs[l].links)continue;const h=this.outputs[l].links;for(let d=0;d<h.length;++d){const _=this.graph.links[h[d]];_&&(_.origin_slot-=1)}}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(n),this.setDirtyCanvas(!0,!0)}addInput(n,l,h){l=l||0;const d={name:n,type:l,link:null};if(h)for(const _ in h)d[_]=h[_];return this.inputs||(this.inputs=[]),this.inputs.push(d),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(d),LiteGraph.registerNodeAndSlotType(this,l),this.setDirtyCanvas(!0,!0),d}addInputs(n){for(let l=0;l<n.length;++l){const h=n[l],d={name:h[0],type:h[1],link:null};if(n[2])for(const _ in h[2])d[_]=h[2][_];this.inputs||(this.inputs=[]),this.inputs.push(d),this.onInputAdded&&this.onInputAdded(d),LiteGraph.registerNodeAndSlotType(this,h[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}removeInput(n){this.disconnectInput(n);const l=this.inputs.splice(n,1);for(let h=n;h<this.inputs.length;++h){if(!this.inputs[h])continue;const d=this.graph.links[this.inputs[h].link];d&&(d.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(n,l[0]),this.setDirtyCanvas(!0,!0)}addConnection(n,l,h,d){const _={name:n,type:l,pos:h,direction:d,links:null};return this.connections.push(_),_}computeSize(n){if(this.constructor.size)return this.constructor.size.concat();let l=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1);const h=n||new Float32Array([0,0]);l=Math.max(l,1);const d=LiteGraph.NODE_TEXT_SIZE,_=b(this.title);let m=0,E=0;if(this.inputs)for(let S=0,R=this.inputs.length;S<R;++S){const C=this.inputs[S],G=C.label||C.name||"",D=b(G);m<D&&(m=D)}if(this.outputs)for(let S=0,R=this.outputs.length;S<R;++S){const C=this.outputs[S],G=C.label||C.name||"",D=b(G);E<D&&(E=D)}h[0]=Math.max(m+E+10,_),h[0]=Math.max(h[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(h[0]=Math.max(h[0],LiteGraph.NODE_WIDTH*1.5)),h[1]=(this.constructor.slot_start_y||0)+l*LiteGraph.NODE_SLOT_HEIGHT;let L=0;if(this.widgets&&this.widgets.length){for(let S=0,R=this.widgets.length;S<R;++S)this.widgets[S].computeSize?L+=this.widgets[S].computeSize(h[0])[1]+4:L+=LiteGraph.NODE_WIDGET_HEIGHT+4;L+=8}this.widgets_up?h[1]=Math.max(h[1],L):this.widgets_start_y!=null?h[1]=Math.max(h[1],L+this.widgets_start_y):h[1]+=L;function b(S){return S?d*S.length*.6:0}return this.constructor.min_height&&h[1]<this.constructor.min_height&&(h[1]=this.constructor.min_height),h[1]+=6,h}getPropertyInfo(n){let l=null;if(this.properties_info){for(let h=0;h<this.properties_info.length;++h)if(this.properties_info[h].name==n){l=this.properties_info[h];break}}return this.constructor["@"+n]&&(l=this.constructor["@"+n]),this.constructor.widgets_info&&this.constructor.widgets_info[n]&&(l=this.constructor.widgets_info[n]),!l&&this.onGetPropertyInfo&&(l=this.onGetPropertyInfo(n)),l||(l={}),l.type||(l.type=typeof this.properties[n]),l.widget=="combo"&&(l.type="enum"),l}addWidget(n,l,h,d,_){this.widgets||(this.widgets=[]),!_&&d&&d.constructor===Object&&(_=d,d=null),_&&_.constructor===String&&(_={property:_}),d&&d.constructor===String&&(_||(_={}),_.property=d,d=null),d&&d.constructor!==Function&&(console.warn("addWidget: callback must be a function"),d=null);const m={type:n.toLowerCase(),name:l,value:h,callback:d,options:_||{}};if(m.options.y!==void 0&&(m.y=m.options.y),!d&&!m.options.callback&&!m.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),n=="combo"&&!m.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(m),this.setSize(this.computeSize()),m}addCustomWidget(n){return this.widgets||(this.widgets=[]),this.widgets.push(n),n}getBounding(n,l){n=n||new Float32Array(4);const h=this.pos,d=this.flags.collapsed,_=this.size;let m=0,E=1,L=0,b=0;return l&&(m=4,E=6+m,L=4,b=5+L),n[0]=h[0]-m,n[1]=h[1]-LiteGraph.NODE_TITLE_HEIGHT-L,n[2]=d?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+E:_[0]+E,n[3]=d?LiteGraph.NODE_TITLE_HEIGHT+b:_[1]+LiteGraph.NODE_TITLE_HEIGHT+b,this.onBounding&&this.onBounding(n),n}isPointInside(n,l,h,d){h=h||0;let _=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(d&&(_=0),this.flags&&this.flags.collapsed){if(LiteGraph.isInsideRectangle(n,l,this.pos[0]-h,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-h,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*h,LiteGraph.NODE_TITLE_HEIGHT+2*h))return!0}else if(this.pos[0]-4-h<n&&this.pos[0]+this.size[0]+4+h>n&&this.pos[1]-_-h<l&&this.pos[1]+this.size[1]+h>l)return!0;return!1}getSlotInPosition(n,l){const h=new Float32Array(2);if(this.inputs)for(let d=0,_=this.inputs.length;d<_;++d){const m=this.inputs[d];if(this.getConnectionPos(!0,d,h),LiteGraph.isInsideRectangle(n,l,h[0]-10,h[1]-5,20,10))return{input:m,slot:d,link_pos:h}}if(this.outputs)for(let d=0,_=this.outputs.length;d<_;++d){const m=this.outputs[d];if(this.getConnectionPos(!1,d,h),LiteGraph.isInsideRectangle(n,l,h[0]-10,h[1]-5,20,10))return{output:m,slot:d,link_pos:h}}return null}findInputSlot(n,l){if(!this.inputs)return-1;for(let h=0,d=this.inputs.length;h<d;++h)if(n==this.inputs[h].name)return l?this.inputs[h]:h;return-1}findOutputSlot(n,l){if(l=l||!1,!this.outputs)return-1;for(let h=0,d=this.outputs.length;h<d;++h)if(n==this.outputs[h].name)return l?this.outputs[h]:h;return-1}findInputSlotFree(n){const d=Object.assign({returnObj:!1,typesNotAccepted:[]},n||{});if(!this.inputs)return-1;for(let _=0,m=this.inputs.length;_<m;++_)if(!(this.inputs[_].link&&this.inputs[_].link!=null)&&!(d.typesNotAccepted&&d.typesNotAccepted.includes&&d.typesNotAccepted.includes(this.inputs[_].type)))return d.returnObj?this.inputs[_]:_;return-1}findOutputSlotFree(n){const d=Object.assign({returnObj:!1,typesNotAccepted:[]},n||{});if(!this.outputs)return-1;for(let _=0,m=this.outputs.length;_<m;++_)if(!(this.outputs[_].links&&this.outputs[_].links!=null)&&!(d.typesNotAccepted&&d.typesNotAccepted.includes&&d.typesNotAccepted.includes(this.outputs[_].type)))return d.returnObj?this.outputs[_]:_;return-1}findInputSlotByType(n,l,h,d){return this.findSlotByType(!0,n,l,h,d)}findOutputSlotByType(n,l,h,d){return this.findSlotByType(!1,n,l,h,d)}findSlotByType(n,l,h,d,_){n=n||!1,h=h||!1,d=d||!1,_=_||!1;const m=n?this.inputs:this.outputs;if(!m)return-1;(l==""||l=="*")&&(l=0);for(let E=0,L=m.length;E<L;++E){const b=(l+"").toLowerCase().split(",");let S=m[E].type=="0"||m[E].type=="*"?"0":m[E].type;S=(S+"").toLowerCase().split(",");for(let R=0;R<b.length;R++)for(let C=0;C<S.length;C++)if(b[R]=="_event_"&&(b[R]=LiteGraph.EVENT),S[R]=="_event_"&&(S[R]=LiteGraph.EVENT),b[R]=="*"&&(b[R]=0),S[R]=="*"&&(S[R]=0),b[R]==S[C]){if(d&&m[E].links&&m[E].links!==null)continue;return h?m[E]:E}}if(d&&!_)for(let E=0,L=m.length;E<L;++E){const b=(l+"").toLowerCase().split(",");let S=m[E].type=="0"||m[E].type=="*"?"0":m[E].type;S=(S+"").toLowerCase().split(",");for(let R=0;R<b.length;R++)for(let C=0;C<S.length;C++)if(b[R]=="*"&&(b[R]=0),S[R]=="*"&&(S[R]=0),b[R]==S[C])return h?m[E]:E}return-1}connectByType(n,l,h,d){const E=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},d||{});l&&l.constructor===Number&&(l=this.graph.getNodeById(l));const L=l.findInputSlotByType(h,!1,!0);if(L>=0&&L!==null)return this.connect(n,l,L);if(E.createEventInCase&&h==LiteGraph.EVENT)return this.connect(n,l,-1);if(E.generalTypeInCase){const b=l.findInputSlotByType(0,!1,!0,!0);if(b>=0)return this.connect(n,l,b)}if(E.firstFreeIfOutputGeneralInCase&&(h==0||h=="*"||h=="")){const b=l.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(b>=0)return this.connect(n,l,b)}return console.debug("no way to connect type: ",h," to targetNODE ",l),null}connectByTypeOutput(n,l,h,d){const E=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},d||{});l&&l.constructor===Number&&(l=this.graph.getNodeById(l));const L=l.findOutputSlotByType(h,!1,!0);if(L>=0&&L!==null)return l.connect(L,this,n);if(E.generalTypeInCase){const b=l.findOutputSlotByType(0,!1,!0,!0);if(b>=0)return l.connect(b,this,n)}if(E.createEventInCase&&h==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots){const b=l.addOnExecutedOutput();return l.connect(b,this,n)}if(E.firstFreeIfInputGeneralInCase&&(h==0||h=="*"||h=="")){const b=l.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(b>=0)return l.connect(b,this,n)}return console.debug("no way to connect byOUT type: ",h," to sourceNODE ",l),null}connect(n,l,h){if(h=h||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(n.constructor===String){if(n=this.findOutputSlot(n),n==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+n),null}else if(!this.outputs||n>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(l&&l.constructor===Number&&(l=this.graph.getNodeById(l)),!l)throw"target node is null";if(l==this)return null;if(h.constructor===String){if(h=l.findInputSlot(h),h==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+h),null}else if(h===LiteGraph.EVENT)if(LiteGraph.do_add_triggers_slots)l.changeMode(LiteGraph.ON_TRIGGER),h=l.findInputSlot("onTrigger");else return null;else if(!l.inputs||h>=l.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;let d=!1;const _=l.inputs[h];let m=null;const E=this.outputs[n];if(!this.outputs[n])return null;if(l.onBeforeConnectInput&&(h=l.onBeforeConnectInput(h)),h===!1||h===null||!LiteGraph.isValidConnection(E.type,_.type))return this.setDirtyCanvas(!1,!0),d&&this.graph.connectionChange(this,m),null;if(l.onConnectInput&&l.onConnectInput(h,E.type,E,this,n)===!1||this.onConnectOutput&&this.onConnectOutput(n,_.type,_,l,h)===!1)return null;if(l.inputs[h]&&l.inputs[h].link!=null&&(this.graph.beforeChange(),l.disconnectInput(h,{doProcessChange:!1}),d=!0),E.links!==null&&E.links.length)switch(E.type){case LiteGraph.EVENT:LiteGraph.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(n,!1,{doProcessChange:!1}),d=!0);break}let L;return LiteGraph.use_uuids?L=LiteGraph.uuidv4():L=++this.graph.last_link_id,m=new LLink(L,_.type||E.type,this.id,n,l.id,h),this.graph.links[m.id]=m,E.links==null&&(E.links=[]),E.links.push(m.id),l.inputs[h].link=m.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,n,!0,m,E),l.onConnectionsChange&&l.onConnectionsChange(LiteGraph.INPUT,h,!0,m,_),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,l,h,this,n),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,n,l,h)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,m),m}disconnectOutput(n,l){if(n.constructor===String){if(n=this.findOutputSlot(n),n==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+n),!1}else if(!this.outputs||n>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const h=this.outputs[n];if(!h||!h.links||h.links.length==0)return!1;if(l){if(l.constructor===Number&&(l=this.graph.getNodeById(l)),!l)throw"Target Node not found";for(let d=0,_=h.links.length;d<_;d++){const m=h.links[d],E=this.graph.links[m];if(E.target_id==l.id){h.links.splice(d,1);const L=l.inputs[E.target_slot];L.link=null,delete this.graph.links[m],this.graph&&this.graph._version++,l.onConnectionsChange&&l.onConnectionsChange(LiteGraph.INPUT,E.target_slot,!1,E,L),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,n,!1,E,h),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,n),this.graph.onNodeConnectionChange(LiteGraph.INPUT,l,E.target_slot));break}}}else{for(let d=0,_=h.links.length;d<_;d++){const m=h.links[d],E=this.graph.links[m];if(!E)continue;const L=this.graph.getNodeById(E.target_id);let b=null;this.graph&&this.graph._version++,L&&(b=L.inputs[E.target_slot],b.link=null,L.onConnectionsChange&&L.onConnectionsChange(LiteGraph.INPUT,E.target_slot,!1,E,b),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,L,E.target_slot)),delete this.graph.links[m],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,n,!1,E,h),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,n),this.graph.onNodeConnectionChange(LiteGraph.INPUT,L,E.target_slot))}h.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}disconnectInput(n){if(n.constructor===String){if(n=this.findInputSlot(n),n==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+n),!1}else if(!this.inputs||n>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const l=this.inputs[n];if(!l)return!1;const h=this.inputs[n].link;if(h!=null){this.inputs[n].link=null;const d=this.graph.links[h];if(d){const _=this.graph.getNodeById(d.origin_id);if(!_)return!1;const m=_.outputs[d.origin_slot];if(!m||!m.links||m.links.length==0)return!1;let E=null;for(let L=0,b=m.links.length;L<b;L++)if(E=L,m.links[L]==h){m.links.splice(L,1);break}delete this.graph.links[h],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,n,!1,d,l),_.onConnectionsChange&&_.onConnectionsChange(LiteGraph.OUTPUT,E,!1,d,m),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,_,E),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,n))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}getConnectionPos(n,l,h){h=h||new Float32Array(2);let d=0;n&&this.inputs&&(d=this.inputs.length),!n&&this.outputs&&(d=this.outputs.length);const _=LiteGraph.NODE_SLOT_HEIGHT*.5;if(this.flags.collapsed){const m=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return this.horizontal?(h[0]=this.pos[0]+m*.5,n?h[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:h[1]=this.pos[1]):(n?h[0]=this.pos[0]:h[0]=this.pos[0]+m,h[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT*.5),h}return n&&l==-1?(h[0]=this.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*.5,h[1]=this.pos[1]+LiteGraph.NODE_TITLE_HEIGHT*.5,h):n&&d>l&&this.inputs[l].pos?(h[0]=this.pos[0]+this.inputs[l].pos[0],h[1]=this.pos[1]+this.inputs[l].pos[1],h):!n&&d>l&&this.outputs[l].pos?(h[0]=this.pos[0]+this.outputs[l].pos[0],h[1]=this.pos[1]+this.outputs[l].pos[1],h):this.horizontal?(h[0]=this.pos[0]+(l+.5)*(this.size[0]/d),n?h[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:h[1]=this.pos[1]+this.size[1],h):(n?h[0]=this.pos[0]+_:h[0]=this.pos[0]+this.size[0]+1-_,h[1]=this.pos[1]+(l+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),h)}alignToGrid(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)}trace(n){this.console||(this.console=[]),this.console.push(n),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,n)}setDirtyCanvas(n,l){this.graph&&this.graph.sendActionToCanvas("setDirty",[n,l])}loadImage(n){const l=new Image;l.src=LiteGraph.node_images_path+n,l.ready=!1;const h=this;return l.onload=function(){this.ready=!0,h.setDirtyCanvas(!0)},l}captureInput(n){if(!this.graph||!this.graph.list_of_graphcanvas)return;const l=this.graph.list_of_graphcanvas;for(let h=0;h<l.length;++h){const d=l[h];!n&&d.node_capturing_input!=this||(d.node_capturing_input=n?this:null)}}collapse(n){this.graph._version++,!(this.constructor.collapsable===!1&&!n)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))}pin(n){this.graph._version++,n===void 0?this.flags.pinned=!this.flags.pinned:this.flags.pinned=n}localToScreen(n,l,h){return[(n+this.pos[0])*h.scale+h.offset[0],(l+this.pos[1])*h.scale+h.offset[1]]}}class LGraphGroup{constructor(n){this._ctor(n)}_ctor(n){this.title=n||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,this.id=LiteGraph.uuidv4(),this.group_id=null,Object.defineProperty(this,"pos",{set:function(l){!l||l.length<2||(this._pos[0]=Math.round(l[0]),this._pos[1]=Math.round(l[1]))},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(l){!l||l.length<2||(this._size[0]=Math.max(140,Math.round(l[0])),this._size[1]=Math.max(80,l[1]))},get:function(){return this._size},enumerable:!0})}configure(n){this.title=n.title,this._bounding.set(n.bounding),this.color=n.color,this.font_size=n.font_size,this.id=n.id,this.group_id=n.group_id,this.status=n.status}serialize(){let n=this._bounding;return{title:this.title,bounding:[Math.round(n[0]),Math.round(n[1]),Math.round(n[2]),Math.round(n[3])],color:this.color,font_size:this.font_size,id:this.id,status:this.status,group_id:this.group_id}}move(n,l,h){if(this._pos[0]+=n,this._pos[1]+=l,!h)for(let d=0;d<this._nodes.length;++d){let _=this._nodes[d];_.pos[0]+=n,_.pos[1]+=l}}recomputeInsideNodes(){this._nodes.length=0;let n=this.graph._nodes,l=new Float32Array(4);for(let h=0;h<n.length;++h){let d=n[h];d.getBounding(l),LiteGraph.overlapBounding(this._bounding,l)&&this._nodes.push(d)}}isPointInside(n,l,h,d){h=h||0;let _=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(d&&(_=0),this.flags&&this.flags.collapsed){if(LiteGraph.isInsideRectangle(n,l,this.pos[0]-h,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-h,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*h,LiteGraph.NODE_TITLE_HEIGHT+2*h))return!0}else if(this.pos[0]-4-h<n&&this.pos[0]+this.size[0]+4+h>n&&this.pos[1]-_-h<l&&this.pos[1]+this.size[1]+h>l)return!0;return!1}setDirtyCanvas(n,l){this.graph&&this.graph.sendActionToCanvas("setDirty",[n,l])}}class DragAndScale{constructor(n,l){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),n&&(this.element=n,l||this.bindEvents(n))}bindEvents(n){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph.pointerListenerAdd(n,"down",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(n,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(n,"up",this._binded_mouse_callback),n.addEventListener("mousewheel",this._binded_mouse_callback,!1),n.addEventListener("wheel",this._binded_mouse_callback,!1)}computeVisibleArea(n){if(!this.element){this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0;return}let l=this.element.width,h=this.element.height,d=-this.offset[0],_=-this.offset[1];n&&(d+=n[0]/this.scale,_+=n[1]/this.scale,l=n[2],h=n[3]);const m=d+l/this.scale,E=_+h/this.scale;this.visible_area[0]=d,this.visible_area[1]=_,this.visible_area[2]=m-d,this.visible_area[3]=E-_}onMouse(n){if(!this.enabled)return;const l=this.element,h=l.getBoundingClientRect(),d=n.clientX-h.left,_=n.clientY-h.top;n.canvasx=d,n.canvasy=_,n.dragging=this.dragging;const m=!this.viewport||this.viewport&&d>=this.viewport[0]&&d<this.viewport[0]+this.viewport[2]&&_>=this.viewport[1]&&_<this.viewport[1]+this.viewport[3];let E=!1;if(this.onmouse&&(E=this.onmouse(n)),n.type==LiteGraph.pointerevents_method+"down"&&m)this.dragging=!0,LiteGraph.pointerListenerRemove(l,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"up",this._binded_mouse_callback);else if(n.type==LiteGraph.pointerevents_method+"move"){if(!E){const L=d-this.last_mouse[0],b=_-this.last_mouse[1];this.dragging&&this.mouseDrag(L,b)}}else n.type==LiteGraph.pointerevents_method+"up"?(this.dragging=!1,LiteGraph.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(l,"move",this._binded_mouse_callback)):m&&(n.type=="mousewheel"||n.type=="wheel"||n.type=="DOMMouseScroll")&&(n.eventType="mousewheel",n.type=="wheel"?n.wheel=-n.deltaY:n.wheel=n.wheelDeltaY!=null?n.wheelDeltaY:n.detail*-60,n.delta=n.wheelDelta?n.wheelDelta/40:n.deltaY?-n.deltaY/3:0,this.changeDeltaScale(1+n.delta*.05));if(this.last_mouse[0]=d,this.last_mouse[1]=_,m)return n.preventDefault(),n.stopPropagation(),!1}toCanvasContext(n){n.scale(this.scale,this.scale),n.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(n){return[(n[0]+this.offset[0])*this.scale,(n[1]+this.offset[1])*this.scale]}convertCanvasToOffset(n,l){return l=l||[0,0],l[0]=n[0]/this.scale-this.offset[0],l[1]=n[1]/this.scale-this.offset[1],l}mouseDrag(n,l){this.offset[0]+=n/this.scale,this.offset[1]+=l/this.scale,this.onredraw&&this.onredraw(this)}changeScale(n,l){if(n<this.min_scale?n=this.min_scale:n>this.max_scale&&(n=this.max_scale),n==this.scale||!this.element)return;const h=this.element.getBoundingClientRect();if(!h)return;l=l||[h.width*.5,h.height*.5];const d=this.convertCanvasToOffset(l);this.scale=n,Math.abs(this.scale-1)<.01&&(this.scale=1);const _=this.convertCanvasToOffset(l),m=[_[0]-d[0],_[1]-d[1]];this.offset[0]+=m[0],this.offset[1]+=m[1],this.onredraw&&this.onredraw(this)}changeDeltaScale(n,l){this.changeScale(this.scale*n,l)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}const _LGraphCanvas=class _LGraphCanvas{constructor(u,n,l){ne(this,"saveUndoStack",async function(){var l,h;const u=this.graph.serialize(),n=this.tempDeepClone(u);(((l=this.undoStack)==null?void 0:l.length)===0||((h=this.undoStack)==null?void 0:h.length)>0&&!this.checkObjectEqual(n,this.undoStack[this.undoStack.length-1]))&&this.undoStack.push(n),this.undoStack.length>this.maxStackSize&&this.undoStack.shift(),this.redoStack.length=0});this.options=l=l||{},this.ALWAYS_FLOW=!1,this.isKeyPressed=!1,this._menus=[],this.maxStackSize=l.maxStackSize||1e3,this.undoStack=[],this.redoStack=[],this.saveUndoStackEvt=this.debounceTime(this.saveUndoStack.bind(this),50),this.background_image=_LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,u&&u.constructor===String&&(u=document.querySelector(u)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=""+LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=l.viewport||null,n&&n.attachCanvas(this),this.setCanvas(u,l.skip_events),this.clear(),l.skip_render||this.startRendering(),this.autoresize=l.autoresize}clear(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()}setGraph(u,n){if(this.graph!=u){if(n||this.clear(),!u&&this.graph){this.graph.detachCanvas(this);return}u.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)}}getTopGraph(){return this._graph_stack.length?this._graph_stack[0]:this.graph}openSubgraph(u){if(!u)throw"graph cannot be null";if(this.graph==u)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),u.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)}closeSubgraph(){if(!this._graph_stack||this._graph_stack.length==0)return;const u=this.graph._subgraph_node,n=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},n.attachCanvas(this),this.setDirty(!0,!0),u&&(this.centerOnNode(u),this.selectNodes([u])),this.ds.offset=[0,0],this.ds.scale=1}getCurrentGraph(){return this.graph}async setCanvas(u,n){if(u&&u.constructor===String&&(u=document.getElementById(u),!u))throw"Error creating LiteGraph canvas: Canvas not found";if(u===this.canvas)return;!u&&this.canvas&&(n||this.unbindEvents());const l=u.parentElement,{width:h,height:d}=l.getBoundingClientRect();if(u.width=h,u.height=d,this.canvas=u,this.ds.element=u,!!u){if(u.className+=" lgraphcanvas",u.data=this,u.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),u.getContext==null)throw u.localName!="canvas"?"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+u.localName:"This browser doesn't support Canvas";this.options.useWebgl?await this.enableWebGL():(this.ctx=u.getContext("2d"))==null&&(u.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),await this.enableWebGL()),n||this.bindEvents(),this.draw(!0,!0)}}_doNothing(u){return u.preventDefault(),!1}_doReturnTrue(u){return u.preventDefault(),!0}bindEvents(){if(this._events_binded){console.warn("LGraphCanvas: events already binded");return}const u=this.canvas,l=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph.pointerListenerAdd(u,"down",this._mousedown_callback,!0),u.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph.pointerListenerAdd(u,"up",this._mouseup_callback,!0),LiteGraph.pointerListenerAdd(u,"move",this._mousemove_callback),u.addEventListener("contextmenu",this._doNothing),u.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),u.setAttribute("tabindex",1),u.addEventListener("keydown",this._key_callback,!0),l.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),u.addEventListener("dragover",this._doNothing,!1),u.addEventListener("dragend",this._doNothing,!1),u.addEventListener("drop",this._ondrop_callback,!1),u.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}unbindEvents(){if(!this._events_binded){console.warn("LGraphCanvas: no events binded");return}const n=this.getCanvasWindow().document;LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),n.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}static getFileExtension(u){const n=u.indexOf("?");n!=-1&&(u=u.substr(0,n));const l=u.lastIndexOf(".");return l==-1?"":u.substr(l+1).toLowerCase()}async enableWebGL(){var n;if(typeof GL>"u")throw"litegl.js must be included to use a WebGL canvas";if(typeof enableWebGLCanvas>"u")throw"webglCanvas.js must be included to use this feature";const u=enableWebGLCanvas(this.canvas);u instanceof WebGLRenderingContext&&(await u.loadCachedTextures(),u.cacheFontAtlas("Arial","normal"),u.cacheFontAtlas("Arial","Bold")),this.gl=u,this.ctx=u,this.bgctx=u,(n=this.gl)==null||n.viewport(0,0,this.canvas.width,this.canvas.height),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.canvas.webgl_enabled=!0}setDirty(u,n){u&&(this.dirty_canvas=!0),n&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){if(!this.canvas)return window;const u=this.canvas.ownerDocument;return u.defaultView||u.parentWindow}startRendering(){if(this.is_rendering)return;this.is_rendering=!0,u.call(this);function u(){this.pause_rendering||this.draw();const n=this.getCanvasWindow();this.is_rendering&&n.requestAnimationFrame(u.bind(this))}}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}processMouseDown(u){let n=!1;if(this.block_drag_grp=!1,this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;this.adjustMouseEvent(u);const l=this.getCanvasWindow();l.document,_LGraphCanvas.active_canvas=this;const h=u.clientX,d=u.clientY;this.ds.viewport=this.viewport;const _=!this.viewport||this.viewport&&h>=this.viewport[0]&&h<this.viewport[0]+this.viewport[2]&&d>=this.viewport[1]&&d<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph.pointerListenerAdd(l.document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(l.document,"up",this._mouseup_callback,!0)),!_)return;let m=this.graph.getNodeOnPos(u.canvasX,u.canvasY,this.visible_nodes,5),E=!1;const L=LiteGraph.getTime(),b=u.isPrimary===void 0||!u.isPrimary,S=L-this.last_mouseclick<300&&b;if(this.mouse[0]=u.clientX,this.mouse[1]=u.clientY,this.graph_mouse[0]=u.canvasX,this.graph_mouse[1]=u.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&b?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(l),!(this.onMouse&&this.onMouse(u)==!0)){if(m||this.closePanels(),u.which==1&&!this.pointer_is_double){if(this.saveUndoStack(),u.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=u.canvasX,this.dragging_rectangle[1]=u.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,E=!0),LiteGraph.alt_drag_do_clone_nodes&&u.altKey&&m&&this.allow_interaction&&!E&&!this.read_only){let C=m.clone();(C=m.clone())&&(C.pos[0]+=5,C.pos[1]+=5,this.graph.add(C,!1,{doCalcSize:!1}),m=C,E=!0,n||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=m),this.selected_nodes[m.id]||this.processNodeSelected(m,u)))}let R=!1;if(m&&(this.allow_interaction||m.flags.allow_interaction)&&!E&&!this.read_only){if(!this.live_mode&&!m.flags.pinned&&this.bringToFront(m),this.allow_interaction&&!this.connecting_node&&!m.flags.collapsed&&!this.live_mode)if(!E&&m.resizable!==!1&&LiteGraph.isInsideRectangle(u.canvasX,u.canvasY,m.pos[0]+m.size[0]-5,m.pos[1]+m.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=m,this.canvas.style.cursor="se-resize",E=!0;else{if(m.outputs)for(let C=0,G=m.outputs.length;C<G;++C){const D=m.outputs[C],H=m.getConnectionPos(!1,C);if(LiteGraph.isInsideRectangle(u.canvasX,u.canvasY,H[0]-15,H[1]-10,30,20)){this.connecting_node=m,this.connecting_output=D,this.connecting_output.slot_index=C,this.connecting_pos=m.getConnectionPos(!1,C),this.connecting_slot=C,LiteGraph.shift_click_do_break_link_from&&u.shiftKey&&m.disconnectOutput(C),S?m.onOutputDblClick&&m.onOutputDblClick(C,u):m.onOutputClick&&m.onOutputClick(C,u),E=!0;break}}if(m.inputs)for(let C=0,G=m.inputs.length;C<G;++C){const D=m.inputs[C],H=m.getConnectionPos(!0,C);if(LiteGraph.isInsideRectangle(u.canvasX,u.canvasY,H[0]-15,H[1]-10,30,20)){if(S?m.onInputDblClick&&m.onInputDblClick(C,u):m.onInputClick&&m.onInputClick(C,u),D.link!==null){const e=this.graph.links[D.link];LiteGraph.click_do_break_link_to&&(m.disconnectInput(C),this.dirty_bgcanvas=!0,E=!0),(this.allow_reconnect_links||u.shiftKey)&&(LiteGraph.click_do_break_link_to||m.disconnectInput(C),this.connecting_node=this.graph._nodes_by_id[e.origin_id],this.connecting_slot=e.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),this.dirty_bgcanvas=!0,E=!0)}E||(this.connecting_node=m,this.connecting_input=D,this.connecting_input.slot_index=C,this.connecting_pos=m.getConnectionPos(!0,C),this.connecting_slot=C,this.dirty_bgcanvas=!0,E=!0)}}}if(!E){const C=[u.canvasX-m.pos[0],u.canvasY-m.pos[1]],G=this.processNodeWidgets(m,this.graph_mouse,u);if(G&&(n=!0,this.node_widget=[m,G]),this.allow_interaction&&S&&this.selected_nodes[m.id]&&(m.onDblClick&&m.onDblClick(u,C,this),this.processNodeDblClicked(m),n=!0),m.onMouseDown&&m.onMouseDown(u,C,this))n=!0;else{if(m.subgraph&&!m.skip_subgraph_button&&!m.flags.collapsed&&C[0]>m.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&C[1]<0){const D=this;setTimeout(function(){D.openSubgraph(m.subgraph)},10)}this.live_mode&&(R=!0,n=!0)}n?m.is_selected||this.processNodeSelected(m,u):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=m),this.processNodeSelected(m,u)),this.dirty_canvas=!0}}else if(!E){if(!this.read_only)for(let C=0;C<this.visible_links.length;++C){const G=this.visible_links[C],D=G._pos;if(!(!D||u.canvasX<D[0]-4||u.canvasX>D[0]+4||u.canvasY<D[1]-4||u.canvasY>D[1]+4)){this.showLinkMenu(G,u),this.over_link_center=null;break}}this.selected_group=this.graph.getGroupOnPos(u.canvasX,u.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&S&&(u.preventDefault(),u.stopPropagation(),this.showGrpPanel(this.selected_group),this.block_drag_grp=!0),this.selected_group&&!this.read_only&&!S&&(this.block_drag_grp=!1,u.ctrlKey&&(this.dragging_rectangle=null),LiteGraph.distance([u.canvasX,u.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()),R=!0}!E&&R&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else if(u.which==2)if(this.saveUndoStack(),LiteGraph.middle_click_slot_add_default_node){if(m&&this.allow_interaction&&!E&&!this.read_only&&!this.connecting_node&&!m.flags.collapsed&&!this.live_mode){let R=!1,C=!1,G=!1;if(m.outputs)for(let D=0,H=m.outputs.length;D<H;++D){const e=m.outputs[D],t=m.getConnectionPos(!1,D);if(LiteGraph.isInsideRectangle(u.canvasX,u.canvasY,t[0]-15,t[1]-10,30,20)){R=e,C=D,G=!0;break}}if(m.inputs)for(let D=0,H=m.inputs.length;D<H;++D){const e=m.inputs[D],t=m.getConnectionPos(!0,D);if(LiteGraph.isInsideRectangle(u.canvasX,u.canvasY,t[0]-15,t[1]-10,30,20)){R=e,C=D,G=!1;break}}if(R&&C!==!1){const D=.5-(C+1)/(G?m.outputs.length:m.inputs.length),H=m.getBounding(),e=[G?H[0]+H[2]:H[0],u.canvasY-80];this.createDefaultNodeForSlot({nodeFrom:G?m:null,slotFrom:G?C:null,nodeTo:G?null:m,slotTo:G?null:C,position:e,nodeType:"AUTO",posAdd:[G?30:-30,-D*130],posSizeFix:[G?0:-1,0]})}}}else!E&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else(u.which==3||this.pointer_is_double)&&(this.saveUndoStack(),this.allow_interaction&&!E&&!this.read_only&&(m&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[m.id]||u.shiftKey||u.ctrlKey||u.metaKey)?this.selected_nodes[m.id]||this.selectNodes([m],!0):this.selectNodes([m])),this.processContextMenu(m,u)));return this.last_mouse[0]=u.clientX,this.last_mouse[1]=u.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!l.document.activeElement||l.document.activeElement.nodeName.toLowerCase()!="input"&&l.document.activeElement.nodeName.toLowerCase()!="textarea")&&u.preventDefault(),u.stopPropagation(),this.onMouseDown&&this.onMouseDown(u),!1}}getGroupMenuOptions(u){return[{content:"제목",callback:this.onShowPropertyEditor},{content:"그룹 위치",property:"그룹 위치",type:"Number",callback:this.onGrpPositionEditor},{content:"그룹 사이즈",property:"그룹 사이즈",type:"Number",callback:this.onGrpSizeEditor},{content:"그룹 색",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeColors},{content:"폰트 사이즈",property:"font_size",type:"Number",callback:this.onShowPropertyEditor},{content:"앞으로",property:"font_size",type:"Number",callback:this.bringGroupToFront.bind(this,u)},{content:"뒤로",property:"font_size",type:"Number",callback:this.sendGroupToBack.bind(this,u)},null,{content:"그룹 삭제",callback:_LGraphCanvas.onMenuNodeRemove}]}processMouseMove(u){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;_LGraphCanvas.active_canvas=this,this.adjustMouseEvent(u);const n=[u.clientX,u.clientY];this.mouse[0]=n[0],this.mouse[1]=n[1];const l=[n[0]-this.last_mouse[0],n[1]-this.last_mouse[1]];if(this.last_mouse=n,this.graph_mouse[0]=u.canvasX,this.graph_mouse[1]=u.canvasY,this.block_click)return u.preventDefault(),!1;u.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,u,this.node_widget[1]),this.dirty_canvas=!0);const h=this.graph.getNodeOnPos(u.canvasX,u.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=u.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=u.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[u.canvasX-this.selected_group.pos[0],u.canvasY-this.selected_group.pos[1]];else{const d=l[0]/this.ds.scale,_=l[1]/this.ds.scale;this.selected_group.move(d,_,u.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=l[0]/this.ds.scale,this.ds.offset[1]+=l[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||h&&h.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(let d=0,_=this.graph._nodes.length;d<_;++d)this.graph._nodes[d].mouseOver&&h!=this.graph._nodes[d]&&(this.graph._nodes[d].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(u),this.node_over=null,this.dirty_canvas=!0);if(h){if(h.redraw_on_mouse&&(this.dirty_canvas=!0),h.mouseOver||(h.mouseOver=!0,this.node_over=h,this.dirty_canvas=!0,h.onMouseEnter&&h.onMouseEnter(u)),h.onMouseMove&&h.onMouseMove(u,[u.canvasX-h.pos[0],u.canvasY-h.pos[1]],this),this.connecting_node){if(this.connecting_output){const d=this._highlight_input||[0,0];if(!this.isOverNodeBox(h,u.canvasX,u.canvasY)){const _=this.isOverNodeInput(h,u.canvasX,u.canvasY,d);if(_!=-1&&h.inputs[_]){const m=h.inputs[_].type;LiteGraph.isValidConnection(this.connecting_output.type,m)&&(this._highlight_input=d,this._highlight_input_slot=h.inputs[_])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input){const d=this._highlight_output||[0,0];if(!this.isOverNodeBox(h,u.canvasX,u.canvasY)){const _=this.isOverNodeOutput(h,u.canvasX,u.canvasY,d);if(_!=-1&&h.outputs[_]){const m=h.outputs[_].type;LiteGraph.isValidConnection(this.connecting_input.type,m)&&(this._highlight_output=d)}else this._highlight_output=null}}}this.canvas&&(LiteGraph.isInsideRectangle(u.canvasX,u.canvasY,h.pos[0]+h.size[0]-5,h.pos[1]+h.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{let d=null;for(let _=0;_<this.visible_links.length;++_){const m=this.visible_links[_],E=m._pos;if(!(!E||u.canvasX<E[0]-4||u.canvasX>E[0]+4||u.canvasY<E[1]-4||u.canvasY>E[1]+4)){d=m;break}}d!=this.over_link_center&&(this.over_link_center=d,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=h&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(u,[u.canvasX-this.node_capturing_input.pos[0],u.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(const d in this.selected_nodes){const _=this.selected_nodes[d];_.pos[0]+=l[0]/this.ds.scale,_.pos[1]+=l[1]/this.ds.scale,_.is_selected||this.processNodeSelected(_,u)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){const d=[u.canvasX-this.resizing_node.pos[0],u.canvasY-this.resizing_node.pos[1]],_=this.resizing_node.computeSize();d[0]=Math.max(_[0],d[0]),d[1]=Math.max(_[1],d[1]),this.resizing_node.setSize(d),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return u.preventDefault(),!1}processMouseUp(u){const n=u.isPrimary===void 0||u.isPrimary;if(!n)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;const h=this.getCanvasWindow().document;_LGraphCanvas.active_canvas=this,this.options.skip_events||(LiteGraph.pointerListenerRemove(h,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerRemove(h,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(u);const d=LiteGraph.getTime();if(u.click_time=d-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),u.which==1){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,u),this.node_widget=null,this.selected_group){const m=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),E=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(m,E,u.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}this.selected_group_resizing=!1;const _=this.graph.getNodeOnPos(u.canvasX,u.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){const m=this.graph._nodes,E=new Float32Array(4),L=Math.abs(this.dragging_rectangle[2]),b=Math.abs(this.dragging_rectangle[3]),S=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-L:this.dragging_rectangle[0],R=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-b:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=S,this.dragging_rectangle[1]=R,this.dragging_rectangle[2]=L,this.dragging_rectangle[3]=b,!_||L>10&&b>10){const C=[];for(let G=0;G<m.length;++G){const D=m[G];D.getBounding(E),LiteGraph.overlapBounding(this.dragging_rectangle,E)&&C.push(D)}C.length&&this.selectNodes(C,u.shiftKey)}else this.selectNodes([_],u.shiftKey||u.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;const E=(this.connecting_output||this.connecting_input).type;if(_){if(this.connecting_output){const L=this.isOverNodeInput(_,u.canvasX,u.canvasY);L!=-1?this.connecting_node.connect(this.connecting_slot,_,L):this.connecting_node.connectByType(this.connecting_slot,_,E)}else if(this.connecting_input){const L=this.isOverNodeOutput(_,u.canvasX,u.canvasY);L!=-1?_.connect(L,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,_,E)}}else LiteGraph.release_link_on_empty_shows_menu&&(u.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(u,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(u,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:u}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:u}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){const m=this.node_dragged;m&&u.click_time<300&&LiteGraph.isInsideRectangle(u.canvasX,u.canvasY,m.pos[0],m.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&m.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else!this.graph.getNodeOnPos(u.canvasX,u.canvasY,this.visible_nodes)&&u.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(u,[u.canvasX-this.node_over.pos[0],u.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(u,[u.canvasX-this.node_capturing_input.pos[0],u.canvasY-this.node_capturing_input.pos[1]])}else u.which==2?(this.dirty_canvas=!0,this.dragging_canvas=!1):u.which==3&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return n&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),u.stopPropagation(),u.preventDefault(),!1}processMouseWheel(u){if(!this.graph||!this.allow_dragcanvas)return;const n=u.wheelDeltaY!=null?u.wheelDeltaY:u.detail*-60;this.adjustMouseEvent(u);const l=u.clientX,h=u.clientY;if(!(!this.viewport||this.viewport&&l>=this.viewport[0]&&l<this.viewport[0]+this.viewport[2]&&h>=this.viewport[1]&&h<this.viewport[1]+this.viewport[3]))return;let _=this.ds.scale;return n>0?_*=1.1:n<0&&(_*=1/1.1),this.ds.changeScale(_,[u.clientX,u.clientY]),this.graph.change(),u.preventDefault(),!1}isOverNodeBox(u,n,l){const h=LiteGraph.NODE_TITLE_HEIGHT;return!!LiteGraph.isInsideRectangle(n,l,u.pos[0]+2,u.pos[1]+2-h,h-4,h-4)}isOverNodeInput(u,n,l,h){if(u.inputs)for(let d=0,_=u.inputs.length;d<_;++d){u.inputs[d];const m=u.getConnectionPos(!0,d);let E=!1;if(u.horizontal?E=LiteGraph.isInsideRectangle(n,l,m[0]-5,m[1]-10,10,20):E=LiteGraph.isInsideRectangle(n,l,m[0]-10,m[1]-5,40,10),E)return h&&(h[0]=m[0],h[1]=m[1]),d}return-1}isOverNodeOutput(u,n,l,h){if(u.outputs)for(let d=0,_=u.outputs.length;d<_;++d){u.outputs[d];const m=u.getConnectionPos(!1,d);let E=!1;if(u.horizontal?E=LiteGraph.isInsideRectangle(n,l,m[0]-5,m[1]-10,10,20):E=LiteGraph.isInsideRectangle(n,l,m[0]-10,m[1]-5,40,10),E)return h&&(h[0]=m[0],h[1]=m[1]),d}return-1}processKey(u){if(!this.graph)return;let n=!1;if(u.target.localName!="input"){if(u.type=="keydown"){this.isKeyPressed=!0,u.keyCode==32&&(this.saveUndoStack(),this.dragging_canvas=!0,n=!0),u.keyCode==27&&(this.saveUndoStack(),this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),n=!0),u.keyCode==65&&u.ctrlKey&&(this.saveUndoStack(),this.selectNodes(),n=!0),u.keyCode===67&&(u.metaKey||u.ctrlKey)&&!u.shiftKey&&this.selected_nodes&&(this.saveUndoStack(),this.copyToClipboard(),n=!0),u.keyCode===86&&(u.metaKey||u.ctrlKey)&&(this.saveUndoStack(),this.pasteFromClipboard(u.shiftKey));const l=h=>{if(this.selected_nodes&&h.key==="ArrowUp"){this.saveUndoStackEvt();for(let d in this.selected_nodes)this.selected_nodes[d].pos[1]-=1}if(this.selected_nodes&&h.key==="ArrowDown"){this.saveUndoStackEvt();for(let d in this.selected_nodes)this.selected_nodes[d].pos[1]+=1}if(this.selected_nodes&&h.key==="ArrowLeft"){this.saveUndoStackEvt();for(let d in this.selected_nodes)this.selected_nodes[d].pos[0]-=1}if(this.selected_nodes&&h.key==="ArrowRight"){this.saveUndoStackEvt();for(let d in this.selected_nodes)this.selected_nodes[d].pos[0]+=1}};if(this.isKeyPressed?l(u):this.isKeyPressed=!1,(u.keyCode==46||u.keyCode==8)&&u.target.localName!="input"&&u.target.localName!="textarea"&&(this.saveUndoStack(),this.deleteSelectedNodes(),n=!0),this.selected_nodes)for(const h in this.selected_nodes)this.selected_nodes[h].onKeyDown&&this.selected_nodes[h].onKeyDown(u)}else if(u.type=="keyup"){if(u.keyCode==32&&(this.dragging_canvas=!1),this.selected_nodes)for(const l in this.selected_nodes)this.selected_nodes[l].onKeyUp&&this.selected_nodes[l].onKeyUp(u);u.ctrlKey&&u.key==="z"&&!this.read_only&&this.undo(),u.ctrlKey&&u.key==="y"&&!this.read_only&&this.redo()}if(this.graph.change(),n)return u.preventDefault(),u.stopImmediatePropagation(),!1}}checkObjectEqual(u,n){const l=JSON.stringify(u),h=JSON.stringify(n);return l===h}undo(){if(this.undoStack.length===0)return;const u=this.graph.serialize();this.redoStack.push(this.tempDeepClone(u));const n=this.undoStack.pop();this.graph.configure(this.tempDeepClone(n)),this.draw(!0,!0)}redo(){if(this.redoStack.length===0)return;const u=this.graph.serialize();this.undoStack.push(this.tempDeepClone(u));const n=this.redoStack.pop();this.graph.configure(this.tempDeepClone(n)),this.draw(!0,!0)}debounceTime(u,n){let l=null;return function(...h){const d=this;clearTimeout(l),l=setTimeout(()=>u.apply(d,h),n)}}tempDeepClone(u){return JSON.parse(JSON.stringify(u))}copyToClipboard(){const u={nodes:[],links:[]};let n=0;const l=[];for(const h in this.selected_nodes){const d=this.selected_nodes[h];d.clonable!==!1&&(d._relative_id=n,l.push(d),n+=1)}for(let h=0;h<l.length;++h){const d=l[h];if(d.clonable===!1)continue;const _=d.clone();if(!_){console.warn("node type not found: "+d.type);continue}if(u.nodes.push(_.serialize()),d.inputs&&d.inputs.length)for(let m=0;m<d.inputs.length;++m){const E=d.inputs[m];if(!E||E.link==null)continue;const L=this.graph.links[E.link];if(!L)continue;const b=this.graph.getNodeById(L.origin_id);b&&u.links.push([b._relative_id,L.origin_slot,d._relative_id,L.target_slot,b.id])}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(u))}pasteFromClipboard(u=!1){if(!LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&u)return;const n=localStorage.getItem("litegrapheditor_clipboard");if(!n)return;this.graph.beforeChange();const l=JSON.parse(n);let h=!1,d=!1;for(let m=0;m<l.nodes.length;++m)h?(h[0]>l.nodes[m].pos[0]&&(h[0]=l.nodes[m].pos[0],d[0]=m),h[1]>l.nodes[m].pos[1]&&(h[1]=l.nodes[m].pos[1],d[1]=m)):(h=[l.nodes[m].pos[0],l.nodes[m].pos[1]],d=[m,m]);const _=[];for(let m=0;m<l.nodes.length;++m){const E=l.nodes[m],L=LiteGraph.createNode(E.type);L&&(L.configure(E),L.pos[0]+=this.graph_mouse[0]-h[0],L.pos[1]+=this.graph_mouse[1]-h[1],this.graph.add(L,{doProcessChange:!1}),_.push(L))}for(let m=0;m<l.links.length;++m){const E=l.links[m];let L;const b=E[0];if(b!=null)L=_[b];else if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&u){const R=E[4];R&&(L=this.graph.getNodeById(R))}const S=_[E[2]];L&&S?L.connect(E[1],S,E[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(_),this.graph.afterChange()}processDrop(u){u.preventDefault(),this.adjustMouseEvent(u);const n=u.clientX,l=u.clientY;if(!(!this.viewport||this.viewport&&n>=this.viewport[0]&&n<this.viewport[0]+this.viewport[2]&&l>=this.viewport[1]&&l<this.viewport[1]+this.viewport[3]))return;const d=[u.canvasX,u.canvasY],_=this.graph?this.graph.getNodeOnPos(d[0],d[1]):null;if(!_){let m=null;this.onDropItem&&(m=this.onDropItem(event)),m||this.checkDropItem(u);return}if(_.onDropFile||_.onDropData){const m=u.dataTransfer.files;if(m&&m.length)for(let E=0;E<m.length;E++){const L=u.dataTransfer.files[0],b=L.name;if(_LGraphCanvas.getFileExtension(b),_.onDropFile&&_.onDropFile(L),_.onDropData){const S=new FileReader;S.onload=function(C){const G=C.target.result;_.onDropData(G,b,L)};const R=L.type.split("/")[0];R=="text"||R==""?S.readAsText(L):R=="image"?S.readAsDataURL(L):S.readAsArrayBuffer(L)}}}return _.onDropItem&&_.onDropItem(event)?!0:this.onDropItem?this.onDropItem(event):!1}checkDropItem(u){if(u.dataTransfer.files.length){const n=u.dataTransfer.files[0],l=_LGraphCanvas.getFileExtension(n.name).toLowerCase(),h=LiteGraph.node_types_by_file_extension[l];if(h){this.graph.beforeChange();const d=LiteGraph.createNode(h.type);d.pos=[u.canvasX,u.canvasY],this.graph.add(d),d.onDropFile&&d.onDropFile(n),this.graph.afterChange()}}}processNodeDblClicked(u){this.onShowNodePanel?this.onShowNodePanel(u):this.showShowNodePanel(u),this.onNodeDblClicked&&this.onNodeDblClicked(u),this.setDirty(!0)}processNodeSelected(u,n){this.selectNode(u,n&&(n.shiftKey||n.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(u)}selectNode(u,n){u==null?this.deselectAllNodes():this.selectNodes([u],n)}selectNodes(u,n){n||this.deselectAllNodes(),u=u||this.graph._nodes,typeof u=="string"&&(u=[u]);for(const l in u){const h=u[l];if(h.is_selected){this.deselectNode(h);continue}if(!h.is_selected&&h.onSelected&&h.onSelected(),h.is_selected=!0,this.selected_nodes[h.id]=h,h.inputs)for(let d=0;d<h.inputs.length;++d)this.highlighted_links[h.inputs[d].link]=!0;if(h.outputs)for(let d=0;d<h.outputs.length;++d){const _=h.outputs[d];if(_.links)for(let m=0;m<_.links.length;++m)this.highlighted_links[_.links[m]]=!0}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}deselectNode(u){if(u.is_selected){if(u.onDeselected&&u.onDeselected(),u.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(u),u.inputs)for(let n=0;n<u.inputs.length;++n)delete this.highlighted_links[u.inputs[n].link];if(u.outputs)for(let n=0;n<u.outputs.length;++n){const l=u.outputs[n];if(l.links)for(let h=0;h<l.links.length;++h)delete this.highlighted_links[l.links[h]]}}}deselectAllNodes(){if(!this.graph)return;const u=this.graph._nodes;for(let n=0,l=u.length;n<l;++n){const h=u[n];h.is_selected&&(h.onDeselected&&h.onDeselected(),h.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(h))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}deleteSelectedNodes(){this.graph.beforeChange();for(const u in this.selected_nodes){const n=this.selected_nodes[u];if(!n.block_delete){if(n.inputs&&n.inputs.length&&n.outputs&&n.outputs.length&&LiteGraph.isValidConnection(n.inputs[0].type,n.outputs[0].type)&&n.inputs[0].link&&n.outputs[0].links&&n.outputs[0].links.length){const l=n.graph.links[n.inputs[0].link],h=n.graph.links[n.outputs[0].links[0]],d=n.getInputNode(0),_=n.getOutputNodes(0)[0];d&&_&&d.connect(l.origin_slot,_,h.target_slot)}this.graph.remove(n),this.onNodeDeselected&&this.onNodeDeselected(n)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}centerOnNode(u){this.ds.offset[0]=-u.pos[0]-u.size[0]*.5+this.canvas.width*.5/this.ds.scale,this.ds.offset[1]=-u.pos[1]-u.size[1]*.5+this.canvas.height*.5/this.ds.scale,this.setDirty(!0,!0)}adjustMouseEvent(u){let n=0,l=0;if(this.canvas){const h=this.canvas.getBoundingClientRect();n=u.clientX-h.left,l=u.clientY-h.top}else n=u.clientX,l=u.clientY;this.last_mouse_position[0]=n,this.last_mouse_position[1]=l,u.canvasX=n/this.ds.scale-this.ds.offset[0],u.canvasY=l/this.ds.scale-this.ds.offset[1]}setZoom(u,n){this.ds.changeScale(u,n),this.dirty_canvas=!0,this.dirty_bgcanvas=!0}convertOffsetToCanvas(u,n){return this.ds.convertOffsetToCanvas(u,n)}convertCanvasToOffset(u,n){return this.ds.convertCanvasToOffset(u,n)}convertEventToCanvasOffset(u){const n=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([u.clientX-n.left,u.clientY-n.top])}bringToFront(u){const n=this.graph._nodes.indexOf(u);n!=-1&&(this.graph._nodes.splice(n,1),this.graph._nodes.push(u))}sendToBack(u){const n=this.graph._nodes.indexOf(u);n!=-1&&(this.graph._nodes.splice(n,1),this.graph._nodes.unshift(u))}computeVisibleNodes(u,n){const l=new Float32Array(4),h=n||[];h.length=0,u=u||this.graph._nodes;for(let d=0,_=u.length;d<_;++d){const m=u[d];this.live_mode&&!m.onDrawBackground&&!m.onDrawForeground||m.getBounding&&LiteGraph.overlapBounding(this.visible_area,m.getBounding(l,!0))&&h.push(m)}return h}draw(u,n){if(!this.canvas||this.canvas.width==0||this.canvas.height==0)return;const l=LiteGraph.getTime();this.render_time=(l-this.last_draw_time)*.001,this.last_draw_time=l,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||n||this.always_render_background||this.graph&&this.graph._last_trigger_time&&l-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||u)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}drawFrontCanvas(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));const u=this.ctx;if(!u)return;const n=this.canvas;u.start2D&&!this.viewport&&(u.start2D(),u.restore(),u.setTransform(1,0,0,1,0,0));const l=this.viewport||this.dirty_area;if(l&&(u.save(),u.beginPath(),u.rect(l[0],l[1],l[2],l[3]),u.clip()),this.clear_background&&(l?u.clearRect(l[0],l[1],l[2],l[3]):u.clearRect(0,0,n.width,n.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():u.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(n,u),this.show_info&&this.renderInfo(u,l?l[0]:0,l?l[1]:0),this.graph){u.save(),this.ds.toCanvasContext(u);const h=this.computeVisibleNodes(null,this.visible_nodes);for(let d=0;d<h.length;++d){const _=h[d];u.save(),u.translate(_.pos[0],_.pos[1]),this.drawNode(_,u),u.restore()}if(this.addNodeGuideLines(u),this.render_execution_order&&this.drawExecutionOrder(u),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(u)),this.connecting_pos!=null){u.lineWidth=this.connections_width;let d=null;const _=this.connecting_output||this.connecting_input,m=_.type;let E=_.dir;E==null&&(this.connecting_output?E=this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:E=this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT);const L=_.shape;switch(m){case LiteGraph.EVENT:d=LiteGraph.EVENT_LINK_COLOR;break;default:d=LiteGraph.CONNECTING_LINK_COLOR}if(this.renderLink(u,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,d,E,LiteGraph.CENTER),u.beginPath(),m===LiteGraph.EVENT||L===LiteGraph.BOX_SHAPE?(u.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),u.fill(),u.beginPath(),u.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):L===LiteGraph.ARROW_SHAPE?(u.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),u.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),u.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),u.closePath()):(u.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,Math.PI*2),u.fill(),u.beginPath(),u.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,Math.PI*2)),u.fill(),u.fillStyle="#ffcc00",this._highlight_input&&(u.beginPath(),this._highlight_input_slot.shape===LiteGraph.ARROW_SHAPE?(u.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),u.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),u.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),u.closePath()):u.arc(this._highlight_input[0],this._highlight_input[1],6,0,Math.PI*2),u.fill()),this._highlight_output){let b=this._highlight_output.shape;u.beginPath(),b===LiteGraph.ARROW_SHAPE?(u.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),u.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),u.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),u.closePath()):u.arc(this._highlight_output[0],this._highlight_output[1],6,0,Math.PI*2),u.fill()}}this.dragging_rectangle&&(u.strokeStyle="#FFF",u.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(u,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(u,null),this.onDrawForeground&&this.onDrawForeground(u,this.visible_rect),u.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(u),this.onDrawOverlay&&this.onDrawOverlay(u),this.showPopover&&this.drawPopoverLine(u),l&&u.restore(),u.finish2D&&u.finish2D()}drawSubgraphPanel(u){const n=this.graph,l=n._subgraph_node;if(!l){console.warn("subgraph without subnode");return}this.drawSubgraphPanelLeft(n,l,u),this.drawSubgraphPanelRight(n,l,u)}drawSubgraphPanelLeft(u,n,l){const h=n.inputs?n.inputs.length:0,d=200,_=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);if(l.fillStyle="#111",l.globalAlpha=.8,l.beginPath(),l.roundRect(10,10,d,(h+1)*_+50,[8]),l.fill(),l.globalAlpha=1,l.fillStyle="#888",l.font="14px Arial",l.textAlign="left",l.fillText("Graph Inputs",20,34),this.drawButton(d-20,20,20,20,"X","#151515")){this.closeSubgraph();return}let m=50;if(l.font="14px Arial",n.inputs)for(let E=0;E<n.inputs.length;++E){const L=n.inputs[E];if(!L.not_subgraph_input){if(this.drawButton(20,m+2,d-20,_-2)){const b=n.constructor.input_node_type||"graph/input";this.graph.beforeChange();const S=LiteGraph.createNode(b);S?(u.add(S),this.block_click=!1,this.last_click_position=null,this.selectNodes([S]),this.node_dragged=S,this.dragging_canvas=!1,S.setProperty("name",L.name),S.setProperty("type",L.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",b)}l.fillStyle="#9C9",l.beginPath(),l.arc(d-16,m+_*.5,5,0,2*Math.PI),l.fill(),l.fillStyle="#AAA",l.fillText(L.name,30,m+_*.75),l.fillStyle="#777",l.fillText(L.type,130,m+_*.75),m+=_}}this.drawButton(20,m+2,d-20,_-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(n)}drawSubgraphPanelRight(u,n,l){const h=n.outputs?n.outputs.length:0,d=this.bgcanvas.width,_=200,m=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);l.fillStyle="#111",l.globalAlpha=.8,l.beginPath(),l.roundRect(d-_-10,10,_,(h+1)*m+50,[8]),l.fill(),l.globalAlpha=1,l.fillStyle="#888",l.font="14px Arial",l.textAlign="left";const E="Graph Outputs",L=l.measureText(E).width;if(l.fillText(E,d-L-20,34),this.drawButton(d-_,20,20,20,"X","#151515")){this.closeSubgraph();return}let b=50;if(l.font="14px Arial",n.outputs)for(let S=0;S<n.outputs.length;++S){const R=n.outputs[S];if(!R.not_subgraph_input){if(this.drawButton(d-_,b+2,_-20,m-2)){const C=n.constructor.output_node_type||"graph/output";this.graph.beforeChange();const G=LiteGraph.createNode(C);G?(u.add(G),this.block_click=!1,this.last_click_position=null,this.selectNodes([G]),this.node_dragged=G,this.dragging_canvas=!1,G.setProperty("name",R.name),G.setProperty("type",R.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",C)}l.fillStyle="#9C9",l.beginPath(),l.arc(d-_+16,b+m*.5,5,0,2*Math.PI),l.fill(),l.fillStyle="#AAA",l.fillText(R.name,d-_+30,b+m*.75),l.fillStyle="#777",l.fillText(R.type,d-_+130,b+m*.75),b+=m}}this.drawButton(d-_,b+2,_-20,m-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(n)}drawButton(u,n,l,h,d,_,m,E){const L=this.ctx;_=_||LiteGraph.NODE_DEFAULT_COLOR,m=m||"#555",E=E||LiteGraph.NODE_TEXT_COLOR;let b=this.ds.convertOffsetToCanvas(this.graph_mouse);const S=LiteGraph.isInsideRectangle(b[0],b[1],u,n,l,h);if(b=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null,b){const G=this.canvas.getBoundingClientRect();b[0]-=G.left,b[1]-=G.top}const R=b&&LiteGraph.isInsideRectangle(b[0],b[1],u,n,l,h);L.fillStyle=S?m:_,R&&(L.fillStyle="#AAA"),L.beginPath(),L.roundRect(u,n,l,h,[4]),L.fill(),d!=null&&d.constructor==String&&(L.fillStyle=E,L.textAlign="center",L.font=(h*.65|0)+"px Arial",L.fillText(d,u+l*.5,n+h*.75),L.textAlign="left");const C=R&&!this.block_click;return R&&this.blockClick(),C}isAreaClicked(u,n,l,h,d){let _=this.mouse;LiteGraph.isInsideRectangle(_[0],_[1],u,n,l,h),_=this.last_click_position;const m=_&&LiteGraph.isInsideRectangle(_[0],_[1],u,n,l,h),E=m&&!this.block_click;return m&&d&&this.blockClick(),E}renderInfo(u,n,l){n=n||10,l=l||this.canvas.height-80,u.save(),u.translate(n,l),u.font="10px Arial",u.fillStyle="#888",u.textAlign="left",this.graph?(u.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13*1),u.fillText("I: "+this.graph.iteration,5,13*2),u.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,13*3),u.fillText("V: "+this.graph._version,5,13*4),u.fillText("FPS:"+this.fps.toFixed(2),5,13*5)):u.fillText("No graph selected",5,13*1),u.restore()}drawBackCanvas(){const u=this.bgcanvas;(u.width!=this.canvas.width||u.height!=this.canvas.height)&&(u.width=this.canvas.width,u.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));const n=this.bgctx;n.start&&n.start();const l=this.viewport||[0,0,n.canvas.width,n.canvas.height];if(this.clear_background&&n.clearRect(l[0],l[1],l[2],l[3]),this._graph_stack&&this._graph_stack.length){n.save(),this._graph_stack[this._graph_stack.length-1];const d=this.graph._subgraph_node;n.strokeStyle=d.bgcolor,n.lineWidth=10,n.strokeRect(1,1,u.width-2,u.height-2),n.lineWidth=1,n.font="40px Arial",n.textAlign="center",n.fillStyle=d.bgcolor||"#AAA";let _="";for(let m=1;m<this._graph_stack.length;++m)_+=this._graph_stack[m]._subgraph_node.getTitle()+" >> ";n.fillText(_+d.getTitle(),u.width*.5,40),n.restore()}let h=!1;if(this.onRenderBackground&&(h=this.onRenderBackground(u,n)),this.viewport||(n.restore(),n.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(n.save(),this.ds.toCanvasContext(n),this.ds.scale<1.5&&!h&&this.clear_background_color&&(n.fillStyle=this.clear_background_color,n.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!h){if(this.zoom_modify_alpha?n.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:n.globalAlpha=this.editor_alpha,n.imageSmoothingEnabled=n.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;const _=this;this._bg_img.onload=function(){_.draw(!0,!0)}}let d=null;this._pattern==null&&this._bg_img.width>0?(d=n.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=d):d=this._pattern,d&&(n.fillStyle=d,n.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),n.fillStyle="transparent"),n.globalAlpha=1,n.imageSmoothingEnabled=n.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(u,n),this.onDrawBackground&&this.onDrawBackground(n,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(n.strokeStyle="#235",n.strokeRect(0,0,u.width,u.height)),this.render_connections_shadows?(n.shadowColor="#000",n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=6):n.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(n),n.shadowColor="rgba(0,0,0,0)",n.restore()}n.finish&&n.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(u,n){var H;const l=new Float32Array(2);this.current_node=u;const h=u.color||u.constructor.color||LiteGraph.NODE_DEFAULT_COLOR;let d=u.bgcolor||u.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR;u.mouseOver;const _=this.ds.scale<.6;if(this.live_mode){u.flags.collapsed||(n.shadowColor="transparent",u.onDrawForeground&&u.onDrawForeground(n,this,this.canvas));return}const m=this.editor_alpha;if(n.globalAlpha=m,this.render_shadows&&!_?(n.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,n.shadowOffsetX=2*this.ds.scale,n.shadowOffsetY=2*this.ds.scale,n.shadowBlur=3*this.ds.scale):n.shadowColor="transparent",u.flags.collapsed&&u.onDrawCollapsed&&u.onDrawCollapsed(n,this)==!0)return;const E=u._shape||LiteGraph.BOX_SHAPE,L=l;l.set(u.size);const b=u.horizontal;if(u.flags.collapsed){n.font=this.inner_text_font;const e=u.getTitle?u.getTitle():u.title;e!=null&&(u._collapsed_width=Math.min(u.size[0],n.measureText(e).width+LiteGraph.NODE_TITLE_HEIGHT*2),L[0]=u._collapsed_width,L[1]=0)}u.clip_area&&(n.save(),n.beginPath(),E==LiteGraph.BOX_SHAPE?n.rect(0,0,L[0],L[1]):E==LiteGraph.ROUND_SHAPE?n.roundRect(0,0,L[0],L[1],[10]):E==LiteGraph.CIRCLE_SHAPE&&n.arc(L[0]*.5,L[1]*.5,L[0]*.5,0,Math.PI*2),n.clip()),u.has_errors&&(d="red"),this.drawNodeShape(u,n,L,h,d,u.is_selected,u.mouseOver),n.shadowColor="transparent",u.onDrawForeground&&u.onDrawForeground(n,this,this.canvas),n.textAlign=b?"center":"left",n.font=this.inner_text_font;const S=!_,R=this.connecting_output,C=this.connecting_input;n.lineWidth=1;let G=0;const D=new Float32Array(2);if(u.flags.collapsed){if(this.render_collapsed_slots){let e=null,t=null;if(u.inputs)for(let r=0;r<u.inputs.length;r++){const s=u.inputs[r];if(s.link!=null){e=s;break}}if(u.outputs)for(let r=0;r<u.outputs.length;r++){const s=u.outputs[r];s.links&&s.links.length&&(t=s)}if(e){let r=0,s=LiteGraph.NODE_TITLE_HEIGHT*-.5;b&&(r=u._collapsed_width*.5,s=-LiteGraph.NODE_TITLE_HEIGHT),n.fillStyle="#686",n.beginPath(),e.type===LiteGraph.EVENT||e.shape===LiteGraph.BOX_SHAPE?n.rect(r-7+.5,s-4,14,8):e.shape===LiteGraph.ARROW_SHAPE?(n.moveTo(r+8,s),n.lineTo(r-4,s-4),n.lineTo(r-4,s+4),n.closePath()):n.arc(r,s,4,0,Math.PI*2),n.fill()}if(t){let r=u._collapsed_width,s=LiteGraph.NODE_TITLE_HEIGHT*-.5;b&&(r=u._collapsed_width*.5,s=0),n.fillStyle="#686",n.strokeStyle="black",n.beginPath(),t.type===LiteGraph.EVENT||t.shape===LiteGraph.BOX_SHAPE?n.rect(r-7+.5,s-4,14,8):t.shape===LiteGraph.ARROW_SHAPE?(n.moveTo(r+6,s),n.lineTo(r-6,s-4),n.lineTo(r-6,s+4),n.closePath()):n.arc(r,s,4,0,Math.PI*2),n.fill()}}}else{if(u.inputs)for(let e=0;e<u.inputs.length;e++){const t=u.inputs[e],r=t.type;let s=t.shape;n.globalAlpha=m,this.connecting_output&&!LiteGraph.isValidConnection(t.type,R.type)&&(n.globalAlpha=.4*m),n.fillStyle=t.link!=null?t.color_on||this.default_connection_color_byType[r]||this.default_connection_color.input_on:t.color_off||this.default_connection_color_byTypeOff[r]||this.default_connection_color_byType[r]||this.default_connection_color.input_off;const a=u.getConnectionPos(!0,e,D);if(a[0]-=u.pos[0],a[1]-=u.pos[1],G<a[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(G=a[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),n.beginPath(),r=="array"&&(s=LiteGraph.GRID_SHAPE),t.type===LiteGraph.EVENT||t.shape===LiteGraph.BOX_SHAPE?b?n.rect(a[0]-5+.5,a[1]-8+.5,10,14):n.rect(a[0]-6+.5,a[1]-5+.5,14,10):s===LiteGraph.ARROW_SHAPE?(n.moveTo(a[0]+8,a[1]+.5),n.lineTo(a[0]-4,a[1]+6+.5),n.lineTo(a[0]-4,a[1]-6+.5),n.closePath()):s===LiteGraph.GRID_SHAPE?(n.rect(a[0]-4,a[1]-4,2,2),n.rect(a[0]-1,a[1]-4,2,2),n.rect(a[0]+2,a[1]-4,2,2),n.rect(a[0]-4,a[1]-1,2,2),n.rect(a[0]-1,a[1]-1,2,2),n.rect(a[0]+2,a[1]-1,2,2),n.rect(a[0]-4,a[1]+2,2,2),n.rect(a[0]-1,a[1]+2,2,2),n.rect(a[0]+2,a[1]+2,2,2)):_?n.rect(a[0]-4,a[1]-4,8,8):n.arc(a[0],a[1],4,0,Math.PI*2),n.fill(),S){const o=t.label!=null?t.label:t.name;o&&(n.fillStyle=LiteGraph.NODE_TEXT_COLOR,b||t.dir==LiteGraph.UP?n.fillText(o,a[0],a[1]-10):this.options.useWebgl?n.fillText(o,a[0]+10,a[1]+2):n.fillText(o,a[0]+10,a[1]+5))}}if(n.textAlign=b?"center":"right",n.strokeStyle="black",u.outputs)for(let e=0;e<u.outputs.length;e++){const t=u.outputs[e],r=t.type;let s=t.shape;this.connecting_input&&!LiteGraph.isValidConnection(r,C.type)&&(n.globalAlpha=.4*m);const a=u.getConnectionPos(!1,e,D);a[0]-=u.pos[0],a[1]-=u.pos[1],G<a[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(G=a[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),n.fillStyle=t.links&&t.links.length?t.color_on||this.default_connection_color_byType[r]||this.default_connection_color.output_on:t.color_off||this.default_connection_color_byTypeOff[r]||this.default_connection_color_byType[r]||this.default_connection_color.output_off,n.beginPath(),r=="array"&&(s=LiteGraph.GRID_SHAPE);let o=!0;if(r===LiteGraph.EVENT||s===LiteGraph.BOX_SHAPE?b?n.rect(a[0]-5+.5,a[1]-8+.5,10,14):n.rect(a[0]-6+.5,a[1]-5+.5,14,10):s===LiteGraph.ARROW_SHAPE?(n.moveTo(a[0]+8,a[1]+.5),n.lineTo(a[0]-4,a[1]+6+.5),n.lineTo(a[0]-4,a[1]-6+.5),n.closePath()):s===LiteGraph.GRID_SHAPE?(n.rect(a[0]-4,a[1]-4,2,2),n.rect(a[0]-1,a[1]-4,2,2),n.rect(a[0]+2,a[1]-4,2,2),n.rect(a[0]-4,a[1]-1,2,2),n.rect(a[0]-1,a[1]-1,2,2),n.rect(a[0]+2,a[1]-1,2,2),n.rect(a[0]-4,a[1]+2,2,2),n.rect(a[0]-1,a[1]+2,2,2),n.rect(a[0]+2,a[1]+2,2,2),o=!1):_?n.rect(a[0]-4,a[1]-4,8,8):n.arc(a[0],a[1],4,0,Math.PI*2),n.fill(),!_&&o&&n.stroke(),S){const c=t.label!=null?t.label:t.name;if(c)if(n.fillStyle=LiteGraph.NODE_TEXT_COLOR,b||t.dir==LiteGraph.DOWN)n.fillText(c,a[0],a[1]-8);else if(this.options.useWebgl){n.textBaseline="middle";const f=((H=n.measureText(c))==null?void 0:H.width)||0;n.fillText(c,a[0]-f-10,a[1]+2)}else n.fillText(c,a[0]-10,a[1]+5)}}if(n.textAlign="left",n.globalAlpha=1,u.widgets){let e=G;(b||u.widgets_up)&&(e=2),u.widgets_start_y!=null&&(e=u.widgets_start_y),this.drawNodeWidgets(u,e,n,this.node_widget&&this.node_widget[0]==u?this.node_widget[1]:null)}}u.clip_area&&n.restore(),n.globalAlpha=1}drawLinkTooltip(u,n){const l=n._pos;if(u.fillStyle="black",u.beginPath(),u.arc(l[0],l[1],3,0,Math.PI*2),u.fill(),n.data==null||this.onDrawLinkTooltip&&this.onDrawLinkTooltip(u,n,this)==!0)return;const h=n.data;let d=null;if(h.constructor===Number?d=h.toFixed(2):h.constructor===String?d='"'+h+'"':h.constructor===Boolean?d=String(h):h.toToolTip?d=h.toToolTip():d="["+h.constructor.name+"]",d==null)return;d=d.substr(0,30),u.font="14px Courier New";const m=u.measureText(d).width+20,E=24;u.shadowColor="black",u.shadowOffsetX=2,u.shadowOffsetY=2,u.shadowBlur=3,u.fillStyle="#454",u.beginPath(),u.roundRect(l[0]-m*.5,l[1]-15-E,m,E,[3]),u.moveTo(l[0]-10,l[1]-15),u.lineTo(l[0]+10,l[1]-15),u.lineTo(l[0],l[1]-5),u.fill(),u.shadowColor="transparent",u.textAlign="center",u.fillStyle="#CEC",u.fillText(d,l[0],l[1]-15-E*.3)}drawNodeShape(u,n,l,h,d,_,m){const E=new Float32Array(4);n.strokeStyle=h,n.fillStyle=d;const L=LiteGraph.NODE_TITLE_HEIGHT,b=this.ds.scale<.5,S=u._shape||u.constructor.shape||LiteGraph.ROUND_SHAPE,R=u.constructor.title_mode;let C=!0;R==LiteGraph.TRANSPARENT_TITLE||R==LiteGraph.NO_TITLE?C=!1:R==LiteGraph.AUTOHIDE_TITLE&&m&&(C=!0);const G=E;G[0]=0,G[1]=C?-L:0,G[2]=l[0]+1,G[3]=C?l[1]+L:l[1];const D=n.globalAlpha;if(n.beginPath(),S==LiteGraph.BOX_SHAPE||b?n.fillRect(G[0],G[1],G[2],G[3]):S==LiteGraph.ROUND_SHAPE||S==LiteGraph.CARD_SHAPE?n.roundRect(G[0],G[1],G[2],G[3],S==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):S==LiteGraph.CIRCLE_SHAPE&&n.arc(l[0]*.5,l[1]*.5,l[0]*.5,0,Math.PI*2),n.fill(),!u.flags.collapsed&&C&&(n.shadowColor="transparent",n.fillStyle="rgba(0,0,0,0.2)",n.fillRect(0,-1,G[2],2)),n.shadowColor="transparent",u.onDrawBackground&&u.onDrawBackground(n,this,this.canvas,this.graph_mouse),C||R==LiteGraph.TRANSPARENT_TITLE){if(u.onDrawTitleBar)u.onDrawTitleBar(n,L,l,this.ds.scale,h);else if(R!=LiteGraph.TRANSPARENT_TITLE&&(u.constructor.title_color||this.render_title_colored)){const t=u.constructor.title_color||h;if(u.flags.collapsed&&(n.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients){let r=_LGraphCanvas.gradients[t];r||(r=_LGraphCanvas.gradients[t]=n.createLinearGradient(0,0,400,0),r.addColorStop(0,t),r.addColorStop(1,"#000")),n.fillStyle=r}else n.fillStyle=t;n.beginPath(),S==LiteGraph.BOX_SHAPE||b?n.rect(0,-L,l[0]+1,L):(S==LiteGraph.ROUND_SHAPE||S==LiteGraph.CARD_SHAPE)&&n.roundRect(0,-L,l[0]+1,L,u.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),n.fill(),n.shadowColor="transparent"}let H=!1;LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[u.mode]&&(H=LiteGraph.NODE_MODES_COLORS[u.mode]),LiteGraph.node_box_coloured_when_on&&(H=u.action_triggered?"#FFF":u.execute_triggered?"#AAA":H);const e=10;if(u.onDrawTitleBox?u.onDrawTitleBox(n,L,l,this.ds.scale):S==LiteGraph.ROUND_SHAPE||S==LiteGraph.CIRCLE_SHAPE||S==LiteGraph.CARD_SHAPE?(b&&(n.fillStyle="black",n.beginPath(),n.arc(L*.5,L*-.5,e*.5+1,0,Math.PI*2),n.fill()),n.fillStyle=u.boxcolor||H||LiteGraph.NODE_DEFAULT_BOXCOLOR,b?n.fillRect(L*.5-e*.5,L*-.5-e*.5,e,e):(n.beginPath(),n.arc(L*.5,L*-.5,e*.5,0,Math.PI*2),n.fill())):(b&&(n.fillStyle="black",n.fillRect((L-e)*.5-1,(L+e)*-.5-1,e+2,e+2)),n.fillStyle=u.boxcolor||H||LiteGraph.NODE_DEFAULT_BOXCOLOR,n.fillRect((L-e)*.5,(L+e)*-.5,e,e)),n.globalAlpha=D,u.onDrawTitleText&&u.onDrawTitleText(n,L,l,this.ds.scale,this.title_text_font,_),!b){n.font=this.title_text_font;const t=String(u.getTitle());t&&(_?n.fillStyle=LiteGraph.NODE_SELECTED_TITLE_COLOR:n.fillStyle=u.constructor.title_text_color||this.node_title_color,u.flags.collapsed?(n.textAlign="left",n.measureText(t),n.fillText(t.substr(0,20),L,LiteGraph.NODE_TITLE_TEXT_Y-L),n.textAlign="left"):(n.textAlign="left",n.fillText(t,L,LiteGraph.NODE_TITLE_TEXT_Y-L)))}if(!u.flags.collapsed&&u.subgraph&&!u.skip_subgraph_button){const t=LiteGraph.NODE_TITLE_HEIGHT,r=u.size[0]-t,s=LiteGraph.isInsideRectangle(this.graph_mouse[0]-u.pos[0],this.graph_mouse[1]-u.pos[1],r+2,-t+2,t-4,t-4);n.fillStyle=s?"#888":"#555",S==LiteGraph.BOX_SHAPE||b?n.fillRect(r+2,-t+2,t-4,t-4):(n.beginPath(),n.roundRect(r+2,-t+2,t-4,t-4,[4]),n.fill()),n.fillStyle="#333",n.beginPath(),n.moveTo(r+t*.2,-t*.6),n.lineTo(r+t*.8,-t*.6),n.lineTo(r+t*.5,-t*.3),n.fill()}u.onDrawTitle&&u.onDrawTitle(n)}_&&(u.onBounding&&u.onBounding(G),R==LiteGraph.TRANSPARENT_TITLE&&(G[1]-=L,G[3]+=L),n.lineWidth=1,n.globalAlpha=.8,n.beginPath(),S==LiteGraph.BOX_SHAPE?n.rect(-6+G[0],-6+G[1],12+G[2],12+G[3]):S==LiteGraph.ROUND_SHAPE||S==LiteGraph.CARD_SHAPE&&u.flags.collapsed?n.roundRect(-6+G[0],-6+G[1],12+G[2],12+G[3],[this.round_radius*2]):S==LiteGraph.CARD_SHAPE?n.roundRect(-6+G[0],-6+G[1],12+G[2],12+G[3],[this.round_radius*2,2,this.round_radius*2,2]):S==LiteGraph.CIRCLE_SHAPE&&n.arc(l[0]*.5,l[1]*.5,l[0]*.5+6,0,Math.PI*2),n.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,n.stroke(),n.strokeStyle=h,n.globalAlpha=1),u.execute_triggered>0&&u.execute_triggered--,u.action_triggered>0&&u.action_triggered--}drawConnections(u){const n=new Float32Array(4),l=new Float32Array(4),h=new Float32Array(2),d=new Float32Array(2),_=LiteGraph.getTime(),m=this.visible_area;n[0]=m[0]-20,n[1]=m[1]-20,n[2]=m[2]+40,n[3]=m[3]+40,u.lineWidth=this.connections_width,u.fillStyle="#AAA",u.strokeStyle="#AAA",u.globalAlpha=this.editor_alpha;const E=this.graph._nodes;for(let L=0,b=E.length;L<b;++L){const S=E[L];if(!(!S.inputs||!S.inputs.length))for(let R=0;R<S.inputs.length;++R){const C=S.inputs[R];if(!C||C.link==null)continue;const G=C.link,D=this.graph.links[G];if(!D)continue;const H=this.graph.getNodeById(D.origin_id);if(H==null)continue;let e=D.origin_slot,t=null;e==-1?t=[H.pos[0]+10,H.pos[1]+10]:t=H.getConnectionPos(!1,e,h);const r=S.getConnectionPos(!0,R,d);if(l[0]=t[0],l[1]=t[1],l[2]=r[0]-t[0],l[3]=r[1]-t[1],l[2]<0&&(l[0]+=l[2],l[2]=Math.abs(l[2])),l[3]<0&&(l[1]+=l[3],l[3]=Math.abs(l[3])),!LiteGraph.overlapBounding(l,n))continue;const s=H.outputs[e],a=S.inputs[R];if(!s||!a)continue;const o=s.dir||(H.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),c=a.dir||(S.horizontal?LiteGraph.UP:LiteGraph.LEFT);if(this.ALWAYS_FLOW)this.renderLink(u,t,r,D,!0,1,"white",o,c);else if(this.renderLink(u,t,r,D,!1,0,null,o,c),D&&D._last_time&&_-D._last_time<1e3){const f=2-(_-D._last_time)*.002,p=u.globalAlpha;u.globalAlpha=p*f,this.renderLink(u,t,r,D,!0,f,"white",o,c),u.globalAlpha=p}}}u.globalAlpha=1}showGrpPanel(u){this.closePanels();const n=this.getCanvasWindow(),l=this,h=this.createPanel(u.title||"",{closable:!0,window:n,onOpen:function(){l.NODEPANEL_IS_OPEN=!0},onClose:function(){l.NODEPANEL_IS_OPEN=!1,l.node_panel=null}});l.node_panel=h,h.id="node-panel",h.node=u,h.classList.add("settings");function d(){h.content.innerHTML="",h.addHTML("<h4>속성</h4>","panel-section");const _=(m,E)=>{switch(l.graph.beforeChange(u),l.saveUndoStack(),m){case"Title":u.title=E;break;case"Color":_LGraphCanvas.node_colors[E]?u.color=_LGraphCanvas.node_colors[E].groupcolor:console.warn("unexpected color: "+E);break;case"X":u.move(parseInt(E)-u.pos[0],0);break;case"Y":u.move(0,parseInt(E)-u.pos[1]);break;case"넓이":u.size[0]=parseInt(E);break;case"높이":u.size[1]=parseInt(E);break}l.graph.afterChange(),l.dirty_canvas=!0};h.addWidget("string","Title",u.title,{},_),u.id&&h.addWidget("string","그룹 아이디",u.id,{},_),u.status&&h.addWidget("string","상태",u.status,{disabled:!0},_),h.addWidget("number","X",u.pos[0],{min:0},_),h.addWidget("number","Y",u.pos[1],{min:0},_),h.addWidget("number","넓이",u.size[0],{min:0},_),h.addWidget("number","높이",u.size[1],{min:0},_),h.addSeparator()}d(),this.canvas.parentNode.appendChild(h)}drawGuideLines(u,{roundX:n,roundY:l,roundWidth:h,roundHeight:d,otherRoundX:_,otherRoundY:m,otherRoundWidth:E,otherRoundHeight:L}){E===h&&(u.beginPath(),u.moveTo(n,l-10),u.lineTo(n,l+d+10),u.stroke(),u.beginPath(),u.moveTo(n+ +h,l-10),u.lineTo(n+h,l+d+10),u.stroke(),u.beginPath(),u.moveTo(_,m-10),u.lineTo(_,m+L+10),u.stroke(),u.beginPath(),u.moveTo(_+E,m-10),u.lineTo(_+E,m+L+10),u.stroke()),L===d&&(u.beginPath(),u.moveTo(n-10,l),u.lineTo(n+h+10,l),u.stroke(),u.beginPath(),u.moveTo(n-10,l+d),u.lineTo(n+h+10,l+d),u.stroke(),u.beginPath(),u.moveTo(_-10,m),u.lineTo(_+E+10,m),u.stroke(),u.beginPath(),u.moveTo(_-10,m+L),u.lineTo(_+E+10,m+L),u.stroke()),_===n&&(l<m?(u.beginPath(),u.moveTo(n,l),u.lineTo(_,m+L),u.stroke()):(u.beginPath(),u.moveTo(_,m),u.lineTo(n,l+d),u.stroke())),_+E===n+h&&(l<m?(u.beginPath(),u.moveTo(n+h,l),u.lineTo(_+E,m+L),u.stroke()):(u.beginPath(),u.moveTo(_+E,m),u.lineTo(n+h,l+d),u.stroke())),m===l&&(n<_?(u.beginPath(),u.moveTo(n,l),u.lineTo(_+E,m),u.stroke()):(u.beginPath(),u.moveTo(_,m),u.lineTo(n+h,l),u.stroke())),m+L===l+d&&(n<_?(u.beginPath(),u.moveTo(n,l+d),u.lineTo(_+E,m+L),u.stroke()):(u.beginPath(),u.moveTo(_,m+L),u.lineTo(n+h,l+d),u.stroke()))}drawGroups(u,n){var h,d,_,m,E;if(!this.graph)return;const l=this.graph._groups;n.save(),n.globalAlpha=.5*this.editor_alpha;for(let L=0;L<l.length;++L){const b=l[L];if(!LiteGraph.overlapBounding(this.visible_area,b._bounding))continue;const S=b._pos,R=b._size,C=b.color||_LGraphCanvas.node_colors.black.groupcolor;n.fillStyle=C,n.globalAlpha=.75,n.beginPath();const G=10;n.fillStyle=C,n.beginPath(),n.moveTo(S[0]+G,S[1]),n.lineTo(S[0]+R[0]-G,S[1]),n.quadraticCurveTo(S[0]+R[0],S[1],S[0]+R[0],S[1]+G),n.lineTo(S[0]+R[0],S[1]+R[1]-G),n.quadraticCurveTo(S[0]+R[0],S[1]+R[1],S[0]+R[0]-G,S[1]+R[1]),n.lineTo(S[0]+G,S[1]+R[1]),n.quadraticCurveTo(S[0],S[1]+R[1],S[0],S[1]+R[1]-G),n.lineTo(S[0],S[1]+G),n.quadraticCurveTo(S[0],S[1],S[0]+G,S[1]),n.closePath(),n.fill(),this.read_only||(n.fillStyle="#0085FF",n.beginPath(),n.moveTo(S[0]+R[0]-7,S[1]+R[1]),n.lineTo(S[0]+R[0],S[1]+R[1]),n.lineTo(S[0]+R[0],S[1]+R[1]-7),n.closePath(),n.fill());const D=LiteGraph.DEFAULT_GROUP_FONT_SIZE||20,H=b.font_size||D;if(n.fillStyle="#ffffff",n.font="Bold "+H+"px Arial",n.textAlign="left",n.fillText(b.title,S[0]+12,S[1]+H+8),!this.read_only){const e=b.font_size*.6;n.font=`${e}px Arial`,n.fillStyle="#c6c6c6";const t=`x/y/넓이/높이: ${parseInt(b.pos[0])}/${parseInt(b.pos[1])}/${parseInt(b.size[0])}/${parseInt(b.size[1])}`;let r="";for(let s=0;s<t.length;s++){const a=r+t[s]+"";if(n.measureText(a).width>b.size[0]-30&&s>0){r=r.slice(0,r.length-2),r+=" ..";break}else r=a}n.fillText(r,S[0]+10,S[1]+b.size[1]-12)}if(this.selected_group&&(b==null?void 0:b.id)!==((h=this.selected_group)==null?void 0:h.id)&&!this.read_only){n.strokeStyle="#c4c4c4",n.lineWidth=1;const e=(d=this.selected_group)==null?void 0:d.size[0],t=(_=this.selected_group)==null?void 0:_.size[1],r=(m=this.selected_group)==null?void 0:m.pos[0],s=(E=this.selected_group)==null?void 0:E.pos[1],a=b.size[0],o=b.size[1],c=b.pos[0],f=b.pos[1],p=Math.round(r),T=Math.round(s),g=Math.round(e),N=Math.round(t),A=Math.round(c),M=Math.round(f),B=Math.round(a),O=Math.round(o);this.drawGuideLines(n,{roundX:p,roundY:T,roundWidth:g,roundHeight:N,otherRoundX:A,otherRoundY:M,otherRoundWidth:B,otherRoundHeight:O})}}n.restore()}scaleFit(){this.canvas&&(this.ds.scale=1,this.ds.max_scale=1,this.ds.min_scale=1,window.innerWidth>=3840&&(this.ds.scale=2,this.ds.max_scale=2,this.ds.min_scale=2))}renderLink(u,n,l,h,d,_,m,E,L,b){if(m="#3b3b3b",h){const C=this.graph.getNodeById(h.origin_id),G=this.graph.getNodeById(h.target_id),D=C.properties.status,H=G.properties.status,e=C.properties.resultIndex;typeof e=="number"&&h.origin_slot===e&&(D===1&&H===1?m="#34c38f":D===-1||H===-1?m="#f46a6a":(D===0||H===0)&&(m="#3b3b3b"))}h&&this.visible_links.push(h),!m&&h&&(m=h.color||_LGraphCanvas.link_type_colors[h.type]),m||(m=this.default_link_color),h!=null&&this.highlighted_links[h.id]&&(m="#FFF"),E=E||LiteGraph.RIGHT,L=L||LiteGraph.LEFT;const S=LiteGraph.distance(n,l);this.render_connections_border&&this.ds.scale>.6&&(u.lineWidth=this.connections_width+4),u.lineJoin="round",b=b||1,b>1&&(u.lineWidth=.5),u.beginPath();for(let C=0;C<b;C+=1){const G=(C-(b-1)*.5)*5;if(this.links_render_mode==LiteGraph.SPLINE_LINK){u.moveTo(n[0],n[1]+G);let D=0,H=0,e=0,t=0;switch(E){case LiteGraph.LEFT:D=S*-.25;break;case LiteGraph.RIGHT:D=S*.25;break;case LiteGraph.UP:H=S*-.25;break;case LiteGraph.DOWN:H=S*.25;break}switch(L){case LiteGraph.LEFT:e=S*-.25;break;case LiteGraph.RIGHT:e=S*.25;break;case LiteGraph.UP:t=S*-.25;break;case LiteGraph.DOWN:t=S*.25;break}u.bezierCurveTo(n[0]+D,n[1]+H+G,l[0]+e,l[1]+t+G,l[0],l[1]+G)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){u.moveTo(n[0],n[1]+G);let D=0,H=0,e=0,t=0;switch(E){case LiteGraph.LEFT:D=-1;break;case LiteGraph.RIGHT:D=1;break;case LiteGraph.UP:H=-1;break;case LiteGraph.DOWN:H=1;break}switch(L){case LiteGraph.LEFT:e=-1;break;case LiteGraph.RIGHT:e=1;break;case LiteGraph.UP:t=-1;break;case LiteGraph.DOWN:t=1;break}const r=15;u.lineTo(n[0]+D*r,n[1]+H*r+G),u.lineTo(l[0]+e*r,l[1]+t*r+G),u.lineTo(l[0],l[1]+G)}else if(this.links_render_mode==LiteGraph.STRAIGHT_LINK){u.moveTo(n[0],n[1]);let D=n[0],H=n[1],e=l[0],t=l[1];E==LiteGraph.RIGHT?D+=10:H+=10,L==LiteGraph.LEFT?e-=10:t-=10,u.lineTo(D,H),u.lineTo((D+e)*.5,H),u.lineTo((D+e)*.5,t),u.lineTo(e,t),u.lineTo(l[0],l[1])}else return}this.render_connections_border&&this.ds.scale>.6&&!d&&(u.strokeStyle="rgba(0,0,0,0.5)",u.stroke()),u.lineWidth=this.connections_width,u.fillStyle=u.strokeStyle=m,u.stroke();let R=this.computeConnectionPoint(n,l,.5,E,L);if(h&&h._pos&&(h._pos[0]=R[0],h._pos[1]=R[1]),this.ds.scale>=.6&&this.highquality_render&&L!=LiteGraph.CENTER&&!this.read_only){if(this.render_connection_arrows){const C=this.computeConnectionPoint(n,l,.25,E,L),G=this.computeConnectionPoint(n,l,.26,E,L),D=this.computeConnectionPoint(n,l,.75,E,L),H=this.computeConnectionPoint(n,l,.76,E,L);let e=0,t=0;this.render_curved_connections?(e=-Math.atan2(G[0]-C[0],G[1]-C[1]),t=-Math.atan2(H[0]-D[0],H[1]-D[1])):t=e=l[1]>n[1]?0:Math.PI,u.save(),u.translate(C[0],C[1]),u.rotate(e),u.beginPath(),u.moveTo(-5,-3),u.lineTo(0,7),u.lineTo(5,-3),u.fill(),u.restore(),u.save(),u.translate(D[0],D[1]),u.rotate(t),u.beginPath(),u.moveTo(-5,-3),u.lineTo(0,7),u.lineTo(5,-3),u.fill(),u.restore()}u.beginPath(),u.arc(R[0],R[1],5,0,Math.PI*2),u.fill()}if(_){u.fillStyle=m;for(let C=0;C<3;++C){let G=(LiteGraph.getTime()*2e-4+C*.2)%1;if(this.links_render_mode===LiteGraph.STRAIGHT_LINK){let D=n[0],H=n[1],e=l[0],t=l[1];E==LiteGraph.RIGHT?D+=10:E==LiteGraph.LEFT?D-=10:E==LiteGraph.DOWN?H+=10:E==LiteGraph.UP&&(H-=10),L==LiteGraph.LEFT?e-=10:L==LiteGraph.RIGHT?e+=10:L==LiteGraph.UP?t-=10:L==LiteGraph.DOWN&&(t+=10);const r=(D+e)*.5,s=Math.abs(r-D),a=Math.abs(t-H),o=Math.abs(e-r),c=s+a+o,f=G*c;let p=[D,H];if(f<=s)p=[D+f*(D<r?1:-1),H];else if(f<=s+a){const T=f-s;H<t?p=[r,H+T]:p=[r,H-T]}else if(f<=c){const T=f-(s+a);p=[r+T*(r<e?1:-1),t]}u.beginPath(),u.arc(p[0],p[1],5,0,2*Math.PI),u.fill()}else R=this.computeConnectionPoint(n,l,G,E,L);u.beginPath(),u.arc(R[0],R[1],5,0,2*Math.PI),u.fill()}}}computeConnectionPoint(u,n,l,h,d){h=h||LiteGraph.RIGHT,d=d||LiteGraph.LEFT;const _=LiteGraph.distance(u,n),m=u,E=[u[0],u[1]],L=[n[0],n[1]],b=n;switch(h){case LiteGraph.LEFT:E[0]+=_*-.25;break;case LiteGraph.RIGHT:E[0]+=_*.25;break;case LiteGraph.UP:E[1]+=_*-.25;break;case LiteGraph.DOWN:E[1]+=_*.25;break}switch(d){case LiteGraph.LEFT:L[0]+=_*-.25;break;case LiteGraph.RIGHT:L[0]+=_*.25;break;case LiteGraph.UP:L[1]+=_*-.25;break;case LiteGraph.DOWN:L[1]+=_*.25;break}const S=(1-l)*(1-l)*(1-l),R=3*((1-l)*(1-l))*l,C=3*(1-l)*(l*l),G=l*l*l,D=S*m[0]+R*E[0]+C*L[0]+G*b[0],H=S*m[1]+R*E[1]+C*L[1]+G*b[1];return[D,H]}drawExecutionOrder(u){u.shadowColor="transparent",u.globalAlpha=.25,u.textAlign="center",u.strokeStyle="white",u.globalAlpha=.75;const n=this.visible_nodes;for(let l=0;l<n.length;++l){const h=n[l];u.fillStyle="black",u.fillRect(h.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,h.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),h.order==0&&u.strokeRect(h.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,h.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),u.fillStyle="#FFF",u.fillText(h.order,h.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*-.5,h.pos[1]-6)}u.globalAlpha=1}drawNodeWidgets(u,n,l,h){if(!u.widgets||!u.widgets.length)return 0;const d=u.size[0],_=u.widgets;n+=2;const m=LiteGraph.NODE_WIDGET_HEIGHT,E=this.ds.scale>.5;l.save(),l.globalAlpha=this.editor_alpha;const L=LiteGraph.WIDGET_OUTLINE_COLOR,b=LiteGraph.WIDGET_BGCOLOR,S=LiteGraph.WIDGET_TEXT_COLOR,R=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,C=15;for(let G=0;G<_.length;++G){let D=_[G],H=n;D.y&&(H=D.y),D.last_y=H,l.strokeStyle=L,l.fillStyle="#222",l.textAlign="left",D.disabled&&(l.globalAlpha*=.5);const e=D.width||d;let t=D.options.max-D.options.min,r=(D.value-D.options.min)/t;switch(D.type){case"button":D.clicked&&(l.fillStyle="#AAA",D.clicked=!1,this.dirty_canvas=!0),l.fillRect(C,H,e-C*2,m),E&&!D.disabled&&l.strokeRect(C,H,e-C*2,m),E&&(l.textAlign="center",l.fillStyle=S,l.fillText(D.label||D.name,e*.5,H+m*.7));break;case"toggle":if(l.textAlign="left",l.strokeStyle=L,l.fillStyle=b,l.beginPath(),E?l.roundRect(C,H,e-C*2,m,[m*.5]):l.rect(C,H,e-C*2,m),l.fill(),E&&!D.disabled&&l.stroke(),l.fillStyle=D.value?"#89A":"#333",l.beginPath(),l.arc(e-C*2,H+m*.5,m*.36,0,Math.PI*2),l.fill(),E){l.fillStyle=R;const s=D.label||D.name;s!=null&&l.fillText(s,C*2,H+m*.7),l.fillStyle=D.value?S:R,l.textAlign="right",l.fillText(D.value?D.options.on||"true":D.options.off||"false",e-40,H+m*.7)}break;case"slider":if(l.fillStyle=b,l.fillRect(C,H,e-C*2,m),r<0&&(r=0),r>1&&(r=1),l.fillStyle=Object.prototype.hasOwnProperty.call(D.options,"slider_color")?D.options.slider_color:h==D?"#89A":"#678",l.fillRect(C,H,r*(e-C*2),m),E&&!D.disabled&&l.strokeRect(C,H,e-C*2,m),D.marker){let s=(D.marker-D.options.min)/t;s<0&&(s=0),s>1&&(s=1),l.fillStyle=Object.prototype.hasOwnProperty.call(D.options,"marker_color")?D.options.marker_color:"#AA9",l.fillRect(C+s*(e-C*2),H,2,m)}E&&(l.textAlign="center",l.fillStyle=S,l.fillText(D.label||D.name+"  "+Number(D.value).toFixed(D.options.precision!=null?D.options.precision:3),e*.5,H+m*.7));break;case"number":case"combo":if(l.textAlign="left",l.strokeStyle=L,l.fillStyle=b,l.beginPath(),E?l.roundRect(C,H,e-C*2,m,[m*.5]):l.rect(C,H,e-C*2,m),l.fill(),E)if(D.disabled||l.stroke(),l.fillStyle=S,D.disabled||(l.beginPath(),l.moveTo(C+16,H+5),l.lineTo(C+6,H+m*.5),l.lineTo(C+16,H+m-5),l.fill(),l.beginPath(),l.moveTo(e-C-16,H+5),l.lineTo(e-C-6,H+m*.5),l.lineTo(e-C-16,H+m-5),l.fill()),l.fillStyle=R,l.fillText(D.label||D.name,C*2+5,H+m*.7),l.fillStyle=S,l.textAlign="right",D.type=="number")l.fillText(Number(D.value).toFixed(D.options.precision!==void 0?D.options.precision:3),e-C*2-20,H+m*.7);else{let s=D.value;if(D.options.values){let a=D.options.values;a.constructor===Function&&(a=a()),a&&a.constructor!==Array&&(s=a[D.value])}l.fillText(s,e-C*2-20,H+m*.7)}break;case"string":case"text":if(l.textAlign="left",l.strokeStyle=L,l.fillStyle=b,l.beginPath(),E?l.roundRect(C,H,e-C*2,m,[m*.5]):l.rect(C,H,e-C*2,m),l.fill(),E){D.disabled||l.stroke(),l.save(),l.beginPath(),l.rect(C,H,e-C*2,m),l.clip(),l.fillStyle=R;const s=D.label||D.name;s!=null&&l.fillText(s,C*2,H+m*.7),l.fillStyle=S,l.textAlign="right",l.fillText(String(D.value).substr(0,30),e-C*2,H+m*.7),l.restore()}break;default:D.draw&&D.draw(l,u,e,H,m);break}n+=(D.computeSize?D.computeSize(e)[1]:m)+4,l.globalAlpha=this.editor_alpha}l.restore(),l.textAlign="left"}processNodeWidgets(node,pos,event,active_widget){if(!node.widgets||!node.widgets.length||!this.allow_interaction&&!node.flags.allow_interaction)return null;const x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow();for(let i=0;i<node.widgets.length;++i){const w=node.widgets[i];if(!w||w.disabled)continue;const widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(w!=active_widget&&(x<6||x>widget_width-12||y<w.last_y||y>w.last_y+widget_height||w.last_y===void 0))continue;const old_value=w.value;let _old_value=w.value,nvalue=clamp((x-15)/(widget_width-30),0,1);switch(w.type){case"button":event.type===LiteGraph.pointerevents_method+"down"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":if(w.options.read_only)break;w.value=w.options.min+(w.options.max-w.options.min)*nvalue,_old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value)},20),this.dirty_canvas=!0;break;case"number":case"combo":if(event.type==LiteGraph.pointerevents_method+"move"&&w.type=="number")deltaX&&(w.value+=deltaX*.1*(w.options.step||1)),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(event.type==LiteGraph.pointerevents_method+"down"){let u=w.options.values;u&&u.constructor===Function&&(u=w.options.values(w,node));let n=null;w.type!="number"&&(n=u.constructor===Array?u:Object.keys(u));const l=x<40?-1:x>widget_width-40?1:0;if(w.type=="number")w.value+=l*.1*(w.options.step||1),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(l){let h=-1;this.last_mouseclick=0,u.constructor===Object?h=n.indexOf(String(w.value))+l:h=n.indexOf(w.value)+l,h>=n.length&&(h=n.length-1),h<0&&(h=0),u.constructor===Array?w.value=u[h]:w.value=h}else{let d=function(_,m,E){return u!=n&&(_=h.indexOf(_)),this.value=_,inner_value_change(this,_),that.dirty_canvas=!0,!1};const h=u!=n?Object.values(u):u;new ContextMenu(h,{scale:Math.max(1,this.ds.scale),event,className:"dark",callback:d.bind(w)},ref_window)}}else if(event.type==LiteGraph.pointerevents_method+"up"&&w.type=="number"){const delta=x<40?-1:x>widget_width-40?1:0;event.click_time<200&&delta==0&&this.prompt("Value",w.value,(function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(u){}this.value=Number(v),inner_value_change(this,this.value)}).bind(w),event)}old_value!=w.value&&setTimeout((function(){inner_value_change(this,this.value)}).bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph.pointerevents_method+"down"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type==LiteGraph.pointerevents_method+"down"&&this.prompt("Value",w.value,(function(u){inner_value_change(this,u)}).bind(w),event,w.options?w.options.multiline:!1);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node));break}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),w}function inner_value_change(u,n){u.type=="number"&&(n=Number(n)),u.value=n,u.options&&u.options.property&&node.properties[u.options.property]!==void 0&&node.setProperty(u.options.property,n),u.callback&&u.callback(u.value,that,node,pos,event)}return null}adjustNodesSize(){const u=this.graph._nodes;for(let n=0;n<u.length;++n)u[n].size=u[n].computeSize();this.setDirty(!0,!0)}resize(u,n){if(!u&&!n){const l=this.canvas.parentNode;u=l.offsetWidth,n=l.offsetHeight}this.canvas.width==u&&this.canvas.height==n||(this.canvas.width=u,this.canvas.height=n,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}switchLiveMode(u){if(!u){this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;return}const n=this,l=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);const h=setInterval(function(){n.editor_alpha*=l,n.dirty_canvas=!0,n.dirty_bgcanvas=!0,l<1&&n.editor_alpha<.01&&(clearInterval(h),l<1&&(n.live_mode=!0)),l>1&&n.editor_alpha>.99&&(clearInterval(h),n.editor_alpha=1)},1)}onNodeSelectionChange(u){}static onGroupAdd(u,n,l){const h=_LGraphCanvas.active_canvas;h.getCanvasWindow();const d=new LGraphGroup;d.pos=h.convertEventToCanvasOffset(l),h.graph.add(d)}static getBoundaryNodes(u){let n=null,l=null,h=null,d=null;for(const _ in u){const m=u[_],[E,L]=m.pos,[b,S]=m.size;(n===null||L<n.pos[1])&&(n=m),(l===null||E+b>l.pos[0]+l.size[0])&&(l=m),(h===null||L+S>h.pos[1]+h.size[1])&&(h=m),(d===null||E<d.pos[0])&&(d=m)}return{top:n,right:l,bottom:h,left:d}}boundaryNodesForSelection(){return _LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))}static alignNodes(u,n,l){if(!u)return;const h=_LGraphCanvas.active_canvas;let d=[];l===void 0?d=_LGraphCanvas.getBoundaryNodes(u):d={top:l,right:l,bottom:l,left:l};for(const[_,m]of Object.entries(h.selected_nodes))switch(n){case"right":m.pos[0]=d.right.pos[0]+d.right.size[0]-m.size[0];break;case"left":m.pos[0]=d.left.pos[0];break;case"top":m.pos[1]=d.top.pos[1];break;case"bottom":m.pos[1]=d.bottom.pos[1]+d.bottom.size[1]-m.size[1];break}h.dirty_canvas=!0,h.dirty_bgcanvas=!0}static onNodeAlign(u,n,l,h,d){new ContextMenu(["Top","Bottom","Left","Right"],{event:l,callback:_,parentMenu:h});function _(m){_LGraphCanvas.alignNodes(_LGraphCanvas.active_canvas.selected_nodes,m.toLowerCase(),d)}}static onGroupAlign(u,n,l,h){new ContextMenu(["Top","Bottom","Left","Right"],{event:l,callback:d,parentMenu:h});function d(_){_LGraphCanvas.alignNodes(_LGraphCanvas.active_canvas.selected_nodes,_.toLowerCase())}}static onMenuAdd(u,n,l,h,d){const _=_LGraphCanvas.active_canvas,m=_.getCanvasWindow(),E=_.graph;if(!E)return;function L(b,S){const R=LiteGraph.getNodeTypesCategories(_.filter||E.filter).filter(function(D){return D.startsWith(b)}),C=[];R.map(function(D){if(!D)return;const H=new RegExp("^("+b+")"),e=D.replace(H,"").split("/")[0],t=b===""?e+"/":b+e+"/";let r=e;r.indexOf("::")!=-1&&(r=r.split("::")[1]),C.findIndex(function(a){return a.value===t})===-1&&C.push({value:t,content:r,has_submenu:!0,callback:function(a,o,c,f){L(a.value,f)}})}),LiteGraph.getNodeTypesInCategory(b.slice(0,-1),_.filter||E.filter).map(function(D){if(D.skip_list)return;const H={value:D.type,content:D.title,has_submenu:!1,callback:function(e,t,r,s){const a=s.getFirstEvent();_.graph.beforeChange();const o=LiteGraph.createNode(e.value);o&&(o.pos=_.convertEventToCanvasOffset(a),_.graph.add(o)),d&&d(o),_.graph.afterChange()}};C.push(H)}),new ContextMenu(C,{event:l,parentMenu:S},m)}return L("",h),!1}static onMenuCollapseAll(){}static onMenuNodeEdit(){}static showMenuNodeOptionalInputs(u,n,l,h,d){if(!d)return;const _=this,E=_LGraphCanvas.active_canvas.getCanvasWindow();let L=d.optional_inputs;d.onGetInputs&&(L=d.onGetInputs());let b=[];if(L)for(let R=0;R<L.length;R++){const C=L[R];if(!C){b.push(null);continue}let G=C[0];C[2]||(C[2]={}),C[2].label&&(G=C[2].label),C[2].removable=!0;const D={content:G,value:C};C[1]==LiteGraph.ACTION&&(D.className="event"),b.push(D)}if(d.onMenuNodeInputs){const R=d.onMenuNodeInputs(b);R&&(b=R)}if(!b.length){console.log("no input entries");return}new ContextMenu(b,{event:l,callback:S,parentMenu:h,node:d},E);function S(R,C,G){d&&(R.callback&&R.callback.call(_,d,R,C,G),R.value&&(d.graph.beforeChange(),d.addInput(R.value[0],R.value[1],R.value[2]),d.onNodeInputAdd&&d.onNodeInputAdd(R.value),d.setDirtyCanvas(!0,!0),d.graph.afterChange()))}return!1}static showMenuNodeOptionalOutputs(u,n,l,h,d){if(!d)return;const _=this,E=_LGraphCanvas.active_canvas.getCanvasWindow();let L=d.optional_outputs;d.onGetOutputs&&(L=d.onGetOutputs());let b=[];if(L)for(let R=0;R<L.length;R++){const C=L[R];if(!C){b.push(null);continue}if(d.flags&&d.flags.skip_repeated_outputs&&d.findOutputSlot(C[0])!=-1)continue;let G=C[0];C[2]||(C[2]={}),C[2].label&&(G=C[2].label),C[2].removable=!0;const D={content:G,value:C};C[1]==LiteGraph.EVENT&&(D.className="event"),b.push(D)}if(this.onMenuNodeOutputs&&(b=this.onMenuNodeOutputs(b)),LiteGraph.do_add_triggers_slots&&d.findOutputSlot("onExecuted")==-1&&b.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"}),d.onMenuNodeOutputs){const R=d.onMenuNodeOutputs(b);R&&(b=R)}if(!b.length)return;new ContextMenu(b,{event:l,callback:S,parentMenu:h,node:d},E);function S(R,C,G){if(!d||(R.callback&&R.callback.call(_,d,R,C,G),!R.value))return;const D=R.value[1];if(D&&(D.constructor===Object||D.constructor===Array)){const H=[];for(const e in D)H.push({content:e,value:D[e]});return new ContextMenu(H,{event:C,callback:S,parentMenu:h,node:d}),!1}else d.graph.beforeChange(),d.addOutput(R.value[0],R.value[1],R.value[2]),d.onNodeOutputAdd&&d.onNodeOutputAdd(R.value),d.setDirtyCanvas(!0,!0),d.graph.afterChange()}return!1}static onShowMenuNodeProperties(u,n,l,h,d){if(!d||!d.properties)return;const _=_LGraphCanvas.active_canvas,m=_.getCanvasWindow(),E=[];for(const b in d.properties){let S=d.properties[b]!==void 0?d.properties[b]:" ";typeof S=="object"&&(S=JSON.stringify(S));const R=d.getPropertyInfo(b);(R.type=="enum"||R.type=="combo")&&(S=_LGraphCanvas.getPropertyPrintableValue(S,R.values)),S=_LGraphCanvas.decodeHTML(S),E.push({content:"<span class='property_name'>"+(R.label?R.label:b)+"</span><span class='property_value'>"+S+"</span>",value:b})}if(!E.length)return;new ContextMenu(E,{event:l,callback:L,parentMenu:h,allow_html:!0,node:d},m);function L(b,S,R,C){if(!d)return;const G=this.getBoundingClientRect();_.showEditPropertyValue(d,b.value,{position:[G.left,G.top]})}return!1}static decodeHTML(u){const n=document.createElement("div");return n.innerText=u,n.innerHTML}static onMenuResizeNode(u,n,l,h,d){if(!d)return;const _=function(E){E.size=E.computeSize(),E.onResize&&E.onResize(E.size)},m=_LGraphCanvas.active_canvas;if(!m.selected_nodes||Object.keys(m.selected_nodes).length<=1)_(d);else for(const E in m.selected_nodes)_(m.selected_nodes[E]);d.setDirtyCanvas(!0,!0)}static showLinkMenu(u,n){const l=this,h=l.graph.getNodeById(u.origin_id),d=l.graph.getNodeById(u.target_id);let _=!1;h&&h.outputs&&h.outputs[u.origin_slot]&&(_=h.outputs[u.origin_slot].type);let m=!1;d&&d.outputs&&d.outputs[u.target_slot]&&(m=d.inputs[u.target_slot].type);const E=["Add Node",null,"Delete",null],L=new ContextMenu(E,{event:n,title:u.data!=null?u.data.constructor.name:null,callback:b});function b(S,R,C){switch(S){case"Add Node":_LGraphCanvas.onMenuAdd(null,null,C,L,function(G){!G.inputs||!G.inputs.length||!G.outputs||!G.outputs.length||h.connectByType(u.origin_slot,G,_)&&(G.connectByType(u.target_slot,d,m),G.pos[0]-=G.size[0]*.5)});break;case"Delete":l.graph.removeLink(u.id);break}}return!1}createDefaultNodeForSlot(u){const l=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},u||{}),h=this,d=l.nodeFrom&&l.slotFrom!==null,_=!d&&l.nodeTo&&l.slotTo!==null;if(!d&&!_)return console.warn("No data passed to createDefaultNodeForSlot "+l.nodeFrom+" "+l.slotFrom+" "+l.nodeTo+" "+l.slotTo),!1;if(!l.nodeType)return console.warn("No type to createDefaultNodeForSlot"),!1;const m=d?l.nodeFrom:l.nodeTo;let E=d?l.slotFrom:l.slotTo,L=!1;switch(typeof E){case"string":L=d?m.findOutputSlot(E,!1):m.findInputSlot(E,!1),E=d?m.outputs[E]:m.inputs[E];break;case"object":L=d?m.findOutputSlot(E.name):m.findInputSlot(E.name);break;case"number":L=E,E=d?m.outputs[E]:m.inputs[E];break;case"undefined":default:return console.warn("Cant get slot information "+E),!1}(E===!1||L===!1)&&console.warn("createDefaultNodeForSlot bad slotX "+E+" "+L);const b=E.type==LiteGraph.EVENT?"_event_":E.type,S=d?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(S&&S[b]){E.link;let R=!1;if(typeof S[b]=="object"||Array.isArray(S[b])){for(const C in S[b])if(l.nodeType==S[b][C]||l.nodeType=="AUTO"){R=S[b][C];break}}else(l.nodeType==S[b]||l.nodeType=="AUTO")&&(R=S[b]);if(R){let C=!1;typeof R=="object"&&R.node&&(C=R,R=R.node);const G=LiteGraph.createNode(R);if(G){if(C){if(C.properties)for(const D in C.properties)G.addProperty(D,C.properties[D]);if(C.inputs){G.inputs=[];for(const D in C.inputs)G.addOutput(C.inputs[D][0],C.inputs[D][1])}if(C.outputs){G.outputs=[];for(const D in C.outputs)G.addOutput(C.outputs[D][0],C.outputs[D][1])}C.title&&(G.title=C.title),C.json&&G.configure(C.json)}return h.graph.add(G),G.pos=[l.position[0]+l.posAdd[0]+(l.posSizeFix[0]?l.posSizeFix[0]*G.size[0]:0),l.position[1]+l.posAdd[1]+(l.posSizeFix[1]?l.posSizeFix[1]*G.size[1]:0)],d?l.nodeFrom.connectByType(L,G,b):l.nodeTo.connectByTypeOutput(L,G,b),!0}else console.log("failed creating "+R)}}return!1}showConnectionMenu(u){const l=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},u||{}),h=this,d=l.nodeFrom&&l.slotFrom,_=!d&&l.nodeTo&&l.slotTo;if(!d&&!_)return console.warn("No data passed to showConnectionMenu"),!1;const m=d?l.nodeFrom:l.nodeTo;let E=d?l.slotFrom:l.slotTo,L=!1;switch(typeof E){case"string":L=d?m.findOutputSlot(E,!1):m.findInputSlot(E,!1),E=d?m.outputs[E]:m.inputs[E];break;case"object":L=d?m.findOutputSlot(E.name):m.findInputSlot(E.name);break;case"number":L=E,E=d?m.outputs[E]:m.inputs[E];break;default:return console.warn("Cant get slot information "+E),!1}const b=["Add Node",null];h.allow_searchbox&&(b.push("Search"),b.push(null));const S=E.type==LiteGraph.EVENT?"_event_":E.type,R=d?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(R&&R[S])if(typeof R[S]=="object"||Array.isArray(R[S]))for(const D in R[S])b.push(R[S][D]);else b.push(R[S]);const C=new ContextMenu(b,{event:l.e,title:(E&&E.name!=""?E.name+(S?" | ":""):"")+(E&&S?S:""),callback:G});function G(D,H,e){switch(h.createDefaultNodeForSlot(Object.assign(l,{position:[l.e.canvasX,l.e.canvasY],nodeType:D})),D){case"Add Node":_LGraphCanvas.onMenuAdd(null,null,e,C,function(t){d?l.nodeFrom.connectByType(L,t,S):l.nodeTo.connectByTypeOutput(L,t,S)});break;case"Search":d?h.showSearchBox(e,{node_from:l.nodeFrom,slot_from:E,type_filter_in:S}):h.showSearchBox(e,{node_to:l.nodeTo,slot_from:E,type_filter_out:S});break}}return!1}static onShowPropertyEditor(u,n,l,h,d){const _=u.property||"title",m=d[_],E=document.createElement("div");E.is_modified=!1,E.className="graphdialog",E.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",E.close=function(){E.parentNode&&E.parentNode.removeChild(E)};const L=E.querySelector(".name");L.innerText=_;let b=E.querySelector(".value");b&&(b.value=m,b.addEventListener("blur",function(s){this.focus()}),b.addEventListener("keydown",function(s){if(E.is_modified=!0,s.keyCode==27)E.close();else if(s.keyCode==13)t();else if(s.keyCode!=13&&s.target.localName!="textarea")return;s.preventDefault(),s.stopPropagation()}));const R=_LGraphCanvas.active_canvas.canvas,C=R.getBoundingClientRect();let G=-20,D=-20;C&&(G-=C.left,D-=C.top),event?(E.style.left=event.clientX+G+"px",E.style.top=event.clientY+D+"px"):(E.style.left=R.width*.5+G+"px",E.style.top=R.height*.5+D+"px"),E.querySelector("button").addEventListener("click",t),R.parentNode.appendChild(E),b&&b.focus();let e=null;E.addEventListener("mouseleave",function(s){LiteGraph.dialog_close_on_mouse_leave&&!E.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(e=setTimeout(E.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),E.addEventListener("mouseenter",function(s){LiteGraph.dialog_close_on_mouse_leave&&e&&clearTimeout(e)});function t(){b&&r(b.value)}function r(s){u.type=="Number"?s=Number(s):u.type=="Boolean"&&(s=!!s),d[_]=s,E.parentNode&&E.parentNode.removeChild(E),d.setDirtyCanvas(!0,!0)}}prompt(u,n,l,h,d){const _=this;u=u||"";const m=document.createElement("div");m.is_modified=!1,m.className="graphdialog rounded",d?m.innerHTML="<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":m.innerHTML="<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",m.close=function(){_.prompt_box=null,m.parentNode&&m.parentNode.removeChild(m)};const L=_LGraphCanvas.active_canvas.canvas;L.parentNode.appendChild(m),this.ds.scale>1&&(m.style.transform="scale("+this.ds.scale+")");let b=null,S=!1;LiteGraph.pointerListenerAdd(m,"leave",function(s){S||LiteGraph.dialog_close_on_mouse_leave&&!m.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(b=setTimeout(m.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(m,"enter",function(s){LiteGraph.dialog_close_on_mouse_leave&&b&&clearTimeout(b)});const R=m.querySelectorAll("select");R&&R.forEach(function(s){s.addEventListener("click",function(a){S++}),s.addEventListener("blur",function(a){S=0}),s.addEventListener("change",function(a){S=-1})}),_.prompt_box&&_.prompt_box.close(),_.prompt_box=m;const C=m.querySelector(".name");C.innerText=u;const G=m.querySelector(".value");G.value=n;const D=G;D.addEventListener("keydown",function(s){if(m.is_modified=!0,s.keyCode==27)m.close();else if(s.keyCode==13&&s.target.localName!="textarea")l&&l(this.value),m.close();else return;s.preventDefault(),s.stopPropagation()}),m.querySelector("button").addEventListener("click",function(s){l&&l(D.value),_.setDirty(!0),m.close()});const e=L.getBoundingClientRect();let t=-20,r=-20;return e&&(t-=e.left,r-=e.top),h?(m.style.left=h.clientX+t+"px",m.style.top=h.clientY+r+"px"):(m.style.left=L.width*.5+t+"px",m.style.top=L.height*.5+r+"px"),setTimeout(function(){D.focus()},10),m}showSearchBox(u,n){const l={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};n=Object.assign(l,n||{});const h=this,d=_LGraphCanvas.active_canvas,_=d.canvas,m=_.ownerDocument||document,E=document.createElement("div");E.className="litegraph litesearchbox graphdialog rounded",E.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",n.do_type_filter&&(E.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",E.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),E.innerHTML+="<div class='helper'></div>",m.fullscreenElement?m.fullscreenElement.appendChild(E):(m.body.appendChild(E),m.body.style.overflow="hidden");let L,b;if(n.do_type_filter&&(L=E.querySelector(".slot_in_type_filter"),b=E.querySelector(".slot_out_type_filter")),E.close=function(){h.search_box=null,this.blur(),_.focus(),m.body.style.overflow="",setTimeout(function(){h.canvas.focus()},20),E.parentNode&&E.parentNode.removeChild(E)},this.ds.scale>1&&(E.style.transform="scale("+this.ds.scale+")"),n.hide_on_mouse_leave){let o=!1,c=null;LiteGraph.pointerListenerAdd(E,"enter",function(f){c&&(clearTimeout(c),c=null)}),LiteGraph.pointerListenerAdd(E,"leave",function(f){o||(c=setTimeout(function(){E.close()},500))}),n.do_type_filter&&(L.addEventListener("click",function(f){o++}),L.addEventListener("blur",function(f){o=0}),L.addEventListener("change",function(f){o=-1}),b.addEventListener("click",function(f){o++}),b.addEventListener("blur",function(f){o=0}),b.addEventListener("change",function(f){o=-1}))}h.search_box&&h.search_box.close(),h.search_box=E;const S=E.querySelector(".helper");let R=null,C=null,G=null,D=E.querySelector("input");if(D&&(D.addEventListener("blur",function(o){h.search_box&&this.focus()}),D.addEventListener("keydown",function(o){if(o.keyCode==38)s(!1);else if(o.keyCode==40)s(!0);else if(o.keyCode==27)E.close();else if(o.keyCode==13)a(),G?r(G.innerHTML):R?r(R):E.close();else{C&&clearInterval(C),C=setTimeout(a,250);return}return o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation(),!0})),n.do_type_filter){if(L){const o=LiteGraph.slot_types_in,c=o.length;(n.type_filter_in==LiteGraph.EVENT||n.type_filter_in==LiteGraph.ACTION)&&(n.type_filter_in="_event_");for(let f=0;f<c;f++){const p=document.createElement("option");p.value=o[f],p.innerHTML=o[f],L.appendChild(p),n.type_filter_in!==!1&&(n.type_filter_in+"").toLowerCase()==(o[f]+"").toLowerCase()&&(p.selected=!0)}L.addEventListener("change",function(){a()})}if(b){const o=LiteGraph.slot_types_out,c=o.length;(n.type_filter_out==LiteGraph.EVENT||n.type_filter_out==LiteGraph.ACTION)&&(n.type_filter_out="_event_");for(let f=0;f<c;f++){const p=document.createElement("option");p.value=o[f],p.innerHTML=o[f],b.appendChild(p),n.type_filter_out!==!1&&(n.type_filter_out+"").toLowerCase()==(o[f]+"").toLowerCase()&&(p.selected=!0)}b.addEventListener("change",function(){a()})}}const H=_.getBoundingClientRect(),e=(u?u.clientX:H.left+H.width*.5)-80,t=(u?u.clientY:H.top+H.height*.5)-20;E.style.left=e+"px",E.style.top=t+"px",u.layerY>H.height-200&&(S.style.maxHeight=H.height-u.layerY-20+"px"),D.focus(),n.show_all_on_open&&a();function r(o){if(o)if(h.onSearchBoxSelection)h.onSearchBoxSelection(o,u,d);else{const c=LiteGraph.searchbox_extras[o.toLowerCase()];c&&(o=c.type),d.graph.beforeChange();const f=LiteGraph.createNode(o);if(f&&(f.pos=d.convertEventToCanvasOffset(u),d.graph.add(f,!1)),c&&c.data){if(c.data.properties)for(const p in c.data.properties)f.addProperty(p,c.data.properties[p]);if(c.data.inputs){f.inputs=[];for(const p in c.data.inputs)f.addOutput(c.data.inputs[p][0],c.data.inputs[p][1])}if(c.data.outputs){f.outputs=[];for(const p in c.data.outputs)f.addOutput(c.data.outputs[p][0],c.data.outputs[p][1])}c.data.title&&(f.title=c.data.title),c.data.json&&f.configure(c.data.json)}if(n.node_from){let p=!1;switch(typeof n.slot_from){case"string":p=n.node_from.findOutputSlot(n.slot_from);break;case"object":n.slot_from.name?p=n.node_from.findOutputSlot(n.slot_from.name):p=-1,p==-1&&typeof n.slot_from.slot_index<"u"&&(p=n.slot_from.slot_index);break;case"number":p=n.slot_from;break;default:p=0}typeof n.node_from.outputs[p]<"u"&&p!==!1&&p>-1&&n.node_from.connectByType(p,f,n.node_from.outputs[p].type)}if(n.node_to){let p=!1;switch(typeof n.slot_from){case"string":p=n.node_to.findInputSlot(n.slot_from);break;case"object":n.slot_from.name?p=n.node_to.findInputSlot(n.slot_from.name):p=-1,p==-1&&typeof n.slot_from.slot_index<"u"&&(p=n.slot_from.slot_index);break;case"number":p=n.slot_from;break;default:p=0}typeof n.node_to.inputs[p]<"u"&&p!==!1&&p>-1&&n.node_to.connectByTypeOutput(p,f,n.node_to.inputs[p].type)}d.graph.afterChange()}E.close()}function s(o){const c=G;G&&G.classList.remove("selected"),G?(G=o?G.nextSibling:G.previousSibling,G||(G=c)):G=o?S.childNodes[0]:S.childNodes[S.childNodes.length],G&&(G.classList.add("selected"),G.scrollIntoView({block:"end",behavior:"smooth"}))}function a(){C=null;let o=D.value;if(R=null,S.innerHTML="",!o&&!n.show_all_if_empty)return;if(h.onSearchBox){const f=h.onSearchBox(S,o,d);if(f)for(let p=0;p<f.length;++p)c(f[p])}else{let N=function(A,M){const P=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},M||{}),U=LiteGraph.registered_node_types[A];if(f&&U.filter!=f||(!n.show_all_if_empty||o)&&A.toLowerCase().indexOf(o)===-1)return!1;if(n.do_type_filter&&!P.skipFilter){const X=A;let k=p.value;if(P.inTypeOverride!==!1&&(k=P.inTypeOverride),p&&k&&LiteGraph.registered_slot_in_types[k]&&LiteGraph.registered_slot_in_types[k].nodes&&LiteGraph.registered_slot_in_types[k].nodes.includes(X)===!1)return!1;let V=T.value;if(P.outTypeOverride!==!1&&(V=P.outTypeOverride),T&&V&&LiteGraph.registered_slot_out_types[V]&&LiteGraph.registered_slot_out_types[V].nodes&&LiteGraph.registered_slot_out_types[V].nodes.includes(X)===!1)return!1}return!0};o=o.toLowerCase();const f=d.filter||d.graph.filter;let p=null,T=null;n.do_type_filter&&h.search_box?(p=h.search_box.querySelector(".slot_in_type_filter"),T=h.search_box.querySelector(".slot_out_type_filter")):(p=!1,T=!1);for(const A in LiteGraph.searchbox_extras){const M=LiteGraph.searchbox_extras[A];if((!n.show_all_if_empty||o)&&M.desc.toLowerCase().indexOf(o)===-1)continue;const B=LiteGraph.registered_node_types[M.type];B&&B.filter!=f||N(M.type)&&c(M.desc,"searchbox_extra")}let g=null;if(Array.prototype.filter)g=Object.keys(LiteGraph.registered_node_types).filter(N);else{g=[];for(const A in LiteGraph.registered_node_types)N(A)&&g.push(A)}for(let A=0;A<g.length;A++)c(g[A]);if(n.show_general_after_typefiltered&&(p.value||T.value)){const A=[];for(const M in LiteGraph.registered_node_types)N(M,{inTypeOverride:p&&p.value?"*":!1,outTypeOverride:T&&T.value?"*":!1})&&A.push(M);for(let M=0;M<A.length;M++)c(A[M],"generic_type")}if((p.value||T.value)&&S.childNodes.length==0&&n.show_general_if_none_on_typefilter){const A=[];for(const M in LiteGraph.registered_node_types)N(M,{skipFilter:!0})&&A.push(M);for(let M=0;M<A.length;M++)c(A[M],"not_in_filter")}}function c(f,p){const T=document.createElement("div");R||(R=f),T.innerText=f,T.dataset.type=escape(f),T.className="litegraph lite-search-item",p&&(T.className+=" "+p),T.addEventListener("click",function(g){r(unescape(this.dataset.type))}),S.appendChild(T)}}return E}showEditPropertyValue(u,n,l){if(!u||u.properties[n]===void 0)return;l=l||{};const h=u.getPropertyInfo(n),d=h.type;let _="";if(d=="string"||d=="number"||d=="array"||d=="object")_="<input autofocus type='text' class='value'/>";else if((d=="enum"||d=="combo")&&h.values){_="<select autofocus type='text' class='value'>";for(const R in h.values){let C=R;h.values.constructor===Array&&(C=h.values[R]),_+="<option value='"+C+"' "+(C==u.properties[n]?"selected":"")+">"+h.values[R]+"</option>"}_+="</select>"}else if(d=="boolean"||d=="toggle")_="<input autofocus type='checkbox' class='value' "+(u.properties[n]?"checked":"")+"/>";else{console.warn("unknown type: "+d);return}const m=this.createDialog("<span class='name'>"+(h.label?h.label:n)+"</span>"+_+"<button>OK</button>",l);let E=!1;if((d=="enum"||d=="combo")&&h.values)E=m.querySelector("select"),E.addEventListener("change",function(R){m.modified(),S(R.target.value)});else if(d=="boolean"||d=="toggle")E=m.querySelector("input"),E&&E.addEventListener("click",function(R){m.modified(),S(!!E.checked)});else if(E=m.querySelector("input"),E){E.addEventListener("blur",function(C){this.focus()});let R=u.properties[n]!==void 0?u.properties[n]:"";d!=="string"&&(R=JSON.stringify(R)),E.value=R,E.addEventListener("keydown",function(C){if(C.keyCode==27)m.close();else if(C.keyCode==13)b();else if(C.keyCode!=13){m.modified();return}C.preventDefault(),C.stopPropagation()})}E&&E.focus(),m.querySelector("button").addEventListener("click",b);function b(){S(E.value)}function S(R){h&&h.values&&h.values.constructor===Object&&h.values[R]!=null&&(R=h.values[R]),typeof u.properties[n]=="number"&&(R=Number(R)),(d=="array"||d=="object")&&(R=JSON.parse(R)),u.properties[n]=R,u.graph&&u.graph._version++,u.onPropertyChanged&&u.onPropertyChanged(n,R),l.onclose&&l.onclose(),m.close(),u.setDirtyCanvas(!0,!0)}return m}createDialog(u,n){n=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},n||{});const h=document.createElement("div");h.className="graphdialog",h.innerHTML=u,h.is_modified=!1;const d=this.canvas.getBoundingClientRect();let _=-20,m=-20;if(d&&(_-=d.left,m-=d.top),n.position?(_+=n.position[0],m+=n.position[1]):n.event?(_+=n.event.clientX,m+=n.event.clientY):(_+=this.canvas.width*.5,m+=this.canvas.height*.5),h.style.left=_+"px",h.style.top=m+"px",this.canvas.parentNode.appendChild(h),n.checkForInput){let S=[];(S=h.querySelectorAll("input"))&&S.forEach(function(R){R.addEventListener("keydown",function(C){if(h.modified(),C.keyCode==27)h.close();else if(C.keyCode!=13)return;C.preventDefault(),C.stopPropagation()}),R.focus()})}h.modified=function(){h.is_modified=!0},h.close=function(){h.parentNode&&h.parentNode.removeChild(h)};let E=null,L=!1;h.addEventListener("mouseleave",function(S){L||(n.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!h.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(E=setTimeout(h.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),h.addEventListener("mouseenter",function(S){(n.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&E&&clearTimeout(E)});const b=h.querySelectorAll("select");return b&&b.forEach(function(S){S.addEventListener("click",function(R){L++}),S.addEventListener("blur",function(R){L=0}),S.addEventListener("change",function(R){L=-1})}),h}createPanel(u,n){n=n||{};const l=n.window||window,h=document.createElement("div");if(h.className="litegraph dialog",h.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",h.header=h.querySelector(".dialog-header"),n.width&&(h.style.width=n.width+(n.width.constructor===Number?"px":"")),n.height&&(h.style.height=n.height+(n.height.constructor===Number?"px":"")),n.closable){const d=document.createElement("span");d.innerHTML="&#10005;",d.classList.add("close"),d.addEventListener("click",function(){h.close()}),h.header.appendChild(d)}return h.title_element=h.querySelector(".dialog-title"),h.title_element.innerText=u,h.content=h.querySelector(".dialog-content"),h.alt_content=h.querySelector(".dialog-alt-content"),h.footer=h.querySelector(".dialog-footer"),h.close=()=>{h.onClose&&typeof h.onClose=="function"&&h.onClose(),h.parentNode&&h.parentNode.removeChild(h),h.parentNode&&h.parentNode.removeChild(this)},h.toggleAltContent=d=>{let _,m;typeof d<"u"?(_=d?"block":"none",m=d?"none":"block"):(_=h.alt_content.style.display!="block"?"block":"none",m=h.alt_content.style.display!="block"?"none":"block"),h.alt_content.style.display=_,h.content.style.display=m},h.toggleFooterVisibility=d=>{let _;typeof d<"u"?_=d?"block":"none":_=h.footer.style.display!="block"?"block":"none",h.footer.style.display=_},h.clear=()=>{this.content.innerHTML=""},h.addHTML=(d,_,m)=>{const E=document.createElement("div");return _&&(E.className=_),E.innerHTML=d,m?h.footer.appendChild(E):h.content.appendChild(E),E},h.addButton=(d,_,m)=>{const E=document.createElement("button");return E.innerText=d,E.options=m,E.classList.add("btn"),E.addEventListener("click",_),h.footer.appendChild(E),E},h.addSeparator=()=>{const d=document.createElement("div");d.className="separator",h.content.appendChild(d)},h.addWidget=(d,_,m,E,L)=>{E=E||{};let b=String(m);d=d.toLowerCase(),d=="number"&&(b=parseFloat(m).toFixed(3));const S=document.createElement("div");S.className="property",S.innerHTML="<span class='property_name'></span><span class='property_value'></span>",S.querySelector(".property_name").innerText=E.label||_;const R=S.querySelector(".property_value");R.innerText=b,S.dataset.property=_,S.dataset.type=E.type||d,S.options=E,S.value=m;const C=E.disabled||!1;if(C&&R.classList.add("disabled"),d=="code")S.addEventListener("click",function(D){D.preventDefault(),!C&&h.inner_showCodePad(this.dataset.property)});else if(d=="boolean")S.classList.add("boolean"),m&&S.classList.add("bool-on"),S.addEventListener("click",function(D){if(D.preventDefault(),C)return;const H=this.dataset.property||_;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",G(H,this.value)});else if(d=="string"||d=="number"){const D=document.createElement("input"),H=d==="string"?"string":"number";E.id&&D.setAttribute("id",E.id),D.setAttribute("type",H),E.min&&D.setAttribute("min",E.min),E.max&&D.setAttribute("max",E.max),D.classList.add("property_value_input"),C&&(D.setAttribute("disabled",C),D.classList.add("disabled")),R.innerText="",D.value=d==="string"?b:Number(b),R.appendChild(D),D.addEventListener("input",function(t){if(t.preventDefault(),C)return;const r=h.parentNode.dataset.property||_,s=h.parentNode.dataset.type;let a=t.target.value;s=="number"&&(a=Number(a)),G(r,a)})}else if(d=="enum"||d=="combo"){const D=_LGraphCanvas.getPropertyPrintableValue(m,E.values);R.innerText=D,R.addEventListener("click",H=>{if(H.preventDefault(),C)return;this.closeAllContextmenu();const e=E.values||[],t=h.parentNode.dataset.property||_,r=R,s=new ContextMenu(e,{event:H,className:"dark",callback:a},l);this._menus.push(s);function a(o,c,f){return r.innerText=o,G(t,o),!1}})}else if(d==="button"){S.innerHTML=`
                  <span class='property_name'></span>
                  <span class='property_value_img'>
                    <span class="property_img_src"></span>
                    
                  </span>`,S.querySelector(".property_name").innerText=E.label||_;const D=S.querySelector(".property_value_img");D.setAttribute("contenteditable",!0),D.innerText=b,S.dataset.property=_,S.dataset.type=E.type||d,S.options=E,S.value=m;const H=E.disabled,e=document.createElement("btn");e.classList.add("btn","btn-save-image"),e.textContent="이미지 추가",e.addEventListener("click",function(t){if(t.preventDefault(),H)return;const r=document.createElement("input");r.type="file",r.setAttribute("accept",".png,.jpg,.jpeg,.gif,.webp,"),r.click()}),D.appendChild(e)}h.content.appendChild(S);function G(D,H){E.callback&&E.callback(D,H,E),L&&L(D,H,E)}return S},h.onOpen&&typeof h.onOpen=="function"&&h.onOpen(),h}static getPropertyPrintableValue(u,n){if(!n||n.constructor===Array)return String(u);if(n.constructor===Object){let l="";for(const h in n)if(n[h]==u){l=h;break}return String(u)+" ("+l+")"}}closePanels(){const u=document.querySelector("#node-panel");u&&u.close();const n=document.querySelector("#option-panel");n&&n.close()}showShowGraphOptionsPanel(u,n,l,h){let d=document.querySelector("#node-panel"),_;if(this.constructor&&this.constructor.name=="HTMLDivElement"){if(!n||!n.event||!n.event.target||!n.event.target.lgraphcanvas){console.warn("Canvas not found");return}_=n.event.target.lgraphcanvas}else _=this;_.closePanels();const m=_.getCanvasWindow();d=_.createPanel("Options",{closable:!0,window:m,onOpen:function(){_.OPTIONPANEL_IS_OPEN=!0},onClose:function(){_.OPTIONPANEL_IS_OPEN=!1,_.options_panel=null}}),_.options_panel=d,d.id="option-panel",d.classList.add("settings");function E(){d.content.innerHTML="";const L=function(S,R,C){C&&C.key&&(S=C.key),C.values&&(R=Object.values(C.values).indexOf(R)),_[S]=R},b=LiteGraph.availableCanvasOptions;b.sort();for(const S in b){const R=b[S];d.addWidget("boolean",R,_[R],{key:R,on:"True",off:"False"},L)}_.links_render_mode,d.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[_.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},L),d.addSeparator(),d.footer.innerHTML=""}E(),_.canvas.parentNode.appendChild(d)}showShowNodePanel(u){this.SELECTED_NODE=u,this.closePanels();const n=this.getCanvasWindow(),l=this,h=this.createPanel(u.title||"",{closable:!0,window:n,onOpen:function(){l.NODEPANEL_IS_OPEN=!0},onClose:function(){l.NODEPANEL_IS_OPEN=!1,l.node_panel=null}});l.node_panel=h,h.id="node-panel",h.node=u,h.classList.add("settings");function d(){var L;h.content.innerHTML="",h.addHTML("<span class='node_type'>"+u.type+"</span><span class='node_desc'>"+(u.constructor.desc||"")+"</span><span class='separator'></span>"),h.addHTML("<h4>Properties</h4>");const _=(b,S)=>{l.graph.beforeChange(u);const R=Object.values(LiteGraph.NODE_MODES).indexOf(S);if(b.includes("inputName")){const C=u.properties[`editable-${b}`];u.setInputName(C.index,S),u.properties[`editable-${b}`].value=S}else if(b.includes("outputName")){const C=u.properties[`editable-${b}`];u.setOutputName(C.index,S),u.properties[`editable-${b}`].value=S}else switch(b){case"Title":u.title=S;break;case"Mode":R>=0&&LiteGraph.NODE_MODES[R]?u.changeMode(R):console.warn("unexpected mode: "+S);break;case"Color":_LGraphCanvas.node_colors[S]?(u.color=_LGraphCanvas.node_colors[S].color,u.bgcolor=_LGraphCanvas.node_colors[S].bgcolor):console.warn("unexpected color: "+S);break;case"x":u.pos=[parseInt(S),u.pos[1]];break;case"y":u.pos=[u.pos[0],parseInt(S)];break;case"Width":u.size=[parseInt(S),u.size[1]];break;case"Height":u.size=[u.size[0],parseInt(S)];break;default:u.setProperty(b,S);break}l.graph.afterChange(),l.dirty_canvas=!0};h.addWidget("string","Title",u.title,{disabled:!1},_);const m=["font_size","status","message"];for(let b in u.properties){if(m.includes(b)||b.includes("editable-"))continue;const S=u.properties[b],R=u.getPropertyInfo(b);R.type,!(u.onAddPropertyToPanel&&u.onAddPropertyToPanel(b,h))&&h.addWidget(R.widget||R.type,b,S,R,_)}if(h.addSeparator(),u.onShowCustomPanelInfo&&u.onShowCustomPanelInfo(h),(L=Object.keys(u.properties))==null?void 0:L.some(b=>b.includes("editable-"))){h.addHTML("<h4>Editable-Properties</h4>");for(let b in u.properties)if(b.includes("editable-")){const S=u.properties[b].value,R=u.getPropertyInfo(b);R.type;const C=b.split("-")[1];if(u.onAddPropertyToPanel&&u.onAddPropertyToPanel(b,h))continue;h.addWidget(R.widget||R.type,C,S,R,_)}}h.footer.innerHTML="",h.addButton("Delete",function(){u.block_delete||(u.graph.remove(u),h.close())}).classList.add("delete")}h.inner_showCodePad=_=>{h.classList.remove("settings"),h.classList.add("centered"),h.alt_content.innerHTML="<textarea class='code'></textarea>";const m=h.alt_content.querySelector("textarea"),E=()=>{h.toggleAltContent(!1),h.toggleFooterVisibility(!0),m.parentNode.removeChild(m),h.classList.add("settings"),h.classList.remove("centered"),d()};m.value=u.properties[_],m.addEventListener("keydown",function(S){S.code=="Enter"&&S.ctrlKey&&(u.setProperty(_,m.value),E())}),h.toggleAltContent(!0),h.toggleFooterVisibility(!1),m.style.height="calc(100% - 40px)";const L=h.addButton("Assign",function(){u.setProperty(_,m.value),E()});h.alt_content.appendChild(L);const b=h.addButton("Close",E);b.style.float="right",h.alt_content.appendChild(b)},d(),this.canvas.parentNode.appendChild(h)}showSubgraphPropertiesDialog(u){console.log("showing subgraph properties dialog");const n=this.canvas.parentNode.querySelector(".subgraph_dialog");n&&n.close();const l=this.createPanel("Subgraph Inputs",{closable:!0,width:500});l.node=u,l.classList.add("subgraph_dialog");function h(){if(l.clear(),u.inputs)for(let m=0;m<u.inputs.length;++m){const E=u.inputs[m];if(E.not_subgraph_input)continue;const b=l.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");b.dataset.name=E.name,b.dataset.slot=m,b.querySelector(".name").innerText=E.name,b.querySelector(".type").innerText=E.type,b.querySelector("button").addEventListener("click",function(S){u.removeInput(Number(this.parentNode.dataset.slot)),h()})}}return l.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",function(m){const E=this.parentNode,L=E.querySelector(".name").value,b=E.querySelector(".type").value;!L||u.findInputSlot(L)!=-1||(u.addInput(L,b),E.querySelector(".name").value="",E.querySelector(".type").value="",h())}),h(),this.canvas.parentNode.appendChild(l),l}showSubgraphPropertiesDialogRight(u){const n=this.canvas.parentNode.querySelector(".subgraph_dialog");n&&n.close();const l=this.createPanel("Subgraph Outputs",{closable:!0,width:500});l.node=u,l.classList.add("subgraph_dialog");function h(){if(l.clear(),u.outputs)for(let E=0;E<u.outputs.length;++E){const L=u.outputs[E];if(L.not_subgraph_output)continue;const S=l.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");S.dataset.name=L.name,S.dataset.slot=E,S.querySelector(".name").innerText=L.name,S.querySelector(".type").innerText=L.type,S.querySelector("button").addEventListener("click",function(R){u.removeOutput(Number(this.parentNode.dataset.slot)),h()})}}const _=l.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);_.querySelector(".name").addEventListener("keydown",function(E){E.keyCode==13&&m.apply(this)}),_.querySelector("button").addEventListener("click",function(E){m.apply(this)});function m(){const E=this.parentNode,L=E.querySelector(".name").value,b=E.querySelector(".type").value;!L||u.findOutputSlot(L)!=-1||(u.addOutput(L,b),E.querySelector(".name").value="",E.querySelector(".type").value="",h())}return h(),this.canvas.parentNode.appendChild(l),l}checkPanels(){if(!this.canvas)return;const u=this.canvas.parentNode.querySelectorAll(".litegraph.dialog");for(let n=0;n<u.length;++n){const l=u[n];l.node&&(!l.node.graph||l.graph!=this.graph)&&l.close()}}static onMenuNodeCollapse(u,n,l,h,d){d.graph.beforeChange();const _=function(E){E.collapse()},m=_LGraphCanvas.active_canvas;if(!m.selected_nodes||Object.keys(m.selected_nodes).length<=1)_(d);else for(const E in m.selected_nodes)_(m.selected_nodes[E]);d.graph.afterChange()}static onMenuNodePin(u,n,l,h,d){d.pin()}static onMenuNodeMode(u,n,l,h,d){new ContextMenu(LiteGraph.NODE_MODES,{event:l,callback:_,parentMenu:h,node:d});function _(m){if(!d)return;const E=Object.values(LiteGraph.NODE_MODES).indexOf(m),L=function(S){E>=0&&LiteGraph.NODE_MODES[E]?S.changeMode(E):(console.warn("unexpected mode: "+m),S.changeMode(LiteGraph.ALWAYS))},b=_LGraphCanvas.active_canvas;if(!b.selected_nodes||Object.keys(b.selected_nodes).length<=1)L(d);else for(const S in b.selected_nodes)L(b.selected_nodes[S])}return!1}static onMenuNodeColors(u,n,l,h,d){if(!d)throw"no node for color";const _=[];_.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(const E in _LGraphCanvas.node_colors){const L=_LGraphCanvas.node_colors[E],b={value:E,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+L.color+"; background-color:"+L.bgcolor+"'>"+E+"</span>"};_.push(b)}new ContextMenu(_,{event:l,callback:m,parentMenu:h,node:d});function m(E){if(!d)return;const L=E.value?_LGraphCanvas.node_colors[E.value]:null,b=function(R){L?R.constructor===LiteGraph.LGraphGroup?R.color=L.groupcolor:(R.color=L.color,R.bgcolor=L.bgcolor):(delete R.color,delete R.bgcolor)},S=_LGraphCanvas.active_canvas;if(!S.selected_nodes||Object.keys(S.selected_nodes).length<=1)b(d);else for(const R in S.selected_nodes)b(S.selected_nodes[R]);d.setDirtyCanvas(!0,!0)}return!1}static onMenuNodeShapes(u,n,l,h,d){if(!d)throw"no node passed";new ContextMenu(LiteGraph.VALID_SHAPES,{event:l,callback:_,parentMenu:h,node:d});function _(m){if(!d)return;d.graph.beforeChange();const E=function(b){b.shape=m},L=_LGraphCanvas.active_canvas;if(!L.selected_nodes||Object.keys(L.selected_nodes).length<=1)E(d);else for(const b in L.selected_nodes)E(L.selected_nodes[b]);d.graph.afterChange(),d.setDirtyCanvas(!0)}return!1}static onMenuNodeRemove(u,n,l,h,d){if(!d)throw"no node passed";const _=d.graph;_.beforeChange();const m=function(L){L.removable!==!1&&_.remove(L)},E=_LGraphCanvas.active_canvas;if(!E.selected_nodes||Object.keys(E.selected_nodes).length<=1)m(d);else for(const L in E.selected_nodes)m(E.selected_nodes[L]);_.afterChange(),d.setDirtyCanvas(!0,!0)}static onMenuNodeToSubgraph(u,n,l,h,d){const _=d.graph,m=_LGraphCanvas.active_canvas;if(!m)return;let E=Object.values(m.selected_nodes||{});E.length||(E=[d]);const L=LiteGraph.createNode("graph/subgraph");L.pos=d.pos.concat(),_.add(L),L.buildFromNodes(E),m.deselectAllNodes(),d.setDirtyCanvas(!0,!0)}static onMenuNodeClone(u,n,l,h,d){d.graph.beforeChange();const _={},m=function(L){if(L.clonable===!1)return;const b=L.clone();b&&(b.pos=[L.pos[0]+5,L.pos[1]+5],L.graph.add(b),_[b.id]=b)},E=_LGraphCanvas.active_canvas;if(!E.selected_nodes||Object.keys(E.selected_nodes).length<=1)m(d);else for(const L in E.selected_nodes)m(E.selected_nodes[L]);Object.keys(_).length&&E.selectNodes(_),d.graph.afterChange(),d.setDirtyCanvas(!0,!0)}getNodeMenuOptions(u){let n=null;if(u.getMenuOptions?n=u.getMenuOptions(this):(n=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:_LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:_LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:_LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:_LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeMode}],u.resizable!==!1&&n.push({content:"Resize",callback:_LGraphCanvas.onMenuResizeNode}),n.push({content:"Collapse",callback:_LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:_LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeShapes},null)),u.onGetInputs){const l=u.onGetInputs();l&&l.length&&(n[0].disabled=!1)}if(u.onGetOutputs){const l=u.onGetOutputs();l&&l.length&&(n[1].disabled=!1)}if(u.getExtraMenuOptions){const l=u.getExtraMenuOptions(this,n);l&&(l.push(null),n=l.concat(n))}return u.clonable!==!1&&n.push({content:"Clone",callback:_LGraphCanvas.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&n.push({content:"Align Selected To",has_submenu:!0,callback:_LGraphCanvas.onNodeAlign}),n.push(null,{content:"Remove",disabled:!(u.removable!==!1&&!u.block_delete),callback:_LGraphCanvas.onMenuNodeRemove}),u.graph&&u.graph.onGetNodeMenuOptions&&u.graph.onGetNodeMenuOptions(n,u),n}bringGroupToFront(u){const n=this.graph._groups,l=this.findGroupIndexById(u.id);Number(l)!==-1&&(n.splice(Number(l),1),n.push(u),this.setDirty(!0,!0))}onGrpSizeEditor(u,n,l,h,d){u.property;const _=document.createElement("div");_.is_modified=!1,_.className="graphdialog",_.innerHTML=`
                <div class="d-flex flex-column align-items-start p-2" id="grpSizeDialog">
                  <div> <div><span class='main-tit p-1'>그룹 사이즈 변경</span> </div>
                  <div class="p-1"><span class='sub-prop'>넓이</span><input  type='number' class='value' id="widthValue" /></div>
                  <div class="p-1"><span class='sub-prop'>높이</span><input type='number' class='value' id="heightValue"  /></div>
                  <div class="d-flex align-items-center justify-content-end p-1"><button class="okBtn">OK</button></div>
                </div>
               
                
                `,_.close=function(){_.parentNode&&_.parentNode.removeChild(_)};const E=_LGraphCanvas.active_canvas.canvas,L=E.getBoundingClientRect();let b=-20,S=-20;L&&(b-=L.left,S-=L.top),event?(_.style.left=event.clientX+b+"px",_.style.top=event.clientY+S+"px"):(_.style.left=E.width*.5+b+"px",_.style.top=E.height*.5+S+"px"),_.querySelector(".okBtn").addEventListener("click",H),E.parentNode.appendChild(_);const C=document.querySelector("#widthValue"),G=document.querySelector("#heightValue");C&&(C.value=Number(d.size[0]),C.addEventListener("keydown",function(t){if(_.is_modified=!0,t.keyCode==27)_.close();else if(t.keyCode==13)H();else if(t.keyCode!=13&&t.target.localName!="textarea")return;t.preventDefault(),t.stopPropagation()})),G&&(G.value=Number(d.size[1]),G.addEventListener("keydown",function(t){if(_.is_modified=!0,t.keyCode==27)_.close();else if(t.keyCode==13)H();else if(t.keyCode!=13&&t.target.localName!="textarea")return;t.preventDefault(),t.stopPropagation()}));let D=null;_.addEventListener("mouseleave",function(t){LiteGraph.dialog_close_on_mouse_leave&&!_.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(D=setTimeout(_.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),_.addEventListener("mouseenter",function(t){LiteGraph.dialog_close_on_mouse_leave&&D&&clearTimeout(D)});function H(){e(C==null?void 0:C.value,G==null?void 0:G.value)}function e(t,r){const s=t||d.size[0],a=r||d.size[1];d.size=[s,a],_.parentNode&&_.parentNode.removeChild(_),d.setDirtyCanvas(!0,!0)}}onShowPropertyEditor(u,n,l,h,d){const _=u.property||"title",m=d[_],E=document.createElement("div");E.is_modified=!1,E.className="graphdialog",E.innerHTML="<span class='name'></span><input type='text' class='value '/><button>OK</button>",E.close=function(){E.parentNode&&E.parentNode.removeChild(E)};const L=E.querySelector(".name");L.innerText=_;let b=E.querySelector(".value");b&&(b.value=m,b.addEventListener("keydown",function(s){if(E.is_modified=!0,s.keyCode==27)E.close();else if(s.keyCode==13)t();else if(s.keyCode!=13&&s.target.localName!="textarea")return;s.preventDefault(),s.stopPropagation()}));const R=_LGraphCanvas.active_canvas.canvas,C=R.getBoundingClientRect();let G=-20,D=-20;C&&(G-=C.left,D-=C.top),event?(E.style.left=event.clientX+G+"px",E.style.top=event.clientY+D+"px"):(E.style.left=R.width*.5+G+"px",E.style.top=R.height*.5+D+"px"),E.querySelector("button").addEventListener("click",t),R.parentNode.appendChild(E);let e=null;E.addEventListener("mouseleave",function(s){LiteGraph.dialog_close_on_mouse_leave&&!E.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(e=setTimeout(E.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),E.addEventListener("mouseenter",function(s){LiteGraph.dialog_close_on_mouse_leave&&e&&clearTimeout(e)});function t(){b&&r(b.value)}function r(s){u.type=="Number"?s=Number(s):u.type=="Boolean"&&(s=!!s),d[_]=s,E.parentNode&&E.parentNode.removeChild(E),d.setDirtyCanvas(!0,!0)}}onGrpPositionEditor(u,n,l,h,d){const _=document.createElement("div");_.is_modified=!1,_.className="graphdialog",_.innerHTML=`
                <div class="d-flex flex-column align-items-start p-2" id="grpSizeDialog">
                  <div> <div><span class='main-tit p-1'>그룹 위치 변경</span> </div>
                  <div class="p-1"><span class='sub-prop'>X</span><input  type='number' class='value' id="xValue" /></div>
                  <div class="p-1"><span class='sub-prop'>Y</span><input type='number' class='value' id="yValue" /></div>
                  <div class="d-flex align-items-center justify-content-end p-1"><button class="okBtn">OK</button></div>
                </div>
                `,_.close=function(){_.parentNode&&_.parentNode.removeChild(_)};const E=_LGraphCanvas.active_canvas.canvas,L=E.getBoundingClientRect();let b=-20,S=-20;L&&(b-=L.left,S-=L.top),event?(_.style.left=event.clientX+b+"px",_.style.top=event.clientY+S+"px"):(_.style.left=E.width*.5+b+"px",_.style.top=E.height*.5+S+"px"),_.querySelector(".okBtn").addEventListener("click",H),E.parentNode.appendChild(_);const C=document.querySelector("#xValue"),G=document.querySelector("#yValue");C&&(C.value=Number(d.pos[0]),C.addEventListener("keydown",function(t){if(_.is_modified=!0,t.keyCode==27)_.close();else if(t.keyCode==13)H();else if(t.keyCode!=13&&t.target.localName!="textarea")return;t.preventDefault(),t.stopPropagation()})),G&&(G.value=Number(d.pos[1]),G.addEventListener("keydown",function(t){if(_.is_modified=!0,t.keyCode==27)_.close();else if(t.keyCode==13)H();else if(t.keyCode!=13&&t.target.localName!="textarea")return;t.preventDefault(),t.stopPropagation()}));let D=null;_.addEventListener("mouseleave",function(t){LiteGraph.dialog_close_on_mouse_leave&&!_.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(D=setTimeout(_.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),_.addEventListener("mouseenter",function(t){LiteGraph.dialog_close_on_mouse_leave&&D&&clearTimeout(D)});function H(){e(C==null?void 0:C.value,G==null?void 0:G.value)}function e(t,r){const s=t||d.pos[0],a=r||d.pos[1];d.recomputeInsideNodes();const o=[s-d.pos[0],a-d.pos[1]];d.move(o[0],o[1]),_.parentNode&&_.parentNode.removeChild(_),d.setDirtyCanvas(!0,!0)}}sendGroupToBack(u){const n=this.graph._groups,l=this.findGroupIndexById(u.id);Number(l)!==-1&&(n.splice(Number(l),1),n.unshift(u),this.setDirty(!0,!0))}findGroupIndexById(u){const n=this.graph._groups;for(let l in n)if(n[l].id===u)return l;return-1}addNodeGuideLines(u){var l;const n=this.selected_nodes?Object.keys(this.selected_nodes):[];if((n==null?void 0:n.length)===1&&!this.read_only&&((l=this.graph._nodes)==null?void 0:l.length)>=2){const h=this.selected_nodes[n[0]],_=h.constructor.title_mode?0:LiteGraph.NODE_TITLE_HEIGHT,m=this.graph._nodes.map(R=>({x:R.pos[0],y:R.pos[1]-_,width:R.size[0],height:R.size[1],id:R.id})).filter(R=>(R==null?void 0:R.id)!==(h==null?void 0:h.id)),E=h.size[0],L=h.size[1],b=h.pos[0],S=h.pos[1]-_;u.strokeStyle="#c4c4c4",u.lineWidth=1;for(let R in m){u.strokeStyle=16711680;const C=m[R],G=C.width,D=C.height,H=C.x,e=C.y,t=Math.round(b),r=Math.round(S),s=Math.round(E),a=Math.round(L),o=Math.round(H),c=Math.round(e),f=Math.round(G),p=Math.round(D);o===t&&(r<c?(u.beginPath(),u.moveTo(t,r),u.lineTo(o,c+p+_),u.stroke()):(u.beginPath(),u.moveTo(o,c),u.lineTo(t,r+a+_),u.stroke())),o+f===t+s&&(r<c?(u.beginPath(),u.moveTo(t+s,r),u.lineTo(o+f,c+p+_),u.stroke()):(u.beginPath(),u.moveTo(o+f,c),u.lineTo(t+s,r+a+_),u.stroke())),c===r&&(t<o?(u.beginPath(),u.moveTo(t,r),u.lineTo(o+f,c),u.stroke()):(u.beginPath(),u.moveTo(o,c),u.lineTo(t+s,r),u.stroke())),c+p===r+a&&(t<o?(u.beginPath(),u.moveTo(t,r+a+_),u.lineTo(o+f,c+p+_),u.stroke()):(u.beginPath(),u.moveTo(o,c+p+_),u.lineTo(t+s,r+a+_),u.stroke()))}}}getCanvasMenuOptions(){let u=null;if(this.getMenuOptions?u=this.getMenuOptions():(u=[{content:"노드 추가",has_submenu:!0,callback:_LGraphCanvas.onMenuAdd.bind(this)},{content:"그룹 추가",callback:_LGraphCanvas.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&u.push({content:"정렬",has_submenu:!0,callback:_LGraphCanvas.onGroupAlign}),this._graph_stack&&this._graph_stack.length>0&&u.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){const n=this.getExtraMenuOptions(this,u);n&&(u=u.concat(n))}return u}processContextMenu(u,n){const l=this,d=_LGraphCanvas.active_canvas.getCanvasWindow();if(!d)return;let _=null;const m={event:n,callback:L,extra:u};u&&(m.title=u.type);let E=null;if(u&&(E=u.getSlotInPosition(n.canvasX,n.canvasY),_LGraphCanvas.active_node=u),E){if(_=[],u.getSlotMenuOptions)_=u.getSlotMenuOptions(E);else{E&&E.output&&E.output.links&&E.output.links.length&&_.push({content:"Disconnect Links",slot:E});const b=E.input||E.output;b.removable&&_.push(b.locked?"Cannot remove":{content:"Remove Slot",slot:E}),b.nameLocked||_.push({content:"Rename Slot",slot:E})}m.title=(E.input?E.input.type:E.output.type)||"*",E.input&&E.input.type==LiteGraph.ACTION&&(m.title="Action"),E.output&&E.output.type==LiteGraph.EVENT&&(m.title="Event")}else if(u)_=this.getNodeMenuOptions(u);else{_=this.getCanvasMenuOptions();const b=this.graph.getGroupOnPos(n.canvasX,n.canvasY);b&&_.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:b,options:this.getGroupMenuOptions(b)}})}if(!_)return;new ContextMenu(_,m,d);function L(b,S,R){if(b){if(b.content=="Remove Slot"){const C=b.slot;u.graph.beforeChange(),C.input?u.removeInput(C.slot):C.output&&u.removeOutput(C.slot),u.graph.afterChange();return}else if(b.content=="Disconnect Links"){const C=b.slot;u.graph.beforeChange(),C.output?u.disconnectOutput(C.slot):C.input&&u.disconnectInput(C.slot),u.graph.afterChange();return}else if(b.content=="Rename Slot"){const C=b.slot,G=C.input?u.getInputInfo(C.slot):u.getOutputInfo(C.slot),D=l.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",S),H=D.querySelector("input");H&&G&&(H.value=G.label||"");const e=function(){u.graph.beforeChange(),H.value&&(G&&(G.label=H.value),l.setDirty(!0)),D.close(),u.graph.afterChange()};D.querySelector("button").addEventListener("click",e),H.addEventListener("keydown",function(t){if(D.is_modified=!0,t.keyCode==27)D.close();else if(t.keyCode==13)e();else if(t.keyCode!=13&&t.target.localName!="textarea")return;t.preventDefault(),t.stopPropagation()}),H.focus()}}}}};ne(_LGraphCanvas,"DEFAULT_BACKGROUND_IMAGE","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII="),ne(_LGraphCanvas,"link_type_colors",{"-1":LiteGraph.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"}),ne(_LGraphCanvas,"gradients",{}),ne(_LGraphCanvas,"search_limit",-1),ne(_LGraphCanvas,"node_colors",{red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}});let LGraphCanvas=_LGraphCanvas;class ContextMenu{constructor(n,l){l=l||{},this.options=l;const h=this;l.parentMenu&&(l.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),l.parentMenu=null):(this.parentMenu=l.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));let d=null;l.event&&(d=l.event.constructor.name),d!=="MouseEvent"&&d!=="CustomEvent"&&d!=="PointerEvent"&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+d+")"),l.event=null);const _=document.createElement("div");_.className="litegraph litecontextmenu litemenubar-panel",l.className&&(_.className+=" "+l.className),_.style.minWidth=100,_.style.minHeight=100,_.style.pointerEvents="none",setTimeout(function(){_.style.pointerEvents="auto"},100),LiteGraph.pointerListenerAdd(_,"up",function(C){return C.preventDefault(),!0},!0),_.addEventListener("contextmenu",function(C){return C.button!=2||C.preventDefault(),!1},!0),LiteGraph.pointerListenerAdd(_,"down",function(C){if(C.button==2)return h.close(),C.preventDefault(),!0},!0);function m(C){const G=parseInt(_.style.top);return _.style.top=(G+C.deltaY*l.scroll_speed).toFixed()+"px",C.preventDefault(),!0}if(l.scroll_speed||(l.scroll_speed=.1),_.addEventListener("wheel",m,!0),_.addEventListener("mousewheel",m,!0),this.root=_,l.title){const C=document.createElement("div");C.className="litemenu-title",C.innerHTML=l.title,_.appendChild(C)}for(let C=0;C<n.length;C++){let G=n.constructor==Array?n[C]:C;G!=null&&G.constructor!==String&&(G=G.content===void 0?String(G):G.content);const D=n[C];this.addItem(G,D,l)}LiteGraph.pointerListenerAdd(_,"enter",function(C){_.closing_timer&&clearTimeout(_.closing_timer)});let E=document;l.event&&(E=l.event.target.ownerDocument),E||(E=document),E.fullscreenElement?E.fullscreenElement.appendChild(_):E.body.appendChild(_);let L=l.left||0,b=l.top||0;if(l.event){if(L=l.event.clientX-10,b=l.event.clientY-10,l.title&&(b-=20),l.parentMenu){const D=l.parentMenu.root.getBoundingClientRect();L=D.left+D.width}const C=document.body.getBoundingClientRect(),G=_.getBoundingClientRect();C.height==0&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),C.width&&L>C.width-G.width-10&&(L=C.width-G.width-10),C.height&&b>C.height-G.height-10&&(b=C.height-G.height-10)}_.style.left=L+"px",_.style.top=b+"px",l.scale&&(_.style.transform="scale("+l.scale+")");const R=LGraphCanvas.active_canvas.canvas;this.parent=R.parentElement||document}addItem(n,l,h){const d=this;h=h||{};const _=document.createElement("div");_.className="litemenu-entry submenu";let m=!1;l===null?_.classList.add("separator"):(_.innerHTML=l&&l.title?l.title:n,_.value=l,l&&(l.disabled&&(m=!0,_.classList.add("disabled")),(l.submenu||l.has_submenu)&&_.classList.add("has_submenu")),typeof l=="function"?(_.dataset.value=n,_.onclick_callback=l):_.dataset.value=l,l.className&&(_.className+=" "+l.className)),this.root.appendChild(_),m||_.addEventListener("click",L),!m&&h.autoopen&&LiteGraph.pointerListenerAdd(_,"enter",E);function E(b){const S=this.value;!S||!S.has_submenu||L.call(this,b)}function L(b){const S=this.value;let R=!0;if(d.current_submenu&&d.current_submenu.close(b),h.callback&&h.callback.call(this,S,h,b,d,h.node)===!0&&(R=!1),S&&(S.callback&&!h.ignore_item_callbacks&&S.disabled!==!0&&S.callback.call(this,S,h,b,d,h.extra)===!0&&(R=!1),S.submenu)){if(!S.submenu.options)throw"ContextMenu submenu needs options";new d.constructor(S.submenu.options,{callback:S.submenu.callback,event:b,parentMenu:d,ignore_item_callbacks:S.submenu.ignore_item_callbacks,title:S.submenu.title,extra:S.submenu.extra,autoopen:h.autoopen}),R=!1}R&&!d.lock&&d.close()}return _}close(n,l){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!l&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,n===void 0?this.parentMenu.close():n&&!ContextMenu.isCursorOverElement(n,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,LiteGraph.pointerevents_method+"leave",n)),this.current_submenu&&this.current_submenu.close(n,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)}static trigger(n,l,h,d){const _=document.createEvent("CustomEvent");return _.initCustomEvent(l,!0,!0,h),_.srcElement=d,n.dispatchEvent?n.dispatchEvent(_):n.__events&&n.__events.dispatchEvent(_),_}getTopMenu(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this}getFirstEvent(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event}static isCursorOverElement(n,l){const h=n.clientX,d=n.clientY,_=l.getBoundingClientRect();return _?d>_.top&&d<_.top+_.height&&h>_.left&&h<_.left+_.width:!1}}function clamp(u,n,l){return n>u?n:l<u?l:u}typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(u){window.setTimeout(u,1e3/60)}),typeof exports<"u"&&(exports.LiteGraph=(void 0).LiteGraph,exports.LGraph=(void 0).LGraph,exports.LLink=(void 0).LLink,exports.LGraphNode=(void 0).LGraphNode,exports.LGraphGroup=(void 0).LGraphGroup,exports.DragAndScale=(void 0).DragAndScale,exports.LGraphCanvas=(void 0).LGraphCanvas,exports.ContextMenu=(void 0).ContextMenu);class RootNode extends LGraphNode{constructor(){super(),this.mode=0,this.addProperty("status",0,"number"),this.addProperty("message","","string")}}class ManualTrigger extends RootNode{constructor(){super(),this.title="수동 시작"}onExecute(){}}LiteGraph.registerNodeType("trigger/manualTrigger",ManualTrigger);class Selector extends LGraphNode{constructor(){super(),this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0,this.title="Selector",this.desc="selects an output"}onDrawBackground(n){if(!this.flags.collapsed){n.fillStyle="#AFB";var l=(this.selected+1)*LiteGraph.NODE_SLOT_HEIGHT+6;n.beginPath(),n.moveTo(50,l),n.lineTo(50,l+LiteGraph.NODE_SLOT_HEIGHT),n.lineTo(34,l+LiteGraph.NODE_SLOT_HEIGHT*.5),n.fill()}}onExecute(){var n=this.getInputData(0);(n==null||n.constructor!==Number)&&(n=0),this.selected=n=Math.round(n)%(this.inputs.length-1);var l=this.getInputData(n+1);l!==void 0&&this.setOutputData(0,l)}onGetInputs(){return[["E",0],["F",0],["G",0],["H",0]]}}class Sequence extends LGraphNode{constructor(){super(),this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(","),this.title="Sequence",this.desc="select one element from a sequence from a string"}onPropertyChanged(n,l){n=="sequence"&&(this.values=l.split(","))}onExecute(){var n=this.getInputData(1);n&&n!=this.current_sequence&&(this.values=n.split(","),this.current_sequence=n);var l=this.getInputData(0);l==null&&(l=0),this.index=l=Math.round(l)%this.values.length,this.setOutputData(0,this.values[l])}}class LogicAnd extends LGraphNode{constructor(){super(),this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean"),this.title="AND",this.desc="Return true if all inputs are true"}onExecute(){var n=!0;for(var l in this.inputs)if(!this.getInputData(l)){var n=!1;break}this.setOutputData(0,n)}onGetInputs(){return[["and","boolean"]]}}class LogicOr extends LGraphNode{constructor(){super(),this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean"),this.title="OR",this.desc="Return true if at least one input is true"}onExecute(){var n=!1;for(var l in this.inputs)if(this.getInputData(l)){n=!0;break}this.setOutputData(0,n)}onGetInputs(){return[["or","boolean"]]}}class LogicNot extends LGraphNode{constructor(){super(),this.properties={},this.addInput("in","boolean"),this.addOutput("out","boolean"),this.title="NOT",this.desc="Return the logical negation"}onExecute(){var n=!this.getInputData(0);this.setOutputData(0,n)}}class LogicCompare extends LGraphNode{constructor(){super(),this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean"),this.title="bool == bool",this.desc="Compare for logical equality"}onExecute(){var n=null,l=!0;for(var h in this.inputs)if(n===null)n=this.getInputData(h);else if(n!=this.getInputData(h)){l=!1;break}this.setOutputData(0,l)}onGetInputs(){return[["bool","boolean"]]}}class LogicBranch extends LGraphNode{constructor(){super(),this.properties={},this.addInput("onTrigger",LiteGraph.ACTION),this.addInput("condition","boolean"),this.addOutput("true",LiteGraph.EVENT),this.addOutput("false",LiteGraph.EVENT),this.mode=LiteGraph.ON_TRIGGER,this.title="Branch",this.desc="Branch execution on condition"}onExecute(n,l){var h=this.getInputData(1);h?this.triggerSlot(0):this.triggerSlot(1)}}LiteGraph.registerNodeType("logic/CompareBool",LogicCompare),LiteGraph.registerNodeType("logic/NOT",LogicNot),LiteGraph.registerNodeType("logic/OR",LogicOr),LiteGraph.registerNodeType("logic/AND",LogicAnd),LiteGraph.registerNodeType("logic/sequence",Sequence),LiteGraph.registerNodeType("logic/selector",Selector),LiteGraph.registerNodeType("logic/IF",LogicBranch)})();
